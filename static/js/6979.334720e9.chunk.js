"use strict";(self.webpackChunksc_viaduct=self.webpackChunksc_viaduct||[]).push([[6979],{27106:(e,t,r)=>{function i(e,t){this.v=e,this.k=t}r.d(t,{A:()=>i})},19495:(e,t,r)=>{function i(e){var t,r,i,n=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,i=Symbol.iterator);n--;){if(r&&null!=(t=e[r]))return t.call(e);if(i&&null!=(t=e[i]))return new s(t.call(e));r="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function s(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return s=function(e){this.s=e,this.n=e.next},s.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s.return;return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s.return;return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new s(e)}r.d(t,{A:()=>i})},56218:(e,t,r)=>{r.d(t,{A:()=>s});var i=r(27106);function s(e){return new i.A(e,0)}},30912:(e,t,r)=>{r.d(t,{A:()=>n});var i=r(27106);function s(e){var t,r;function s(t,r){try{var o=e[t](r),a=o.value,c=a instanceof i.A;Promise.resolve(c?a.v:a).then((function(r){if(c){var i="return"===t?"return":"next";if(!a.k||r.done)return s(i,r);r=e[i](r).value}n(o.done?"return":"normal",r)}),(function(e){s("throw",e)}))}catch(e){n("throw",e)}}function n(e,i){switch(e){case"return":t.resolve({value:i,done:!0});break;case"throw":t.reject(i);break;default:t.resolve({value:i,done:!1})}(t=t.next)?s(t.key,t.arg):r=null}this._invoke=function(e,i){return new Promise((function(n,o){var a={key:e,arg:i,resolve:n,reject:o,next:null};r?r=r.next=a:(t=r=a,s(e,i))}))},"function"!=typeof e.return&&(this.return=void 0)}function n(e){return function(){return new s(e.apply(this,arguments))}}s.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},s.prototype.next=function(e){return this._invoke("next",e)},s.prototype.throw=function(e){return this._invoke("throw",e)},s.prototype.return=function(e){return this._invoke("return",e)}},98006:(e,t,r)=>{function i(){const e=new Float32Array(6);return e[0]=1,e[3]=1,e}function s(e,t,r,i){const s=t[i],n=t[i+1];e[i]=r[0]*s+r[2]*n+r[4],e[i+1]=r[1]*s+r[3]*n+r[5]}function n(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2;const o=(arguments.length>4&&void 0!==arguments[4]?arguments[4]:0)||t.length/n;for(let a=i;a<o;a++)s(e,t,r,a*n)}r.d(t,{gb:()=>n,vt:()=>i});Object.freeze(Object.defineProperty({__proto__:null,clone:function(e){const t=new Float32Array(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},create:i,createView:function(e,t){return new Float32Array(e,t,6)},fromValues:function(e,t,r,i,s,n){const o=new Float32Array(6);return o[0]=e,o[1]=t,o[2]=r,o[3]=i,o[4]=s,o[5]=n,o},transform:s,transformMany:n},Symbol.toStringTag,{value:"Module"}))},94967:(e,t,r)=>{r.d(t,{$0:()=>u,B8:()=>n,D_:()=>s,Tl:()=>l,e$:()=>a,hs:()=>c,lw:()=>o});var i=r(53494);function s(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e}function n(e,t){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5];let c=r*n-i*s;return c?(c=1/c,e[0]=n*c,e[1]=-i*c,e[2]=-s*c,e[3]=r*c,e[4]=(s*a-n*o)*c,e[5]=(i*o-r*a)*c,e):null}function o(e,t,r){const i=t[0],s=t[1],n=t[2],o=t[3],a=t[4],c=t[5],l=r[0],u=r[1],d=r[2],h=r[3],p=r[4],f=r[5];return e[0]=i*l+n*u,e[1]=s*l+o*u,e[2]=i*d+n*h,e[3]=s*d+o*h,e[4]=i*p+n*f+a,e[5]=s*p+o*f+c,e}function a(e,t,r){const i=t[0],s=t[1],n=t[2],o=t[3],a=t[4],c=t[5],l=Math.sin(r),u=Math.cos(r);return e[0]=i*u+n*l,e[1]=s*u+o*l,e[2]=i*-l+n*u,e[3]=s*-l+o*u,e[4]=a,e[5]=c,e}function c(e,t,r){const i=t[0],s=t[1],n=t[2],o=t[3],a=t[4],c=t[5],l=r[0],u=r[1];return e[0]=i*l,e[1]=s*l,e[2]=n*u,e[3]=o*u,e[4]=a,e[5]=c,e}function l(e,t,r){const i=t[0],s=t[1],n=t[2],o=t[3],a=t[4],c=t[5],l=r[0],u=r[1];return e[0]=i,e[1]=s,e[2]=n,e[3]=o,e[4]=i*l+n*u+a,e[5]=s*l+o*u+c,e}function u(e,t){const r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=-r,e[3]=i,e[4]=0,e[5]=0,e}function d(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e}const h=o,p=d;Object.freeze(Object.defineProperty({__proto__:null,add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},determinant:function(e){return e[0]*e[3]-e[1]*e[2]},equals:function(e,t){const r=e[0],s=e[1],n=e[2],o=e[3],a=e[4],c=e[5],l=t[0],u=t[1],d=t[2],h=t[3],p=t[4],f=t[5],_=(0,i.FD)();return Math.abs(r-l)<=_*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(s-u)<=_*Math.max(1,Math.abs(s),Math.abs(u))&&Math.abs(n-d)<=_*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(o-h)<=_*Math.max(1,Math.abs(o),Math.abs(h))&&Math.abs(a-p)<=_*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(c-f)<=_*Math.max(1,Math.abs(c),Math.abs(f))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]},frob:function(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+1)},fromRotation:u,fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e},fromTranslation:function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e},identity:s,invert:n,mul:h,multiply:o,multiplyScalar:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e},multiplyScalarAndAdd:function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e[4]=t[4]+r[4]*i,e[5]=t[5]+r[5]*i,e},rotate:a,scale:c,set:function(e,t,r,i,s,n,o){return e[0]=t,e[1]=r,e[2]=i,e[3]=s,e[4]=n,e[5]=o,e},str:function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},sub:p,subtract:d,translate:l},Symbol.toStringTag,{value:"Module"}))},51703:(e,t,r)=>{r.d(t,{F:()=>c,l:()=>l});var i=r(28899),s=r(81806);const n=128e3;let o=null,a=null;async function c(){return o||(o=async function(){const e=(0,s.A)("esri-csp-restrictions")?await r.e(7879).then(r.bind(r,27879)).then((e=>e.l)):await r.e(6821).then(r.bind(r,56821)).then((e=>e.l));a=await e.default({locateFile:e=>(0,i.s)("esri/core/libs/libtess/".concat(e))})}()),o}function l(e,t){const r=Math.max(e.length,n);return a.triangulate(e,t,r)}},33376:(e,t,r)=>{r.d(t,{T:()=>o});var i=r(90321),s=r(20176),n=r(1484);const o={getObjectId:e=>e.objectId,getAttributes:e=>e.attributes,getAttribute:(e,t)=>e.attributes[t],cloneWithGeometry:(e,t)=>new s.Om(t,e.attributes,null,e.objectId),getGeometry:e=>e.geometry,getCentroid:(e,t)=>(null==e.centroid&&(e.centroid=(0,i.Q)(new n.A,e.geometry,t.hasZ,t.hasM)),e.centroid)}},78238:(e,t,r)=>{function i(e){const t={};for(const r in e){if("declaredClass"===r)continue;const s=e[r];if(null!=s&&"function"!=typeof s)if(Array.isArray(s)){t[r]=[];for(let e=0;e<s.length;e++)t[r][e]=i(s[e])}else"object"==typeof s?s.toJSON&&(t[r]=JSON.stringify(s)):t[r]=s}return t}r.d(t,{z:()=>i})},36643:(e,t,r)=>{r.d(t,{GB:()=>v,IJ:()=>_,Jf:()=>x,Pk:()=>m,eW:()=>f,gW:()=>g,kS:()=>y});var i=r(8),s=r(3825),n=r(90534),o=r(19902),a=r(1438),c=r(80963),l=r(78238),u=r(89122),d=r(57831);const h="Layer does not support extent calculation.";function p(e,t){var r;const i=e.geometry,s=e.toJSON();delete s.compactGeometryEnabled,delete s.defaultSpatialReferenceEnabled;const n=s;let a,l,u;if(null!=i&&(l=i.spatialReference,u=(0,c.YX)(l),n.geometryType=(0,o.$B)(i),n.geometry=function(e,t){if(t&&"extent"===e.type)return"".concat(e.xmin,",").concat(e.ymin,",").concat(e.xmax,",").concat(e.ymax);if(t&&"point"===e.type)return"".concat(e.x,",").concat(e.y);const r=e.toJSON();return delete r.spatialReference,JSON.stringify(r)}(i,e.compactGeometryEnabled),n.inSR=u),s.groupByFieldsForStatistics&&(n.groupByFieldsForStatistics=s.groupByFieldsForStatistics.join(",")),s.objectIds&&(n.objectIds=s.objectIds.join(",")),s.orderByFields&&(n.orderByFields=s.orderByFields.join(",")),!s.outFields||!s.returnDistinctValues&&(null!==t&&void 0!==t&&t.returnCountOnly||null!==t&&void 0!==t&&t.returnExtentOnly||null!==t&&void 0!==t&&t.returnIdsOnly)?delete n.outFields:s.outFields.includes("*")?n.outFields="*":n.outFields=s.outFields.join(","),s.outSR?(n.outSR=(0,c.YX)(s.outSR),a=e.outSpatialReference):i&&(s.returnGeometry||s.returnCentroid)&&(n.outSR=n.inSR,a=l),s.returnGeometry&&delete s.returnGeometry,s.outStatistics&&(n.outStatistics=JSON.stringify(s.outStatistics)),s.fullText&&(n.fullText=JSON.stringify(s.fullText)),s.pixelSize&&(n.pixelSize=JSON.stringify(s.pixelSize)),s.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=l&&null!=(null===(r=e.quantizationParameters)||void 0===r?void 0:r.extent)&&l.equals(e.quantizationParameters.extent.spatialReference)&&delete s.quantizationParameters.extent.spatialReference,n.quantizationParameters=JSON.stringify(s.quantizationParameters)),s.parameterValues&&(n.parameterValues=JSON.stringify(s.parameterValues)),s.rangeValues&&(n.rangeValues=JSON.stringify(s.rangeValues)),s.dynamicDataSource&&(n.layer=JSON.stringify({source:s.dynamicDataSource}),delete s.dynamicDataSource),s.timeExtent){const e=s.timeExtent,{start:t,end:r}=e;null==t&&null==r||(n.time=t===r?t:"".concat(null!==t&&void 0!==t?t:"null",",").concat(null!==r&&void 0!==r?r:"null")),delete s.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=l&&null!=a&&l.equals(a)&&(n.defaultSR=n.inSR,delete n.inSR,delete n.outSR),n}async function f(e,t,r,i){const s=null!=t.timeExtent&&t.timeExtent.isEmpty?{data:{features:[]}}:await v(e,t,"json",i);return(0,d.q)(t,r,s.data),s}async function _(e,t,r,i){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:r.createFeatureResult()};const s=await y(e,t,i),n=s;return n.data=(0,u.m)(s.data,r),n}function y(e,t,r){return v(e,t,"pbf",r)}function m(e,t,r){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):v(e,t,"json",r,{returnIdsOnly:!0})}function g(e,t,r){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):v(e,t,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})}async function x(e,t,r){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:{count:0,extent:null}};const i=await v(e,t,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}),s=i.data;if(s.hasOwnProperty("extent"))return i;if(s.features)throw new Error(h);if(s.hasOwnProperty("count"))throw new Error(h);return i}async function v(e,t,r){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const u="string"==typeof e?(0,n.An)(e):e,d=t.geometry?[t.geometry]:[],h=await(0,a.el)(d,null,{signal:o.signal}),f=null===h||void 0===h?void 0:h[0];null!=f&&((t=t.clone()).geometry=f);const _=(0,l.z)((0,i.A)((0,i.A)((0,i.A)({},u.query),{},{f:r},c),p(t,c)));return(0,s.A)((0,n.fj)(u.path,function(e,t){return null!=e.formatOf3DObjects&&!(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)}(t,c)?"query3d":"query"),(0,i.A)((0,i.A)({},o),{},{responseType:"pbf"===r?"array-buffer":"json",query:(0,i.A)((0,i.A)({},_),o.query)}))}},77555:(e,t,r)=>{r.d(t,{$o:()=>i,$u:()=>s});const i=15.5,s=1024},27307:(e,t,r)=>{r.d(t,{i:()=>_});var i=r(28808),s=r(5095);function n(e,t){return e.x===t.x&&e.y===t.y}function o(e){if(!e)return;const t=e.length;if(t<=1)return;let r=0;for(let i=1;i<t;i++)n(e[i],e[r])||++r===i||(e[r]=e[i]);e.length=r+1}function a(e,t){return e.x=t.y,e.y=-t.x,e}function c(e,t){return e.x=-t.y,e.y=t.x,e}function l(e,t){return e.x=t.x,e.y=t.y,e}function u(e,t){return e.x=-t.x,e.y=-t.y,e}function d(e){return Math.sqrt(e.x*e.x+e.y*e.y)}function h(e,t){return e.x*t.y-e.y*t.x}function p(e,t){return e.x*t.x+e.y*t.y}function f(e,t,r,i){return e.x=t.x*r+t.y*i,e.y=t.x*i-t.y*r,e}class _{constructor(e,t,r){this._writeVertex=e,this._writeTriangle=t,this._canUseThinTessellation=r,this._prevNormal={x:void 0,y:void 0},this._nextNormal={x:void 0,y:void 0},this._textureNormalLeft={x:0,y:1},this._textureNormalRight={x:0,y:-1},this._textureNormal={x:void 0,y:void 0},this._joinNormal={x:void 0,y:void 0},this._inner={x:void 0,y:void 0},this._outer={x:void 0,y:void 0},this._roundStart={x:void 0,y:void 0},this._roundEnd={x:void 0,y:void 0},this._startBreak={x:void 0,y:void 0},this._endBreak={x:void 0,y:void 0},this._innerPrev={x:void 0,y:void 0},this._innerNext={x:void 0,y:void 0},this._bevelStart={x:void 0,y:void 0},this._bevelEnd={x:void 0,y:void 0},this._bevelMiddle={x:void 0,y:void 0}}tessellate(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._canUseThinTessellation;o(e),r&&t.halfWidth<s.Gh&&!t.offset?this._tessellateThin(e,t):this._tessellate(e,t)}_tessellateThin(e,t){if(e.length<2)return;const r=t.wrapDistance||65535;let i=t.initialDistance||0,s=!1,n=e[0].x,o=e[0].y;const a=e.length;for(let c=1;c<a;++c){s&&(s=!1,i=0);let t=e[c].x,a=e[c].y,l=t-n,u=a-o,d=Math.sqrt(l*l+u*u);if(l/=d,u/=d,i+d>r){s=!0;const e=(r-i)/d;d=r-i,t=(1-e)*n+e*t,a=(1-e)*o+e*a,--c}const h=this._writeVertex(n,o,0,0,l,u,u,-l,0,-1,i),p=this._writeVertex(n,o,0,0,l,u,-u,l,0,1,i);i+=d;const f=this._writeVertex(t,a,0,0,l,u,u,-l,0,-1,i),_=this._writeVertex(t,a,0,0,l,u,-u,l,0,1,i);this._writeTriangle(h,p,f),this._writeTriangle(p,f,_),n=t,o=a}}_tessellate(e,t){const r=e[0],s=e[e.length-1],o=n(r,s),_=o?3:2;if(e.length<_)return;const y=t.pixelCoordRatio,m=null!=t.capType?t.capType:i.xR.BUTT,g=null!=t.joinType?t.joinType:i.JO.MITER,x=null!=t.miterLimit?Math.min(t.miterLimit,4):2,v=null!=t.roundLimit?Math.min(t.roundLimit,1.05):1.05,b=null!=t.halfWidth?t.halfWidth:2,w=!!t.textured;let I,S,T,A=null;const M=this._prevNormal,k=this._nextNormal;let F=-1,E=-1;const C=this._joinNormal;let P,z;const O=this._textureNormalLeft,R=this._textureNormalRight,D=this._textureNormal;let L=-1,N=-1;const B=t.wrapDistance||65535;let V=t.initialDistance||0;const q=this._writeVertex,G=this._writeTriangle,U=(e,t,r,i,s,n)=>{const o=q(S,T,P,z,r,i,e,t,s,n,V);return L>=0&&N>=0&&o>=0&&G(L,N,o),L=N,N=o,o};o&&(I=e[e.length-2],k.x=s.x-I.x,k.y=s.y-I.y,E=d(k),k.x/=E,k.y/=E);let j=!1;for(let n=0;n<e.length;++n){if(j&&(j=!1,V=0),I&&(M.x=-k.x,M.y=-k.y,F=E,V+F>B&&(j=!0)),j){const t=(B-V)/F;F=B-V,I={x:(1-t)*I.x+t*e[n].x,y:(1-t)*I.y+t*e[n].y},--n}else I=e[n];S=I.x,T=I.y;const t=n<=0&&!j,r=n===e.length-1;if(t||(V+=F),A=r?o?e[1]:null:e[n+1],A?(k.x=A.x-S,k.y=A.y-T,E=d(k),k.x/=E,k.y/=E):(k.x=void 0,k.y=void 0),!o){if(t){c(C,k),P=C.x,z=C.y,m===i.xR.SQUARE&&(U(-k.y-k.x,k.x-k.y,k.x,k.y,0,-1),U(k.y-k.x,-k.x-k.y,k.x,k.y,0,1)),m===i.xR.ROUND&&(U(-k.y-k.x,k.x-k.y,k.x,k.y,-1,-1),U(k.y-k.x,-k.x-k.y,k.x,k.y,-1,1)),m!==i.xR.ROUND&&m!==i.xR.BUTT||(U(-k.y,k.x,k.x,k.y,0,-1),U(k.y,-k.x,k.x,k.y,0,1));continue}if(r){a(C,M),P=C.x,z=C.y,m!==i.xR.ROUND&&m!==i.xR.BUTT||(U(M.y,-M.x,-M.x,-M.y,0,-1),U(-M.y,M.x,-M.x,-M.y,0,1)),m===i.xR.SQUARE&&(U(M.y-M.x,-M.x-M.y,-M.x,-M.y,0,-1),U(-M.y-M.x,M.x-M.y,-M.x,-M.y,0,1)),m===i.xR.ROUND&&(U(M.y-M.x,-M.x-M.y,-M.x,-M.y,1,-1),U(-M.y-M.x,M.x-M.y,-M.x,-M.y,1,1));continue}}let s,_,q=-h(M,k);if(Math.abs(q)<.01)p(M,k)>0?(C.x=M.x,C.y=M.y,q=1,s=Number.MAX_VALUE,_=!0):(c(C,k),q=1,s=1,_=!1);else{C.x=(M.x+k.x)/q,C.y=(M.y+k.y)/q,s=d(C);const e=(s-1)*b*y;_=s>4||e>F&&e>E}P=C.x,z=C.y;let G=g;switch(g){case i.JO.BEVEL:s<1.05&&(G=i.JO.MITER);break;case i.JO.ROUND:s<v&&(G=i.JO.MITER);break;case i.JO.MITER:s>x&&(G=i.JO.BEVEL)}switch(G){case i.JO.MITER:if(U(C.x,C.y,-M.x,-M.y,0,-1),U(-C.x,-C.y,-M.x,-M.y,0,1),r)break;if(w){const e=j?0:V;L=this._writeVertex(S,T,P,z,k.x,k.y,C.x,C.y,0,-1,e),N=this._writeVertex(S,T,P,z,k.x,k.y,-C.x,-C.y,0,1,e)}break;case i.JO.BEVEL:{const e=q<0;let t,i,s,n;if(e){const e=L;L=N,N=e,t=O,i=R}else t=R,i=O;if(_)s=e?c(this._innerPrev,M):a(this._innerPrev,M),n=e?a(this._innerNext,k):c(this._innerNext,k);else{const t=e?u(this._inner,C):l(this._inner,C);s=t,n=t}const o=e?a(this._bevelStart,M):c(this._bevelStart,M);U(s.x,s.y,-M.x,-M.y,t.x,t.y);const d=U(o.x,o.y,-M.x,-M.y,i.x,i.y);if(r)break;const h=e?c(this._bevelEnd,k):a(this._bevelEnd,k);if(_){const e=this._writeVertex(S,T,P,z,-M.x,-M.y,0,0,0,0,V);L=this._writeVertex(S,T,P,z,k.x,k.y,n.x,n.y,t.x,t.y,V),N=this._writeVertex(S,T,P,z,k.x,k.y,h.x,h.y,i.x,i.y,V),this._writeTriangle(d,e,N)}else{if(w){const e=this._bevelMiddle;e.x=(o.x+h.x)/2,e.y=(o.y+h.y)/2,f(D,e,-M.x,-M.y),U(e.x,e.y,-M.x,-M.y,D.x,D.y),f(D,e,k.x,k.y),L=this._writeVertex(S,T,P,z,k.x,k.y,e.x,e.y,D.x,D.y,V),N=this._writeVertex(S,T,P,z,k.x,k.y,n.x,n.y,t.x,t.y,V)}else{const e=L;L=N,N=e}U(h.x,h.y,k.x,k.y,i.x,i.y)}if(e){const e=L;L=N,N=e}break}case i.JO.ROUND:{const e=q<0;let t,i;if(e){const e=L;L=N,N=e,t=O,i=R}else t=R,i=O;const n=e?u(this._inner,C):l(this._inner,C);let o,d;_?(o=e?c(this._innerPrev,M):a(this._innerPrev,M),d=e?a(this._innerNext,k):c(this._innerNext,k)):(o=n,d=n);const h=e?a(this._roundStart,M):c(this._roundStart,M),y=e?c(this._roundEnd,k):a(this._roundEnd,k),m=U(o.x,o.y,-M.x,-M.y,t.x,t.y),g=U(h.x,h.y,-M.x,-M.y,i.x,i.y);if(r)break;const x=this._writeVertex(S,T,P,z,-M.x,-M.y,0,0,0,0,V);_||this._writeTriangle(L,N,x);const v=u(this._outer,n),b=this._writeVertex(S,T,P,z,k.x,k.y,y.x,y.y,i.x,i.y,V);let I,A;const F=s>2;if(F){let t;s!==Number.MAX_VALUE?(v.x/=s,v.y/=s,t=p(M,v),t=(s*(t*t-1)+1)/t):t=-1,I=e?a(this._startBreak,M):c(this._startBreak,M),I.x+=M.x*t,I.y+=M.y*t,A=e?c(this._endBreak,k):a(this._endBreak,k),A.x+=k.x*t,A.y+=k.y*t}f(D,v,-M.x,-M.y);const E=this._writeVertex(S,T,P,z,-M.x,-M.y,v.x,v.y,D.x,D.y,V);f(D,v,k.x,k.y);const B=w?this._writeVertex(S,T,P,z,k.x,k.y,v.x,v.y,D.x,D.y,V):E,G=x,j=w?this._writeVertex(S,T,P,z,k.x,k.y,0,0,0,0,V):x;let W=-1,Y=-1;if(F&&(f(D,I,-M.x,-M.y),W=this._writeVertex(S,T,P,z,-M.x,-M.y,I.x,I.y,D.x,D.y,V),f(D,A,k.x,k.y),Y=this._writeVertex(S,T,P,z,k.x,k.y,A.x,A.y,D.x,D.y,V)),w?F?(this._writeTriangle(G,g,W),this._writeTriangle(G,W,E),this._writeTriangle(j,B,Y),this._writeTriangle(j,Y,b)):(this._writeTriangle(G,g,E),this._writeTriangle(j,B,b)):F?(this._writeTriangle(x,g,W),this._writeTriangle(x,W,Y),this._writeTriangle(x,Y,b)):(this._writeTriangle(x,g,E),this._writeTriangle(x,B,b)),_?(L=this._writeVertex(S,T,P,z,k.x,k.y,d.x,d.y,t.x,t.y,V),N=b):(L=w?this._writeVertex(S,T,P,z,k.x,k.y,d.x,d.y,t.x,t.y,V):m,this._writeTriangle(L,j,b),N=b),e){const e=L;L=N,N=e}break}}}}}},46979:(e,t,r)=>{r.r(t),r.d(t,{default:()=>Ed});var i=r(50076),s=r(54901),n=r(81806),o=r(77944),a=r(50346),c=r(47249),l=r(68134),u=r(76931),d=r(88943),h=r(88235),p=r(40181),f=r(93453),_=(r(15389),r(96345),r(5095));class y{constructor(e){this._client=e,this.layerView=this._client.createInvokeProxy(""),this.container=this._client.createInvokeProxy("container"),this._eventLog=this._client.createInvokeProxy("eventLog")}onEvent(e){(0,d.oV)(this._eventLog.onEvent(e))}}var m=r(8),g=r(19495),x=r(30726),v=r(48611),b=r(15011),w=r(13312);class I{constructor(e,t,r,i,s,n,o){this.instanceId=e,this.textureKey=t,this.indexStart=r,this.indexCount=i,this.vertexStart=s,this.vertexCount=n,this.overlaps=o}updateBaseOffsets(e){this.vertexStart+=e.vertexFrom,this.indexStart+=e.indexFrom}clone(){return new I(this.instanceId,this.textureKey,this.indexStart,this.indexCount,this.vertexStart,this.vertexCount,this.overlaps)}static write(e,t,r,i,s,n,o,a){e.push(t),e.push(r),e.push(i),e.push(s),e.push(n),e.push(o),e.push(a)}serialize(e){return e.push(this.instanceId),e.push(this.textureKey),e.push(this.indexStart),e.push(this.indexCount),e.push(this.vertexStart),e.push(this.vertexCount),e.push(this.overlaps),e}static deserialize(e){const t=e.readInt32(),r=e.readInt32(),i=e.readInt32(),s=e.readInt32(),n=e.readInt32(),o=e.readInt32(),a=e.readInt32();return new I(t,r,i,s,n,o,a)}}function S(e,t){if(null!==t){e.push(t.length);for(const r of t)r.serialize(e);return e}e.push(0)}function T(e,t,r){const i=e.readInt32(),s=new Array(i);for(let n=0;n<s.length;n++)s[n]=t.deserialize(e,r);return s}I.byteSizeHint=7*Uint32Array.BYTES_PER_ELEMENT;class A{constructor(e,t){this.id=e,this.sortKey=t,this.records=[]}serialize(e){return e.push(this.id),e.writeF32(this.sortKey),S(e,this.records),e}static deserialize(e){var t;const r=e.readInt32(),i=e.readF32(),s=new A(r,i);return s.records=null!==(t=T(e,I))&&void 0!==t?t:[],s}}A.byteSizeHint=2*Uint32Array.BYTES_PER_ELEMENT+I.byteSizeHint;class M{get length(){return this._pos}constructor(e,t){this._pos=0;const r=t?this._roundToNearest(t,e.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(r),this._buffer=new e(this._array),this._ctor=e,this._i16View=new Int16Array(this._array)}_roundToNearest(e,t){const r=Math.round(e);return 1===t?r:r+(t-r%t)}_ensureSize(e){if(this._pos+e>=this._buffer.length){const t=this._roundToNearest(1.25*(this._array.byteLength+e*this._buffer.BYTES_PER_ELEMENT),this._buffer.BYTES_PER_ELEMENT),r=new ArrayBuffer(t),i=new this._ctor(r);i.set(this._buffer,0),this._array=r,this._buffer=i,this._i16View=new Int16Array(this._array)}}ensureSize(e){this._ensureSize(e)}writeF32(e){this._ensureSize(1);const t=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=e,this._pos++,t}push(e){this._ensureSize(1);const t=this._pos;return this._buffer[this._pos++]=e,t}writeFixed(e){this._buffer[this._pos++]=e}setValue(e,t){this._buffer[e]=t}i1616Add(e,t,r){this._i16View[2*e]+=t,this._i16View[2*e+1]+=r}getValue(e){return this._buffer[e]}getValueF32(e){return new Float32Array(this._array,4*e,1)[0]}incr(e){if(this._buffer.length<e)throw new Error("Increment index overflows the target buffer");this._buffer[e]++}decr(e){this._buffer[e]--}writeRegion(e){this._ensureSize(e.length);const t=this._pos;return this._buffer.set(e,this._pos),this._pos+=e.length,t}writeManyFrom(e,t,r){this._ensureSize(r-t);for(let i=t;i!==r;i++)this.writeFixed(e._buffer[i])}buffer(){const e=this._array.slice(0,4*this._pos);return this.destroy(),e}toArray(){return[...this._buffer]}seek(e){this._pos=e}destroy(){this._array=null,this._buffer=null}}class k{constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i=6*r*Uint32Array.BYTES_PER_ELEMENT,s=4*r*t.stride,n=t.stride/4,o=t.attributes.find((e=>"pos"===e.name||"position"===e.name));if(!o)throw new Error("InternalError: Unable to find position attribute");this.layout=(0,m.A)((0,m.A)({},t),{},{position:o}),this._indices=new M(Uint32Array,i),this._vertices=new M(Uint32Array,s),this._metrics=new M(Uint32Array,0),this._metricCountOffset=this._metrics.push(0),this._strideInt=n,this._instanceId=e}serialize(e){const t=this._indices.buffer(),r=this._vertices.buffer(),i=this._metrics.length?this._metrics.buffer():null;return e.push(t,r),{instanceId:this._instanceId,layout:this.layout,indices:t,vertices:r,metrics:i}}get strideInt(){return this._strideInt}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(e){this._vertices.ensureSize(e)}indexEnsureSize(e){this._indices.ensureSize(e)}writeIndex(e){this._indices.push(e)}writeVertex(e){this._vertices.push(e)}writeVertexRegion(e){this._vertices.writeRegion(e)}writeVertexF32(e){this._vertices.writeF32(e)}writeMetric(e){this._metrics.incr(this._metricCountOffset),e.serialize(this._metrics)}}class F{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._id=e,this._sizeHint=t,this._entityRecordCountOffset=0,this._entityCountOffset=0,this._entityIdIndex=0,this._entitySortKeyIndex=0,this._didEntityStart=!1,this._instanceIdToVertexData=new Map,this._recordIndexStart=0,this._recordIndexCount=0,this._recordVertexStart=0,this._recordVertexCount=0,this._current={metric:null,writer:null,start:0,sortKey:0,instanceId:0,layoutHash:0,indexStart:0,vertexStart:0,textureKey:0,metricBoxLenPointer:0},this._entities=new M(Uint32Array,this._sizeHint*A.byteSizeHint),this._entityCountOffset=this._entities.push(0)}get id(){return this._id}serialize(){const e=new Array,t=[],r=this._entities.buffer();for(const i of this._instanceIdToVertexData.values())t.push(i.serialize(e));return{message:{data:t,entities:r},transferList:e}}vertexCount(){var e,t;return null!==(e=null===(t=this._current.writer)||void 0===t?void 0:t.vertexCount)&&void 0!==e?e:0}indexCount(){var e,t;return null!==(e=null===(t=this._current.writer)||void 0===t?void 0:t.indexCount)&&void 0!==e?e:0}vertexEnsureSize(e){this._current.writer.vertexEnsureSize(e)}indexEnsureSize(e){this._current.writer.indexEnsureSize(e)}vertexWrite(e){this._current.writer.writeVertex(e)}vertexWriteRegion(e){this._current.writer.writeVertexRegion(e)}vertexWriteF32(e){this._current.writer.writeVertexF32(e)}recordBounds(e,t,r,i){}indexWrite(e){this._current.writer.writeIndex(e)}metricStart(e){this._current.metric=e}metricEnd(){const e=this._current.writer;this._current.metric.bounds.length&&e.writeMetric(this._current.metric)}metricBoxWrite(e){this._current.metric.bounds.push(e)}entityStart(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;this._entityIdIndex=this._entities.push(e),this._entitySortKeyIndex=this._entities.writeF32(t),this._entityRecordCountOffset=this._entities.push(0),this._didEntityStart=!0}entityRecordCount(){return this._entities.getValue(this._entityRecordCountOffset)}entityEnd(){this._didEntityStart&&(0===this.entityRecordCount()?this._entities.seek(this._entityIdIndex):this._entities.incr(this._entityCountOffset),this._didEntityStart=!1)}recordCount(){return this._entities.getValue(this._entityRecordCountOffset)}recordStart(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._current.writer=this._getVertexWriter(e,t),this._current.indexStart=this._current.writer.indexCount,this._current.vertexStart=this._current.writer.vertexCount,this._current.instanceId=e,this._current.layoutHash=t.hash,this._current.textureKey=r}recordEnd(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;const t=this._current.vertexStart,r=this._current.writer.vertexCount-t;if(!r)return!1;const i=this._current.indexStart,s=this._current.writer.indexCount-i;return this._recordIndexStart=i,this._recordIndexCount=s,this._recordVertexStart=t,this._recordVertexCount=r,this._entities.incr(this._entityRecordCountOffset),I.write(this._entities,this._current.instanceId,this._current.textureKey,i,s,t,r,e),!0}copyLast(e,t){var r;const i=this._recordVertexStart+this._recordVertexCount;this._entities.incr(this._entityRecordCountOffset),I.write(this._entities,this._current.instanceId,this._current.textureKey,this._recordIndexStart+this._recordIndexCount,this._recordIndexCount,i,this._recordVertexCount,0);const s=this._current.writer.indexWriter,n=this._current.writer.vertexWriter,o=this._recordIndexStart+this._recordIndexCount,a=this._recordVertexCount;for(let y=this._recordIndexStart;y!==o;y++){const e=s.getValue(y);s.push(e+a)}const c=this._current.writer.layout.stride/Uint32Array.BYTES_PER_ELEMENT,l=this._recordVertexStart*c,u=(this._recordVertexStart+this._recordVertexCount)*c;for(let y=l;y!==u;y++){const e=n.getValue(y);n.push(e)}const d=this._current.writer.layout.position,h=null!==(r=d.packPrecisionFactor)&&void 0!==r?r:1,p=d.offset/Uint32Array.BYTES_PER_ELEMENT,f=e*h,_=t*h;for(let y=i*c;y<=n.length;y+=c)n.i1616Add(y+p,f,_)}copyLastFrom(e,t,r){var i;const s=e._entities.getValue(e._entityIdIndex);if(s!==this._entities.getValue(this._entityIdIndex)){const t=e._entities.getValueF32(e._entitySortKeyIndex);this.entityStart(s,t)}this.recordStart(e._current.instanceId,e._current.writer.layout,e._current.textureKey);const n=this._current.writer.layout.stride/Uint32Array.BYTES_PER_ELEMENT,o=this._current.vertexStart,a=e._current.vertexStart-o,c=this._current.writer.indexWriter,l=this._current.writer.vertexWriter,u=e._current.writer.indexWriter,d=e._current.writer.vertexWriter;for(let m=e._current.indexStart;m!==u.length;m++){const e=u.getValue(m);c.push(e-a)}for(let m=e._current.vertexStart*n;m!==d.length;m++){const e=d.getValue(m);l.push(e)}const h=this._current.writer.layout.position,p=null!==(i=h.packPrecisionFactor)&&void 0!==i?i:1,f=h.offset/Uint32Array.BYTES_PER_ELEMENT,_=t*p,y=r*p;for(let m=o*n;m<=l.length;m+=n)l.i1616Add(m+f,_,y);this.recordEnd()}_getVertexWriter(e,t){const r=this._instanceIdToVertexData;return r.has(e)||r.set(e,new k(e,t,this._sizeHint)),r.get(e)}}const E=128;function C(e){switch(e){case 1:case 8:case 32:return-1;case 2:case 64:return 0;case 4:case 16:case E:return 1}}function P(e){switch(e){case 1:case 2:case 4:return-1;case 8:case 16:return 0;case 32:case 64:case E:return 1}}class z{constructor(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this.tileKey=e,this._bufferingEnabled=t,this._sizeHint=s,this._meshes={self:new F(this.id,this._sizeHint),neighbors:new Array},this._currentRecordOverlaps=0,this._currentEntityOverlaps=0;const n=i?1:0;this._copyBufferedDataIntoSelf=r&&this._bufferingEnabled&&e.level===n}get id(){return this.tileKey.id}vertexCount(){return this._meshes.self.vertexCount()}indexCount(){return this._meshes.self.indexCount()}indexEnsureSize(e){this._meshes.self.indexEnsureSize(e)}entityStart(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;this._currentEntityOverlaps=0,this._meshes.self.entityStart(e,t)}entityRecordCount(){return this._meshes.self.entityRecordCount()}entityEnd(){if(this._meshes.self.entityEnd(),this._bufferingEnabled){if(this._copyBufferedDataIntoSelf)return;for(let e=0;e<8;e++){const t=1<<e;this._currentEntityOverlaps&t&&this._meshes.neighbors[e].entityEnd()}}}recordStart(e,t,r){this._currentRecordOverlaps=0,this._meshes.self.recordStart(e,t,r)}recordEnd(){const e=this._meshes.self.recordEnd(this._currentRecordOverlaps);return e&&0!==this._currentRecordOverlaps?(this._copyIntoNeighbors(),this._currentEntityOverlaps|=this._currentRecordOverlaps,!0):e}recordBounds(e,t,r,i){this._bufferingEnabled&&this._addOverlap(e,t,r,i)}recordCount(){return this._meshes.self.recordCount()}metricStart(e){this._meshes.self.metricStart(e)}metricBoxWrite(e){this._meshes.self.metricBoxWrite(e)}metricEnd(){this._meshes.self.metricEnd()}vertexWrite(e){this._meshes.self.vertexWrite(e)}vertexWriteF32(e){this._meshes.self.vertexWriteF32(e)}vertexWriteRegion(e){this._meshes.self.vertexWriteRegion(e)}indexWrite(e){this._meshes.self.indexWrite(e)}serialize(e){const t={message:[],transferList:[]},r=this._meshes.self.serialize();return t.message.push((0,m.A)({tileId:this.tileKey.id},r.message)),t.transferList.push(...r.transferList),this._meshes.neighbors.forEach(((r,i)=>{const s=r.serialize(),n=1<<i,o=C(n),a=P(n),c=new f.A(this.tileKey).getNormalizedNeighbor(o,a,e);t.message.push((0,m.A)({tileId:c.id},s.message)),t.transferList.push(...s.transferList)})),t}_addOverlap(e,t,r,i){const s=Math.min(_.CQ/2,r),n=Math.min(_.CQ/2,i),o=255^((e<0+s?148:e>=_.CQ-s?41:189)|(t<0+n?224:t>=_.CQ-n?7:231));this._currentRecordOverlaps|=o}_copyIntoNeighbors(){for(let e=0;e<8;e++){const t=1<<e;if(this._currentRecordOverlaps&t){if(this._copyBufferedDataIntoSelf){const e=-C(t)*_.CQ,r=-P(t)*_.CQ;if(0!==r)continue;this._meshes.self.copyLast(e,r);continue}if(!this._meshes.neighbors[e]){const r=Math.floor(this._sizeHint/16);this._meshes.neighbors[e]=new F(t,r)}const r=this._meshes.neighbors[e],i=-C(t)*_.CQ,s=-P(t)*_.CQ;r.copyLastFrom(this._meshes.self,i,s)}}}}class O{}class R{constructor(){this._defaultResult=null,this._backgroundFillResult=null}static async from(e,t){const r=new R;return r.setDefault(await e.createMeshWriters(t.meshes)),r}size(){return 1}getDefault(){return this._defaultResult}setDefault(e){this._defaultResult=e}getBackgroundFill(){return this._backgroundFillResult}setBackgroundFill(e){this._backgroundFillResult=e}match(e,t){const r=this.doMatch(e,t)||this.getDefault();if(r&&r.length>0){const e=this.getBackgroundFill();if(e)return[...e,...r]}return r}getSortKey(e,t){return 0}doMatch(e,t){return null}async fetchResources(e,t){}}class D extends R{static async fromDictionaryRenderer(e,t){return new D(e,t)}constructor(e,t){super(),this._context=e,this._schema=t,this._hashToGroup=new Map}get fieldMap(){return this._schema.fieldMap}async fetchResources(e,t){const r=t.getCursor(),i=[];for(;r.next();)i.push(this._updateMeshWriterGroup(e,r));await Promise.all(i)}match(e,t){const r=e.getAttributeHash();return this._hashToGroup.get(r)}async _updateMeshWriterGroup(e,t){const r=t.readLegacyFeatureForDisplay(),i=t.getAttributeHash();if(this._hashToGroup.has(i))return;this._hashToGroup.set(i,null);const s=await e.fetchDictionaryResourceImmediate({type:"dictionary-request",feature:r});if(!s)return;const n=await this._context.createMeshWriters(s.meshes);this._hashToGroup.set(i,n)}}class L extends R{constructor(e,t){super(),this._intervals=[],this._isMaxInclusive=t,this._field=e}static async fromIntervalSchema(e,t){const r=await e.storage.createComputedField(t),i=new L(r,t.isMaxInclusive);await Promise.all(t.intervals.map((async t=>{const r=await e.createMeshWriters(t.meshes);i.add(t,r)})));const s=await e.createMeshWriters(t.defaultSymbol);i.setDefault(s);const n=await e.createMeshWriters(t.backgroundFill);return i.setBackgroundFill(n),i}add(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort(((e,t)=>e.interval.min-t.interval.min))}size(){return super.size()+this._intervals.length}doMatch(e,t){var r;const i=null===(r=this._field)||void 0===r?void 0:r.read(e,t);if(null==i||isNaN(i)||i===1/0||i===-1/0)return null;for(let s=0;s<this._intervals.length;s++){const{interval:e,result:t}=this._intervals[s],r=i>=e.min,n=this._isMaxInclusive?i<=e.max:i<e.max;if(r&&n)return t}return null}}class N extends R{static async fromLabelSchema(e,t){const r=t.classes.map((async t=>{const r=await e.createMeshWriters(t.meshes);return{minScale:t.minScale,maxScale:t.maxScale,meshes:r,expression:null,where:await e.storage.createWhereClause(t.where)}})),i=await Promise.all(r);return new N(i)}constructor(e){super(),this._labels=e}match(e,t){if(!this._labels.length)return null;const r=this._getLabels(t.$view.scale),i=[];for(const s of r)s.where&&!s.where(e)||i.push(...s.meshes);return i}_getLabels(e){return this._labels.filter((t=>this._validForTileScale(t,e)))}_validForTileScale(e,t){const r=t-t/4,i=t+t/2;return(!e.minScale||e.minScale>=r)&&(!e.maxScale||e.maxScale<=i)}}class B extends R{constructor(e,t){super(),this._defaultSymbolSortKey=0,this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fields=e,this._separator=t||""}static async fromMatcherSchema(e,t){const r=t.expression?[e.storage.createComputedField({expression:t.expression})]:[t.field?e.storage.createComputedField({field:t.field}):null,t.field2?e.storage.createComputedField({field:t.field2}):null,t.field3?e.storage.createComputedField({field:t.field3}):null],i=(await Promise.all(r)).filter((e=>!!e)),s=new B(i,t.fieldDelimiter),n=await e.createMeshWriters(t.defaultSymbol);s.setDefault(n);const o=await e.createMeshWriters(t.backgroundFill);return s.setBackgroundFill(o),await Promise.all(t.map.map((async(t,r)=>{const i=await e.createMeshWriters(t.symbol);"<Null>"===t.value?s.setNullResult(i):s.add(t.value,i,r+1)}))),s}setNullResult(e){this._nullResult=e}getSortKey(e,t){const r=this._getValueFromFields(e,t);if(null==r||""===r||"<Null>"===r)return 0;const i=this._resultsMap.get(r.toString());return i?i.sortKey:this._defaultSymbolSortKey}add(e,t,r){this._resultsMap.set(e.toString(),{meshWriters:t,sortKey:r}),this._defaultSymbolSortKey=Math.max(this._defaultSymbolSortKey,r+1)}size(){return super.size()+this._resultsMap.size}doMatch(e,t){var r;const i=this._getValueFromFields(e,t);if(null!==this._nullResult&&(null==i||""===i||"<Null>"===i))return this._nullResult;if(null==i)return null;const s=i.toString();return null===(r=this._resultsMap.get(s))||void 0===r?void 0:r.meshWriters}_getValueFromFields(e,t){const r=[];for(const i of this._fields){const s=i.read(e,t);null==s||""===s?r.push("<Null>"):r.push(s)}return r.join(this._separator)}}async function V(e,t){switch(t.type){case"simple":case"heatmap":case"dot-density":case"pie-chart":return R.from(e,t);case"interval":return L.fromIntervalSchema(e,t);case"dictionary":return D.fromDictionaryRenderer(e,t);case"label":return N.fromLabelSchema(e,t);case"map":return B.fromMatcherSchema(e,t);case"subtype":return q.fromSubtypes(e,t);case"cluster":return G.fromClusterSchema(e,t);default:throw new Error("Impl")}}class q extends R{constructor(e,t){super(),this._subMatchers=e,this._subtypeField=t}static async fromSubtypes(e,t){const r=new Map,i=[];for(const s in t.renderers){const n=parseInt(s,10),o=V(e,t.renderers[s]).then((e=>r.set(n,e)));i.push(o)}return await Promise.all(i),new q(r,t.subtypeField)}match(e,t){const r=e.readAttribute(this._subtypeField),i=this._subMatchers.get(r);return i?i.match(e,t):null}}class G extends R{static async fromClusterSchema(e,t){const[r,i]=await Promise.all([V(e,t.feature),V(e,t.cluster)]);return new G(r,i)}constructor(e,t){super(),this._featureMatcher=e,this._clusterMatcher=t}match(e,t){return 1===e.readAttribute("cluster_count")?this._featureMatcher.match(e,t):this._clusterMatcher.match(e,t)}}class U extends O{static async create(e,t){const r=await V(e,t.symbology),i=t.labels?await V(e,t.labels):null;return new U(r,i)}constructor(e,t){super(),this._symbology=e,this._labels=t}destroy(){}async enqueueMatcherRequests(e,t){var r;await Promise.all([this._symbology.fetchResources(e,t),null===(r=this._labels)||void 0===r?void 0:r.fetchResources(e,t)])}enqueueWriterRequests(e,t,r){const i=this._symbology.match(t,r);if(i){for(const s of i)s.enqueueRequest(e,t,r);if(this._labels){const i=this._labels.match(t,r);if(!i)return;for(const s of i)s.enqueueRequest(e,t,r)}}}write(e,t,r,i,s){const n=this._symbology.match(r,i);if(n){for(const o of n)o.write(e,t,r,i,s);if(e.entityRecordCount()>=1&&this._labels){const o=this._labels.match(r,i);if(!o)return;for(const a of o)a.setReferences(n),a.write(e,t,r,i,s)}}}getSortKey(e,t){return this._symbology.getSortKey(e,t)}}var j=r(88685),W=r(76460),Y=r(28808),X=(r(61678),r(93345)),H=(r(12331),r(89179),r(32880),r(98433)),Z=r(96673);const Q=()=>W.A.getLogger("esri.views.2d.engine.webgl.Utils");new Map;function K(e,t,r){const i=new Z.R(t.width,t.height);return i.dataType=t.dataType,t.depth&&(i.depth=t.depth),t.flipped&&(i.flipped=t.flipped),t.hasMipmap&&(i.hasMipmap=t.hasMipmap),i.internalFormat=t.internalFormat,t.isImmutable&&(i.isImmutable=t.isImmutable),t.isOpaque&&(i.isOpaque=t.isOpaque),t.maxAnisotropy&&(i.maxAnisotropy=t.maxAnisotropy),i.pixelFormat=t.pixelFormat,t.preMultiplyAlpha&&(i.preMultiplyAlpha=t.preMultiplyAlpha),t.samplingMode&&(i.samplingMode=t.samplingMode),t.target&&(i.target=t.target),i.uniform=t.uniform,t.unpackAlignment&&(i.unpackAlignment=t.unpackAlignment),t.wrapMode&&(i.wrapMode=t.wrapMode),new H.g(e,i,r)}class J{}class $ extends J{constructor(e){super(),this._fetcher=e,this._controller=new AbortController,this._pendingIds=new Set,this._pendingRequests=[],this._resourceIdToResource=new Map}destroy(){this._controller.abort()}get _abortOptions(){return{signal:this._controller.signal}}enqueueRequest(e){const t=function(e){return"url"in e&&"urlHash"in e?(0,m.A)((0,m.A)({},e),{},{url:""}):e}(e.resource),r=(0,j.Wm)(JSON.stringify(t));return this._pendingIds.has(r)||(this._pendingIds.add(r),this._pendingRequests.push((0,m.A)((0,m.A)({},e),{},{resourceId:r}))),r}async fetchEnqueuedResources(){const e=this._pendingRequests;this._pendingIds.clear(),this._pendingRequests=[];const t=await this._fetcher.fetch(e,this._abortOptions);for(let r=0;r<t.length;r++){const i=e[r].resourceId;this._resourceIdToResource.set(i,t[r])}}async fetchResourceImmediate(e){const t=await this._fetcher.fetch([e],this._abortOptions);if(1!==t.length)throw new Error("FeaturePipelineResourceProxy: failed to fetch resources");return t[0]}async fetchDictionaryResourceImmediate(e){const t=await this._fetcher.fetchDictionary([e],this._abortOptions);if(1!==t.length)throw new Error("FeaturePipelineResourceProxy: failed to fetch dictionary resources");return t[0]}getResource(e){return this._resourceIdToResource.get(e)}}var ee;!function(e){e[e.AnimatedMarker=0]="AnimatedMarker",e[e.Blend=1]="Blend",e[e.ComplexFill=2]="ComplexFill",e[e.ComplexOutlineFill=3]="ComplexOutlineFill",e[e.DotDensity=4]="DotDensity",e[e.Fill=5]="Fill",e[e.Grid=6]="Grid",e[e.Heatmap=7]="Heatmap",e[e.Label=8]="Label",e[e.Line=9]="Line",e[e.Magnifier=10]="Magnifier",e[e.Marker=11]="Marker",e[e.OutlineFill=12]="OutlineFill",e[e.Overlay=13]="Overlay",e[e.PatternFill=14]="PatternFill",e[e.PatternOutlineFill=15]="PatternOutlineFill",e[e.PieChart=16]="PieChart",e[e.Test=17]="Test",e[e.Text=18]="Text",e[e.TexturedLine=19]="TexturedLine"}(ee||(ee={}));var te=r(69539);function re(e,t){return[!(null===e||void 0===e||!e.minScale)&&t.scaleToZoom(e.minScale)||0,!(null===e||void 0===e||!e.maxScale)&&t.scaleToZoom(e.maxScale)||100]}function ie(e){return 1<<e}function se(e){let t=0;for(const[r,i]of e)i&&(t|=1<<r);return t}function ne(e){let t;if(!e)return[0,0,0,0];if("string"==typeof e){const r=te.A.fromString(e);if(!r)return W.A.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.meshWriterUtils").errorOnce(new i.A("mapview:mesh-processing","Unable to parse string into color",{color:e})),[0,0,0,0];t=r.toArray()}else t=e;const[r,s,n,o]=t;return[r*(o/255),s*(o/255),n*(o/255),o]}function oe(e,t){return Math.round(Math.min(Math.sqrt(e*t),255))}function ae(e,t){return Math.round(e*t)/t}const ce={isSDF:0,isMapAligned:1,scaleSymbolsProportionally:2,overrideOutlineColor:3,colorLocked:4,isStroke:5};var le=r(84735),ue=r(16108),de=r(71275),he=r(5271),pe=r(67855);class fe{static executeEffects(e,t,r,i){const s=(0,pe.ll)(e);let n=new de.k(t);for(const o of e){const e=(0,he.A)(o);e&&(n=e.execute(n,o,1.3333333333333333,r,i,s))}return n}static applyEffects(e,t,r){if(!e)return t;const i=(0,pe.ll)(e);let s,n=new de.k(le.z.fromJSONCIM(t));for(const c of e){const e=(0,he.A)(c);e&&(n=e.execute(n,c,1,null,r,i))}const o=[];let a=null;for(;s=n.next();)o.push(...(0,ue.x)(s)),a=s.geometryType;return 0===o.length||null===a?null:"esriGeometryPolygon"===a?{rings:o}:{paths:o}}}let _e=null;function ye(){return _e}const me=new Float32Array(1),ge=new Uint32Array(me.buffer);function xe(e){const t=function(e){return me[0]=e,ge[0]}(e),r=t>>>31;let i=t>>>23&255,s=8388607&t;return i-=127,i>15?r<<15|31744:i<-25?0:(i<-14&&(s+=8388608,s/=2**(-14-i),i=-15),i+=15,s/=8192,s=function(e,t){const r=Math.floor(e),i=e-r;return r<t&&(i>.5||.5===i&&r%2==1)?r+1:r}(s,1023),r<<15|i<<10|s)}function ve(e,t,r,i,s,n,o){if(e.primitiveName===t){let t=null===i||void 0===i?void 0:i.readWithDefault(s,n,e[r]&&o);return"text"===e.type&&(t=t.toString()),void(e[r]=t)}if("type"in e&&null!=e.type){if(e.effects)for(const a of e.effects)ve(a,t,r,i,s,n,o);switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(e.symbolLayers)for(const a of e.symbolLayers)ve(a,t,r,i,s,n,o);break;case"CIMTextSymbol":e.symbol&&ve(e.symbol,t,r,i,s,n,o);break;case"CIMHatchFill":e.lineSymbol&&ve(e.lineSymbol,t,r,i,s,n,o);break;case"CIMPictureMarker":case"CIMCharacterMarker":case"CIMVectorMarker":if(e.markerPlacement&&ve(e.markerPlacement,t,r,i,s,n,o),"CIMVectorMarker"===e.type&&e.markerGraphics)for(const a of e.markerGraphics)ve(a,t,r,i,s,n,o),ve(a.symbol,t,r,i,s,n,o)}}}function be(e){const t=e.width;return null!=e.effects?400:Math.max(1.25*t,8)}function we(e){switch(e){case X.pe.BYTE:case X.pe.UNSIGNED_BYTE:return 1;case X.pe.SHORT:case X.pe.UNSIGNED_SHORT:case X.pe.HALF_FLOAT:return 2;case X.pe.FLOAT:case X.pe.INT:case X.pe.UNSIGNED_INT:return 4}}class Ie{static fromVertexSpec(e,t){const{attributes:r,optionalAttributes:i}=e;let s,n,o;const a=[];for(const f in r){const e=r[f];"position"===e.pack?s=(0,m.A)((0,m.A)({},e),{},{name:f,offset:0}):"id"===e.pack?n=(0,m.A)((0,m.A)({},e),{},{name:f,offset:4}):"bitset"===f?o=(0,m.A)((0,m.A)({},e),{},{name:f,offset:7}):a.push((0,m.A)((0,m.A)({},e),{},{name:f}))}for(const f in i)if(!0===t[f]){const e=i[f];a.push((0,m.A)((0,m.A)({},e),{},{name:f}))}const c=function(e){const t=[],r=[],i=[];for(const s of e){const e=we(s.type)*s.count;switch(e%2||e%4||4){case 4:t.push(s);continue;case 2:r.push(s);continue;case 1:i.push(s);continue;default:throw new Error("Found unexpected dataType byte count")}}return t.push(...r),t.push(...i),t}(a),l=[];let u=8,d=1;for(const f of c)l.push((0,m.A)((0,m.A)({},f),{},{offset:u})),u+=we(f.type)*f.count,f.packAlternating&&(d=Math.max(f.packAlternating.count,d));const h=Uint32Array.BYTES_PER_ELEMENT,p=u%h;return new Ie(s,n,o,l,u+(p?h-p:0),d)}constructor(e,t,r,i,s,n){this.position=e,this.id=t,this.bitset=r,this.standardAttributes=i,this.stride=s,this.packVertexCount=n,i.push(r),this._attributes=[e,t,r,...i]}get attributeLayout(){if(!this._attributeLayout){const e=function(e){const t=e.map((e=>{let{name:t,count:r,type:i}=e;return"".concat(t,".").concat(r,".").concat(i)})).join(",");return(0,j.Wm)(t)}(this._attributes),t=this._attributes.map((e=>{var t;return{name:e.name,count:e.count,offset:e.offset,type:e.type,packPrecisionFactor:e.packPrecisionFactor,normalized:null!==(t=e.normalized)&&void 0!==t&&t}}));this._attributeLayout={attributes:t,hash:e,stride:this.stride}}return this._attributeLayout}}class Se{static fromVertexSpec(e,t){const r=Ie.fromVertexSpec(e,t);return new Se(r)}constructor(e){this._spec=e,this._packed=new Uint8Array(this._spec.stride*this._spec.packVertexCount),this._packedU32View=new Uint32Array(this._packed.buffer),this._dataView=new DataView(this._packed.buffer)}get attributeLayout(){return this._spec.attributeLayout}get stride(){return this._spec.stride}writeVertex(e,t,r,i,s,n){for(let a=0;a<this._spec.packVertexCount;a++){const e=a*this._spec.stride;this._packPosition(r,i,e),this._packId(t,e);const c=this._spec.bitset;if(n){if(c.packTessellation){const t=c.packTessellation(n,s);this._pack(t,c,e)}for(const t of this._spec.standardAttributes){var o;if(null!=t.packTessellation){const r=t.packTessellation(n,s);this._pack(r,t,e)}else if(null!==(o=t.packAlternating)&&void 0!==o&&o.packTessellation){const e=t.packAlternating.packTessellation(n,s);for(let r=0;r<this._spec.packVertexCount;r++){const i=e[r];this._pack(i,t,r*this._spec.stride)}}}}}e.vertexWriteRegion(this._packedU32View)}pack(e,t){for(const i of this._spec.standardAttributes){var r;if(i.pack&&"string"!=typeof i.pack){const r=i.pack(e,t);for(let e=0;e<this._spec.packVertexCount;e++)this._pack(r,i,e*this._spec.stride)}else if(null!==(r=i.packAlternating)&&void 0!==r&&r.pack){const r=i.packAlternating.pack(e,t);for(let e=0;e<this._spec.packVertexCount;e++){const t=r[e];this._pack(t,i,e*this._spec.stride)}}}}_packPosition(e,t,r){var i;const{offset:s}=this._spec.position,n=null!==(i=this._spec.position.packPrecisionFactor)&&void 0!==i?i:1,o=function(e,t){return 65535&e|t<<16}(e*n,t*n);this._dataView.setUint32(r+s,o,!0)}_packId(e,t){var r;const i=e*(null!==(r=this._spec.id.packPrecisionFactor)&&void 0!==r?r:1),s=4278190080&this._dataView.getUint32(t+this._spec.id.offset,!0);this._dataView.setUint32(t+this._spec.id.offset,i|s,!0)}_pack(e,t,r){!function(e,t,r,i){var s;const n=null!==(s=r.packPrecisionFactor)&&void 0!==s?s:1;switch(r.type){case X.pe.BYTE:if(1===r.count)e.setInt8(i+r.offset,t*n);else for(let s=0;s<r.count;s++){const o=s*Int8Array.BYTES_PER_ELEMENT;e.setInt8(i+r.offset+o,t[s]*n)}break;case X.pe.UNSIGNED_BYTE:if(1===r.count)e.setUint8(i+r.offset,t*n);else for(let s=0;s<r.count;s++){const o=s*Uint8Array.BYTES_PER_ELEMENT;e.setUint8(i+r.offset+o,t[s]*n)}break;case X.pe.SHORT:if(1===r.count)e.setInt16(i+r.offset,t*n,!0);else for(let s=0;s<r.count;s++){const o=s*Int16Array.BYTES_PER_ELEMENT;e.setInt16(i+r.offset+o,t[s]*n,!0)}break;case X.pe.UNSIGNED_SHORT:if(1===r.count)e.setUint16(i+r.offset,t*n,!0);else for(let s=0;s<r.count;s++){const o=s*Uint16Array.BYTES_PER_ELEMENT;e.setUint16(i+r.offset+o,t[s]*n,!0)}break;case X.pe.INT:if(1===r.count)e.setInt32(i+r.offset,t*n,!0);else for(let s=0;s<r.count;s++){const o=s*Int32Array.BYTES_PER_ELEMENT;e.setInt32(i+r.offset+o,t[s]*n,!0)}break;case X.pe.UNSIGNED_INT:if(1===r.count)e.setUint32(i+r.offset,t*n,!0);else for(let s=0;s<r.count;s++){const o=s*Uint32Array.BYTES_PER_ELEMENT;e.setUint32(i+r.offset+o,t[s]*n,!0)}break;case X.pe.FLOAT:if(1===r.count)e.setFloat32(i+r.offset,t*n,!0);else for(let s=0;s<r.count;s++){const o=s*Float32Array.BYTES_PER_ELEMENT;e.setFloat32(i+r.offset+o,t[s]*n,!0)}break;case X.pe.HALF_FLOAT:if(1===r.count)e.setUint16(i+r.offset,xe(t*n),!0);else for(let s=0;s<r.count;s++){const o=s*Uint16Array.BYTES_PER_ELEMENT;e.setUint16(i+r.offset+o,xe(t[s]*n),!0)}}}(this._dataView,e,t,r)}}class Te{constructor(e,t,r,i){this._instanceId=e,this._evaluator=t,this._enabledOptionalAttributes=r,this._viewParams=i,this._evaluator.evaluator=e=>this.vertexSpec.createComputedParams(e)}get _vertexPack(){if(!this._cachedVertexPack){const e=Se.fromVertexSpec(this.vertexSpec,this._enabledOptionalAttributes);this._evaluator.hasDynamicProperties||e.pack(this._evaluator.evaluatedMeshParams,this._viewParams),this._cachedVertexPack=e}return this._cachedVertexPack}get evaluatedMeshParams(){return this._evaluator.evaluatedMeshParams}get hasEffects(){return!!this.evaluatedMeshParams.effects}get instanceId(){return this._instanceId}get attributeLayout(){return this._vertexPack.attributeLayout}setReferences(e){this._references=e}getBoundsInfo(){return null}getTileInfo(){return this._viewParams.tileInfo}async loadDependencies(){var e;(function(e){if(!e)return!1;for(const t of e)switch(t.effect.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":case"CIMGeometricEffectDonut":return!0}return!1})(null===(e=this._evaluator.inputMeshParams.effects)||void 0===e?void 0:e.effectInfos)&&await async function(){_e=await Promise.all([r.e(2612),r.e(364)]).then(r.bind(r,1669))}()}enqueueRequest(e,t,r){this._evaluator.hasDynamicProperties&&this._evaluator.enqueueRequest(e,t,r)}write(e,t,r,i,s){var n;this.ensurePacked(t,r,i);const o=this.evaluatedMeshParams.effects;if(!o||0===o.length)return void this._write(e,r,void 0,s);const a=null===(n=r.readGeometryForDisplay())||void 0===n?void 0:n.clone();if(!a)return;const c=le.z.fromOptimizedCIM(a,r.geometryType),l=ye();c.invertY();const u=e.id||"",d=fe.executeEffects(o,c,u,l);let h;for(;h=d.next();)h.invertY(),this._write(e,r,h,s)}ensurePacked(e,t,r){if(!this._evaluator.hasDynamicProperties)return;const i=this._evaluator.evaluateMeshParams(e,t,r);this._vertexPack.pack(i,this._viewParams)}_writeVertex(e,t,r,i,s){const n=this.evaluatedMeshParams;this._vertexPack.writeVertex(e,t,r,i,n,s)}}class Ae extends Te{}function Me(e){const{sprite:t,isMapAligned:r,colorLocked:i,scaleSymbolsProportionally:s,isStroke:n}=e;let o=0;return r&&(o|=ie(ce.isMapAligned)),i&&(o|=ie(ce.colorLocked)),t.sdf&&(o|=ie(ce.isSDF)),s&&(o|=ie(ce.scaleSymbolsProportionally)),n&&(o|=ie(ce.isStroke)),o}var ke;!function(e){e[e.Geographic=0]="Geographic",e[e.Arithmatic=1]="Arithmatic"}(ke||(ke={}));const Fe=3.14159265359/128,Ee=1.1,Ce=1,Pe=1e-5,ze=.05,Oe=1e-30,Re=2;class De extends Ae{get vertexSpec(){return{createComputedParams:e=>{var t;let{pixelDimensions:r,texelDimensions:i,baseSize:s,referenceSize:n,strokeWidth:o,sizeRatio:a}=e;r||(r=e.sprite.sdf?[0,0]:[e.sprite.width,e.sprite.height]),i||(i=e.sprite.sdf?[0,0]:r),s=(0,u.Lz)(s),n=(0,u.Lz)(n),o=(0,u.Lz)(o);const c=(null!==(t=e.sprite.sdfDecodeCoeff)&&void 0!==t?t:1)*a;return(0,m.A)((0,m.A)({},e),{},{pixelDimensions:r,texelDimensions:i,baseSize:s,referenceSize:n,strokeWidth:o,sdfDecodeCoeff:c})},optionalAttributes:{zoomRange:{type:X.pe.SHORT,count:2,packPrecisionFactor:_.fq,pack:(e,t)=>{let{scaleInfo:r}=e,{tileInfo:i}=t;return re(r,i)}}},attributes:{id:{type:X.pe.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:X.pe.UNSIGNED_BYTE,count:1,pack:Me},pos:{type:X.pe.SHORT,count:2,pack:"position",packPrecisionFactor:1},offset:{type:X.pe.FLOAT,count:2,packAlternating:{count:4,pack:e=>{const t=e.texelDimensions;return[[-.5*t[0],-.5*t[1]],[.5*t[0],-.5*t[1]],[-.5*t[0],.5*t[1]],[.5*t[0],.5*t[1]]]}}},uv:{type:X.pe.SHORT,count:2,packPrecisionFactor:1,packAlternating:{count:4,packTessellation:e=>{let{texXmax:t,texXmin:r,texYmax:i,texYmin:s}=e;return[[r,s],[t,s],[r,i],[t,i]]}}},animationPointerAndBaseSizeAndReferenceSize:{type:X.pe.UNSIGNED_SHORT,count:4,packPrecisionFactor:1,pack:e=>{let{animations:t,baseSize:r,referenceSize:i}=e;return[t.dataColumn,t.dataRow,r,i]}},sizing:{type:X.pe.UNSIGNED_SHORT,count:4,packPrecisionFactor:8,pack:e=>{let{strokeWidth:t,pixelDimensions:r,baseSize:i,sprite:s,sizeRatio:n}=e;const o=Math.max(i*s.width/s.height,i),a=s.sdfDecodeCoeff*o*n;return[r[0],r[1],t,a]}},angle:{type:X.pe.BYTE,count:1,packTessellation:e=>{let{angle:t}=e;return t}}}}}_write(e,t){const r=this.evaluatedMeshParams.sprite,{textureBinding:i}=r;e.recordStart(this.instanceId,this.attributeLayout,i);const s=t.getDisplayId();if("esriGeometryPolygon"===t.geometryType){const r=t.readCentroidForDisplay();if(!r)return;const[i,n]=r.coords;this._writeQuad(e,s,i,n)}else if("esriGeometryPoint"===t.geometryType){const r=t.readXForDisplay(),i=t.readYForDisplay();this._writeQuad(e,s,r,i)}else{const r=t.readGeometryForDisplay();if(r){const{angleToLine:t}=this.evaluatedMeshParams;if(t){let t=!0,i=null,n=null;r.forEachVertex(((r,o)=>{if(null!=i&&null!=n){const a=Math.atan2(o-n,r-i)/Fe;t&&(this._writeQuad(e,s,i,n,a),t=!1),this._writeQuad(e,s,r,o,a)}i=r,n=o}))}else r.forEachVertex(((t,r)=>{this._writeQuad(e,s,t,r)}))}}e.recordEnd()}_writeQuad(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const n=this.evaluatedMeshParams.sprite,{rect:o}=n,a=o.x+2,c=o.y+2,l=o.x+o.width-2,u=o.y+o.height-2,d=e.vertexCount();e.recordBounds(r,i,64,64);const h={texXmin:a,texYmin:c,texXmax:l,texYmax:u,angle:s};for(let p=0;p<4;p++)this._writeVertex(e,t,r,i,h);e.indexEnsureSize(6),e.indexWrite(d),e.indexWrite(d+1),e.indexWrite(d+2),e.indexWrite(d+1),e.indexWrite(d+3),e.indexWrite(d+2)}}var Le=r(51703),Ne=(r(38983),r(62032)),Be=r(1484);function Ve(e,t,r,i,s,n,o){ut=0;const a=(i-r)*n,c=s&&s.length,l=c?(s[0]-r)*n:a;let u,d,h,p,f,_=qe(t,r,i,0,l,n,!0);if(_&&_.next!==_.prev){if(c&&(_=function(e,t,r,i,s,n){const o=new Array;for(let a=0,c=i.length;a<c;a++){const s=qe(e,t,r,i[a]*n,a<c-1?i[a+1]*n:r*n,n,!1);s===s.next&&(s.steiner=!0),o.push(He(s))}o.sort(it);for(const a of o)s=Ze(a,s);return s}(t,r,i,s,_,n)),a>80*n){u=h=t[0+r*n],d=p=t[1+r*n];for(let e=n;e<l;e+=n){const i=t[e+r*n],s=t[e+1+r*n];u=Math.min(u,i),d=Math.min(d,s),h=Math.max(h,i),p=Math.max(p,s)}f=Math.max(h-u,p-d),f=0!==f?1/f:0}Ue(_,e,n,u,d,f,o,0)}}function qe(e,t,r,i,s,n,o){let a;if(o===function(e,t,r,i,s,n){let o=0;for(let a=i,c=s-n;a<s;a+=n)o+=(e[c+t*n]-e[a+t*n])*(e[a+1+t*n]+e[c+1+t*n]),c=a;return o}(e,t,0,i,s,n)>0)for(let c=i;c<s;c+=n)a=Ye(c+t*n,e[c+t*n],e[c+1+t*n],a);else for(let c=s-n;c>=i;c-=n)a=Ye(c+t*n,e[c+t*n],e[c+1+t*n],a);return a&&rt(a,a.next)&&(Xe(a),a=a.next),a}function Ge(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;if(!e)return e;let r,i=e;do{if(r=!1,i.steiner||!rt(i,i.next)&&0!==Ke(i.prev,i,i.next))i=i.next;else{if(Xe(i),i=t=i.prev,i===i.next)break;r=!0}}while(r||i!==t);return t}function Ue(e,t,r,i,s,n,o,a){if(!e)return;!a&&n&&(e=Qe(e,i,s,n));let c=e;for(;e.prev!==e.next;){const l=e.prev,u=e.next;if(n?We(e,i,s,n):je(e))t.push(l.index/r+o),t.push(e.index/r+o),t.push(u.index/r+o),Xe(e),e=u.next,c=u.next;else if((e=u)===c){a?1===a?Ue(e=st(e,t,r,o),t,r,i,s,n,o,2):2===a&&nt(e,t,r,i,s,n,o):Ue(Ge(e),t,r,i,s,n,o,1);break}}}function je(e){const t=e.prev,r=e,i=e.next;if(Ke(t,r,i)>=0)return!1;let s=e.next.next;const n=s;let o=0;for(;s!==e.prev&&(0===o||s!==n);){if(o++,$e(t.x,t.y,r.x,r.y,i.x,i.y,s.x,s.y)&&Ke(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function We(e,t,r,i){const s=e.prev,n=e,o=e.next;if(Ke(s,n,o)>=0)return!1;const a=s.x<n.x?s.x<o.x?s.x:o.x:n.x<o.x?n.x:o.x,c=s.y<n.y?s.y<o.y?s.y:o.y:n.y<o.y?n.y:o.y,l=s.x>n.x?s.x>o.x?s.x:o.x:n.x>o.x?n.x:o.x,u=s.y>n.y?s.y>o.y?s.y:o.y:n.y>o.y?n.y:o.y,d=tt(a,c,t,r,i),h=tt(l,u,t,r,i);let p=e.prevZ,f=e.nextZ;for(;p&&p.z>=d&&f&&f.z<=h;){if(p!==e.prev&&p!==e.next&&$e(s.x,s.y,n.x,n.y,o.x,o.y,p.x,p.y)&&Ke(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,f!==e.prev&&f!==e.next&&$e(s.x,s.y,n.x,n.y,o.x,o.y,f.x,f.y)&&Ke(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;p&&p.z>=d;){if(p!==e.prev&&p!==e.next&&$e(s.x,s.y,n.x,n.y,o.x,o.y,p.x,p.y)&&Ke(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;f&&f.z<=h;){if(f!==e.prev&&f!==e.next&&$e(s.x,s.y,n.x,n.y,o.x,o.y,f.x,f.y)&&Ke(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function Ye(e,t,r,i){const s=ct.create(e,t,r);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function Xe(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function He(e){let t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function Ze(e,t){const r=function(e,t){let r=t;const i=e.x,s=e.y;let n,o=-1/0;do{if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){const e=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(e<=i&&e>o){if(o=e,e===i){if(s===r.y)return r;if(s===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!n)return null;if(i===o)return n.prev;const a=n,c=n.x,l=n.y;let u,d=1/0;for(r=n.next;r!==a;)i>=r.x&&r.x>=c&&i!==r.x&&$e(s<l?i:o,s,c,l,s<l?o:i,s,r.x,r.y)&&(u=Math.abs(s-r.y)/(i-r.x),(u<d||u===d&&r.x>n.x)&&et(r,e)&&(n=r,d=u)),r=r.next;return n}(e,t);if(!r)return t;const i=at(r,e);return Ge(i,i.next),Ge(r,r.next)}function Qe(e,t,r,i){let s;for(;s!==e;s=s.next){if(s=s||e,null===s.z&&(s.z=tt(s.x,s.y,t,r,i)),s.prev.next!==s||s.next.prev!==s)return s.prev.next=s,s.next.prev=s,Qe(e,t,r,i);s.prevZ=s.prev,s.nextZ=s.next}return e.prevZ.nextZ=null,e.prevZ=null,function(e){let t,r=1;for(;;){let i,s=e;e=null,t=null;let n=0;for(;s;){n++,i=s;let o=0;for(;o<r&&i;o++)i=i.nextZ;let a=r;for(;o>0||a>0&&i;){let r;0===o?(r=i,i=i.nextZ,a--):0!==a&&i?s.z<=i.z?(r=s,s=s.nextZ,o--):(r=i,i=i.nextZ,a--):(r=s,s=s.nextZ,o--),t?t.nextZ=r:e=r,r.prevZ=t,t=r}s=i}if(t.nextZ=null,r*=2,n<2)return e}}(e)}function Ke(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function Je(e,t,r,i){return!!(rt(e,t)&&rt(r,i)||rt(e,i)&&rt(r,t))||Ke(e,t,r)>0!=Ke(e,t,i)>0&&Ke(r,i,e)>0!=Ke(r,i,t)>0}function $e(e,t,r,i,s,n,o,a){return(s-o)*(t-a)-(e-o)*(n-a)>=0&&(e-o)*(i-a)-(r-o)*(t-a)>=0&&(r-o)*(n-a)-(s-o)*(i-a)>=0}function et(e,t){return Ke(e.prev,e,e.next)<0?Ke(e,t,e.next)>=0&&Ke(e,e.prev,t)>=0:Ke(e,t,e.prev)<0||Ke(e,e.next,t)<0}function tt(e,t,r,i,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*s)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function rt(e,t){return e.x===t.x&&e.y===t.y}function it(e,t){return e.x-t.x}function st(e,t,r,i){let s=e;do{const n=s.prev,o=s.next.next;!rt(n,o)&&Je(n,s,s.next,o)&&et(n,o)&&et(o,n)&&(t.push(n.index/r+i),t.push(s.index/r+i),t.push(o.index/r+i),Xe(s),Xe(s.next),s=e=o),s=s.next}while(s!==e);return s}function nt(e,t,r,i,s,n,o){let a=e;do{let e=a.next.next;for(;e!==a.prev;){if(a.index!==e.index&&ot(a,e)){let c=at(a,e);return a=Ge(a,a.next),c=Ge(c,c.next),Ue(a,t,r,i,s,n,o,0),void Ue(c,t,r,i,s,n,o,0)}e=e.next}a=a.next}while(a!==e)}function ot(e,t){return e.next.index!==t.index&&e.prev.index!==t.index&&!function(e,t){let r=e;do{if(r.index!==e.index&&r.next.index!==e.index&&r.index!==t.index&&r.next.index!==t.index&&Je(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&et(e,t)&&et(t,e)&&function(e,t){let r=e,i=!1;const s=(e.x+t.x)/2,n=(e.y+t.y)/2;do{r.y>n!=r.next.y>n&&r.next.y!==r.y&&s<(r.next.x-r.x)*(n-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==e);return i}(e,t)}function at(e,t){const r=ct.create(e.index,e.x,e.y),i=ct.create(t.index,t.x,t.y),s=e.next,n=t.prev;return e.next=t,t.prev=e,r.next=s,s.prev=r,i.next=r,r.prev=i,n.next=i,i.prev=n,i}class ct{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(e,t,r){const i=ut<lt.length?lt[ut++]:new ct;return i.index=e,i.x=t,i.y=r,i.prev=null,i.next=null,i.z=null,i.prevZ=null,i.nextZ=null,i.steiner=!1,i}}const lt=[];let ut=0;for(let Cd=0;Cd<8096;Cd++)lt.push(new ct);const dt=new Ne.O3(0,0,0,1,0),ht=new Ne.O3(0,0,0,1,0);function pt(e,t,r){let i=0;for(let s=1;s<r;s++){const r=e[2*(t+s-1)],n=e[2*(t+s-1)+1];i+=(e[2*(t+s)]-r)*(e[2*(t+s)+1]+n)}return i}function ft(e,t,r,i,s){let n=0;for(let o=r;o<i;o+=3){const r=2*(e[o]-s),i=2*(e[o+1]-s),a=2*(e[o+2]-s);n+=Math.abs((t[r]-t[a])*(t[i+1]-t[r+1])-(t[r]-t[i])*(t[a+1]-t[r+1]))}return n}function _t(e,t){if(null==e)return null;if(!function(e,t,r){let i=0;for(let s=0;s<e.lengths.length;s++){const n=e.lengths[s];for(let s=0;s<n;s++){const n=e.coords[2*(s+i)],o=e.coords[2*(s+i)+1];if(n<t||n>r||o<t||o>r)return!0}i+=n}return!1}(e,-128,_.CQ+128))return e;dt.setPixelMargin(t),dt.reset(Ne.dC.Polygon);let r=0;for(let o=0;o<e.lengths.length;o++){const t=e.lengths[o];let i=e.coords[2*(0+r)],s=e.coords[2*(0+r)+1];dt.moveTo(i,s);for(let n=1;n<t;n++)i=e.coords[2*(n+r)],s=e.coords[2*(n+r)+1],dt.lineTo(i,s);dt.close(),r+=t}const i=dt.result(!1);if(!i)return null;const s=[],n=[];for(const o of i){let e=0;for(const t of o)n.push(t.x),n.push(t.y),e++;s.push(e)}return new Be.A(s,n)}dt.setExtent(_.CQ),ht.setExtent(_.CQ);const yt=(0,n.A)("featurelayer-fast-triangulation-enabled");class mt extends Te{async loadDependencies(){await Promise.all([super.loadDependencies(),(0,Le.F)()])}_write(e,t,r){var i;const s=null!==(i=null===r||void 0===r?void 0:r.asOptimized())&&void 0!==i?i:t.readGeometryForDisplay(),n=this._clip(s);n&&(e.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(e,t,n),e.recordEnd())}_clip(e){if(!e)return null;return _t(e,this.hasEffects?256:8)}_writeGeometry(e,t,r){const i=r.maxLength>100,s=[],n=this.createTesselationParams(t);if(!i&&yt&&function(e,t){const{coords:r,lengths:i}=t,s=e;let n=0;for(let o=0;o<i.length;){let e=o,t=i[o],a=pt(r,n,t);const c=[];for(;++e<i.length;){const s=i[e],o=pt(r,n+t,s);if(!(o>0))break;a+=o,c.push(n+t),t+=s}const l=s.length;Ve(s,r,n,n+t,c,2,0);const u=ft(s,r,l,s.length,0),d=Math.abs(a);if(Math.abs((u-d)/Math.max(1e-7,d))>1e-5)return s.length=0,!1;o=e,n+=t}return!0}(s,r))return void(s.length&&this._writeVertices(e,t,r.coords,n,s));const o=function(e){const{coords:t,lengths:r}=e,{buffer:i}=(0,Le.l)(t,r);return i}(r);this._writeVertices(e,t,o,n)}_writeVertices(e,t,r,i,s){const n=t.getDisplayId(),o=e.vertexCount(),a=this.hasEffects;let c=0;if(s)for(const l of s){const t=r[2*l],s=r[2*l+1];a&&e.recordBounds(t,s,0,0),this._writeVertex(e,n,t,s,i),c++}else for(let l=0;l<r.length;l+=2){const t=Math.round(r[l]),s=Math.round(r[l+1]);a&&e.recordBounds(t,s,0,0),this._writeVertex(e,n,t,s,i),c++}e.indexEnsureSize(c);for(let l=0;l<c;l++)e.indexWrite(l+o)}}const gt={createComputedParams:e=>e,optionalAttributes:{},attributes:{id:{type:X.pe.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:X.pe.UNSIGNED_BYTE,count:1},pos:{type:X.pe.SHORT,count:2,pack:"position",packPrecisionFactor:10},inverseArea:{type:X.pe.FLOAT,count:1,packTessellation:e=>{let{inverseArea:t}=e;return t}}}};class xt extends mt{constructor(){super(...arguments),this.vertexSpec=gt}createTesselationParams(e){return{inverseArea:1/e.readGeometryArea()}}}var vt=r(55033);const bt={createComputedParams:e=>e,optionalAttributes:{zoomRange:{type:X.pe.SHORT,count:2,packPrecisionFactor:_.fq,pack:(e,t)=>{let{scaleInfo:r}=e,{tileInfo:i}=t;return re(r,i)}}},attributes:{id:{type:X.pe.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:X.pe.UNSIGNED_BYTE,count:1},pos:{type:X.pe.SHORT,count:2,pack:"position",packPrecisionFactor:10},color:{type:X.pe.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{color:t}=e;return ne(t)}}}};class wt extends mt{constructor(){super(...arguments),this.vertexSpec=bt}createTesselationParams(e){return null}}const It={createComputedParams:e=>e,optionalAttributes:bt.optionalAttributes,attributes:(0,m.A)((0,m.A)({},bt.attributes),{},{tlbr:{count:4,type:X.pe.UNSIGNED_SHORT,pack:e=>{let{sprite:t}=e;const{rect:r,width:i,height:s}=t,n=r.x+_.hM,o=r.y+_.hM;return[n,o,n+i,o+s]}},inverseRasterizationScale:{count:1,type:X.pe.BYTE,packPrecisionFactor:16,pack:e=>{let{sprite:t}=e;return 1/t.rasterizationScale}}})};class St extends wt{constructor(){super(...arguments),this.vertexSpec=It}_write(e,t,r){var i,s;const n=null!==(i=null===r||void 0===r?void 0:r.asOptimized())&&void 0!==i?i:t.readGeometryForDisplay(),o=this._clip(n);if(!o)return;const a=null===(s=this.evaluatedMeshParams.sprite)||void 0===s?void 0:s.textureBinding;e.recordStart(this.instanceId,this.attributeLayout,a),this._writeGeometry(e,t,o),e.recordEnd()}}function Tt(e){const{sprite:t,aspectRatio:r,scaleProportionally:i}=e,s=(0,u.Lz)(e.height),n=s>0?s:t.height;let o=s*r;return o<=0?o=t.width:i&&(o*=t.width/t.height),{width:o,height:n}}function At(e){const{applyRandomOffset:t,sampleAlphaOnly:r}=e;return se([[Re,t],[4,r]])}const Mt={createComputedParams:e=>e,optionalAttributes:It.optionalAttributes,attributes:(0,m.A)((0,m.A)({},It.attributes),{},{bitset:{count:1,type:X.pe.UNSIGNED_BYTE,pack:At},width:{count:1,type:X.pe.HALF_FLOAT,pack:e=>Tt(e).width},height:{count:1,type:X.pe.HALF_FLOAT,pack:e=>Tt(e).height},offset:{count:2,type:X.pe.HALF_FLOAT,pack:e=>{let{offsetX:t,offsetY:r}=e;return[(0,u.Lz)(t),-(0,u.Lz)(r)]}},scale:{count:2,type:X.pe.UNSIGNED_BYTE,packPrecisionFactor:16,pack:e=>{let{scaleX:t,scaleY:r}=e;return[t,r]}},angle:{count:1,type:X.pe.UNSIGNED_BYTE,pack:e=>{let{angle:t}=e;return(0,vt.wV)(t)}}})};class kt extends St{constructor(){super(...arguments),this.vertexSpec=Mt}}var Ft=r(27307);class Et{constructor(){this.extrusionOffsetX=0,this.extrusionOffsetY=0,this.normalX=0,this.normalY=0,this.directionX=0,this.directionY=0,this.distance=0}}const Ct={createComputedParams:e=>e,optionalAttributes:{zoomRange:{type:X.pe.SHORT,count:2,packPrecisionFactor:_.fq,pack:(e,t)=>{let{scaleInfo:r}=e,{tileInfo:i}=t;return re(r,i)}}},attributes:{id:{type:X.pe.UNSIGNED_BYTE,count:3,pack:"id"},pos:{type:X.pe.SHORT,count:2,pack:"position",packPrecisionFactor:10},bitset:{type:X.pe.UNSIGNED_BYTE,count:1},color:{type:X.pe.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{color:t}=e;return ne(t)}},offset:{type:X.pe.BYTE,count:2,packPrecisionFactor:16,packTessellation:e=>{let{extrusionOffsetX:t,extrusionOffsetY:r}=e;return[ae(t,16),ae(r,16)]}},normal:{type:X.pe.BYTE,count:2,packPrecisionFactor:16,packTessellation:e=>{let{normalX:t,normalY:r}=e;return[ae(t,16),ae(r,16)]}},halfWidth:{type:X.pe.HALF_FLOAT,count:1,pack:e=>{let{width:t}=e;return(0,u.Lz)(.5*t)}},referenceHalfWidth:{type:X.pe.HALF_FLOAT,count:1,pack:e=>{let{referenceWidth:t}=e;return(0,u.Lz)(.5*t)}}}};class Pt{constructor(){this.id=0,this.bitset=0,this.indexCount=0,this.vertexCount=0,this.vertexFrom=0,this.vertexBounds=0}}class zt extends Te{constructor(e,t,r,i){super(e,t,r,i),this.vertexSpec=Ct,this._currentWrite=new Pt,this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0,wrapDistance:65535,textured:!1},this._tessParams=new Et,this._initializeTessellator()}writeLineVertices(e,t,r){const i=this._getLines(t);null!=i&&this._writeVertices(e,r,i)}_initializeTessellator(){this._lineTessellator=new Ft.i(this._writeTesselatedVertex.bind(this),this._writeTriangle.bind(this),!0)}_write(e,t,r){const i=null!==r&&void 0!==r?r:le.z.fromFeatureSetReaderCIM(t);i&&this._writeGeometry(e,t,i)}_writeGeometry(e,t,r,i){e.recordStart(this.instanceId,this.attributeLayout,i),this.writeLineVertices(e,r,t),e.recordEnd()}_getLines(e){return function(e,t){ht.setPixelMargin(t);const r=ht,i=-t,s=_.CQ+t;let n=[],o=!1;if(!e.nextPath())return null;let a=!0;for(;a;){e.seekPathStart();const t=[];if(!e.pathSize)return null;r.reset(Ne.dC.LineString),e.nextPoint();let c=e.x,l=e.y;if(o)r.moveTo(c,l);else{if(c<i||c>s||l<i||l>s){o=!0;continue}t.push({x:c,y:l})}let u=!1;for(;e.nextPoint();)if(c=e.x,l=e.y,o)r.lineTo(c,l);else{if(c<i||c>s||l<i||l>s){u=!0;break}t.push({x:c,y:l})}if(u)o=!0;else{if(o){const e=r.resultWithStarts();if(e)for(const t of e)n.push(t)}else n.push({line:t,start:0});a=e.nextPath(),o=!1}}return n=n.filter((e=>e.line.length>1)),0===n.length?null:n}(e,be(this.evaluatedMeshParams))}_writeVertices(e,t,r){const{_currentWrite:i,_tessellationOptions:s,evaluatedMeshParams:n}=this,{width:o,capType:a,joinType:c,miterLimit:l,hasSizeVV:d}=n,h=(0,u.Lz)(.5*o);s.halfWidth=h,s.capType=function(e){switch(e){case"butt":case Y.uT.Butt:return Y.xR.BUTT;case"round":case Y.uT.Round:return Y.xR.ROUND;case"square":case Y.uT.Square:return Y.xR.SQUARE}}(a),s.joinType=function(e){switch(e){case"bevel":case Y.wd.Bevel:return Y.JO.BEVEL;case"miter":case Y.wd.Miter:return Y.JO.MITER;case"round":case Y.wd.Round:return Y.JO.ROUND}}(c),s.miterLimit=l;const p=!d;i.out=e,i.id=t.getDisplayId(),i.vertexCount=0,i.indexCount=0,i.vertexFrom=e.vertexCount(),i.vertexBounds=p&&h<_.Gh?0:1;for(const{line:u,start:f}of r)s.initialDistance=f%65535,this._lineTessellator.tessellate(u,s,p)}_writeTesselatedVertex(e,t,r,i,s,n,o,a,c,l,u){const{out:d,id:h,vertexBounds:p}=this._currentWrite;return this.hasEffects&&d.recordBounds(e,t,p,p),this._tessParams.extrusionOffsetX=o,this._tessParams.extrusionOffsetY=a,this._tessParams.normalX=c,this._tessParams.normalY=l,this._tessParams.directionX=s,this._tessParams.directionY=n,this._tessParams.distance=u,this._writeVertex(d,h,e,t,this._tessParams),this._currentWrite.vertexFrom+this._currentWrite.vertexCount++}_writeTriangle(e,t,r){const{out:i}=this._currentWrite;i.indexEnsureSize(3),i.indexWrite(e),i.indexWrite(t),i.indexWrite(r),this._currentWrite.indexCount+=3}}const Ot={createComputedParams:e=>e,optionalAttributes:Ct.optionalAttributes,attributes:(0,m.A)((0,m.A)({},Ct.attributes),{},{bitset:{type:X.pe.UNSIGNED_BYTE,count:1,pack:e=>0},color:{type:X.pe.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{color:t}=e;return ne(t)}}})},Rt={createComputedParams:e=>e,optionalAttributes:Ct.optionalAttributes,attributes:(0,m.A)((0,m.A)({},Ct.attributes),{},{bitset:{type:X.pe.UNSIGNED_BYTE,count:1,pack:e=>se([[0,!0]])},color:{type:X.pe.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{outlineColor:t}=e;return ne(t)}}})};class Dt extends zt{constructor(){super(...arguments),this.vertexSpec=Rt}}class Lt extends wt{constructor(e,t,r,i){super(e,t,r,i),this.vertexSpec=Ot,this._lineMeshWriter=this._createOutlineWriter(e,t,r,i)}_createOutlineWriter(e,t,r,i){return new Dt(e,t,r,i)}_write(e,t,r){var i;const s=null!==(i=null===r||void 0===r?void 0:r.asOptimized())&&void 0!==i?i:t.readGeometryForDisplay(),n=this._clip(s);n&&(e.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(e,t,n),this._lineMeshWriter.writeLineVertices(e,le.z.fromOptimizedCIM(n,"esriGeometryPolyline"),t),e.recordEnd())}_clip(e){return e?_t(e,be(this.evaluatedMeshParams)):null}ensurePacked(e,t,r){super.ensurePacked(e,t,r),this._lineMeshWriter.ensurePacked(e,t,r)}enqueueRequest(e,t,r){super.enqueueRequest(e,t,r),this._lineMeshWriter.enqueueRequest(e,t,r)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}var Nt=r(35143),Bt=r(24245),Vt=r(86994);class qt{constructor(){this._includedModules=new Map}include(e,t){this._includedModules.has(e)?this._includedModules.get(e):(this._includedModules.set(e,t),e(this.builder,t))}}class Gt extends qt{constructor(){super(...arguments),this.vertex=new Wt,this.fragment=new Wt,this.attributes=new Yt,this.varyings=new Xt,this.extensions=new Ht,this.constants=new Zt}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const r=this.extensions.generateSource(e),i=this.attributes.generateSource(e),s=this.varyings.generateSource(e),n="vertex"===e?this.vertex:this.fragment,o=n.uniforms.generateSource(),a=n.code.generateSource(),c="vertex"===e?Qt:"#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif\n",l=this.constants.generateSource().concat(n.constants.generateSource());return"".concat(t?"#version 300 es":"","\n").concat(r.join("\n"),"\n").concat(c,"\n").concat(l.join("\n"),"\n").concat(o.join("\n"),"\n").concat(i.join("\n"),"\n").concat(s.join("\n"),"\n").concat(a.join("\n"))}generateBindPass(e){const t=new Map;this.vertex.uniforms.entries.forEach((e=>{const r=e.bind[Bt.c.Pass];r&&t.set(e.name,r)})),this.fragment.uniforms.entries.forEach((e=>{const r=e.bind[Bt.c.Pass];r&&t.set(e.name,r)}));const r=Array.from(t.values()),i=r.length;return(t,s)=>{for(let n=0;n<i;++n)r[n](e,t,s)}}generateBindDraw(e){const t=new Map;this.vertex.uniforms.entries.forEach((e=>{const r=e.bind[Bt.c.Draw];r&&t.set(e.name,r)})),this.fragment.uniforms.entries.forEach((e=>{const r=e.bind[Bt.c.Draw];r&&t.set(e.name,r)}));const r=Array.from(t.values()),i=r.length;return(t,s,n)=>{for(let o=0;o<i;++o)r[o](e,n,t,s)}}}class Ut{constructor(){this._entries=new Map}add(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];for(const i of t)this._add(i)}get(e){return this._entries.get(e)}_add(e){if(null!=e){if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new i.A("Duplicate uniform name ".concat(e.name," for different uniform type"));this._entries.set(e.name,e)}else W.A.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder").error("Trying to add null Uniform from ".concat((new Error).stack,"."))}generateSource(){return Array.from(this._entries.values()).map((e=>null!=e.arraySize?"uniform ".concat(e.type," ").concat(e.name,"[").concat(e.arraySize,"];"):"uniform ".concat(e.type," ").concat(e.name,";")))}get entries(){return Array.from(this._entries.values())}}class jt{constructor(){this._entries=new Array}add(e){this._entries.push(e)}generateSource(){return this._entries}}class Wt extends qt{constructor(){super(...arguments),this.uniforms=new Ut,this.code=new jt,this.constants=new Zt}get builder(){return this}}class Yt{constructor(){this._entries=new Array}add(e,t){this._entries.push([e,t])}generateSource(e){return"fragment"===e?[]:this._entries.map((e=>"in ".concat(e[1]," ").concat(e[0],";")))}}class Xt{constructor(){this._entries=new Map}add(e,t){this._entries.has(e)&&(0,Vt.vA)(this._entries.get(e)===t),this._entries.set(e,t)}generateSource(e){const t=new Array;return this._entries.forEach(((r,i)=>t.push("vertex"===e?"out ".concat(r," ").concat(i,";"):"in ".concat(r," ").concat(i,";")))),t}}class Ht{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const t="vertex"===e?Ht.ALLOWLIST_VERTEX:Ht.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((e=>t.includes(e))).map((e=>"#extension ".concat(e," : enable")))}}Ht.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],Ht.ALLOWLIST_VERTEX=[];class Zt{constructor(){this._entries=new Set}add(e,t,r){let i="ERROR_CONSTRUCTOR_STRING";switch(t){case"float":i=Zt._numberToFloatStr(r);break;case"int":i=Zt._numberToIntStr(r);break;case"bool":i=r.toString();break;case"vec2":i="vec2(".concat(Zt._numberToFloatStr(r[0]),",                            ").concat(Zt._numberToFloatStr(r[1]),")");break;case"vec3":i="vec3(".concat(Zt._numberToFloatStr(r[0]),",                            ").concat(Zt._numberToFloatStr(r[1]),",                            ").concat(Zt._numberToFloatStr(r[2]),")");break;case"vec4":i="vec4(".concat(Zt._numberToFloatStr(r[0]),",                            ").concat(Zt._numberToFloatStr(r[1]),",                            ").concat(Zt._numberToFloatStr(r[2]),",                            ").concat(Zt._numberToFloatStr(r[3]),")");break;case"ivec2":i="ivec2(".concat(Zt._numberToIntStr(r[0]),",                             ").concat(Zt._numberToIntStr(r[1]),")");break;case"ivec3":i="ivec3(".concat(Zt._numberToIntStr(r[0]),",                             ").concat(Zt._numberToIntStr(r[1]),",                             ").concat(Zt._numberToIntStr(r[2]),")");break;case"ivec4":i="ivec4(".concat(Zt._numberToIntStr(r[0]),",                             ").concat(Zt._numberToIntStr(r[1]),",                             ").concat(Zt._numberToIntStr(r[2]),",                             ").concat(Zt._numberToIntStr(r[3]),")");break;case"mat2":case"mat3":case"mat4":i="".concat(t,"(").concat(Array.prototype.map.call(r,(e=>Zt._numberToFloatStr(e))).join(", "),")")}return this._entries.add("const ".concat(t," ").concat(e," = ").concat(i,";")),this}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}}const Qt="precision highp float;\nprecision highp sampler2D;";function Kt(e,t){const r=[];for(r.push(t);r.length;){const t=r.pop();if("object"==typeof t&&!e.has(t.uid)){e.add(t.uid);for(const e of t.children)r.push(e)}}}class Jt{constructor(){this.uid=Jt.NodeCount++,this._debugName=null,this._isMutable=!1,this.isImplicit=!1}get isMutable(){return this._isMutable}setMutable(){return this._isMutable=!0,this}setDebugName(e){return e=function(e){return e.split(" ").map(((e,t)=>t>0?e.charAt(0).toUpperCase()+e.slice(1):e)).join("")}(e),this._debugName=e,this.isImplicit&&this.children[0]instanceof Jt&&this.children[0].setDebugName(e),this}get debugInfo(){var e;return{name:null!==(e=this._debugName)&&void 0!==e?e:""}}cloneInto(e){e._debugName=this._debugName,e._isMutable=this._isMutable,e.isImplicit=this.isImplicit,e.uid=this.uid}}function $t(e){return"object"==typeof e?e.clone():e}Jt.NodeCount=0;class er extends Jt{constructor(){super(...arguments),this.shaderType="primitive-node"}}class tr extends Jt{constructor(e){super(),this.child=e,this.shaderType="scope-node"}get children(){return[this.child]}clone(){const e=new tr($t(this.child));return this.cloneInto(e),e}}class rr extends Jt{constructor(e,t,r){super(),this.property=e,this.target=t,this.returnType=r,this.shaderType="property-access-node"}get children(){const e=[this.target];return"string"!=typeof this.property&&e.push(this.property),e}clone(){const e=new rr(this.property,$t(this.target),this.returnType);return this.cloneInto(e),e}}class ir extends Jt{constructor(e,t,r){super(),this.condition=e,this.ifTrue=t,this.ifFalse=r,this.shaderType="condition-node"}get children(){return[this.condition,this.ifTrue,this.ifFalse]}clone(){const e=$t(this.ifTrue),t=this.ifFalse?$t(this.ifFalse):null,r=new ir(this.condition,e,t);return this.cloneInto(r),r}}class sr extends Jt{constructor(e,t,r,i){super(),this.captureList=e,this.returnType=t,this.generator=i,this.shaderType="block-node",r&&(this.subgraph=new tr(r))}get children(){var e;return Object.keys(this.captureList).map((e=>this.captureList[e])).concat(null!==(e=this.subgraph)&&void 0!==e?e:[])}clone(){const e={};for(const r in this.captureList)e[r]=$t(this.captureList[r]);const t=new sr(e,this.returnType,this.subgraph?$t(this.subgraph.child):this.subgraph,this.generator);return this.cloneInto(t),t}}class nr extends Jt{constructor(e,t,r,i,s){let n=arguments.length>5&&void 0!==arguments[5]&&arguments[5];super(),this.token=e,this._children=t,this.isInfix=r,this.isPropertyAccess=i,this.returnType=s,this.isTernary=n,this.shaderType="function-node"}get children(){return this._children}clone(){const e=new nr(this.token,this._children.map($t),this.isInfix,this.isPropertyAccess,this.returnType,this.isTernary);return this.cloneInto(e),e}}var or,ar,cr,lr,ur,dr,hr,pr,fr,_r,yr,mr,gr,xr;function vr(e){return new Proxy(e,{get(t,r){if("constructor"===r)return new Proxy(t.constructor,{construct:(e,t,r)=>vr(new e(...t))});if(r in t)return t[r];if("string"==typeof r){const t=function(e){const t=[["float","vec2","vec3","vec4"],["int","ivec2","ivec3","ivec4"],["uint","uvec2","uvec3","uvec4"],["bool","bvec2","bvec3","bvec4"]];for(const r of t)if(r.includes(e))return r.map((e=>Wr[e]));throw new Error("Unable to find type family")}(e.type);return Kr(e,r,t[r.length-1])}}})}function br(e){return new Proxy(e,{construct:(e,t,r)=>vr(new e(...t))})}class wr extends Error{}let Ir=or=class extends er{constructor(e,t){super(),this.elementType=e,this.size=t,this.children=[],this.type="array"}clone(){const e=new or(this.elementType,this.size);return super.cloneInto(e),e}get(e){if("number"==typeof e){const t=new Nr(e);return t.isImplicit=!0,Kr(this,t,this.elementType.constructor)}return Kr(this,e,this.elementType.constructor)}last(){return this.get(this.size-1)}first(){return this.get(0)}findIndex(e,t,r){return function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.size;const s=new Nr(r).setMutable().setDebugName("FindIndexIterator"),n=t(e.get(s)).setDebugName("FindIndexPredicate"),o=ii({iter:s},Nr,n,(e=>{let{out:t,iter:r,subgraph:s}=e;return"\n".concat(t," = -1;\n\nfor (; ").concat(r," < ").concat(i,"; ").concat(r,"++) {\n\n").concat(s.body,"\n\n  if (").concat(s.varName,") {\n    ").concat(t," = ").concat(r,";\n    break;\n  }\n\n}\n")})).setDebugName("FindIndexBlock");return o}(this,e,t,r)}glslFindIndex(e,t,r){return function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.size;const s=ii({array:e},Nr,null,(e=>{let{out:s,array:n}=e;return"\n".concat(s," = -1;\nfor (int i = ").concat(r,"; i < ").concat(i,"; i++) {\n  bool condition;\n  ").concat(t({array:n,i:"i",out:"condition"}),"\n  if (condition) {\n    ").concat(s," = i;\n    break;\n  }\n}\n")})).setDebugName("GlslFindIndexBlock");return s}(this,e,t,r)}static ofType(e,t){const r={construct:(r,i)=>new or(new e,t)};return new Proxy(or,r)}};Ir.type="array",Ir=or=(0,Nt._)([function(e){return new Proxy(e,{construct:(e,t,r)=>function(e){return new Proxy(e,{get(t,r){if(r in t)return t[r];if("string"==typeof r){const t=parseInt(r,10);if(!isNaN(t))return Kr(e,"[".concat(t,"]"),e.elementType.constructor)}}})}(new e(...t))})}],Ir);class Sr extends er{constructor(){super(...arguments),this.type="sampler2D",this.children=[]}clone(){const e=new Sr;return e.children=this.children.map($t),super.cloneInto(e),e}}Sr.type="sampler2D";class Tr extends er{constructor(e){super(),this.type="float",this.children=[e]}clone(){const e=new Tr($t(this.children[0]));return super.cloneInto(e),e}multiply(e){return oi(this,"number"==typeof e?Dr(e,Tr):e)}divide(e){return ai(this,"number"==typeof e?Dr(e,Tr):e)}add(e){return ci(this,"number"==typeof e?Dr(e,Tr):e)}subtract(e){return li(this,"number"==typeof e?Dr(e,Tr):e)}}Tr.type="float";let Ar=ar=class extends er{constructor(e,t){super(),this.type="vec2",this.children=[e,t].filter((e=>null!=e))}clone(){const e=new ar($t(this.children[0]),$t(this.children[1]));return super.cloneInto(e),e}get 0(){return Kr(this,"[0]",Tr)}get 1(){return Kr(this,"[1]",Tr)}get 2(){throw new wr}get 3(){throw new wr}multiply(e){return oi(this,"number"==typeof e?Dr(e,Tr):e)}divide(e){return ai(this,"number"==typeof e?Dr(e,Tr):e)}add(e){return ci(this,"number"==typeof e?Dr(e,Tr):e)}subtract(e){return li(this,"number"==typeof e?Dr(e,Tr):e)}};Ar.type="vec2",Ar=ar=(0,Nt._)([br],Ar);let Mr=cr=class extends er{constructor(e,t,r){super(),this.type="vec3",this.children=[e,t,r].filter((e=>null!=e))}get 0(){return Kr(this,"[0]",Tr)}get 1(){return Kr(this,"[1]",Tr)}get 2(){return Kr(this,"[2]",Tr)}get 3(){throw new wr}clone(){const e=new cr($t(this.children[0]),$t(this.children[1]),$t(this.children[2]));return super.cloneInto(e),e}multiply(e){return oi(this,"number"==typeof e?Dr(e,Tr):e)}divide(e){return ai(this,"number"==typeof e?Dr(e,Tr):e)}add(e){return ci(this,"number"==typeof e?Dr(e,Tr):e)}subtract(e){return li(this,"number"==typeof e?Dr(e,Tr):e)}};Mr.type="vec3",Mr=cr=(0,Nt._)([br],Mr);let kr=lr=class extends er{constructor(e,t,r,i){super(),this.type="vec4",this.children=[e,t,r,i].filter((e=>null!=e))}clone(){const e=new lr($t(this.children[0]),$t(this.children[1]),$t(this.children[2]),$t(this.children[3]));return super.cloneInto(e),e}get 0(){return Kr(this,"[0]",Tr)}get 1(){return Kr(this,"[1]",Tr)}get 2(){return Kr(this,"[2]",Tr)}get 3(){return Kr(this,"[3]",Tr)}multiply(e){return oi(this,"number"==typeof e?Dr(e,Tr):e)}divide(e){return ai(this,"number"==typeof e?Dr(e,Tr):e)}add(e){return ci(this,"number"==typeof e?Dr(e,Tr):e)}subtract(e){return li(this,"number"==typeof e?Dr(e,Tr):e)}};kr.type="vec4",kr=lr=(0,Nt._)([br],kr);let Fr=ur=class extends er{constructor(e){super(),this.type="uint",this.children=[e]}clone(){const e=new ur($t(this.children[0]));return super.cloneInto(e),e}};Fr.type="uint",Fr=ur=(0,Nt._)([br],Fr);let Er=dr=class extends er{constructor(e,t){super(),this.type="uvec2",this.children=[e,t].filter((e=>null!=e))}clone(){const e=new dr($t(this.children[0]),$t(this.children[1]));return super.cloneInto(e),e}};Er.type="uvec2",Er=dr=(0,Nt._)([br],Er);let Cr=hr=class extends er{constructor(e,t,r){super(),this.type="uvec3",this.children=[e,t,r].filter((e=>null!=e))}clone(){const e=new hr($t(this.children[0]),$t(this.children[1]),$t(this.children[2]));return super.cloneInto(e),e}};Cr.type="uvec3",Cr=hr=(0,Nt._)([br],Cr);let Pr=pr=class extends er{constructor(e,t,r,i){super(),this.type="uvec4",this.children=[e,t,r,i].filter((e=>null!=e))}clone(){const e=new pr($t(this.children[0]),$t(this.children[1]),$t(this.children[2]),$t(this.children[3]));return super.cloneInto(e),e}};Pr.type="uvec4",Pr=pr=(0,Nt._)([br],Pr);class zr extends er{constructor(e){super(),this.type="bool",this.children=[e]}and(e){return _i(this,e)}or(e){return fi(this,e)}clone(){const e=new zr($t(this.children[0]));return super.cloneInto(e),e}}zr.type="bool";let Or=fr=class extends er{constructor(e,t){super(),this.type="bvec2",this.children=[e,t].filter((e=>null!=e))}all(){return yi(this)}any(){return mi(this)}clone(){const e=new fr($t(this.children[0]),$t(this.children[1]));return super.cloneInto(e),e}};Or.type="bvec2",Or=fr=(0,Nt._)([br],Or);let Rr=_r=class extends er{constructor(e,t,r){super(),this.type="bvec3",this.children=[e,t,r].filter((e=>null!=e))}all(){return yi(this)}any(){return mi(this)}clone(){const e=new _r($t(this.children[0]),$t(this.children[1]),$t(this.children[2]));return super.cloneInto(e),e}};function Dr(e,t){return"number"==typeof e?new t(e):e}Rr.type="bvec3",Rr=_r=(0,Nt._)([br],Rr);let Lr=yr=class extends er{constructor(e,t,r,i){super(),this.type="bvec4",this.children=[e,t,r,i].filter((e=>null!=e))}all(){return yi(this)}any(){return mi(this)}clone(){const e=new yr($t(this.children[0]),$t(this.children[1]),$t(this.children[2]),$t(this.children[3]));return super.cloneInto(e),e}};Lr.type="bvec4",Lr=yr=(0,Nt._)([br],Lr);class Nr extends er{constructor(e){super(),this.type="int",this.children=[e]}multiply(e){return oi(this,Dr(e,Nr))}add(e){return ci(this,Dr(e,Nr))}subtract(e){return li(this,Dr(e,Nr))}divide(e){return ai(this,Dr(e,Nr))}clone(){const e=new Nr($t(this.children[0]));return super.cloneInto(e),e}}Nr.type="int";let Br=mr=class extends er{constructor(e,t){super(),this.type="ivec2",this.children=[e,t].filter((e=>null!=e))}clone(){const e=new mr($t(this.children[0]),$t(this.children[1]));return super.cloneInto(e),e}};Br.type="ivec2",Br=mr=(0,Nt._)([br],Br);let Vr=gr=class extends er{constructor(e,t,r){super(),this.type="ivec3",this.children=[e,t,r].filter((e=>null!=e))}clone(){const e=new gr($t(this.children[0]),$t(this.children[1]),$t(this.children[2]));return super.cloneInto(e),e}};Vr.type="ivec3",Vr=gr=(0,Nt._)([br],Vr);let qr=xr=class extends er{constructor(e,t,r,i){super(),this.type="ivec4",this.children=[e,t,r,i].filter((e=>null!=e))}clone(){const e=new xr($t(this.children[0]),$t(this.children[1]),$t(this.children[2]),$t(this.children[3]));return super.cloneInto(e),e}};qr.type="ivec4",qr=xr=(0,Nt._)([br],qr);class Gr extends er{constructor(e,t,r,i){super(),this.type="mat2",this.children=[e,t,r,i]}clone(){const e=new Gr($t(this.children[0]),$t(this.children[1]),$t(this.children[2]),$t(this.children[3]));return super.cloneInto(e),e}multiply(e){return oi(this,e)}}Gr.type="mat2";class Ur extends er{static identity(){return new Ur(1,0,0,0,1,0,0,0,1)}static fromRotation(e){const t=ki(e),r=xi(e);return new Ur(r,t,0,ri(t),r,0,0,0,1)}constructor(e,t,r,i,s,n,o,a,c){super(),this.type="mat3",this.children=[e,t,r,i,s,n,o,a,c]}add(e){return ci(this,e)}multiply(e){return oi(this,e)}clone(){const e=new Ur($t(this.children[0]),$t(this.children[1]),$t(this.children[2]),$t(this.children[3]),$t(this.children[4]),$t(this.children[5]),$t(this.children[6]),$t(this.children[7]),$t(this.children[8]));return super.cloneInto(e),e}}Ur.type="mat3";class jr extends er{static identity(){return new jr(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}constructor(e,t,r,i,s,n,o,a,c,l,u,d,h,p,f,_){super(),this.type="mat4",this.children=[e,t,r,i,s,n,o,a,c,l,u,d,h,p,f,_]}static fromColumns(e,t,r,i){return new jr(e.x,e.y,e.z,e.w,t.x,t.y,t.z,t.w,r.x,r.y,r.z,r.w,i.x,i.y,i.z,i.w)}multiply(e){return oi(this,e)}clone(){const e=new jr($t(this.children[0]),$t(this.children[1]),$t(this.children[2]),$t(this.children[3]),$t(this.children[4]),$t(this.children[5]),$t(this.children[6]),$t(this.children[7]),$t(this.children[8]),$t(this.children[9]),$t(this.children[10]),$t(this.children[11]),$t(this.children[12]),$t(this.children[13]),$t(this.children[14]),$t(this.children[15]));return super.cloneInto(e),e}}jr.type="mat4";const Wr={float:Tr,vec2:Ar,vec3:Mr,vec4:kr,int:Nr,ivec2:Br,ivec3:Vr,ivec4:qr,uint:Fr,uvec2:Er,uvec3:Cr,uvec4:Pr,bool:zr,bvec2:Or,bvec3:Rr,bvec4:Lr},Yr=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new Nr(...t)},Xr=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new Tr(...t)},Hr=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new Ar(...t)},Zr=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new kr(...t)},Qr=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new Ur(...t)};function Kr(e,t,r){const i=new r(new rr(t,e,r));return i.isImplicit=!0,i}function Jr(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(i){const s=new i,n=new i(new nr(e,[t,r],!0,!1,s));return n.isImplicit=!0,n}if("float"===t.type||"int"===t.type){const i=new r.constructor(new nr(e,[t,r],!0,!1,r.constructor));return i.isImplicit=!0,i}if(("mat2"===t.type||"mat3"===t.type||"mat4"===t.type)&&"float"!==r.type){const i=new r.constructor(new nr(e,[t,r],!0,!1,r.constructor));return i.isImplicit=!0,i}const s=new t.constructor(new nr(e,[t,r],!0,!1,t.constructor));return s.isImplicit=!0,s}function $r(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.constructor;const i=new r(new nr(e,[t],!1,!1,r));return i.isImplicit=!0,i}function ei(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.constructor;const s=new i(new nr(e,[t,r],!1,!1,i));return s.isImplicit=!0,s}function ti(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:t.constructor;const n=new s(new nr(e,[t,r,i],!1,!1,s));return n.isImplicit=!0,n}function ri(e){return oi(e,Xr(-1))}function ii(e,t,r,i){return new t(new sr(e,t,r,i))}function si(e,t,r){const i="function"==typeof t?t():t,s="function"==typeof r?r():r,n=new i.constructor(new ir(e,i,s));return n.isImplicit=!0,n}function ni(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];const i=t.map((e=>{let[t,r]=e;return"function"==typeof r?[t,r()]:[t,r]})),s=i[0][1].constructor,n=i.findIndex((e=>!0===e[0]));if(-1===n)throw new Error("A cond must have a fallthrough case with `true`/; ");const o=i.slice(0,n),a=i[n][1],c=new s(o.reduceRight(((e,t)=>si(t[0],t[1],e)),a));return c.isImplicit=!0,c}function oi(e,t){return Jr("*",e,t)}function ai(e,t){return Jr("/",e,t)}function ci(e,t){return Jr("+",e,t)}function li(e,t){return Jr("-",e,t)}function ui(e,t){return Jr("==",e,t,zr)}function di(e,t){return Jr("<=",e,t,zr)}function hi(e,t){return Jr(">",e,t,zr)}function pi(e,t){return Jr(">=",e,t,zr)}function fi(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.length<=1?t[0]:t.slice(1).reduce(((e,t)=>function(e,t){return Jr("||",e,t,zr)}(e,t)),t[0])}function _i(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.length<=1?t[0]:t.slice(1).reduce(((e,t)=>function(e,t){return Jr("&&",e,t,zr)}(e,t)),t[0])}function yi(e){return $r("all",e,zr)}function mi(e){return $r("any",e,zr)}function gi(e,t,r){return ti("clamp",e,t,r,e.constructor)}function xi(e){return $r("cos",e)}function vi(e,t){return ei("dot",e,t,Tr)}function bi(e){return $r("fract",e)}function wi(e){return $r("length",e,Tr)}function Ii(e,t){return ei("max",e,t)}function Si(e,t){return ei("min",e,t)}function Ti(e,t,r){return ti("mix",e,t,r)}function Ai(e,t){return ei("mod",e,t)}function Mi(e){return"bool"===e.type?$r("!",e):$r("not",e)}function ki(e){return $r("sin",e)}function Fi(e,t){return ei("step",e,t,t.constructor)}function Ei(e,t){return ei("texture",e,t,kr)}function Ci(e,t,r){const i=t.split("\n");for(const s of i)if(s.trim().length){{let t="";null!=r&&(t+="/*id:".concat(null!==r&&void 0!==r?r:"000","*/   ")),e.body+=t.padEnd(14)}e.body+=" ".repeat(e.indent)+s+"\n"}}class Pi{write(e){for(const t of e.rootOutputNodes())e.shouldPruneOutputNode(t)||(t.variableName=this._write(e,t.node));return e}_createVarName(e,t){let r="";return"boolean"!=typeof t&&"number"!=typeof t&&t.debugInfo.name&&(r="".concat(t.debugInfo.name,"_")),"".concat(r,"v").concat(e.varCount++)}_write(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if("number"==typeof t)return t.toString();if("boolean"==typeof t)return t.toString();let i=e.getEmit(t);if(i)return i;switch(t.shaderType){case"scope-node":i=this._writeScopeNode(e,t);break;case"primitive-node":i=this._writePrimitiveNode(e,t,r);break;case"function-node":i=this._writeFunctionNode(e,t);break;case"property-access-node":i=this._writePropertyAccessNode(e,t);break;case"text-node":i=t.text;break;case"block-node":i=this._writeBlockNode(e,t);break;case"condition-node":i=this._writeConditionNode(e,t)}return e.setEmit(t,i),i}_writeScopeNode(e,t){const r=new t.child.constructor;r.setDebugName(t.debugInfo.name);const i=this._write(e,r,!0);return Ci(e,"{ /*ScopeStart: ".concat(t.uid," ").concat(t.debugInfo.name,"*/")),e.indent+=2,Ci(e,"".concat(i," = ").concat(this._write(e,t.child),";")),e.indent-=2,Ci(e,"} /*ScopeEnd: ".concat(t.uid," ").concat(t.debugInfo.name,"*/")),i}_writeConditionNode(e,t){const r=new t.ifTrue.constructor,i=this._write(e,r,!0);Ci(e,"if (".concat(this._write(e,t.condition),") {")),e.indent+=2;const s=e.createSubgraphContext(),n=this._write(s,t.ifTrue);if(e.body+=s.body,n&&Ci(e,"".concat(i," = ").concat(n,";")),e.indent-=2,Ci(e,"}"),t.ifFalse){Ci(e,"else {"),e.indent+=2;const r=e.createSubgraphContext(),s=this._write(r,t.ifFalse);e.body+=r.body,s&&Ci(e,"".concat(i," = ").concat(s,";")),e.indent-=2,Ci(e,"}")}return i}_writeBlockNode(e,t){const{captureList:r,generator:i,returnType:s}=t,n={};for(const l in r){if(!r[l])continue;const t=this._write(e,r[l]);n[l]=t}const o=new s,a=this._write(e,o,!0);if(n.out=a,t.subgraph){const r=e.createSubgraphContext(),i=this._write(r,t.subgraph.child),s=r.body;n.subgraph={varName:i,body:s}}const c=i(n);return Ci(e,"{\n"),e.indent+=2,Ci(e,c),e.indent-=2,Ci(e,"}\n"),a}_writePropertyAccessNode(e,t){const r=this._write(e,t.target);return"string"==typeof t.property&&t.property.includes("[")?"".concat(r).concat(t.property):"string"!=typeof t.property?"".concat(r,"[").concat(this._write(e,t.property),"]"):"".concat(r,".").concat(t.property)}_writeFunctionNode(e,t){const r=t.returnType.type;if(t.isInfix){const[i,s]=t.children.map((t=>this._write(e,t))),n=this._createVarName(e,t);return Ci(e,"".concat(r.padEnd(5)," ").concat(n," = ").concat(i," ").concat(t.token," ").concat(s,";"),t.uid),n}const i=t.children.map((t=>this._write(e,t))).join(", "),s=this._createVarName(e,t);return Ci(e,"".concat(r.padEnd(5)," ").concat(s," = ").concat(t.token,"(").concat(i,");"),t.uid),s}_writePrimitiveNode(e,t){var r;let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const s=e.getInput(t);if(s)return s.isUsed=!0,s.variableName;const n=1===t.children.length&&(null===(r=t.children[0])||void 0===r?void 0:r.type)===t.type;if(t.isImplicit||n)return this._write(e,t.children[0]);const o=this._createVarName(e,t);if(i)return Ci(e,"".concat(t.type.padEnd(5)," ").concat(o,";"),t.uid),o;const a=!t.debugInfo.name&&!t.isMutable;if(a&&"float"===t.type&&"number"==typeof t.children[0])return Number.isInteger(t.children[0])?t.children[0].toFixed(1):t.children[0].toString();if(a&&"int"===t.type&&"number"==typeof t.children[0]&&Number.isInteger(t.children[0]))return t.children[0].toString();const c=t.children.map((t=>this._write(e,t))).join(", ");return"array"===t.type?(Ci(e,"".concat(t.type.padEnd(5)," ").concat(o," = [").concat(c,"];"),t.uid),o):a?"".concat(t.type,"(").concat(c,")"):(Ci(e,"".concat(t.type.padEnd(5)," ").concat(o," = ").concat(t.type,"(").concat(c,");"),t.uid),o)}}class zi{constructor(e,t,r){this.variableName=e,this.variableInputType=t,this.node=r,this.type="shader-input",this.isUsed=!1}clone(){return new zi(this.variableName,this.variableInputType,$t(this.node))}}class Oi{constructor(e,t,r){this.outVariableName=e,this.outVariableType=t,this.node=r,this.type="shader-output"}clone(){const e=new Oi(this.outVariableName,this.outVariableType,$t(this.node));return e.variableName=this.variableName,e}}class Ri{static createVertex(e,t,r,i,s,n){const o=[];for(const c in e){const t=e[c],i=r.get(c);i?o.push(new zi(i,"builtin",t)):o.push(new zi("a_"+c,"in",t))}for(const c of i){const e=c.uniformHydrated;o.push(new zi(c.uniformName,"uniform",e))}const a=[];for(const c in t){const e=t[c];"glPosition"===c?a.push(new Oi("gl_Position","builtin",e)):"glPointSize"===c?a.push(new Oi("gl_PointSize","builtin",e)):a.push(new Oi("v_"+c,"out",e))}return new Ri(o,a,s,n)}static createFragment(e,t,r,i,s,n){const o=[],a=Array.from(s.rootOutputNodes());for(const l in e){const t=e[l],i=r.get(l);if(i){o.push(new zi(i,"builtin",t));continue}const s=a.find((e=>e.node===t));s&&o.push(new zi(s.outVariableName,"in",t))}for(const l of i){const e=l.uniformHydrated;o.push(new zi(l.uniformName,"uniform",e))}const c=[];for(const l in t){const e=t[l],i=r.get(l);"discard"===l?c.push(new Oi(null,"discard",e)):i?c.push(new Oi(i,"builtin",e)):c.push(new Oi(l,"out",e))}return new Ri(o,c,n)}constructor(e,t,r,i){this.type="shader-graph-context",this.indent=0,this.body="",this.varCount=0,this._inputShaderTypesByNodeUid=new Map,this._nodeEmitMap=new Map;for(const s of e)this._inputShaderTypesByNodeUid.set(s.node.uid,s);this._outputShaderTypes=t,this._transformFeedbackBindings=r,this._transformFeedbackNames=new Set(r.map((e=>"v_"+e.propertyKey))),this._usedInFragmentShader=i}shouldPruneOutputNode(e){return!!this._usedInFragmentShader&&"builtin"!==e.outVariableType&&!this._transformFeedbackNames.has(e.outVariableName)&&!this._usedInFragmentShader.has(e.node.uid)}setEmit(e,t){this._nodeEmitMap.set(e.uid,t)}getEmit(e){return this._nodeEmitMap.get(e.uid)}inputs(){return this._inputShaderTypesByNodeUid.values()}getInput(e){return this._inputShaderTypesByNodeUid.get(e.uid)}*rootOutputNodes(){for(const e of this._outputShaderTypes)yield e}*nodes(){const e=[];for(const t of this._outputShaderTypes.values())e.push(t.node);for(;e.length;){const t=e.pop();"number"!=typeof t&&"boolean"!=typeof t&&e.push(...t.children.filter(Boolean)),yield t}}*nodesOfTypeOrFunction(){for(const e of this.nodes())"number"!=typeof e&&"boolean"!=typeof e&&(yield e)}createSubgraphContext(){const e=this.clone();return e.body="",e.indent=this.indent+2,e._nodeEmitMap=new Map(this._nodeEmitMap),e}clone(){const e=new Ri([],this._outputShaderTypes,this._transformFeedbackBindings,this._usedInFragmentShader);return e._inputShaderTypesByNodeUid=this._inputShaderTypesByNodeUid,e.indent=this.indent,e.body=this.body,e.varCount=this.varCount,e._nodeEmitMap=this._nodeEmitMap,e}insertVertexShader(e){e.vertex.code.add(""),this._insertInputs(e,"vertex"),e.vertex.code.add(""),e.vertex.code.add("// OUTPUTS: "),e.vertex.code.add("// --------------------------------------------------------- ");for(const t of this.rootOutputNodes()){const r="builtin"===t.outVariableType;this.shouldPruneOutputNode(t)||(r?e.vertex.code.add("// ".concat(t.outVariableType.padEnd(7)," ").concat(t.node.type.padEnd(9)," ").concat(t.outVariableName,";")):e.vertex.code.add("".concat(t.outVariableType.padEnd(10)," ").concat(t.node.type.padEnd(9)," ").concat(t.outVariableName,";")))}e.vertex.code.add(""),e.vertex.code.add("void main() {"),e.vertex.code.add("  "+this.body.split("\n").join("\n  "));for(const t of this.rootOutputNodes())this.shouldPruneOutputNode(t)||e.vertex.code.add("  ".concat(t.outVariableName," = ").concat(t.variableName,";"));e.vertex.code.add("}")}insertFragmentShader(e){this._insertInputs(e,"fragment"),e.fragment.code.add(""),e.fragment.code.add("// OUTPUTS: "),e.fragment.code.add("// --------------------------------------------------------- ");for(const t of this.rootOutputNodes())"builtin"===t.outVariableType?e.fragment.code.add("// ".concat(t.outVariableType.padEnd(7)," ").concat(t.node.type.padEnd(9)," ").concat(t.outVariableName,";")):e.fragment.code.add("".concat(t.outVariableType.padEnd(10)," ").concat(t.node.type.padEnd(9)," ").concat(t.outVariableName,";"));e.fragment.code.add(""),e.fragment.code.add("void main() {"),e.fragment.code.add("  "+this.body.split("\n").join("\n  "));for(const t of this.rootOutputNodes())"discard"===t.outVariableType?(e.fragment.code.add("  // TODO: Should ensure codegen for discard appears first in fragment shader"),e.fragment.code.add("  if (".concat(t.variableName,") {")),e.fragment.code.add("    discard;"),e.fragment.code.add("  }"),e.fragment.code.add("  ")):e.fragment.code.add("  ".concat(t.outVariableName," = ").concat(t.variableName,";"));e.fragment.code.add("}")}_insertInputs(e,t){e[t].code.add("// INPUTS: "),e[t].code.add("// --------------------------------------------------------- ");for(const r of this.inputs())r.isUsed&&"builtin"!==r.variableInputType&&("array"===r.node.type?e[t].code.add("".concat(r.variableInputType.padEnd(10)," ").concat(r.node.elementType.type.padEnd(9)," ").concat(r.variableName,"[").concat(r.node.size,"];")):e[t].code.add("".concat(r.variableInputType.padEnd(10)," ").concat(r.node.type.padEnd(9)," ").concat(r.variableName,";")))}}var Di=r(44488);function Li(e,t,r){const s=t.length;if(s!==r){const n=new i.A("Invalid Uniform","Invalid length, expected ".concat(r," but got ").concat(s),{uniformName:e,values:t});W.A.getLogger("esri.views.2d.engine.webgl.shaderGraph.typed.TypedShaderProgram").errorOnce(n)}}class Ni{constructor(e,t,r,i,s,n){this._program=null,this._vao=null,this._temporaryTextures=[],this.vertexShader=e,this.fragmentShader=t,this._locations=r,this._locationInfo=i,this._uniformBindings=s,this._transformFeedbackBindings=n}destroy(){this._program&&this._program.dispose(),this.cleanupTemporaryTextures()}get locations(){return this._locations}get locationInfo(){return this._locationInfo}setUniforms(e){this._uniforms=e}cleanupTemporaryTextures(){for(const e of this._temporaryTextures)e.dispose();this._temporaryTextures=[]}bind(e){const t=this._uniforms;if(!this._program){const t=new Map;for(const[e,r]of this._locations)t.set(e,r);const i=[];for(const e of null!==(r=this._transformFeedbackBindings)&&void 0!==r?r:[]){var r;const{index:t,propertyKey:s}=e;i[t]="v_".concat(s)}this._program=new Di.B(e,this.vertexShader,this.fragmentShader,t,new Map,i)}const i=this._program;e.useProgram(i);for(const s of this._uniformBindings){const{shaderModulePath:r,uniformName:n,uniformType:o,uniformArrayLength:a}=s,c=(0,v.wc)(r,t);if(null==c){if("sampler2D"===o)continue;throw new Error("Failed to find uniform value for ".concat(r))}switch("array"===o?s.uniformArrayElementType:o){case"sampler2D":{const{unit:t,texture:r}=c;if(i.setUniform1i(n,t),"type"in r)e.bindTexture(r,t);else{const i=K(e,r.descriptor,r.data);e.bindTexture(i,t)}break}case"int":if(!a){i.setUniform1i(n,c);break}Li(s.uniformName,c,a),i.setUniform1iv(n,c);break;case"float":if(!a){i.setUniform1f(n,c);break}Li(s.uniformName,c,a),i.setUniform1fv(n,c);break;case"vec2":if(!a){i.setUniform2f(n,c[0],c[1]);break}Li(s.uniformName,c,a),i.setUniform2fv(n,c.flat());break;case"vec3":if(!a){i.setUniform3f(n,c[0],c[1],c[2]);break}Li(s.uniformName,c,a),i.setUniform3fv(n,c.flat());break;case"vec4":if(!a){i.setUniform4f(n,c[0],c[1],c[2],c[3]);break}Li(s.uniformName,c,a),i.setUniform4fv(n,c.flat());break;case"mat3":i.setUniformMatrix3fv(n,c);break;case"mat4":i.setUniformMatrix4fv(n,c);break;default:throw new Error("Unable to set uniform for type ".concat(o))}}}}function Bi(e){return new e}function Vi(e,t,r){var i;const s=null!==(i=e.constructor[t])&&void 0!==i?i:[];e.constructor.hasOwnProperty(t)||Object.defineProperty(e.constructor,t,{value:s.slice()}),e.constructor[t].push(r)}function qi(e,t){return(r,i)=>{Vi(r,"locations",{typeCtor:t,propertyKey:i,parameterIndex:null,index:e})}}const Gi=e=>(t,r,i)=>{Vi(t,"inputs",{inputCtor:e,propertyKey:r,parameterIndex:i})},Ui=e=>(t,r)=>{Vi(t,"uniforms",{typeCtor:e,propertyKey:r})},ji=e=>(t,r)=>{Vi(t,"options",{typeCtor:e,propertyKey:r})},Wi=(e,t)=>{Vi(e,"defines",{propertyKey:t})};const Yi=(e,t)=>(r,i)=>{r.constructor.builtins.push({builtin:e,propertyKey:i,typeCtor:t})};class Xi{}Xi.builtins=[],(0,Nt._)([Yi("gl_VertexID",Nr)],Xi.prototype,"glVertexID",void 0);class Hi{}class Zi{}Zi.builtins=[],(0,Nt._)([Yi("gl_FragCoord",kr)],Zi.prototype,"glFragCoord",void 0),(0,Nt._)([Yi("gl_PointCoord",Ar)],Zi.prototype,"glPointCoord",void 0);class Qi{}class Ki{constructor(){this.type="uniform-group"}get _uniforms(){var e;return null!==(e=this.constructor.uniforms)&&void 0!==e?e:[]}}class Ji{constructor(){this.logShader=!1,this.computeAttributes={}}get vertexInput(){const e=this._shaderModuleClass.inputs.findLast((e=>"vertex"===e.propertyKey&&0===e.parameterIndex));if(!e)throw new Error("Unable to find vertex input parameter");return e}get computeInput(){return this._shaderModuleClass.inputs.findLast((e=>"vertex"===e.propertyKey&&1===e.parameterIndex))}get fragmentInput(){const e=this._shaderModuleClass.inputs.findLast((e=>"fragment"===e.propertyKey));if(!e)throw new Error("Unable to find fragment input parameter");return e}get transformFeedbackBindings(){var e;return null!==(e=this.fragmentInput.inputCtor.transformFeedbackBindings)&&void 0!==e?e:[]}get locations(){var e,t;return[...this.vertexInput.inputCtor.locations,...null!==(e=null===(t=this.computeInput)||void 0===t?void 0:t.inputCtor.locations)&&void 0!==e?e:[]]}get locationsMap(){const e=new Map,t=new Set;for(const r of this.locations)t.has(r.index)?W.A.getLogger("esri.views.2d.engine.webgl.shaderGraph.GraphShaderModule").warnOnce("mapview-rendering","Unable to assigned attribute ".concat(r.propertyKey," to ").concat(r.index,". Index already in use"),{locationsMap:e}):(e.set(r.propertyKey,r.index),t.add(r.index));return e}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map((e=>{let[t,r]=e;return"".concat(t,".").concat(r)})).join("."),r=(0,j.Wm)(t),i=this.computeAttributes;this._locationInfo={hash:r,locations:e,computeAttributeMap:i}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const t of this.locations)e.set("a_"+t.propertyKey,t.index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set;for(const t of this._options)e.add(t.propertyKey);this._optionPropertyKeys=e}return this._optionPropertyKeys}get _shaderModuleClass(){return this.constructor}get _defines(){var e;return null!==(e=this._shaderModuleClass.defines)&&void 0!==e?e:[]}get _options(){var e;return null!==(e=this._shaderModuleClass.options)&&void 0!==e?e:[]}get _uniforms(){var e;return null!==(e=this._shaderModuleClass.uniforms)&&void 0!==e?e:[]}getProgram(e,t,r,i){try{const{vertex:s,fragment:n,uniformBindings:o}=this._generateShaders(e,t,r,i);return new Ni(s,n,this.renamedLocationsMap,this.locationInfo,o,this.transformFeedbackBindings)}catch(s){return new Ni("","",this.renamedLocationsMap,this.locationInfo,[],this.transformFeedbackBindings)}}getDebugUniformClassInfo(e){const t=this._options.find((t=>t.propertyKey===e));if(t)return{type:"option",className:t.typeCtor};const r=this._uniforms.find((t=>t.propertyKey===e));if(!r)throw new Error("Unable to find uniform class type for property: ".concat(e));return{type:"required",className:r.typeCtor}}getShaderKey(e,t,r,i){const s=Object.keys(e).map((t=>"".concat(t,".").concat(e[t]))).join("."),n=Object.keys(r).map((e=>"".concat(e,".").concat(r[e]))).join("."),o=Object.keys(i).map((e=>"".concat(e,".").concat(i[e]))).join("."),a=Object.keys(t).filter((e=>this.optionPropertyKeys.has(e)&&t[e])).join(".");return"".concat(this.constructor.name,".").concat(s,".").concat(n,".").concat(o,".").concat(a)}_generateShaders(e,t,r,i){const s=[];this._setDefines(r),this._setOptionalUniforms(s,t),this._setRequiredUniforms(s);const n=this._hydrateVertexInput(i),o=this._injectPackPrecisionFactor(n,e),a=this._hydrateComputeInput(),c=a&&this._injectComputePackPrecisionFactor(a,e),l=this.vertex(o,c),u=this._hydrateFragmentInput(l),d=this.fragment(u),h=new Set;for(const m in d){Kt(h,d[m])}const p=this._getVertexInputBuiltins(),f=Ri.createVertex((0,m.A)((0,m.A)({},n),a),l,p,s,this.transformFeedbackBindings,h);(new Pi).write(f);const _=this._getFragmentInputBuiltins(d);_.set("glPointCoord","gl_PointCoord");const y=Ri.createFragment(u,d,_,s,f,this.transformFeedbackBindings);(new Pi).write(y);const g=this._createShaderBuilder(f,y),x=g.generate("vertex",!0),v=g.generate("fragment",!0);return this.logShader&&(console.log(x),console.log(v)),{vertex:x,fragment:v,uniformBindings:s}}_setDefines(e){for(const t in e)this[t]=e[t]}_setOptionalUniforms(e,t){for(const r of this._options)t[r.propertyKey]?this[r.propertyKey]=this._hydrateUniformGroup(e,r):this[r.propertyKey]=null}_setRequiredUniforms(e){for(const t of this._uniforms)this[t.propertyKey]=this._hydrateUniformGroup(e,t)}_hydrateUniformGroup(e,t){const r=new(0,t.typeCtor);for(const s of null!==(i=r._uniforms)&&void 0!==i?i:[]){var i;const n=Bi(s.typeCtor),o="u_".concat(t.propertyKey,"_").concat(s.propertyKey),a=n.type,c=[t.propertyKey,s.propertyKey].join(".");if("type"in s.typeCtor&&"array"===s.typeCtor.type){const t=n;e.push({shaderModulePath:c,uniformName:o,uniformType:a,uniformArrayLength:t.size,uniformArrayElementType:t.elementType.type,uniformHydrated:n})}else e.push({shaderModulePath:c,uniformName:o,uniformType:a,uniformHydrated:n});r[s.propertyKey]=n}return r}_hydrateVertexInput(e){const t=this.vertexInput.inputCtor,r=t.locations.reduce(((t,r)=>!1===e[r.propertyKey]?t:(0,m.A)((0,m.A)({},t),{},{[r.propertyKey]:Bi(r.typeCtor)})),{});for(const{propertyKey:i,typeCtor:s}of t.builtins){const e=Bi(s);r[i]=e}return r}_hydrateComputeInput(){return null==this.computeInput?null:this.computeInput.inputCtor.locations.reduce(((e,t)=>(0,m.A)((0,m.A)({},e),{},{[t.propertyKey]:Bi(t.typeCtor)})),{})}_injectPackPrecisionFactor(e,t){const r={};for(const i in e){const s=e[i],n=t[i];if(n){if("float"!==s.type&&"vec2"!==s.type&&"vec3"!==s.type&&"vec4"!==s.type)throw new Error("InternalError: packPrecisionFactor requires GenType, but found ".concat(s.type));r[i]=s.divide(new Tr(n))}else r[i]=s}return r}_injectComputePackPrecisionFactor(e,t){const r={},i=new Map;for(const n in this.computeAttributes)for(const e of null!==(s=this.computeAttributes[n])&&void 0!==s?s:[]){var s;i.set(e,n)}for(const n in e){const s=e[n],o=i.get(n);if(!o)continue;const a=t[o];if(a){if("float"!==s.type&&"vec2"!==s.type&&"vec3"!==s.type&&"vec4"!==s.type)throw new Error("InternalError: packPrecisionFactor requires GenType, but found ".concat(s.type));r[n]=s.divide(new Tr(a))}else r[n]=s}return r}_hydrateFragmentInput(e){const t={};for(const r in e)t[r]=e[r];for(const{propertyKey:r,typeCtor:i}of Zi.builtins){const e=Bi(i);t[r]=e}return t}_getVertexInputBuiltins(){const e=this.vertexInput.inputCtor,t=new Map;for(const{builtin:r,propertyKey:i}of e.builtins)t.set(i,r);return t}_getFragmentInputBuiltins(e){const t=e.constructor,r=new Map;for(const s of null!==(i=t.builtins)&&void 0!==i?i:[]){var i;r.set(s.propertyKey,s.builtin)}return r}_createShaderBuilder(e,t){const r=new Gt;return this._insertDebugInfo(r),e.insertVertexShader(r),t.insertFragmentShader(r),r}_insertDebugInfo(e){e.vertex.code.add("// DEFINES: "),e.vertex.code.add("// --------------------------------------------------------- ");for(const t of this._defines)this[t.propertyKey]?e.vertex.code.add("//   ".concat(t.propertyKey,": true")):e.vertex.code.add("//   ".concat(t.propertyKey,": false"));e.vertex.code.add(""),e.vertex.code.add("// OPTIONS: "),e.vertex.code.add("// --------------------------------------------------------- ");for(const t of this._options)this[t.propertyKey]?e.vertex.code.add("//   ".concat(t.propertyKey,": true")):e.vertex.code.add("//   ".concat(t.propertyKey,": false"))}}function $i(e){const t=Xr(12.9898),r=Xr(78.233),i=Xr(43758.5453);return bi(ki(Ai(vi(e,Hr(t,r)),Xr(3.14))).multiply(i))}function es(e){return ui(e,Xr(Oe))}function ts(e,t){const r=Xr(2**t);return Ai(function(e){return $r("floor",e)}(e.divide(r)),Xr(2))}function rs(e,t){return ts(e,t+_.U5)}function is(e){const t=ts(e.z,7),r=Xr(1).subtract(t),i=e.xyz.subtract(function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return new Mr(...t)}(0,0,Xr(128)));return r.multiply(e).add(t.multiply(i))}class ss extends Ki{getVisualVariableData(e){if(!this._vvData){const t=this.getAttributeDataCoords(e);this._vvData=Ei(this.visualVariableData,t).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(e){if(!this._uv){const t=is(e),r=this.size,i=Yr(t.x),s=Yr(t.y).multiply(Yr(256)),n=Yr(t.z).multiply(Yr(256)).multiply(Yr(256)),o=Xr(i.add(s).add(n)),a=Ai(o,r),c=o.subtract(a).divide(r);this._uv=new Ar(a,c).add(.5).divide(r)}return this._uv}getFilterData(e){const t=this.getAttributeDataCoords(e);return Ei(this.filterFlags,t).setDebugName("storage0")}getAnimationData(e){const t=this.getAttributeDataCoords(e);return Ei(this.animation,t).setDebugName("storage1")}getVVData(e){return this.getVisualVariableData(e)}getDataDrivenData0(e){const t=this.getAttributeDataCoords(e);return Ei(this.dataDriven0,t).setDebugName("storage30")}getDataDrivenData1(e){const t=this.getAttributeDataCoords(e);return Ei(this.dataDriven1,t).setDebugName("storage31")}getDataDrivenData2(e){const t=this.getAttributeDataCoords(e);return Ei(this.dataDriven2,t).setDebugName("storage32")}getGPGPUData(e){const t=this.getAttributeDataCoords(e);return Ei(this.gpgpu,t).setDebugName("storage4")}getLocalTimeOrigin(e){const t=this.getAttributeDataCoords(e);return Ei(this.localTimeOrigin,t).x.setDebugName("storage5")}getFilterFlags(e){return(0,n.A)("webgl-ignores-sampler-precision")?function(e){return $r("ceil",e)}(this.getFilterData(e).x.multiply(Xr(255))):this.getFilterData(e).x.multiply(Xr(255))}getLabelVisibility(e){const t=this.getFilterData(e).y.multiply(255);return new Tr(1).subtract(t)}getAnimationValue(e){return this.getAnimationData(e).x}getSizeValue(e){return this.getVisualVariableData(e).x}getColorValue(e){return this.getVisualVariableData(e).y}getOpacityValue(e){return this.getVisualVariableData(e).z}getRotationValue(e){return this.getVisualVariableData(e).w}}(0,Nt._)([Ui(Sr)],ss.prototype,"filterFlags",void 0),(0,Nt._)([Ui(Sr)],ss.prototype,"animation",void 0),(0,Nt._)([Ui(Sr)],ss.prototype,"gpgpu",void 0),(0,Nt._)([Ui(Sr)],ss.prototype,"localTimeOrigin",void 0),(0,Nt._)([Ui(Sr)],ss.prototype,"visualVariableData",void 0),(0,Nt._)([Ui(Sr)],ss.prototype,"dataDriven0",void 0),(0,Nt._)([Ui(Sr)],ss.prototype,"dataDriven1",void 0),(0,Nt._)([Ui(Sr)],ss.prototype,"dataDriven2",void 0),(0,Nt._)([Ui(Tr)],ss.prototype,"size",void 0);class ns extends Ki{}(0,Nt._)([Ui(Tr)],ns.prototype,"activeReasons",void 0),(0,Nt._)([Ui(Tr)],ns.prototype,"highlightAll",void 0);class os extends Ki{}(0,Nt._)([Ui(Ar)],os.prototype,"position",void 0),(0,Nt._)([Ui(Tr)],os.prototype,"distance",void 0),(0,Nt._)([Ui(Tr)],os.prototype,"smallSymbolDistance",void 0),(0,Nt._)([Ui(Tr)],os.prototype,"smallSymbolSizeThreshold",void 0);class as extends Ki{}(0,Nt._)([Ui(Ur)],as.prototype,"displayViewScreenMat3",void 0),(0,Nt._)([Ui(Ur)],as.prototype,"displayViewMat3",void 0),(0,Nt._)([Ui(Ur)],as.prototype,"displayMat3",void 0),(0,Nt._)([Ui(Ur)],as.prototype,"viewMat3",void 0),(0,Nt._)([Ui(Ur)],as.prototype,"tileMat3",void 0),(0,Nt._)([Ui(Tr)],as.prototype,"displayZoomFactor",void 0),(0,Nt._)([Ui(Tr)],as.prototype,"requiredZoomFactor",void 0),(0,Nt._)([Ui(Ar)],as.prototype,"tileOffset",void 0),(0,Nt._)([Ui(Tr)],as.prototype,"currentScale",void 0),(0,Nt._)([Ui(Tr)],as.prototype,"currentZoom",void 0),(0,Nt._)([Ui(Tr)],as.prototype,"metersPerSRUnit",void 0),(0,Nt._)([Ui(Tr)],as.prototype,"rotation",void 0),(0,Nt._)([Ui(Tr)],as.prototype,"pixelRatio",void 0);class cs extends Xi{}(0,Nt._)([qi(0,Mr)],cs.prototype,"id",void 0),(0,Nt._)([qi(1,Tr)],cs.prototype,"bitset",void 0),(0,Nt._)([qi(2,Ar)],cs.prototype,"pos",void 0);class ls extends Hi{}(0,Nt._)([qi(14,Ar)],ls.prototype,"nextPos1",void 0),(0,Nt._)([qi(15,Ar)],ls.prototype,"nextPos2",void 0);class us extends Zi{}class ds extends Ji{clip(e,t){let r=new Tr(0);const i=this.storage.getFilterFlags(e);if(r=r.add(Xr(2).multiply(Xr(1).subtract(rs(i,0)))),this.inside?r=r.add(Xr(2).multiply(Xr(1).subtract(rs(i,1)))):this.outside?r=r.add(Xr(2).multiply(rs(i,1))):this.highlight&&(r=r.add(Xr(2).multiply(Xr(1).subtract(this._checkHighlight(i))))),null!=t){const e=new Tr(1).subtract(Fi(t.x,this.view.currentZoom)),i=Fi(t.y,this.view.currentZoom);r=r.add(new Tr(2).multiply(e.add(i)))}return r}getFragmentOutput(e,t){var r,i;let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Tr(1/255);const n=new Qi;return n.glFragColor=null!==(r=null!==(i=this._maybeWriteHittest(t))&&void 0!==i?i:this._maybeHighlight(e,s))&&void 0!==r?r:e,n}_maybeHighlight(e,t){return this.highlight?new kr(e.rgb,Fi(t,e.a)):null}_checkHighlight(e){let t=this._checkHighlightBit(e,0);for(let r=1;r<_.U5;r++)t=t.add(this._checkHighlightBit(e,r));return Fi(new Tr(.1),t.add(this.highlight.highlightAll))}_checkHighlightBit(e,t){return function(e,t){return ts(e,t)}(e,t).multiply(ts(this.highlight.activeReasons,t))}maybeRunHittest(e,t,r){if(null==this.hittestRequest)return null;let i=si(hi(this.hittest(e,t,r),this.hittestRequest.distance),new Tr(2),new Tr(0));const s=function(e){return e.multiply(2).subtract(1)}(this.storage.getAttributeDataCoords(e.id));i=i.add(this.clip(e.id,e.zoomRange));const n=new kr(new Tr(1/255),0,0,0);return{glPointSize:new Tr(1),glPosition:new kr(s,i,1),color:n}}_maybeWriteHittest(e){return null!=this.hittestRequest?e.color:null}}function hs(e,t){return vi(e,function(e){return $r("normalize",e)}(t))}function ps(e,t,r){const i=r.subtract(t),s=gi(hs(e.subtract(t),i).divide(wi(i)),new Tr(0),new Tr(1));return function(e,t){return ei("distance",e,t,Tr)}(e,t.add(s.multiply(r.subtract(t))))}function fs(e){const t=function(e){return $r("abs",e)}(e);return Fi(t.x.add(t.y).add(t.z),new Tr(1.05))}function _s(e,t,r,i){return ui(fs(function(e,t,r,i){const s=new Ur(r.x.multiply(i.y).subtract(i.x.multiply(r.y)),i.x.multiply(t.y).subtract(t.x.multiply(i.y)),t.x.multiply(r.y).subtract(r.x.multiply(t.y)),r.y.subtract(i.y),i.y.subtract(t.y),t.y.subtract(r.y),i.x.subtract(r.x),t.x.subtract(i.x),r.x.subtract(t.x)),n=t.x.multiply(r.y.subtract(i.y)),o=r.x.multiply(i.y.subtract(t.y)),a=i.x.multiply(t.y.subtract(r.y)),c=n.add(o).add(a);return new Tr(1).divide(c).multiply(s.multiply(new Mr(1,e)))}(e,t,r,i)),new Tr(1))}function ys(e,t,r,i){const s=function(e,t){return e.x.multiply(t.y).subtract(t.x.multiply(e.y))}(r.subtract(t),i.subtract(t)),n=_i(function(e,t){return Jr("<",e,t,zr)}(s,new Tr(ze)),hi(s,new Tr(-ze)));return ni([_i(Mi(n),_s(e.xy,t,r,i)),new Tr(-1)],[!0,()=>{const s=ps(e,t,r),n=ps(e,r,i),o=ps(e,i,t);return Si(Si(s,n),o)}])}function ms(e){return e.distance.add(1)}function gs(e,t,r){const{viewMat3:i,tileMat3:s}=e.view,n=i.multiply(s),o=n.multiply(new Mr(t.pos,1)),a=n.multiply(new Mr(r.nextPos1,1)),c=n.multiply(new Mr(r.nextPos2,1));return ys(e.hittestRequest.position,o.xy,a.xy,c.xy)}(0,Nt._)([Wi],ds.prototype,"inside",void 0),(0,Nt._)([Wi],ds.prototype,"outside",void 0),(0,Nt._)([ji(ns)],ds.prototype,"highlight",void 0),(0,Nt._)([Ui(ss)],ds.prototype,"storage",void 0),(0,Nt._)([Ui(as)],ds.prototype,"view",void 0),(0,Nt._)([ji(os)],ds.prototype,"hittestRequest",void 0);class xs extends Ki{getColor(e,t,r){return ni([fi(es(e),r),t],[di(e,this.values.first()),this.colors.first()],[pi(e,this.values.last()),this.colors.last()],[!0,()=>{const t=this.values.findIndex((t=>hi(t,e))),r=this.values.get(t),i=t.subtract(1),s=this.values.get(i),n=e.subtract(s).divide(r.subtract(s));return Ti(this.colors.get(i),this.colors.get(t),n)}])}}(0,Nt._)([Ui(Ir.ofType(kr,8))],xs.prototype,"colors",void 0),(0,Nt._)([Ui(Ir.ofType(Tr,8))],xs.prototype,"values",void 0);class vs extends Ki{getOpacity(e){return ni([es(e),new Tr(1)],[di(e,this.opacityValues.first()),this.opacities.first()],[pi(e,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const t=this.opacityValues.findIndex((t=>hi(t,e))),r=this.opacityValues.get(t),i=t.subtract(1),s=this.opacityValues.get(i),n=e.subtract(s).divide(r.subtract(s));return Ti(this.opacities.get(i),this.opacities.get(t),n)}])}}function bs(e){return null!=e.visualVariableSizeMinMaxValue||null!=e.visualVariableSizeScaleStops||null!=e.visualVariableSizeStops||null!=e.visualVariableSizeUnitValue}function ws(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new zr(!1);if(null==e.visualVariableColor)return r;const s=e.storage.getColorValue(t);return e.visualVariableColor.getColor(s,r,i)}function Is(e,t){if(null==e.visualVariableOpacity)return new Tr(1);const r=e.storage.getOpacityValue(t);return e.visualVariableOpacity.getOpacity(r)}(0,Nt._)([Ui(Ir.ofType(Tr,8))],vs.prototype,"opacities",void 0),(0,Nt._)([Ui(Ir.ofType(Tr,8))],vs.prototype,"opacityValues",void 0);class Ss extends cs{}(0,Nt._)([qi(3,kr)],Ss.prototype,"color",void 0),(0,Nt._)([qi(4,Ar)],Ss.prototype,"zoomRange",void 0);class Ts extends ds{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const r=Is(this,e.id),i=ws(this,e.id,e.color).multiply(r),s=this.view.displayViewScreenMat3.multiply(new Mr(e.pos.xy,1)),n=this.clip(e.id,e.zoomRange);return(0,m.A)({glPosition:new kr(s.xy,n,1),color:i},this.maybeRunHittest(e,t,null))}fragment(e){return this.getFragmentOutput(e.color,e,new Tr(0))}hittest(e,t){return gs(this,e,t)}}(0,Nt._)([ji(xs)],Ts.prototype,"visualVariableColor",void 0),(0,Nt._)([ji(vs)],Ts.prototype,"visualVariableOpacity",void 0),(0,Nt._)([(0,Nt.a)(0,Gi(Ss)),(0,Nt.a)(1,Gi(ls))],Ts.prototype,"vertex",null),(0,Nt._)([(0,Nt.a)(0,Gi(us))],Ts.prototype,"fragment",null);class As extends Ki{getPatternOffsetAtTileOrigin(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Tr(0),r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Tr(1);const i=new Ar(16777216).divide(e);let s=e.multiply(bi(this.maxIntsToLocalOrigin.multiply(i))).add(this.tileOffsetFromLocalOrigin).subtract(new Tr(.5).multiply(e));return s=new Ar(s.x.multiply(r).subtract(s.y.multiply(t)),s.x.multiply(t).add(s.y.multiply(r))),Ai(s,e)}}(0,Nt._)([Ui(Ar)],As.prototype,"tileOffsetFromLocalOrigin",void 0),(0,Nt._)([Ui(Ar)],As.prototype,"maxIntsToLocalOrigin",void 0);class Ms extends Ki{}(0,Nt._)([Ui(Ar)],Ms.prototype,"size",void 0),(0,Nt._)([Ui(Sr)],Ms.prototype,"texture",void 0);class ks extends Ss{}(0,Nt._)([qi(5,kr)],ks.prototype,"tlbr",void 0),(0,Nt._)([qi(6,Tr)],ks.prototype,"width",void 0),(0,Nt._)([qi(7,Tr)],ks.prototype,"height",void 0),(0,Nt._)([qi(8,Ar)],ks.prototype,"offset",void 0),(0,Nt._)([qi(9,Ar)],ks.prototype,"scale",void 0),(0,Nt._)([qi(10,Tr)],ks.prototype,"angle",void 0);function Fs(e,t,r,i,s){const n=ui(ts(s,Re),Xr(1)),o=function(e){return vi(e,Zr(255/256,255/65536,255/16777216,255/4294967296))}(new kr(e,0));return si(n,Qr(i.divide(t.x),r.divide(t.y),0,ri(r.divide(t.x)),i.divide(t.y),0,$i(Hr(o,0)),$i(Hr(0,o)),1),Qr(i.divide(t.x),r.divide(t.y),0,ri(r.divide(t.x)),i.divide(t.y),0,0,0,1))}function Es(e,t){const r=e.view.requiredZoomFactor,i=new Ar(t.width,t.height),s=i.multiply(t.scale).multiply(r),n=t.angle.multiply(Fe),o=ki(n),a=xi(n),c=Fs(t.id,s,o,a,t.bitset),l=e.localTileOffset.getPatternOffsetAtTileOrigin(i,o,a),u=r.multiply(t.scale).multiply(t.offset.subtract(l)).divide(s),d=new Mr(t.pos,1),h=c.multiply(d).xy.subtract(u),p=t.tlbr.divide(e.mosaicInfo.size.xyxy);let f=ts(t.bitset,4);return null!=e.visualVariableColor&&(f=si(es(e.storage.getColorValue(t.id)),new Tr(0),f)),{tileTextureCoord:h,tlbr:p,sampleAlphaOnly:f}}function Cs(e,t){const r=Ai(t.tileTextureCoord,new Tr(1)),i=Ti(t.tlbr.xy,t.tlbr.zw,r);let s=Ei(e.mosaicInfo.texture,i);return s=si(hi(t.sampleAlphaOnly,new Tr(.5)),s.aaaa,s),t.color.multiply(s)}class Ps extends Ts{vertex(e,t){return(0,m.A)((0,m.A)({},super.vertex(e,t)),Es(this,e))}fragment(e){const t=Cs(this,e);return this.getFragmentOutput(t,e,new Tr(0))}}(0,Nt._)([Ui(Ms)],Ps.prototype,"mosaicInfo",void 0),(0,Nt._)([Ui(As)],Ps.prototype,"localTileOffset",void 0),(0,Nt._)([(0,Nt.a)(0,Gi(ks)),(0,Nt.a)(1,Gi(ls))],Ps.prototype,"vertex",null),(0,Nt._)([(0,Nt.a)(0,Gi(class extends us{}))],Ps.prototype,"fragment",null);class zs extends Ki{getSize(e,t){const r=this.minMaxValueAndSize.xy,i=this.minMaxValueAndSize.zw;return si(es(e),t,(()=>{const t=gi(e.subtract(r.x).divide(r.y.subtract(r.x)),new Tr(0),new Tr(1));return i.x.add(t.multiply(i.y.subtract(i.x)))}))}}(0,Nt._)([Ui(kr)],zs.prototype,"minMaxValueAndSize",void 0);class Os extends Ki{getSizeForViewScale(e){return ni([di(e,this.values.first()),this.sizes.first()],[pi(e,this.values.last()),this.sizes.last()],[!0,()=>{const t=this.values.findIndex((t=>hi(t,e))),r=this.values.get(t),i=t.subtract(1),s=this.values.get(i),n=e.subtract(s).divide(r.subtract(s));return Ti(this.sizes.get(i),this.sizes.get(t),n)}])}}(0,Nt._)([Ui(Ir.ofType(Tr,8))],Os.prototype,"sizes",void 0),(0,Nt._)([Ui(Ir.ofType(Tr,8))],Os.prototype,"values",void 0);class Rs extends Ki{getSize(e,t){const r=ni([es(e),t],[di(e,this.values.first()),this.sizes.first()],[pi(e,this.values.last()),this.sizes.last()],[!0,()=>{const t=this.values.findIndex((t=>hi(t,e))),r=this.values.get(t),i=t.subtract(1),s=this.values.get(i),n=e.subtract(s).divide(r.subtract(s));return Ti(this.sizes.get(i),this.sizes.get(t),n)}]);return si(es(r),t,r)}}(0,Nt._)([Ui(Ir.ofType(Tr,8))],Rs.prototype,"sizes",void 0),(0,Nt._)([Ui(Ir.ofType(Tr,8))],Rs.prototype,"values",void 0);class Ds extends Ki{getSize(e,t){return si(es(e),t,e.multiply(this.unitValueToPixelsRatio))}}(0,Nt._)([Ui(Tr)],Ds.prototype,"unitValueToPixelsRatio",void 0);class Ls extends cs{}(0,Nt._)([qi(3,kr)],Ls.prototype,"color",void 0),(0,Nt._)([qi(4,Ar)],Ls.prototype,"offset",void 0),(0,Nt._)([qi(5,Ar)],Ls.prototype,"normal",void 0),(0,Nt._)([qi(6,Tr)],Ls.prototype,"halfWidth",void 0),(0,Nt._)([qi(7,Tr)],Ls.prototype,"referenceHalfWidth",void 0),(0,Nt._)([qi(8,Ar)],Ls.prototype,"zoomRange",void 0);class Ns extends us{}class Bs extends Ki{}function Vs(e){return Ii(new Tr(Ee).multiply(Fi(e,new Tr(Ce))),new Tr(1))}function qs(e,t){const{id:r,halfWidth:i,referenceHalfWidth:s}=t;if(bs(e)){const t=function(e,t,r){if(bs(e)){var i,s,n,o,a,c,l;const u=e.storage.getSizeValue(t);return null!==(i=null!==(s=null!==(n=null===(o=e.visualVariableSizeMinMaxValue)||void 0===o?void 0:o.getSize(u,r))&&void 0!==n?n:null===(a=e.visualVariableSizeScaleStops)||void 0===a?void 0:a.getSizeForViewScale(e.view.currentScale))&&void 0!==s?s:null===(c=e.visualVariableSizeStops)||void 0===c?void 0:c.getSize(u,r))&&void 0!==i?i:null===(l=e.visualVariableSizeUnitValue)||void 0===l?void 0:l.getSize(u,r)}return r}(e,r,new Tr(2).multiply(s));return new Tr(.5).multiply(i.divide(Ii(s,new Tr(Pe)))).multiply(t)}return i}function Gs(e,t){const{id:r,offset:i,pos:s,normal:n,zoomRange:o}=t,{displayViewScreenMat3:a,displayViewMat3:c}=e.view,l=ws(e,r,t.color),u=Is(e,r),d=qs(e,t),h=new Tr(.5).multiply(e.antialiasingControls.antialiasing),p=Ii(d.add(h),new Tr(.45)).add(new Tr(.1).multiply(h)),f=Vs(p).multiply(p).multiply(i),_=c.multiply(new Mr(f,new Tr(0))),y=a.multiply(new Mr(s,new Tr(1))).add(_),m=new Tr(2).multiply(Fi(d,new Tr(0))).add(e.clip(r,o)),g=new kr(y.xy,m,1);return{color:l,opacity:u,halfWidth:p,normal:n,scaledOffset:f,scaledHalfWidth:d,glPosition:new kr(g.xy,m,1)}}function Us(e,t){const{opacity:r,color:i}=e,s=function(e,t){const{halfWidth:r,normal:i}=e,s=Vs(r),n=wi(i).multiply(r);return gi(s.multiply(r.subtract(n)).divide(t.add(s).subtract(new Tr(1))),new Tr(0),new Tr(1))}(e,t);return r.multiply(i).multiply(s)}(0,Nt._)([Ui(Tr)],Bs.prototype,"antialiasing",void 0),(0,Nt._)([Ui(Tr)],Bs.prototype,"blur",void 0);class js extends ds{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const r=Gs(this,e);return(0,m.A)((0,m.A)({},r),this.maybeRunHittest(e,t,r.halfWidth))}fragment(e){const t=Us(e,this.antialiasingControls.blur);return this.getFragmentOutput(t,e)}hittest(e,t,r){const{viewMat3:i,tileMat3:s}=this.view,n=i.multiply(s),o=n.multiply(new Mr(e.pos,1)),a=n.multiply(new Mr(t.nextPos1,1)),c=n.multiply(new Mr(t.nextPos2,1)),{distance:l,smallSymbolDistance:u,smallSymbolSizeThreshold:d}=this.hittestRequest,h=Fi(r,d.multiply(.5)).multiply(l.subtract(u)),p=this.hittestRequest.position;return Si(ps(p,o.xy,a.xy),ps(p,o.xy,c.xy)).subtract(r).add(h)}}(0,Nt._)([Ui(Bs)],js.prototype,"antialiasingControls",void 0),(0,Nt._)([ji(xs)],js.prototype,"visualVariableColor",void 0),(0,Nt._)([ji(vs)],js.prototype,"visualVariableOpacity",void 0),(0,Nt._)([ji(zs)],js.prototype,"visualVariableSizeMinMaxValue",void 0),(0,Nt._)([ji(Os)],js.prototype,"visualVariableSizeScaleStops",void 0),(0,Nt._)([ji(Rs)],js.prototype,"visualVariableSizeStops",void 0),(0,Nt._)([ji(Ds)],js.prototype,"visualVariableSizeUnitValue",void 0),(0,Nt._)([(0,Nt.a)(0,Gi(Ls)),(0,Nt.a)(1,Gi(ls))],js.prototype,"vertex",null),(0,Nt._)([(0,Nt.a)(0,Gi(Ns))],js.prototype,"fragment",null);class Ws extends cs{}(0,Nt._)([qi(3,Ar)],Ws.prototype,"offset",void 0),(0,Nt._)([qi(4,kr)],Ws.prototype,"color",void 0),(0,Nt._)([qi(5,Ar)],Ws.prototype,"normal",void 0),(0,Nt._)([qi(6,Tr)],Ws.prototype,"halfWidth",void 0),(0,Nt._)([qi(7,Tr)],Ws.prototype,"referenceHalfWidth",void 0),(0,Nt._)([qi(8,Ar)],Ws.prototype,"zoomRange",void 0);class Ys extends Ns{}function Xs(e,t,r){const{id:i,bitset:s}=t,n=ts(s,0),o=hi(n,new Tr(.5)),a=Gs(e,t),c=si(o,a.halfWidth,new Tr(0)),l=Is(e,i),u=ws(e,i,t.color),d=si(o,t.color,u.multiply(l)),h=e.view.displayViewScreenMat3.multiply(new Mr(t.pos.xy,1)),p=e.clip(t.id),f=new kr(h.xy,p,1),_=si(o,a.glPosition,f),y=r&&e.maybeRunHittest(t,r,o);return(0,m.A)({isOutline:n,color:d,opacity:new Tr(1),halfWidth:c,normal:a.normal,glPosition:_},y)}class Hs extends ds{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}}(0,Nt._)([Ui(Bs)],Hs.prototype,"antialiasingControls",void 0),(0,Nt._)([ji(xs)],Hs.prototype,"visualVariableColor",void 0),(0,Nt._)([ji(vs)],Hs.prototype,"visualVariableOpacity",void 0),(0,Nt._)([ji(zs)],Hs.prototype,"visualVariableSizeMinMaxValue",void 0),(0,Nt._)([ji(Os)],Hs.prototype,"visualVariableSizeScaleStops",void 0),(0,Nt._)([ji(Rs)],Hs.prototype,"visualVariableSizeStops",void 0),(0,Nt._)([ji(Ds)],Hs.prototype,"visualVariableSizeUnitValue",void 0);class Zs extends Hs{vertex(e,t){return Xs(this,e,t)}fragment(e){const{color:t,isOutline:r}=e,i=hi(r,new Tr(.5)),s=si(i,Us(e,this.antialiasingControls.blur),t),n=si(i,new Tr(1/255),new Tr(0));return this.getFragmentOutput(s,e,n)}hittest(e,t,r){return si(r,ms(this.hittestRequest),gs(this,e,t))}}(0,Nt._)([(0,Nt.a)(0,Gi(Ws)),(0,Nt.a)(1,Gi(ls))],Zs.prototype,"vertex",null),(0,Nt._)([(0,Nt.a)(0,Gi(Ys))],Zs.prototype,"fragment",null);class Qs extends Ss{}(0,Nt._)([qi(5,kr)],Qs.prototype,"tlbr",void 0),(0,Nt._)([qi(6,Tr)],Qs.prototype,"inverseRasterizationScale",void 0);function Ks(e,t){const r=t.tlbr.xy,i=t.tlbr.zw,s=i.x.subtract(r.x),n=r.y.subtract(i.y),o=new Ar(s,n).multiply(t.inverseRasterizationScale),a=o.multiply(e.view.requiredZoomFactor),c=function(e){const t=new Tr(1),r=new Tr(0);return new Ur(t.divide(e.x),r.divide(e.y),0,ri(r.divide(e.x)),t.divide(e.y),0,0,0,1)}(a),l=e.localTileOffset.getPatternOffsetAtTileOrigin(o).divide(a),u=new Mr(t.pos,1);return{tileTextureCoord:c.multiply(u).xy.subtract(l),tlbr:t.tlbr.divide(e.mosaicInfo.size.xyxy)}}function Js(e,t){const r=Ai(e.tileTextureCoord,new Tr(1)),i=Ti(e.tlbr.xy,e.tlbr.zw,r),s=Ei(t.texture,i);return e.color.multiply(s)}class $s extends Ts{vertex(e,t){return(0,m.A)((0,m.A)({},super.vertex(e,t)),Ks(this,e))}fragment(e){const t=Js(e,this.mosaicInfo);return this.getFragmentOutput(t,e,new Tr(0))}}(0,Nt._)([Ui(Ms)],$s.prototype,"mosaicInfo",void 0),(0,Nt._)([Ui(As)],$s.prototype,"localTileOffset",void 0),(0,Nt._)([(0,Nt.a)(0,Gi(Qs)),(0,Nt.a)(1,Gi(ls))],$s.prototype,"vertex",null),(0,Nt._)([(0,Nt.a)(0,Gi(class extends us{}))],$s.prototype,"fragment",null);class en extends Ws{}(0,Nt._)([qi(9,kr)],en.prototype,"tlbr",void 0),(0,Nt._)([qi(10,Tr)],en.prototype,"inverseRasterizationScale",void 0);class tn extends Ys{}class rn extends Zs{vertex(e,t){return(0,m.A)((0,m.A)({},Xs(this,e,t)),Ks(this,e))}fragment(e){const{isOutline:t}=e,r=hi(t,new Tr(.5)),i=si(r,Us(e,this.antialiasingControls.blur),Js(e,this.mosaicInfo)),s=si(r,new Tr(1/255),new Tr(0));return this.getFragmentOutput(i,e,s)}}(0,Nt._)([Ui(Ms)],rn.prototype,"mosaicInfo",void 0),(0,Nt._)([Ui(As)],rn.prototype,"localTileOffset",void 0),(0,Nt._)([(0,Nt.a)(0,Gi(en)),(0,Nt.a)(1,Gi(ls))],rn.prototype,"vertex",null),(0,Nt._)([(0,Nt.a)(0,Gi(tn))],rn.prototype,"fragment",null);const sn=1/16;class nn extends cs{}(0,Nt._)([qi(3,kr)],nn.prototype,"color",void 0),(0,Nt._)([qi(4,kr)],nn.prototype,"tlbr",void 0),(0,Nt._)([qi(5,Tr)],nn.prototype,"angle",void 0),(0,Nt._)([qi(6,Tr)],nn.prototype,"aux1",void 0),(0,Nt._)([qi(7,Tr)],nn.prototype,"aux2",void 0),(0,Nt._)([qi(8,Ar)],nn.prototype,"aux3",void 0),(0,Nt._)([qi(9,Ar)],nn.prototype,"aux4",void 0),(0,Nt._)([qi(10,Ar)],nn.prototype,"zoomRange",void 0);class on extends Hs{vertex(e,t){const{aux1:r,aux2:i,aux3:s,aux4:n}=e,o=(0,m.A)((0,m.A)({},e),{},{width:r,height:i,offset:s,scale:n.multiply(sn)}),a=Xs(this,(0,m.A)((0,m.A)({},e),{},{halfWidth:r,referenceHalfWidth:i,offset:s,normal:n.subtract(128).multiply(sn)})),c=Es(this,o),l=hi(a.isOutline,new Tr(.5));return(0,m.A)((0,m.A)((0,m.A)({},a),c),this.maybeRunHittest(e,t,l))}fragment(e){const{isOutline:t}=e,r=hi(t,new Tr(.5)),i=si(r,Us(e,this.antialiasingControls.blur),Cs(this,e)),s=si(r,new Tr(1/255),new Tr(0));return this.getFragmentOutput(i,e,s)}hittest(e,t,r){return si(r,ms(this.hittestRequest),gs(this,e,t))}}(0,Nt._)([Ui(Ms)],on.prototype,"mosaicInfo",void 0),(0,Nt._)([Ui(As)],on.prototype,"localTileOffset",void 0),(0,Nt._)([(0,Nt.a)(0,Gi(nn)),(0,Nt.a)(1,Gi(ls))],on.prototype,"vertex",null),(0,Nt._)([(0,Nt.a)(0,Gi(class extends tn{}))],on.prototype,"fragment",null);const an=Mt,cn=Rt,ln={createComputedParams:e=>e,optionalAttributes:an.optionalAttributes,attributes:(0,m.A)((0,m.A)({},an.attributes),{},{bitset:{type:X.pe.UNSIGNED_BYTE,count:1,pack:e=>At(e)},aux1:{count:1,type:X.pe.HALF_FLOAT,pack:e=>Tt(e).width},aux2:{count:1,type:X.pe.HALF_FLOAT,pack:e=>Tt(e).height},aux3:{count:2,type:X.pe.HALF_FLOAT,pack:e=>{let{offsetX:t,offsetY:r}=e;return[(0,u.Lz)(t),(0,u.Lz)(r)]}},aux4:{count:2,type:X.pe.UNSIGNED_BYTE,pack:e=>{let{scaleX:t,scaleY:r}=e;return[16*t,16*r]}}})},un={createComputedParams:e=>e,optionalAttributes:an.optionalAttributes,attributes:(0,m.A)((0,m.A)({},an.attributes),{},{color:cn.attributes.color,bitset:{type:X.pe.UNSIGNED_BYTE,count:1,pack:e=>se([[0,!0]])},aux1:{count:1,type:X.pe.HALF_FLOAT,pack:e=>(0,u.Lz)(.5*e.width)},aux2:{count:1,type:X.pe.HALF_FLOAT,pack:e=>(0,u.Lz)(.5*e.referenceWidth)},aux3:{count:2,type:X.pe.HALF_FLOAT,packTessellation:e=>{let{extrusionOffsetX:t,extrusionOffsetY:r}=e;return[t,r]}},aux4:{count:2,type:X.pe.UNSIGNED_BYTE,packTessellation:e=>{let{normalX:t,normalY:r}=e;return[16*t+128,16*r+128]}}})};class dn extends Dt{constructor(){super(...arguments),this.vertexSpec=un}}class hn extends Lt{constructor(){super(...arguments),this.vertexSpec=ln}_createOutlineWriter(e,t,r,i){return new dn(e,t,r,i)}_write(e,t,r){var i,s;const n=null!==(i=null===r||void 0===r?void 0:r.asOptimized())&&void 0!==i?i:t.readGeometryForDisplay(),o=this._clip(n);if(!o)return;const a=null===(s=this.evaluatedMeshParams.sprite)||void 0===s?void 0:s.textureBinding;e.recordStart(this.instanceId,this.attributeLayout,a),this._writeGeometry(e,t,o),this._lineMeshWriter.writeLineVertices(e,le.z.fromOptimizedCIM(o,"esriGeometryPolyline"),t),e.recordEnd()}ensurePacked(e,t,r){super.ensurePacked(e,t,r),this._lineMeshWriter.ensurePacked(e,t,r)}enqueueRequest(e,t,r){super.enqueueRequest(e,t,r),this._lineMeshWriter.enqueueRequest(e,t,r)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}const pn={optionalAttributes:It.optionalAttributes,createComputedParams:e=>e,attributes:(0,m.A)((0,m.A)({},It.attributes),Ot.attributes)},fn={optionalAttributes:It.optionalAttributes,createComputedParams:e=>e,attributes:(0,m.A)((0,m.A)({},It.attributes),Rt.attributes)};class _n extends Dt{constructor(){super(...arguments),this.vertexSpec=fn}}class yn extends Lt{constructor(){super(...arguments),this.vertexSpec=pn}_createOutlineWriter(e,t,r,i){return new _n(e,t,r,i)}_write(e,t,r){var i,s;const n=null!==(i=null===r||void 0===r?void 0:r.asOptimized())&&void 0!==i?i:t.readGeometryForDisplay(),o=this._clip(n);if(!o)return;const a=null===(s=this.evaluatedMeshParams.sprite)||void 0===s?void 0:s.textureBinding;e.recordStart(this.instanceId,this.attributeLayout,a),this._writeGeometry(e,t,o),this._lineMeshWriter.writeLineVertices(e,le.z.fromOptimizedCIM(o,"esriGeometryPolyline"),t),e.recordEnd()}ensurePacked(e,t,r){super.ensurePacked(e,t,r),this._lineMeshWriter.ensurePacked(e,t,r)}enqueueRequest(e,t,r){super.enqueueRequest(e,t,r),this._lineMeshWriter.enqueueRequest(e,t,r)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}const mn={createComputedParams:e=>e,optionalAttributes:{},attributes:{pos:{type:X.pe.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:X.pe.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:X.pe.UNSIGNED_BYTE,count:1},offset:{type:X.pe.BYTE,count:2,packAlternating:{count:4,pack:()=>[[-1,-1],[1,-1],[-1,1],[1,1]]}}}};class gn extends Te{constructor(){super(...arguments),this.vertexSpec=mn}_write(e,t){e.recordStart(this.instanceId,this.attributeLayout);const r=t.getDisplayId();if("esriGeometryPoint"===t.geometryType){const i=t.readXForDisplay(),s=t.readYForDisplay();this._writeQuad(e,r,i,s)}else if("esriGeometryMultipoint"===t.geometryType){const i=t.readGeometryForDisplay();null===i||void 0===i||i.forEachVertex(((t,i)=>{t>=0&&t<=512&&i>=0&&i<=512&&this._writeQuad(e,r,t,i)}))}e.recordEnd()}_writeQuad(e,t,r,i){const s=e.vertexCount();this._writeVertex(e,t,r,i),e.indexWrite(s+0),e.indexWrite(s+1),e.indexWrite(s+2),e.indexWrite(s+1),e.indexWrite(s+3),e.indexWrite(s+2)}}var xn=r(87663),vn=r(94967),bn=r(98006),wn=r(19555),In=r(59422),Sn=r(72745),Tn=r(98618),An=r(71447);const Mn=8388607,kn=8388608,Fn=e=>e&Mn;var En=r(19358);class Cn{constructor(e,t,r,i,s,n,o,a){let c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:[];this.entityTexel=e,this.anchorX=t,this.anchorY=r,this.directionX=i,this.directionY=s,this.maxScale=n,this.minScale=o,this.referenceBounds=a,this.bounds=c}serialize(e){e.push(this.entityTexel),e.writeF32(this.anchorX),e.writeF32(this.anchorY),e.writeF32(this.directionX),e.writeF32(this.directionY),e.writeF32(this.maxScale),e.writeF32(this.minScale),null===this.referenceBounds?(e.writeF32(0),e.writeF32(0),e.writeF32(0)):(e.writeF32(this.referenceBounds.size),e.writeF32(this.referenceBounds.offsetX),e.writeF32(this.referenceBounds.offsetY)),S(e,this.bounds)}static deserialize(e){var t;const r=e.readInt32(),i=e.readF32(),s=e.readF32(),n=e.readF32(),o=e.readF32(),a=e.readF32(),c=e.readF32(),l=e.readF32(),u=e.readF32(),d=e.readF32(),h=null!==(t=T(e,En.A))&&void 0!==t?t:[];return new Cn(r,i,s,n,o,a,c,{size:l,offsetX:u,offsetY:d},h)}}var Pn=r(77555);function zn(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e}function On(e,t){return Math.sqrt(e*e+t*t)}function Rn(e){const t=On(e[0],e[1]);e[0]/=t,e[1]/=t}function Dn(e,t){return On(e[0]-t[0],e[1]-t[1])}function Ln(e){return e.length-1}function Nn(e){let t=0;for(let r=0;r<Ln(e);r++)t+=Bn(e,r);return t}function Bn(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,[i,s]=function(e,t){return e[t+1]}(e,t);return[i,s]=[Math.round(i),Math.round(s)],Math.sqrt(i*i+s*s)*r}class Vn{constructor(e,t,r,i,s){this._segments=e,this._index=t,this._distance=r,this._xStart=i,this._yStart=s,this._done=!1}static create(e){return new Vn(e,0,0,e[0][0],e[0][1])}clone(){return new Vn(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(e){return this._index===e._index||e._index===this._index-1&&(0===this._distance||1===e._distance)||e._index===this._index+1&&(1===this._distance||0===e._distance)}leq(e){return this._index<e._index||this._index===e._index&&this._distance<=e._distance}geq(e){return this._index>e._index||this._index===e._index&&this._distance>=e._distance}get _segment(){return this._segments[this._index+1]}get angle(){const e=this.dy,t=(0*e+-1*-this.dx)/(1*this.length);let r=Math.acos(t);return e>0&&(r=2*Math.PI-r),r}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:e,dy:t}=this;return Math.sqrt(e*e+t*t)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Ln(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(e,t){const r=this.backwardLength;if(e<=r)return this._distance=(r-e)/this.length,this;let i=this.backwardLength;for(;this.prev();){if(i+this.length>e)return this._seekBackwards(e-i);i+=this.length}return this._distance=0,t?this:null}seek(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e<0)return this._seekBackwards(Math.abs(e),t);if(e<=this.remainingLength)return this._distance=(this.backwardLength+e)/this.length,this;let r=this.remainingLength;for(;this.next();){if(r+this.length>e)return this.seek(e-r,t);r+=this.length}return this._distance=1,t?this:null}}function qn(e,t,r){let i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const s=Nn(e),n=Vn.create(e),o=s/2;if(!i)return n.seek(o),void(Math.abs(n.x)<Pn.$u&&Math.abs(n.y)<Pn.$u&&r(n.clone(),0,o+0*t,s));const a=Math.max((s-t)/2,0),c=Math.floor(a/t),l=o-c*t;n.seek(l);for(let u=-c;u<=c;u++)Math.abs(n.x)<Pn.$u&&Math.abs(n.y)<Pn.$u&&r(n.clone(),u,o+u*t,s),n.seek(t)}function Gn(e,t){const r=t;for(let i=0;i<e.length;i++){let t=e[i];Un(t,r);const s=[];s.push(t[0]);for(let e=1;e<t.length;e++){const[r,i]=t[e-1],[n,o]=t[e],a=n-r,c=o-i;s.push([a,c])}e[i]=s,t=s}return e}function Un(e,t){const r=1e-6;if(t<=0)return;const i=e.length;if(i<3)return;const s=[];let n=0;s.push(0);for(let d=1;d<i;d++)n+=Dn(e[d],e[d-1]),s.push(n);t=Math.min(t,.2*n);const o=[];o.push(e[0][0]),o.push(e[0][1]);const a=e[i-1][0],c=e[i-1][1],l=zn([0,0],e[0],e[1]);Rn(l),e[0][0]+=t*l[0],e[0][1]+=t*l[1],zn(l,e[i-1],e[i-2]),Rn(l),e[i-1][0]+=t*l[0],e[i-1][1]+=t*l[1];for(let d=1;d<i;d++)s[d]+=t;s[i-1]+=t;const u=.5*t;for(let d=1;d<i-1;d++){let n=0,a=0,c=0;for(let i=d-1;i>=0&&!(s[i+1]<s[d]-u);i--){const o=u+s[i+1]-s[d],l=s[i+1]-s[i],h=s[d]-s[i]<u?1:o/l;if(Math.abs(h)<r)break;const p=h*h,f=h*o-.5*p*l,_=h*l/t,y=e[i+1],m=e[i][0]-y[0],g=e[i][1]-y[1];n+=_/f*(y[0]*h*o+.5*p*(o*m-l*y[0])-p*h*l*m/3),a+=_/f*(y[1]*h*o+.5*p*(o*g-l*y[1])-p*h*l*g/3),c+=_}for(let o=d+1;o<i&&!(s[o-1]>s[d]+u);o++){const i=u-s[o-1]+s[d],l=s[o]-s[o-1],h=s[o]-s[d]<u?1:i/l;if(Math.abs(h)<r)break;const p=h*h,f=h*i-.5*p*l,_=h*l/t,y=e[o-1],m=e[o][0]-y[0],g=e[o][1]-y[1];n+=_/f*(y[0]*h*i+.5*p*(i*m-l*y[0])-p*h*l*m/3),a+=_/f*(y[1]*h*i+.5*p*(i*g-l*y[1])-p*h*l*g/3),c+=_}o.push(n/c),o.push(a/c)}o.push(a),o.push(c);for(let d=0,h=0;d<i;d++)e[d][0]=o[h++],e[d][1]=o[h++]}var jn=r(15941);class Wn{static getPlacement(e,t,r,i,s,n){const o=(0,he.c)(r);return o?(-1===t&&e.invertY(),o.execute(e,r,i,s,n)):null}}var Yn=r(40392),Xn=r(97763);class Hn{constructor(e){const{offsetX:t,offsetY:r,postAngle:i,fontSize:s,haloSize:n,outlineSize:o,scaleFactor:a,transforms:c}=e;if(this.offsetX=t,this.offsetY=r,this.postAngle=i,this.fontSize=Math.min(s,96),this.haloSize=null!==n&&void 0!==n?n:0,this.outlineSize=null!==o&&void 0!==o?o:0,this.transforms=c,c&&c.infos.length>1){const e=(0,Xn.zb)(s,i,!1,t,r,c,!1);this.fontSize=Math.min(e.size,96);const n=e.size/s;this.haloSize*=n,this.outlineSize*=n,this.postAngle=e.rotation,this.offsetX=e.offsetX,this.offsetY=e.offsetY}a&&(this.fontSize*=a,this.offsetX*=a,this.offsetY*=a)}}const Zn=[4,4],Qn=[16,4],Kn={topLeft:Qn,topRight:Qn,bottomLeft:Qn,bottomRight:Qn},Jn=[4,2],$n=[4,6],eo={topLeft:Jn,topRight:Jn,bottomLeft:$n,bottomRight:$n},to={topLeft:Jn,topRight:$n,bottomLeft:Jn,bottomRight:$n},ro={topLeft:$n,topRight:$n,bottomLeft:Zn,bottomRight:Zn},io={topLeft:Zn,topRight:Zn,bottomLeft:$n,bottomRight:$n},so={topLeft:$n,topRight:Zn,bottomLeft:$n,bottomRight:Zn},no={topLeft:Zn,topRight:$n,bottomLeft:Zn,bottomRight:$n},oo={createComputedParams:e=>e,optionalAttributes:{zoomRange:{type:X.pe.UNSIGNED_SHORT,count:2,packPrecisionFactor:_.fq,packTessellation:e=>{let{minZoom:t,maxZoom:r}=e;return[t||0,r||28]}},clipAngle:{type:X.pe.UNSIGNED_BYTE,count:1,packTessellation:e=>{let{clipAngle:t}=e;return co(t||0)}},referenceSymbol:{type:X.pe.BYTE,count:4,packPrecisionFactor:1,packTessellation:(e,t)=>{const r=e.isLineLabel||!e.referenceBounds,i=(0,An.iT)(r?"center":t.horizontalAlignment),s=(0,An.Dy)(r?"middle":t.verticalAlignment),{offsetX:n,offsetY:o,size:a}=r?{offsetX:0,offsetY:0,size:0}:e.referenceBounds;return[(0,u.Lz)(n),-(0,u.Lz)(o),Math.round((0,u.Lz)(a)),i+1<<2|s+1]}}},attributes:{pos:{type:X.pe.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:X.pe.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:X.pe.UNSIGNED_BYTE,count:1,packTessellation:e=>{let{isBackground:t,mapAligned:r}=e;return se([[0,t],[3,!!r]])}},offset:{type:X.pe.SHORT,count:2,packPrecisionFactor:8,packAlternating:{count:4,packTessellation:e=>{let{offsets:t}=e;const{bottomLeft:r,bottomRight:i,topLeft:s,topRight:n}=t;return[s,n,r,i]}}},textureUV:{type:X.pe.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,packTessellation:e=>{let{texcoords:t}=e;const{bottomLeft:r,bottomRight:i,topLeft:s,topRight:n}=t;return[s,n,r,i]}}},color:{type:X.pe.UNSIGNED_BYTE,count:4,normalized:!0,packTessellation:e=>{let{color:t}=e;return t}},fontSize:{type:X.pe.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,packTessellation:e=>{let{fontSize:t}=e;return Math.round((0,u.Lz)(t))}},referenceSize:{type:X.pe.UNSIGNED_BYTE,count:1,packPrecisionFactor:4,packTessellation:(e,t)=>{let{fontSize:r}=e,{referenceSize:i}=t;return Math.round((0,u.Lz)(null!==i&&void 0!==i?i:r))}},outlineColor:{type:X.pe.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{outlineColor:t}=e;return ne(t)}},haloColor:{type:X.pe.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{haloColor:t}=e;return ne(t)}},outlineAndHaloSize:{type:X.pe.UNSIGNED_SHORT,count:2,packPrecisionFactor:4,packTessellation:e=>{let{outlineSize:t,haloSize:r}=e;return[Math.round((0,u.Lz)(t)),Math.round((0,u.Lz)(r))]}}}};class ao extends Te{constructor(){super(...arguments),this.vertexSpec=oo,this._textMeshParamsPropsInitialized=!1}ensurePacked(e,t,r){super.ensurePacked(e,t,r),this._textMeshParamsPropsInitialized&&!this._evaluator.hasDynamicProperties||(this._textMeshTransformProps=new Hn(this.evaluatedMeshParams),this._textMeshParamsPropsInitialized=!0)}_write(e,t,r){const i=this._getShaping();if(!i)return;const s=t.getDisplayId();if(null!=this.evaluatedMeshParams.placement)return this._writePlacedTextMarkers(e,t,i,r);if(null!==r&&void 0!==r&&r.nextPath())return r.nextPoint(),this._writeGlyphs(e,s,r.x,r.y,i,0);if("esriGeometryPolygon"===t.geometryType){const r=t.readCentroidForDisplay();if(!r)return;const[n,o]=r.coords;return this._writeGlyphs(e,s,n,o,i,0)}if("esriGeometryMultipoint"===t.geometryType){const r=t.readGeometryForDisplay();return void(null===r||void 0===r||r.forEachVertex(((t,r)=>this._writeGlyphs(e,s,t,r,i,0))))}const n=t.readXForDisplay(),o=t.readYForDisplay();return this._writeGlyphs(e,s,n,o,i,0)}_writePlacedTextMarkers(e,t,r,i){const s=null!==i&&void 0!==i?i:le.z.fromFeatureSetReaderCIM(t);if(!s)return;const n=Wn.getPlacement(s,-1,this.evaluatedMeshParams.placement,(0,u.Lz)(1),e.id,ye());if(!n)return;const o=t.getDisplayId();let a=n.next();for(;null!=a;){const t=a.tx,i=-a.ty,s=-a.getAngle();this._writeGlyphs(e,o,t,i,r,s),a=n.next()}}_getShaping(e){var t;const r=this._textMeshTransformProps,i=this.evaluatedMeshParams;if(null===(t=i.glyphs)||void 0===t||!t.glyphs.length)return null;const s=(0,u.Lz)(r.fontSize),n=(0,u.Lz)(r.offsetX),o=(0,u.Lz)(r.offsetY),a=(0,jn.qE)((0,u.Lz)(i.lineWidth),_.GR,_.cp),c=_.DY*(0,jn.qE)(i.lineHeightRatio,.25,4);return(0,Yn.Tl)(i.glyphs,{scale:s/_.eG,angle:r.postAngle,xOffset:n,yOffset:o,horizontalAlignment:i.horizontalAlignment,verticalAlignment:e||i.verticalAlignment,maxLineWidth:a,lineHeight:c,decoration:i.decoration,borderLineSizePx:(0,u.Lz)(i.boxBorderLineSize),hasBackground:!!i.boxBackgroundColor,useCIMAngleBehavior:i.useCIMAngleBehavior})}_writeGlyphs(e,t,r,i,s,n,o,a){const c=this.evaluatedMeshParams,l=this._textMeshTransformProps,d=(0,u.Lz)(l.fontSize),h=l.haloSize,p=l.outlineSize,f=(0,u.Lz)(l.offsetX),_=(0,u.Lz)(l.offsetY),[y,g]=re(c.scaleInfo,this.getTileInfo());0!==n&&s.setRotation(n);const x=s.bounds,v=r+x.x+f,b=i+x.y-_,w=2*(c.minPixelBuffer?c.minPixelBuffer/d:1),I=Math.max(x.width,x.height)*w;s.textBox&&(e.recordStart(this.instanceId,this.attributeLayout,s.glyphs[0].textureBinding),e.recordBounds(v,b,I,I),this._writeTextBox(e,t,r,i,s.textBox,o,a),e.recordEnd());for(const u of s.glyphs){e.recordStart(this.instanceId,this.attributeLayout,u.textureBinding),e.recordBounds(v,b,I,I);const{texcoords:s,offsets:n}=u;this._writeQuad(e,t,r,i,(0,m.A)({texcoords:s,offsets:n,fontSize:d,haloSize:h,outlineSize:p,color:ne(c.color),isBackground:!1,referenceBounds:o,minZoom:y,maxZoom:g},a)),e.recordEnd()}0!==n&&s.setRotation(-n)}_writeTextBox(e,t,r,i,s,n,o){const a=this.evaluatedMeshParams,{fontSize:c,haloSize:l,outlineSize:u}=this._textMeshTransformProps,{boxBackgroundColor:d,boxBorderLineColor:h}=a,p=(0,m.A)({isBackground:!0,fontSize:c,haloSize:l,outlineSize:u,referenceBounds:n},o);d&&(this._writeQuad(e,t,r,i,(0,m.A)({texcoords:Kn,offsets:s.main,color:ne(d)},p)),h||(this._writeQuad(e,t,r,i,(0,m.A)({texcoords:ro,offsets:s.top,color:ne(d)},p)),this._writeQuad(e,t,r,i,(0,m.A)({texcoords:io,offsets:s.bot,color:ne(d)},p)),this._writeQuad(e,t,r,i,(0,m.A)({texcoords:so,offsets:s.left,color:ne(d)},p)),this._writeQuad(e,t,r,i,(0,m.A)({texcoords:no,offsets:s.right,color:ne(d)},p)))),h&&(this._writeQuad(e,t,r,i,(0,m.A)({texcoords:eo,offsets:s.top,color:ne(h)},p)),this._writeQuad(e,t,r,i,(0,m.A)({texcoords:eo,offsets:s.bot,color:ne(h)},p)),this._writeQuad(e,t,r,i,(0,m.A)({texcoords:to,offsets:s.left,color:ne(h)},p)),this._writeQuad(e,t,r,i,(0,m.A)({texcoords:to,offsets:s.right,color:ne(h)},p)))}_writeQuad(e,t,r,i,s){const n=e.vertexCount();this._writeVertex(e,t,r,i,s),e.indexWrite(n+0),e.indexWrite(n+1),e.indexWrite(n+2),e.indexWrite(n+1),e.indexWrite(n+3),e.indexWrite(n+2)}}const co=e=>Math.round(e*(254/360)),lo=(0,xn.Bj)((e=>{let t=0;if(0===e)return 1/0;for(;!(e%2);)t++,e/=2;return t}));class uo extends ao{constructor(){super(...arguments),this._zoomLevel=0}_write(e,t,r,i){if(this._zoomLevel=i||0,null!=r)throw new Error("InternalError: EffectGeometry not support for LabelMeshWriter");switch(t.geometryType){case"esriGeometryPoint":{const r=t.readXForDisplay(),i=t.readYForDisplay();this._writePoint(e,r,i,t);break}case"esriGeometryEnvelope":case"esriGeometryPolygon":case"esriGeometryMultipoint":{const r=t.readCentroidForDisplay();if(!r)return;const[i,s]=r.coords;this._writePoint(e,i,s,t);break}case"esriGeometryPolyline":this._writeLines(e,t)}}_createLineLabelMetric(e,t,r,i){var s,n,o,a;const c=Fn(e),l="right"===this.evaluatedMeshParams.horizontalAlignment?-1:1,u="bottom"===this.evaluatedMeshParams.verticalAlignment?-1:1,d=null!==(s=null===(n=this.evaluatedMeshParams.scaleInfo)||void 0===n?void 0:n.maxScale)&&void 0!==s?s:0,h=null!==(o=null===(a=this.evaluatedMeshParams.scaleInfo)||void 0===a?void 0:a.minScale)&&void 0!==o?o:0;return new Cn(c,t,r,l,u,d,h,null!==i&&void 0!==i?i:null)}_writePoint(e,t,r,i){var s,n,o,a;const c=this._getShaping();if(!c)return;const l=i.getDisplayId(),u=(0,An.xy)(this.evaluatedMeshParams.horizontalAlignment),d=(0,An.UD)(this.evaluatedMeshParams.verticalAlignment),h=null!==(s=null===(n=this.evaluatedMeshParams.scaleInfo)||void 0===n?void 0:n.maxScale)&&void 0!==s?s:0,p=null!==(o=null===(a=this.evaluatedMeshParams.scaleInfo)||void 0===a?void 0:a.minScale)&&void 0!==o?o:0,f=Fn(i.getDisplayId()),_=this._getPointReferenceBounds()||{offsetX:0,offsetY:0,size:0};e.metricStart(new Cn(f,t,r,u,d,h,p,_)),this._writeGlyphs(e,l,t,r,c,0,_),e.metricBoxWrite(c.boundsT),e.metricEnd()}_getPointReferenceBounds(){if(!this._references)return null;for(const e of this._references){const t=e.getBoundsInfo();if(t)return t}return null}_writeLines(e,t){const{scaleInfo:r,verticalAlignment:i}=this.evaluatedMeshParams,s=this.evaluatedMeshParams.repeatLabelDistance||128,n=this._getShaping("middle");if(!n)return;const o=(e,t,r,i)=>this._placeSubdivGlyphs(e,t,r,i),a=(n.bounds.width+s)/2;this._current={out:e,id:t.getDisplayId(),shaping:n,zoomRange:re(r,this.getTileInfo()),referenceBounds:this._getPointReferenceBounds()||{offsetX:0,offsetY:0,size:0},offsetDirection:null},this._verticalPlacement="bottom"===i?"above":"top"===i?"below":null,this._verticalPlacement?this._writeAboveAndBelowAlong(t,o,a):this._writeCenterAlong(t,o,a)}_writeAboveAndBelowAlong(e,t,r){const{repeatLabel:i}=this.evaluatedMeshParams,{shaping:s}=this._current,n=s.bounds.halfHeight,o=e.readGeometryForDisplay();if(!o)return;const a=new Be.A;(0,Tn.kz)(a,o,!1,!1,"esriGeometryPolyline",1);const c=ho(new Be.A,a,n),l=ho(new Be.A,a,-n),u=(0,Tn.zv)(l,"esriGeometryPolyline",!1,!1),d=Gn((0,Tn.zv)(c,"esriGeometryPolyline",!1,!1).paths,s.bounds.width),h=Gn(u.paths,s.bounds.width);this._current.offsetDirection="above";for(const p of d)qn(p,r,t,!!i);this._current.offsetDirection="below";for(const p of h)qn(p,r,t,!!i)}_writeCenterAlong(e,t,r){const{repeatLabel:i}=this.evaluatedMeshParams,{shaping:s}=this._current,n=Gn(e.readLegacyGeometryForDisplay().paths,s.bounds.width);for(const o of n)qn(o,r,t,!!i)}_placeSubdivGlyphs(e,t,r,i){const{allowOverrun:s,labelPosition:n,repeatLabelDistance:o}=this.evaluatedMeshParams,a=this._current.zoomRange[0],c=lo(t),l=this._current.shaping.bounds.width/2,u=Math.sqrt(o||128)/2,d=Math.min(r,i-r),h=this._current.shaping.isMultiline?28:Math.log2(d/(u+l/2)),p=0===t?h:Math.min(c,h),f=Math.max(a,this._zoomLevel+1-p),_=this._zoomLevel-f,y=this._current.shaping.bounds.width/2*2**_;this._current.shaping.isMultiline?0===t&&this._placeStraight(e,f):s&&_<0?this._placeStraightAlong(e,a):"parallel"===n?this._placeStraightAlong(e,f):"curved"===n&&this._placeCurved(e,f,y)}_placeStraight(e,t){const{out:r,id:i,shaping:s,referenceBounds:n}=this._current,{x:o,y:a}=e;r.metricStart(this._createLineLabelMetric(i,o,a)),r.metricBoxWrite(s.boundsT);const c=e.angle*(180/Math.PI)%360,l=(e.angle*(180/Math.PI)+180)%360;this._writeGlyphs(r,i,o,a,s,0,n,{clipAngle:c,mapAligned:!0,isLineLabel:!0,minZoom:t}),this._writeGlyphs(r,i,o,a,s,0,n,{clipAngle:l,mapAligned:!0,isLineLabel:!0,minZoom:t}),r.metricEnd()}_placeCurved(e,t,r){const{out:i,id:s}=this._current;i.metricStart(this._createLineLabelMetric(s,e.x,e.y));const n=e.clone(),o=e.angle*(180/Math.PI)%360,a=(e.angle*(180/Math.PI)+180)%360;this._verticalPlacement&&this._verticalPlacement!==this._current.offsetDirection||(this._placeFirst(n,t,1,o),this._placeBack(e,n,t,r,1,o),this._placeForward(e,n,t,r,1,o)),this._verticalPlacement&&this._verticalPlacement===this._current.offsetDirection||(this._placeFirst(n,t,0,a),this._placeBack(e,n,t,r,0,a),this._placeForward(e,n,t,r,0,a)),i.metricEnd()}_placeStraightAlong(e,t){const{out:r,id:i,shaping:s,zoomRange:n,referenceBounds:o}=this._current,{boxBorderLineColor:a,boxBackgroundColor:c}=this.evaluatedMeshParams,l=e.clone(),d=e.angle*(180/Math.PI)%360,h=(e.angle*(180/Math.PI)+180)%360,p=s.glyphs.length>0&&!(!a&&!c);if(r.metricStart(this._createLineLabelMetric(i,e.x,e.y)),p){const a=Math.max(t,n[0],0),c=Math.min(28,n[1]),l=(0,vn.$0)((0,bn.vt)(),-e.angle),p={minZoom:a,maxZoom:c,clipAngle:d,mapAligned:!0,isLineLabel:!0},f=(0,u.Lz)(this.evaluatedMeshParams.offsetX),_=(0,u.Lz)(this.evaluatedMeshParams.offsetY);if(!this._verticalPlacement||this._verticalPlacement===this._current.offsetDirection){const t=(0,In.fA)(f,-1*_),[n,a]=s.shapeBackground((0,vn.Tl)((0,bn.vt)(),l,t));r.recordStart(this.instanceId,this.attributeLayout,s.glyphs[0].textureBinding);const c=2*Math.max(n.width,n.height);r.recordBounds(e.x+n.x,e.y+n.y,c,c),this._writeTextBox(r,i,e.x,e.y,a,o,p),r.recordEnd()}if(!this._verticalPlacement||this._verticalPlacement!==this._current.offsetDirection){const t=(0,In.fA)(f,_),[n,a]=s.shapeBackground((0,vn.Tl)((0,bn.vt)(),l,t));p.clipAngle=h,r.recordStart(this.instanceId,this.attributeLayout,s.glyphs[0].textureBinding);const c=2*Math.max(n.width,n.height);r.recordBounds(e.x+n.x,e.y+n.y,c,c),this._writeTextBox(r,i,e.x,e.y,a,o,p),r.recordEnd()}}this._verticalPlacement&&this._verticalPlacement!==this._current.offsetDirection||this._placeFirst(l,t,1,d,!0),this._verticalPlacement&&this._verticalPlacement===this._current.offsetDirection||this._placeFirst(l,t,0,h,!0),r.metricEnd()}_placeBack(e,t,r,i,s,n){const o=e.clone();let a=e.backwardLength+0;for(;o.prev()&&!(a>=i);)this._placeOnSegment(o,t,a,r,-1,s,n),a+=o.length+0}_placeForward(e,t,r,i,s,n){const o=e.clone();let a=e.remainingLength+0;for(;o.next()&&!(a>=i);)this._placeOnSegment(o,t,a,r,1,s,n),a+=o.length+0}_placeFirst(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const{out:n,id:o,shaping:a,zoomRange:c,referenceBounds:l}=this._current,u=a.glyphs;for(const d of u){const u=d.x>a.bounds.x?r:1-r,h=u*e.remainingLength+(1-u)*e.backwardLength,p=Math.abs(d.x+d.width/2-a.bounds.x),f=Math.max(0,this._zoomLevel+Math.log2(p/(h+0))),_=Math.max(t,s?0:f);d.maxZoom=Math.min(c[1],28),d.angle=e.angle+(1-r)*Math.PI,d.minZoom=Math.max(c[0],_),this._writeLineGlyph(n,o,e.x,e.y,a.bounds,d,i,l,!0),(r||this._current.offsetDirection)&&this._isVisible(d.minZoom,d.maxZoom)&&n.metricBoxWrite(d.bounds)}}_placeOnSegment(e,t,r,i,s,n,o){const{out:a,id:c,shaping:l,referenceBounds:u}=this._current,d=l.glyphs,h=e.dx/e.length,p=e.dy/e.length,f={x:e.x+r*-s*h,y:e.y+r*-s*p};for(const _ of d){const t=_.x>l.bounds.x?n:1-n;if(!(t&&1===s||!t&&-1===s))continue;const d=Math.abs(_.x+_.width/2-l.bounds.x),h=Math.max(0,this._zoomLevel+Math.log2(d/r)-.1),p=Math.max(i,this._zoomLevel+Math.log2(d/(r+e.length+0)));0!==h&&(_.angle=e.angle+(1-n)*Math.PI,_.minZoom=p,_.maxZoom=h,this._writeLineGlyph(a,c,f.x,f.y,l.bounds,_,o,u,!0),(n||this._current.offsetDirection)&&this._isVisible(_.minZoom,_.maxZoom)&&a.metricBoxWrite(_.bounds))}}_writeLineGlyph(e,t,r,i,s,n,o,a,c){const l=r+s.x,u=i+s.y,d=2*(this.evaluatedMeshParams.minPixelBuffer?this.evaluatedMeshParams.minPixelBuffer/this._textMeshTransformProps.fontSize:1),h=Math.max(s.width,s.height)*d;e.recordStart(this.instanceId,this.attributeLayout,n.textureBinding),e.recordBounds(l,u,h,h);const{texcoords:p,offsets:f}=n,{fontSize:_,haloSize:y,outlineSize:m}=this._textMeshTransformProps;this._writeQuad(e,t,r,i,{texcoords:p,offsets:f,fontSize:_,haloSize:y,outlineSize:m,color:ne(this.evaluatedMeshParams.color),isBackground:!1,referenceBounds:a,minZoom:Math.max(this._current.zoomRange[0],n.minZoom),maxZoom:Math.min(this._current.zoomRange[1],n.maxZoom),clipAngle:o,mapAligned:c,isLineLabel:!0}),e.recordEnd()}_isVisible(e,t){const r=Math.floor(this._zoomLevel*_.fq)/_.fq;return e<=r&&r<=t}}function ho(e,t,r){const{coords:i,lengths:s}=t,n=(0,Sn.vt)(),o=(0,Sn.vt)(),a=(0,Sn.vt)(),c=(0,Sn.vt)(),l=(0,Sn.vt)(),u=(0,Sn.vt)();let d=0;for(let h=0;h<s.length;h++){const t=s[h];for(let s=0;s<t;s++){const h=2*(s+d-1),p=2*(s+d),f=2*(s+d+1);s>0?(0,wn.hZ)(n,i[h],i[h+1]):(0,wn.hZ)(n,0,0),(0,wn.hZ)(o,i[p],i[p+1]),s<t-1?(0,wn.hZ)(a,i[f],i[f+1]):(0,wn.hZ)(a,0,0),0===s?(0,wn.hZ)(c,0,0):((0,wn.jb)(c,o,n),(0,wn.S8)(c,c),(0,wn.hZ)(c,c[1],-c[0])),s===t-1?(0,wn.hZ)(l,0,0):((0,wn.jb)(l,a,o),(0,wn.S8)(l,l),(0,wn.hZ)(l,l[1],-l[0])),(0,wn.WQ)(u,c,l),(0,wn.S8)(u,u);const _=u[0]*l[0]+u[1]*l[1];0!==_&&(0,wn.hs)(u,u,_),(0,wn.hs)(u,u,r),e.coords.push(o[0]+u[0],o[1]+u[1])}e.lengths.push(t),d+=t}return e}const po={createComputedParams:e=>e,optionalAttributes:Ct.optionalAttributes,attributes:(0,m.A)((0,m.A)({},Ct.attributes),{},{bitset:{type:X.pe.UNSIGNED_BYTE,count:1,pack:e=>{let{shouldSampleAlphaOnly:t,shouldScaleDash:r,isSDF:i}=e;return se([[4,t],[2,r],[3,i]])}},tlbr:{type:X.pe.UNSIGNED_SHORT,count:4,pack:e=>{let{sprite:t}=e;const{rect:r,width:i,height:s}=t,n=r.x+_.hM,o=r.y+_.hM;return[n,o,n+i,o+s]}},accumulatedDistance:{type:X.pe.UNSIGNED_SHORT,count:1,packTessellation:e=>{let{distance:t}=e;return t}},segmentDirection:{type:X.pe.BYTE,count:2,packPrecisionFactor:16,packTessellation:e=>{let{directionX:t,directionY:r}=e;return[t,r]}},offsetAlongLine:{type:X.pe.HALF_FLOAT,count:1,pack:e=>{let{offsetAlongLine:t}=e;return(0,u.Lz)(t)}},capType:{type:X.pe.UNSIGNED_BYTE,count:1,pack:e=>{let{capType:t}=e;switch(t){case Y.uT.Butt:case"butt":return 0;case Y.uT.Square:case"square":return 1;case Y.uT.Round:case"round":return 2;default:return 0}}}})};class fo extends zt{constructor(e,t,r,i){super(e,t,r,i),this.vertexSpec=po,this._tessellationOptions.textured=!0}_write(e,t,r){const i=null!==r&&void 0!==r?r:le.z.fromFeatureSetReaderCIM(t);if(!i)return;const{sprite:s}=this.evaluatedMeshParams;this._writeGeometry(e,t,i,null===s||void 0===s?void 0:s.textureBinding)}}class _o{static from(e){return"width"in e?this.fromSimpleMeshParams(e):this.fromComplexMeshParams(e)}static fromSimpleMeshParams(e){const t=new _o(e.sprite,e.color,e.outlineColor,e.minPixelBuffer,e.placement,e.scaleInfo,e.effects),{type:r,width:i,height:s,angle:n,alignment:o,outlineSize:a,referenceSize:c,sprite:l,overrideOutlineColor:d}=e;return t.rawWidth=(0,u.Lz)(i),t.rawHeight=(0,u.Lz)(s),t.angle=n,t.alignment=o,t.outlineSize=(0,u.Lz)(a),t.referenceSize=(0,u.Lz)(c),t.overrideOutlineColor=d,t.offsetX=(0,u.Lz)(e.offsetX),t.offsetY=(0,u.Lz)(e.offsetY),"simple"!==r||l.sdf||(t.rawWidth=l.width,t.rawHeight=l.height),t._computeSize(e,!1),t}static fromComplexMeshParams(e){var t;const r=new _o(e.sprite,e.color,e.outlineColor,e.minPixelBuffer,e.placement,e.scaleInfo,e.effects);let{alignment:i,transforms:s,size:n,scaleX:o,anchorX:a,anchorY:c,angle:l,colorLocked:d,frameHeight:h,widthRatio:p,offsetX:f,offsetY:_,outlineSize:y,referenceSize:m,scaleFactor:g,sizeRatio:x,isAbsoluteAnchorPoint:v,rotateClockwise:b,scaleSymbolsProportionally:w,sprite:I}=e;if(s&&s.infos.length>0){const e=(0,Xn.zb)(n,l,b,f,_,s);n=e.size,l=e.rotation,f=e.offsetX,_=e.offsetY,b=!1}g&&(n*=g,f*=g,_*=g);const S=o*(I.width/I.height);r.alignment=i,r.rawHeight=(0,u.Lz)(n),r.rawWidth=r.rawHeight*S,r.referenceSize=(0,u.Lz)(m),r.sizeRatio=x,r.sdfDecodeCoeff=(null!==(t=I.sdfDecodeCoeff)&&void 0!==t?t:1)*x,r.angle=l,r.rotateClockwise=b,r.anchorX=a,r.anchorY=c,r.offsetX=(0,u.Lz)(f),r.offsetY=(0,u.Lz)(_),v&&n&&(I.sdf?r.anchorX=a/(n*p):r.anchorX=a/(n*S),r.anchorY=c/n);const T=w&&h?n/h:1;return r.outlineSize=0===y||isNaN(y)?0:(0,u.Lz)(y)*T,r.scaleSymbolsProportionally=w,r.colorLocked=d,r._computeSize(e,!0),r}constructor(e,t,r,i,s,n,o){this.sprite=e,this.color=t,this.outlineColor=r,this.minPixelBuffer=i,this.placement=s,this.scaleInfo=n,this.effects=o,this.rawWidth=0,this.rawHeight=0,this.angle=0,this.outlineSize=0,this.referenceSize=0,this.sizeRatio=1,this.sdfDecodeCoeff=1,this.alignment=Y.C1.SCREEN,this.scaleSymbolsProportionally=!1,this.overrideOutlineColor=!1,this.colorLocked=!1,this.anchorX=0,this.anchorY=0,this.computedWidth=0,this.computedHeight=0,this.texXmin=0,this.texYmin=0,this.texXmax=0,this.texYmax=0,this.offsetX=0,this.offsetY=0,this.rotateClockwise=!0}get boundsInfo(){return{size:Math.max(this.computedHeight,this.computedWidth),offsetX:this.offsetX,offsetY:this.offsetY}}_computeSize(e,t){var r;const{sprite:i,hasSizeVV:s}=e,n=!!i.sdf,o=null!==(r=i.sdfPaddingRatio)&&void 0!==r?r:.5,{rawWidth:a,rawHeight:c,sizeRatio:l,outlineSize:u}=this,d=l*(n?1/(1-o):1),h=a*d,p=c*d;if(n&&!s){const e=t&&a>c?h:a,r=c,i=u+2;this.computedWidth=Math.min(e+i,h),this.computedHeight=Math.min(r+i,p)}else this.computedWidth=h,this.computedHeight=p;const f=n?Math.max(i.width,i.height)/Math.max(h,p):1,y=.5*(h-this.computedWidth)*f,m=.5*(p-this.computedHeight)*f,g=i.rect.x+_.hM+y,x=i.rect.y+_.hM+m,v=g+i.width-2*y,b=x+i.height-2*m;this.texXmin=Math.floor(g),this.texYmin=Math.floor(x),this.texXmax=Math.ceil(v),this.texYmax=Math.ceil(b),this.computedWidth*=(this.texXmax-this.texXmin)/(v-g),this.computedHeight*=(this.texYmax-this.texYmin)/(b-x),this.anchorX*=h/this.computedWidth,this.anchorY*=p/this.computedHeight}}const yo=128/Math.PI;function mo(e){return function(e,t){return e%=t,Math.abs(e>=0?e:e+t)}(e*yo,256)}const go={createComputedParams:e=>_o.from(e),optionalAttributes:{zoomRange:{type:X.pe.SHORT,count:2,packPrecisionFactor:_.fq,pack:(e,t)=>{let{scaleInfo:r}=e,{tileInfo:i}=t;return re(r,i)}}},attributes:{pos:{type:X.pe.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:X.pe.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:X.pe.UNSIGNED_BYTE,count:1,pack:e=>{let{sprite:t,alignment:r,scaleSymbolsProportionally:i,overrideOutlineColor:s,colorLocked:n}=e,o=0;return t.sdf&&(o|=ie(ce.isSDF)),r===Y.C1.MAP&&(o|=ie(ce.isMapAligned)),i&&(o|=ie(ce.scaleSymbolsProportionally)),s&&(o|=ie(ce.overrideOutlineColor)),n&&(o|=ie(ce.colorLocked)),o}},offset:{type:X.pe.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:e=>{let{angle:t,computedWidth:r,computedHeight:i,anchorX:s,anchorY:n,offsetX:o,offsetY:a,rotateClockwise:c}=e;const l=function(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const n=(0,bn.vt)(),o=s?1:-1;return(0,vn.D_)(n),(t||r)&&(0,vn.Tl)(n,n,[t,-r]),i&&(0,vn.e$)(n,n,.017453292519944444*o*-i),n}(0,o,a,-t,c),u=-(.5+s)*r,d=-(.5-n)*i,h=[u,d],p=[u+r,d],f=[u,d+i],_=[u+r,d+i];return(0,wn.l0)(h,h,l),(0,wn.l0)(p,p,l),(0,wn.l0)(f,f,l),(0,wn.l0)(_,_,l),[h,p,f,_]}}},textureUV:{type:X.pe.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:e=>{let{texXmax:t,texXmin:r,texYmax:i,texYmin:s}=e;return[[r,s],[t,s],[r,i],[t,i]]}}},color:{type:X.pe.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{color:t}=e;return ne(t)}},outlineColor:{type:X.pe.UNSIGNED_BYTE,count:4,normalized:!0,pack:e=>{let{outlineColor:t}=e;return ne(t)}},sizing:{type:X.pe.UNSIGNED_BYTE,count:4,pack:e=>{let{rawWidth:t,rawHeight:r,outlineSize:i,referenceSize:s}=e;return[oe(Math.max(t,r),128),oe(i,128),oe(s,128),0]}},placementAngle:{type:X.pe.UNSIGNED_BYTE,count:1,packTessellation:e=>{let{placementAngle:t}=e;return mo(t)}},sdfDecodeCoeff:{type:X.pe.UNSIGNED_SHORT,count:1,packPrecisionFactor:64,pack:e=>{let{sdfDecodeCoeff:t}=e;return t}}}};class xo extends Te{constructor(){super(...arguments),this.vertexSpec=go}getBoundsInfo(){return this.evaluatedMeshParams.boundsInfo}_write(e,t,r){var i;const s=null===(i=this.evaluatedMeshParams.sprite)||void 0===i?void 0:i.textureBinding,n=t.getDisplayId();e.recordStart(this.instanceId,this.attributeLayout,s);const o=this.evaluatedMeshParams.minPixelBuffer,a=Math.max(this.evaluatedMeshParams.computedWidth,o),c=Math.max(this.evaluatedMeshParams.computedHeight,o),l=-this.evaluatedMeshParams.anchorX*this.evaluatedMeshParams.computedWidth,u=this.evaluatedMeshParams.anchorY*this.evaluatedMeshParams.computedHeight,d=this.evaluatedMeshParams.offsetX+l,h=-this.evaluatedMeshParams.offsetY+u;if(null!=this.evaluatedMeshParams.placement)this._writePlacedMarkers(e,t,r,a,c);else if(null!==r&&void 0!==r&&r.nextPath()){r.nextPoint();const t=r.x,i=r.y;e.recordBounds(t+d,i+h,a,c),this._writeQuad(e,n,t,i)}else if("esriGeometryPolygon"===t.geometryType){const r=t.readCentroidForDisplay();if(!r)return;const[i,s]=r.coords;e.recordBounds(i+d,s+h,a,c),this._writeQuad(e,n,i,s)}else if("esriGeometryPoint"===t.geometryType){const r=t.readXForDisplay(),i=t.readYForDisplay();e.recordBounds(r+d,i+h,a,c),this._writeQuad(e,n,r,i)}else{const r=t.readGeometryForDisplay();null===r||void 0===r||r.forEachVertex(((t,r)=>{e.recordBounds(t+d,r+h,a,c),Math.abs(t)>Pn.$u||Math.abs(r)>Pn.$u||this._writeQuad(e,n,t,r)}))}e.recordEnd()}_writePlacedMarkers(e,t,r,i,s){var n;const o=null!==r&&void 0!==r?r:null===(n=le.z.fromFeatureSetReaderCIM(t))||void 0===n?void 0:n.clone();if(!o)return;const a=Wn.getPlacement(o,-1,this.evaluatedMeshParams.placement,(0,u.Lz)(1),e.id,ye());if(!a)return;const c=t.getDisplayId();let l=a.next();const d=this.evaluatedMeshParams.offsetX,h=-this.evaluatedMeshParams.offsetY;for(;null!=l;){const t=l.tx,r=-l.ty;if(Math.abs(t)>Pn.$u||Math.abs(r)>Pn.$u){l=a.next();continue}const n=-l.getAngle();e.recordBounds(t+d,r+h,i,s),this._writeQuad(e,c,t,r,n),l=a.next()}}_writeQuad(e,t,r,i,s){const n=e.vertexCount(),o=null==s?null:{placementAngle:s};this._writeVertex(e,t,r,i,o),e.indexWrite(n+0),e.indexWrite(n+1),e.indexWrite(n+2),e.indexWrite(n+1),e.indexWrite(n+3),e.indexWrite(n+2)}}var vo=r(18690),bo=r(53084);function wo(e,t){let r;if("string"==typeof e)r=(0,j.Wm)(e+"-seed(".concat(t,")"));else{let i=12;r=e^t;do{r=107*(r>>8^r)+i|0}while(0!=--i)}return(1+r/(1<<31))/2}function Io(e){return Math.floor(wo(e,So)*To)}const So=53290320,To=10;var Ao;!function(e){e.Local="Local",e.Global="Global"}(Ao||(Ao={}));class Mo{generateSource(e){const t=[];for(let i=1;i<this.length;i++)t.push("vec4 atom".concat(i," = texture(").concat(e.animationTexture,", (pointer + 0.5) / size);")),t.push("pointer.x += 1.0;");for(let i=0;i<this.ins;i++)t.push("top--;"),t.push("vec4 in".concat(this.ins-i-1," = stack[top];"));for(let i=0;i<this.outs;i++)t.push("vec4 out".concat(i,";"));const{microcode:r}=this;for(const i of r)t.push(i);for(let i=0;i<this.outs;i++)t.push("stack[top] = out".concat(i,";")),t.push("top++;"),t.push("if (top >= ".concat(Ro,") { top = ").concat(Ro-1,"; }"));return t}}let ko=128;function Fo(e){return["float duration = clamp(".concat(e.duration,", 0.05, 3600.0);"),"float startTimeOffset = ".concat(e.startTimeOffset,";"),"float repeatDelay = ".concat(e.repeatDelay,";"),"float timeOriginSelector = ".concat(e.timeOriginSelector,";"),"float repeatType = ".concat(e.repeatType,";"),"float easing = ".concat(e.easing,";"),"float playAnimation = ".concat(e.playAnimation," * (1.0 - step(0.0, -").concat(e.duration,"));"),"float reverseAnimation = ".concat(e.reverseAnimation,";"),"float time = globalTime - (timeOriginSelector == 1.0 ? localTimeOrigin : 0.0);","time *= playAnimation;","time *= 1.0 - reverseAnimation * 2.0;","float period = duration + repeatDelay;","time += reverseAnimation == 1.0 ? (period - startTimeOffset - 0.001) : startTimeOffset + 0.001;","float omega = time / period;","float oi = floor(omega);","omega = repeatType == 1.0 || repeatType == 3.0 ? omega - oi : omega;","float of = omega * period;","of = (clamp(of, reverseAnimation * repeatDelay, period - (1.0 - reverseAnimation) * repeatDelay) - reverseAnimation * repeatDelay) / duration;","of = easing == 2.0 ? pow(of, 3.0) : of;","of = easing == 3.0 ? 1.0 - pow(1.0 - of, 3.0) : of;","of = easing == 4.0 ? of < 0.5 ? 4.0 * pow(of, 3.0) : 1.0 - pow(-2.0 * of + 2.0, 3.0) / 2.0 : of;","bool oscillate = repeatType == 3.0 && mod(oi, 2.0) == 1.0;","".concat(e.out," = oscillate ? 1.0 - of : of;")]}const Eo={Linear:1,EaseIn:2,EaseOut:3,EaseInOut:4},Co={Loop:1,None:2,Oscillate:3},Po={Local:1,Global:2};function zo(e){const t=Eo[e.easing],r=Co[e.repeatType],i=Po[e.timeOriginSelector];return[[e.duration,e.startTimeOffset,e.repeatDelay,i],[r,t,e.playAnimation,e.reverseAnimation]]}const Oo={scalar:new class extends Mo{constructor(){super(...arguments),this.opcode=++ko,this.length=1,this.ins=0,this.outs=1,this.microcode=["out0 = vec4(atom0.y, atom0.y, atom0.y, atom0.y);"]}encode(e){return[[this.opcode,e,0,0]]}},vector3:new class extends Mo{constructor(){super(...arguments),this.opcode=++ko,this.length=1,this.ins=0,this.outs=1,this.microcode=["out0 = vec4(atom0.yzw, 0.0);"]}encode(e){return[[this.opcode,e[0]||0,e[1]||0,e[2]||0]]}},vector4:new class extends Mo{constructor(){super(...arguments),this.opcode=++ko,this.length=2,this.ins=0,this.outs=1,this.microcode=["out0 = atom1;"]}encode(e){return[[this.opcode,0,0,0],e]}},animatedTransform:new class extends Mo{constructor(){super(...arguments),this.opcode=++ko,this.length=10,this.ins=1,this.outs=1,this.microcode=["vec2 fromTranslation = atom1.xy;","vec2 toTranslation = atom1.zw;","float fromRotation = atom2.x;","float toRotation = atom2.y;","float fromScale = atom2.z;","float toScale = atom2.w;","bool relativeTranslation = atom9.x == 1.0;","bool absoluteScale = atom9.y == 1.0;","vec2 translationMultiplier = relativeTranslation ? pixelDimensions : vec2(1.0, 1.0);","float scaleDivisor = absoluteScale ? pixelDimensions.y : 1.0;","float fTranslation;","{",...Fo({duration:"atom3.x",startTimeOffset:"atom3.y",repeatDelay:"atom3.z",timeOriginSelector:"atom3.w",repeatType:"atom4.x",easing:"atom4.y",playAnimation:"atom4.z",reverseAnimation:"atom4.w",out:"fTranslation"}),"}","float fRotation;","{",...Fo({duration:"atom5.x",startTimeOffset:"atom5.y",repeatDelay:"atom5.z",timeOriginSelector:"atom5.w",repeatType:"atom6.x",easing:"atom6.y",playAnimation:"atom6.z",reverseAnimation:"atom6.w",out:"fRotation"}),"}","float fScale;","{",...Fo({duration:"atom7.x",startTimeOffset:"atom7.y",repeatDelay:"atom7.z",timeOriginSelector:"atom7.w",repeatType:"atom8.x",easing:"atom8.y",playAnimation:"atom8.z",reverseAnimation:"atom8.w",out:"fScale"}),"}","vec2 aTranslation = mix(fromTranslation, toTranslation, fTranslation);","float aRotation = mix(fromRotation, toRotation, fRotation);","float aScale = mix(fromScale, toScale, fScale);","vec2 pTranslation = in0.xy;","float pRotation = in0.z;","float pScale = in0.w;","aTranslation *= translationMultiplier;","aScale /= scaleDivisor;","float rotation = pRotation + aRotation;","float scale = pScale * aScale;","float sin1 = sin(pRotation);","float cos1 = cos(pRotation);","float s1 = pScale;","float x1 = pTranslation.x;","float y1 = pTranslation.y;","float x2 = aTranslation.x;","float y2 = aTranslation.y;","\n    vec2 translation = vec2(\n      cos1 * s1 * x2 - sin1 * s1 * y2 + x1,\n      sin1 * s1 * x2 + cos1 * s1 * y2 + y1\n    );\n    ","out0 = vec4(translation, rotation, scale);"]}encode(e){return[[this.opcode,0,0,0],[e.translation.from[0],e.translation.from[1],e.translation.to[0],e.translation.to[1]],[e.rotation.from,e.rotation.to,e.scale.from,e.scale.to],...zo(e.translation.timing),...zo(e.rotation.timing),...zo(e.scale.timing),[e.relativeTranslation?1:0,e.absoluteScale?1:0,0,0]]}},animatedColor:new class extends Mo{constructor(){super(...arguments),this.opcode=++ko,this.length=7,this.ins=1,this.outs=1,this.microcode=["float fromOpacity = atom0.y;","float toOpacity = atom0.z;","vec4 fromColor = atom1;","vec4 toColor = atom2;","float fColor;","{",...Fo({duration:"atom3.x",startTimeOffset:"atom3.y",repeatDelay:"atom3.z",timeOriginSelector:"atom3.w",repeatType:"atom4.x",easing:"atom4.y",playAnimation:"atom4.z",reverseAnimation:"atom4.w",out:"fColor"}),"}","float fOpacity;","{",...Fo({duration:"atom5.x",startTimeOffset:"atom5.y",repeatDelay:"atom5.z",timeOriginSelector:"atom5.w",repeatType:"atom6.x",easing:"atom6.y",playAnimation:"atom6.z",reverseAnimation:"atom6.w",out:"fOpacity"}),"}","vec4 aColor = mix(fromColor, toColor, fColor);","aColor.a *= mix(fromOpacity, toOpacity, fOpacity);","vec4 pColor = in0;","out0 = aColor * pColor;"]}encode(e){return[[this.opcode,e.opacity.from,e.opacity.to,0],[e.color.from[0],e.color.from[1],e.color.from[2],e.color.from[3]],[e.color.to[0],e.color.to[1],e.color.to[2],e.color.to[3]],...zo(e.color.timing),...zo(e.opacity.timing)]}},ret:new class extends Mo{constructor(){super(...arguments),this.opcode=++ko,this.length=1,this.ins=0,this.outs=0,this.microcode=["break;"]}encode(){return[[this.opcode,0,0,0]]}}},Ro=4;function Do(e){return e instanceof Lo?e:"object"==typeof e&&"type"in e?qo[e.type].hydrate(e):new No(e)}class Lo{constructor(e){this.inputs=e}encode(){const e=[];for(const t of this.inputs)e.push(...t.encode());return e.push(...this.instructions),e}}class No extends Lo{constructor(e){super([]),this.value=e}simplify(){return this}get instructions(){if(Array.isArray(this.value)){const[e,t,r,i]=this.value;return null!=i?Oo.vector4.encode([e,t||0,r||0,i]):Oo.vector3.encode([e,t||0,r||0])}return Oo.scalar.encode(this.value)}}class Bo extends Lo{constructor(e,t){super([t]),this._config=e,this._parent=t}static hydrate(e){return new Bo(e,Do(e.parent))}simplify(){if(this._config.relativeTranslation||this._config.absoluteScale)return this;const e=this._parent.simplify();if(!(e instanceof No))return this;const[t,r,i,s]=e.value,n=this._config.translation.from[0],o=this._config.translation.from[1],a=this._config.rotation.from,c=this._config.scale.from;if(n===this._config.translation.to[0]&&o===this._config.translation.to[1]&&a===this._config.rotation.to&&c===this._config.scale.to){const e=i+a,l=s*c,u=Math.sin(i),d=Math.cos(i);return new No([d*s*n-u*s*o+t,u*s*n+d*s*o+r,e,l])}return new Bo(this._config,e)}get instructions(){return Oo.animatedTransform.encode(this._config)}}class Vo extends Lo{constructor(e,t){super([t]),this._config=e,this._parent=t}static hydrate(e){return new Vo(e,Do(e.parent))}simplify(){const e=this._parent.simplify();if(!(e instanceof No))return this;const[t,r,i,s]=e.value,n=this._config.color.from[0],o=this._config.color.from[1],a=this._config.color.from[2];let c=this._config.color.from[3];const l=this._config.opacity.from;return n===this._config.color.to[0]&&o===this._config.color.to[1]&&a===this._config.color.to[2]&&c===this._config.color.to[3]&&l===this._config.opacity.to?(c*=l,new No([t*n,r*o,i*a,s*c])):new Vo(this._config,e)}get instructions(){return Oo.animatedColor.encode(this._config)}}const qo={AnimatedTransform:Bo,AnimatedColor:Vo};function Go(e){return jo(e.map((e=>Yo(e))).map((e=>Do(e).simplify())))}function Uo(e){const t=[];return t.push(e.transform),t.push(e.fromColor),t.push(e.toColor),t.push(e.colorMix),t.push(e.toOpacity),t.push(e.opacityMix),t}function jo(e){const t=[],r=[];let i=0;for(const s of e){const n=[...s.encode(),...Oo.ret.encode()];t.push([i+e.length,0,0,0]),r.push(...n),i+=n.length}return[...t,...r]}async function Wo(e,t){const r=e;let i;if("number"==typeof r||"string"==typeof r||"boolean"==typeof r)i=r;else if(Array.isArray(r))i=await Promise.all(r.map((e=>Wo(e,t))));else if("object"==typeof r)if("valueExpressionInfo"in r){const{valueExpressionInfo:e}=r,{expression:s}=e;i=(0,m.A)((0,m.A)({},r),{},{computed:await t.createComputedField({expression:s})})}else{i={};for(const e in r)i[e]=await Wo(r[e],t)}return i}function Yo(e,t,r){const i=e;let s;if("number"==typeof i||"string"==typeof i||"boolean"==typeof i)s=i;else if(Array.isArray(i))s=i.map((e=>Yo(e,t,r)));else if("object"==typeof i)if("type"in i&&null!=i.type&&"Process"===i.type)switch(i.op){case"ArcadeColor":{const e=Yo(i.value,t,r);Xo(Array.isArray(e)&&4===e.length),s=[e[0]/255,e[1]/255,e[2]/255,e[3]]}break;case"Transparency":{const e=Yo(i.value,t,r);Xo("number"==typeof e),s=1-e/100}break;case"Divide":{const e=Yo(i.left,t,r);Xo("number"==typeof e);const n=Yo(i.right,t,r);Xo("number"==typeof n),s=e/n}break;case"Random":{const e=Yo(i.seed,t,r),n=Yo(i.min,t,r),o=Yo(i.max,t,r);s=n+wo(Io(t.getObjectId()||0),e)*(o-n)}}else if("computed"in i)s=function(e){if(!("computed"in e))return e;let i=e.computed.readWithDefault(t,r,[255*e.defaultValue[0],255*e.defaultValue[1],255*e.defaultValue[2],e.defaultValue[3]]);if("string"==typeof i){const e=te.A.fromString(i);e&&(i=[e.r,e.g,e.b,e.a])}return i}(i);else{s={};for(const e in i)s[e]=Yo(i[e],t,r)}return s}function Xo(e){if(!e)throw new Error("Assertion failed.")}class Ho{destroy(){}}class Zo extends Ho{constructor(e){super(),this._value=e}resize(e){}read(e,t){return this._value}readWithDefault(e,t,r){return this._value}referencesScale(){return!1}referencesGeometry(){return!1}}async function Qo(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{defaultValue:i,valueExpressionInfo:s,value:n}=t;if(s){const{expression:n}=s,o=await e.createComputedField({expression:n},r);return o?(0,m.A)((0,m.A)({},t),{},{computed:o,defaultValue:i}):null}return(0,m.A)((0,m.A)({},t),{},{computed:new Zo(n),defaultValue:i})}async function Ko(e,t){const{valueExpressionInfo:r}=t,{expression:i}=r,s=await e.createComputedField({expression:i});return s?(0,m.A)((0,m.A)({},t),{},{computed:s}):null}function Jo(e){return"object"==typeof e&&null!=e&&(!(!("valueExpressionInfo"in e)||!e.valueExpressionInfo)||"type"in e&&"Process"===e.type&&"op"in e&&"Random"===e.op)}function $o(e){if(Array.isArray(e))for(const t of e)if($o(t))return!0;if("object"==typeof e){if(Jo(e))return!0;for(const t in e)if($o(e[t]))return!0}return!1}class ea{static async create(e,t,r){const i={},s=new Map,n=new Map,o=new Map,a=new Map,c=new Map,l=new Map;for(const h in r){const p=r[h];if(null!=p&&"object"==typeof p)if(Array.isArray(p)){if("object"==typeof p[0])throw new Error("InternalError: Cannot handle ".concat(h,". Nested array params are not supported"));i[h]=p}else if("valueExpressionInfo"in p){if(p.value){i[h]=p.value;continue}const t=await Ko(e,p);if(!t){i[h]=p.defaultValue;continue}s.set(h,t),i[h]=null}else switch(p.type){case"cim-effect-infos":if(p.effectInfos.some((e=>e.overrides.length))){n.set(h,{effects:await Promise.all(p.effectInfos.map((async t=>{const r=t.overrides.map((t=>Qo(e,t)));return{effect:t.effect,compiledOverrides:(await Promise.all(r)).filter(vo.Ru)}})))});break}i[h]=p.effectInfos.map((e=>e.effect));break;case"cim-marker-placement-param":p.overrides.length&&o.set(h,{placementInfo:p,compiledOverrides:(await Promise.all(p.overrides.map((t=>Qo(e,t))))).filter(vo.Ru)}),i[h]=p.placement;break;case"text-rasterization-param":{var u;if(p.overrides.length){const t=p.overrides.map((t=>Qo(e,t,p.useLegacyLabelEvaluationRules)));a.set(h,{compiledOverrides:(await Promise.all(t)).filter(vo.Ru),rasterizationParam:p,objectIdToResourceId:new Map});continue}const r={type:"cim-rasterization-info",resource:p.resource};i[h]=null!==(u=await t.fetchResourceImmediate(r))&&void 0!==u?u:null;break}case"sprite-rasterization-param":{var d;if(p.overrides.length){const t=p.overrides.map((t=>Qo(e,t)));a.set(h,{compiledOverrides:(await Promise.all(t)).filter(vo.Ru),rasterizationParam:p,objectIdToResourceId:new Map});continue}if("animated"===p.resource.type){a.set(h,{compiledOverrides:[],rasterizationParam:p,objectIdToResourceId:new Map});continue}const r={type:"cim-rasterization-info",resource:p.resource};i[h]=null!==(d=await t.fetchResourceImmediate(r))&&void 0!==d?d:null;break}case"cim-marker-transform-param":{const{params:t}=p;if($o(t)){const r={compiledMarkerInfos:[]};await Promise.all(t.map((async t=>{const i={props:{}};for(const r in t)if(Jo(t[r])){const s=await Ko(e,t[r]);i.compiledExpressionMap||(i.compiledExpressionMap=new Map);const n=i.compiledExpressionMap;s&&n.set(r,s)}else i.props[r]=t[r];r.compiledMarkerInfos.push(i)}))),c.set(h,r)}else i[h]={type:"cim-marker-transform-info",infos:t};break}case"animation-params":{const{params:r}=p,s=Uo(r);if($o(s)){const t=await Promise.all(s.map((t=>Wo(t,e))));l.set(h,{params:t,propertyIdToResourceId:new Map,key:h})}else{const e=Go(s),r=await t.fetchResourceImmediate({type:"animation-info",resource:e});null!=r&&"sprite"===r.type&&(i[h]={dataRow:r.rect.y,dataColumn:r.rect.x})}break}default:i[h]=p}else i[h]=p}return new ea(r,i,s,n,o,a,c,l)}constructor(e,t,r,i,s,n,o,a){this.inputMeshParams=e,this._resolvedMeshParams=t,this._dynamicProperties=r,this._dynamicEffectProperties=i,this._dynamicPlacementProperties=s,this._dynamicAsyncProperties=n,this._dynamicTransformProperties=o,this._dynamicAsyncAnimations=a,this.evaluator=e=>e}get hasDynamicProperties(){return!!(this._dynamicProperties.size||this._dynamicAsyncProperties.size||this._dynamicEffectProperties.size||this._dynamicTransformProperties.size||this._dynamicPlacementProperties.size||this._dynamicAsyncAnimations.size)}get evaluatedMeshParams(){return this._evaluatedMeshParams||(this._evaluatedMeshParams=this.evaluator(this._resolvedMeshParams)),this._evaluatedMeshParams}enqueueRequest(e,t,r){for(const n of this._dynamicAsyncProperties.values()){const o=(0,bo.o8)(n.rasterizationParam.resource);"animated"===n.rasterizationParam.resource.type&&n.rasterizationParam.resource.randomizeStartTime&&(o.primitiveName="__RESERVED__PRIMITIVE__NAME__",o.startGroup=Io(t.getObjectId()||0));for(const{primitiveName:e,propertyName:c,computed:l,defaultValue:u,valueExpressionInfo:d}of n.compiledOverrides)try{ve(o,"animated"===n.rasterizationParam.resource.type?o.primitiveName:e,c,l,t,r,u)}catch(s){W.A.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.mesh.MeshWriterInputEvaluator").errorOnce(new i.A("invalid-arcade-expression","Encountered an error when evaluating the arcade expression '".concat(null===d||void 0===d?void 0:d.expression,"' (primitive: '").concat(e,"', property: '").concat(c,"')"),s))}const a=e.enqueueRequest({type:"cim-rasterization-info",resource:o});n.objectIdToResourceId.set(t.getObjectId(),a)}for(const i of this._dynamicAsyncAnimations.values()){const s=i.params.map((e=>Yo(e,t,r))).map(Do).map((e=>e.simplify())),n=jo(s),o=e.enqueueRequest({type:"animation-info",resource:n});i.propertyIdToResourceId.set(t.getObjectId()+"."+i.key,o)}}evaluateMeshParams(e,t,r){for(const[i,s]of this._dynamicProperties.entries())this._resolvedMeshParams[i]=s.computed.readWithDefault(t,r,s.defaultValue);for(const[i,s]of this._dynamicPlacementProperties.entries())for(const{computed:e,defaultValue:n,propertyName:o}of s.compiledOverrides){const a=e.readWithDefault(t,r,n);s.placementInfo.placement[o]=a,this._resolvedMeshParams[i]=s.placementInfo.placement}for(const[i,s]of this._dynamicEffectProperties.entries())for(const e of s.effects){for(const{computed:i,defaultValue:s,propertyName:n}of e.compiledOverrides){const o=i.readWithDefault(t,r,s);e.effect[n]=o}this._resolvedMeshParams[i]=s.effects.map((e=>e.effect))}for(const[i,s]of this._dynamicTransformProperties.entries()){const e={type:"cim-marker-transform-info",infos:[]};for(const i of s.compiledMarkerInfos){const s=(0,m.A)({},i.props);if(i.compiledExpressionMap)for(const[e,n]of i.compiledExpressionMap){const i=n.computed.readWithDefault(t,r,n.defaultValue);s[e]="number"==typeof i||"boolean"==typeof i?i:n.defaultValue}e.infos.push(s)}this._resolvedMeshParams[i]=e}for(const[i,s]of this._dynamicAsyncProperties.entries()){const r=s.objectIdToResourceId.get(t.getObjectId());if(null==r)continue;const n=e.getResource(r);this._resolvedMeshParams[i]=n}for(const[i,s]of this._dynamicAsyncAnimations.entries()){const r=s.propertyIdToResourceId.get(t.getObjectId()+"."+i);if(null==r)continue;const n=e.getResource(r);this._resolvedMeshParams[i]={dataRow:n.rect.y,dataColumn:n.rect.x}}return this._evaluatedMeshParams=this.evaluator(this._resolvedMeshParams),this.evaluatedMeshParams}}const ta={createComputedParams:e=>e,optionalAttributes:{},attributes:{pos:{type:X.pe.SHORT,count:2,packPrecisionFactor:10,pack:"position"},id:{type:X.pe.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:X.pe.UNSIGNED_BYTE,count:1,pack:e=>0},offset:{type:X.pe.SHORT,count:2,packPrecisionFactor:16,packAlternating:{count:4,pack:e=>{let{size:t}=e;const r=(0,u.Lz)(t),i=-r/2,s=-r/2;return[[i,s],[i+r,s],[i,s+r],[i+r,s+r]]}}},texCoords:{type:X.pe.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:()=>[[0,1],[1,1],[0,0],[1,0]]}},size:{type:X.pe.UNSIGNED_BYTE,count:2,pack:e=>{let{size:t}=e;return[t,t]}},referenceSize:{type:X.pe.UNSIGNED_BYTE,count:1,pack:e=>{let{size:t}=e;return(0,u.Lz)(t)}},zoomRange:{type:X.pe.UNSIGNED_BYTE,count:2,pack:(e,t)=>{let{scaleInfo:r}=e,{tileInfo:i}=t;return re(r,i)}}}};class ra extends Te{constructor(){super(...arguments),this.vertexSpec=ta}_write(e,t){const r=t.getDisplayId(),i=this.evaluatedMeshParams.minPixelBuffer,s=Math.max((0,u.Lz)(this.evaluatedMeshParams.size),i);let n,o;if("esriGeometryPoint"===t.geometryType)n=t.readXForDisplay(),o=t.readYForDisplay();else{const e=t.readCentroidForDisplay();if(!e)return;n=null===e||void 0===e?void 0:e.coords[0],o=null===e||void 0===e?void 0:e.coords[1]}e.recordStart(this.instanceId,this.attributeLayout),e.recordBounds(n,o,s,s);const a=e.vertexCount();this._writeVertex(e,r,n,o),e.indexWrite(a+0),e.indexWrite(a+1),e.indexWrite(a+2),e.indexWrite(a+1),e.indexWrite(a+3),e.indexWrite(a+2),e.recordEnd()}}class ia{async createMeshWriter(e,t,r,i){const s=this._getMeshWriter(i.techniqueType),n=await ea.create(e,t,i.inputParams),o=new s(i.id,n,i.optionalAttributes,r);return await o.loadDependencies(),o}_getMeshWriter(e){switch(e){case ee.Fill:return wt;case ee.DotDensity:return xt;case ee.ComplexFill:return kt;case ee.PatternFill:return St;case ee.OutlineFill:return Lt;case ee.PatternOutlineFill:return yn;case ee.ComplexOutlineFill:return hn;case ee.Marker:return xo;case ee.PieChart:return ra;case ee.Text:return ao;case ee.Line:return zt;case ee.TexturedLine:return fo;case ee.Heatmap:return gn;case ee.Label:return uo;case ee.AnimatedMarker:return De;default:throw new Error("Internal Error: Mesh writer not in the registry")}}}class sa{constructor(e,t,r,i){this.storage=e,this.proxy=t,this.viewParams=r,this.registry=i}async createMeshWriters(e){const t=e.map((e=>this.registry.createMeshWriter(this.storage,this.proxy,this.viewParams,e)));return Promise.all(t)}}var na=r(80544);class oa{constructor(e){this._outstandingMessages=[],this._queue=new na.e({concurrency:e.concurrency,process:t=>e.process(t)})}async push(e){if(e.end)return await Promise.all(this._outstandingMessages),await this._queue.push(e),void(this._outstandingMessages=[]);const t=this._queue.push(e);return this._outstandingMessages.push(t),t}}var aa=r(27106);function ca(e){var t={},r=!1;function i(t,i){return r=!0,i=new Promise((function(r){r(e[t](i))})),{done:!1,value:new aa.A(i,1)}}return t["undefined"!=typeof Symbol&&Symbol.iterator||"@@iterator"]=function(){return this},t.next=function(e){return r?(r=!1,e):i("next",e)},"function"==typeof e.throw&&(t.throw=function(e){if(r)throw r=!1,e;return i("throw",e)}),"function"==typeof e.return&&(t.return=function(e){return r?(r=!1,e):i("return",e)}),t}var la=r(56218),ua=r(30912),da=(r(35238),r(20176)),ha=r(24586),pa=r(1900);class fa{static async create(e,t){var r;if("count"===t.statisticType){const e=new Zo(1);return new fa(t.name,t.alias,t.type,t.statisticType,e)}const i=await e.createComputedField({expression:null===(r=t.onStatisticExpression)||void 0===r?void 0:r.expression,field:t.onStatisticField});return new fa(t.name,t.alias,t.type,t.statisticType,i)}constructor(e,t,r,i,s){this.name=e,this.alias=t,this.type=r,this.statisticType=i,this.computed=s}}var _a=r(54099),ya=r(42294),ma=r(33376),ga=r(38276);class xa{constructor(e){this.subscription=e,this.handledChunks=new Set}destroy(){}}class va{constructor(e,t){this._source=e,this._attributeStore=t,this._sendStates=new Map}destroy(){}get enablePixelBuffering(){return!0}onSubscribe(e){const t=this.createState(e);this._sendStates.set(e.key.id,t),this.updateChunks()}onUnsubscribe(e){var t;null!==(t=this._sendStates.get(e.key.id))&&void 0!==t&&t.destroy(),this._sendStates.delete(e.key.id)}invalidate(){const e=Array.from(this._sendStates.values());this._sendStates.clear();for(const t of e)t.destroy(),this.onSubscribe(t.subscription)}invalidateAttributeData(){}getFeatureObjectIdsForAggregate(e){throw new Error("InternalError: AggregateId lookup not supported")}getDisplayIds(e){return this.displayMap(e,(e=>e),(e=>e))}getDisplayAndObjectIds(e){return this.displayMap(e,(e=>e),((e,t,r)=>[e,r]))}beforeUpdateChunks(){}afterUpdateChunks(){}}class ba extends va{constructor(e,t,r,i){super(e,t),this.spatialReference=r,this.aggregateFields=i,this.events=new _a.A,this.featureAdapter=ma.T}get aggregateQueryEngine(){return this._aggregateQueryEngine||(this._aggregateQueryEngine=new ga.d({featureStore:this,fieldsIndex:this._metadata.fieldsIndex,geometryType:this._metadata.geometryType,objectIdField:this._metadata.objectIdField,spatialReference:this.spatialReference})),this._aggregateQueryEngine}removeChunks(e){}forEach(e){return this.forEachAggregateWorldSpace(e)}forEachInBounds(e,t){}forEachBounds(e,t){const r=(0,ya.vt)();for(const i of e){const e=(0,Tn.jQ)(r,i.geometry,!1,!1);e&&t(e)}}}class wa{constructor(e,t,r,i,s){this.subscription=e,this.reader=t,this.clear=r,this.end=i,this.debugInfo=s,this.type="append"}get id(){return this.subscription.tile.id}createMessage(e,t,r){return{type:"append",clear:this.clear,id:this.id,append:e,end:this.end,debugInfo:this.debugInfo,subscriptionVesrion:this.subscription.version,version:t,attributeEpoch:r}}}class Ia{constructor(e,t,r,i,s){this.subscription=e,this.reader=t,this.remove=r,this.end=i,this.debugInfo=s,this.type="update"}get id(){return this.subscription.tile.id}createMessage(e,t,r){return{type:"update",id:this.id,modify:e,debugInfo:this.debugInfo,remove:this.remove,version:t,subscriptionVesrion:this.subscription.version,end:this.end,attributeEpoch:r}}}var Sa=r(61196);function Ta(e,t){if(!(this instanceof Ta))return new Ta(e,t);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this.toBBox=t:this._initFormat(t)),this.clear()}function Aa(e,t,r){if(!r)return t.indexOf(e);for(var i=0;i<t.length;i++)if(r(e,t[i]))return i;return-1}function Ma(e,t){ka(e,0,e.children.length,t,e)}function ka(e,t,r,i,s){s||(s=Na(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(var n,o=t;o<r;o++)n=e.children[o],Fa(s,e.leaf?i(n):n);return s}function Fa(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function Ea(e,t){return e.minX-t.minX}function Ca(e,t){return e.minY-t.minY}function Pa(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function za(e){return e.maxX-e.minX+(e.maxY-e.minY)}function Oa(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function Ra(e,t){var r=Math.max(e.minX,t.minX),i=Math.max(e.minY,t.minY),s=Math.min(e.maxX,t.maxX),n=Math.min(e.maxY,t.maxY);return Math.max(0,s-r)*Math.max(0,n-i)}function Da(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function La(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function Na(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Ba(e,t,r,i,s){for(var n,o=[t,r];o.length;)(r=o.pop())-(t=o.pop())<=i||(n=t+Math.ceil((r-t)/i/2)*i,(0,Sa.q)(e,n,t,r,s),o.push(t,n,n,r))}Ta.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,r=[],i=this.toBBox;if(!La(e,t))return r;for(var s,n,o,a,c=[];t;){for(s=0,n=t.children.length;s<n;s++)o=t.children[s],La(e,a=t.leaf?i(o):o)&&(t.leaf?r.push(o):Da(e,a)?this._all(o,r):c.push(o));t=c.pop()}return r},collides:function(e){var t=this.data,r=this.toBBox;if(!La(e,t))return!1;for(var i,s,n,o,a=[];t;){for(i=0,s=t.children.length;i<s;i++)if(n=t.children[i],La(e,o=t.leaf?r(n):n)){if(t.leaf||Da(e,o))return!0;a.push(n)}t=a.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,r=e.length;t<r;t++)this.insert(e[t]);return this}var i=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var s=this.data;this.data=i,i=s}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(e){return null!=e&&this._insert(e,this.data.height-1),this},clear:function(){return this.data=Na([]),this},remove:function(e,t){if(null==e)return this;for(var r,i,s,n,o=this.data,a=this.toBBox(e),c=[],l=[];o||c.length;){if(o||(o=c.pop(),i=c[c.length-1],r=l.pop(),n=!0),o.leaf&&-1!==(s=Aa(e,o.children,t)))return o.children.splice(s,1),c.push(o),this._condense(c),this;n||o.leaf||!Da(o,a)?i?(r++,o=i.children[r],n=!1):o=null:(c.push(o),l.push(r),r=0,i=o,o=o.children[0])}return this},toBBox:function(e){return e},compareMinX:Ea,compareMinY:Ca,toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var r=[];e;)e.leaf?t.push.apply(t,e.children):r.push.apply(r,e.children),e=r.pop();return t},_build:function(e,t,r,i){var s,n=r-t+1,o=this._maxEntries;if(n<=o)return Ma(s=Na(e.slice(t,r+1)),this.toBBox),s;i||(i=Math.ceil(Math.log(n)/Math.log(o)),o=Math.ceil(n/Math.pow(o,i-1))),(s=Na([])).leaf=!1,s.height=i;var a,c,l,u,d=Math.ceil(n/o),h=d*Math.ceil(Math.sqrt(o));for(Ba(e,t,r,h,this.compareMinX),a=t;a<=r;a+=h)for(Ba(e,a,l=Math.min(a+h-1,r),d,this.compareMinY),c=a;c<=l;c+=d)u=Math.min(c+d-1,l),s.children.push(this._build(e,c,u,i-1));return Ma(s,this.toBBox),s},_chooseSubtree:function(e,t,r,i){for(var s,n,o,a,c,l,u,d;i.push(t),!t.leaf&&i.length-1!==r;){for(u=d=1/0,s=0,n=t.children.length;s<n;s++)c=Pa(o=t.children[s]),(l=Oa(e,o)-c)<d?(d=l,u=c<u?c:u,a=o):l===d&&c<u&&(u=c,a=o);t=a||t.children[0]}return t},_insert:function(e,t,r){var i=this.toBBox,s=r?e:i(e),n=[],o=this._chooseSubtree(s,this.data,t,n);for(o.children.push(e),Fa(o,s);t>=0&&n[t].children.length>this._maxEntries;)this._split(n,t),t--;this._adjustParentBBoxes(s,n,t)},_split:function(e,t){var r=e[t],i=r.children.length,s=this._minEntries;this._chooseSplitAxis(r,s,i);var n=this._chooseSplitIndex(r,s,i),o=Na(r.children.splice(n,r.children.length-n));o.height=r.height,o.leaf=r.leaf,Ma(r,this.toBBox),Ma(o,this.toBBox),t?e[t-1].children.push(o):this._splitRoot(r,o)},_splitRoot:function(e,t){this.data=Na([e,t]),this.data.height=e.height+1,this.data.leaf=!1,Ma(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,r){var i,s,n,o,a,c,l,u;for(c=l=1/0,i=t;i<=r-t;i++)o=Ra(s=ka(e,0,i,this.toBBox),n=ka(e,i,r,this.toBBox)),a=Pa(s)+Pa(n),o<c?(c=o,u=i,l=a<l?a:l):o===c&&a<l&&(l=a,u=i);return u},_chooseSplitAxis:function(e,t,r){var i=e.leaf?this.compareMinX:Ea,s=e.leaf?this.compareMinY:Ca;this._allDistMargin(e,t,r,i)<this._allDistMargin(e,t,r,s)&&e.children.sort(i)},_allDistMargin:function(e,t,r,i){e.children.sort(i);var s,n,o=this.toBBox,a=ka(e,0,t,o),c=ka(e,r-t,r,o),l=za(a)+za(c);for(s=t;s<r-t;s++)n=e.children[s],Fa(a,e.leaf?o(n):n),l+=za(a);for(s=r-t-1;s>=t;s--)n=e.children[s],Fa(c,e.leaf?o(n):n),l+=za(c);return l},_adjustParentBBoxes:function(e,t,r){for(var i=r;i>=0;i--)Fa(t[i],e)},_condense:function(e){for(var t,r=e.length-1;r>=0;r--)0===e[r].children.length?r>0?(t=e[r-1].children).splice(t.indexOf(e[r]),1):this.clear():Ma(e[r],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}};class Va{static fromReader(e){const t=[],r=e.copy(),i=(0,ya.vt)();for(;r.next();)r.getBounds(i)&&t.push(r.getIndex());const s=Ta(9,(e=>(r.setIndex(e),{minX:r.getBoundsXMin(),minY:r.getBoundsYMin(),maxX:r.getBoundsXMax(),maxY:r.getBoundsYMax()})));return s.load(t),new Va(s)}constructor(e){this._index=e}search(e){const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}}var qa=r(76797),Ga=r(65215),Ua=r(14556);new Float64Array(2),new Float64Array(2);function ja(e,t,r,i){if(i.isWebMercator){const i=(0,jn.KJ)(e/Ua.$O.radius),s=i-360*Math.floor((i+180)/360),n=[0,0];return Wa(n,0,(0,jn.KJ)(Math.PI/2-2*Math.atan(Math.exp(-t/Ua.$O.radius))),s,r),n}const s=(0,ha.Cv)({x:e,y:t},i,w.A.WGS84);if(!s)return null;const n=[0,0];return Wa(n,0,s.y,s.x,r),n}function Wa(e,t,r,i,s){s%2&&(s+=1);let n=0,o=0,a=-90,c=90,l=-180,u=180;for(let d=0;d<s/2;d++){for(let e=0;e<5;e++){const t=(l+u)/2,r=i>t?1:0;n|=r<<29-(e+5*d),l=(1-r)*l+r*t,u=(1-r)*t+r*u}for(let e=0;e<5;e++){const t=(a+c)/2,i=r>t?1:0;o|=i<<29-(e+5*d),a=(1-i)*a+i*t,c=(1-i)*t+i*c}}e[2*t]=n,e[2*t+1]=o}class Ya{constructor(e){this._statistics=e}get statistics(){return this._statistics}}function Xa(e,t,r){var i;if(null==e)return null;const s=t.readArcadeFeature();t.contextTimeZone=null===(i=r.$view)||void 0===i?void 0:i.timeZone;try{return e.evaluate((0,m.A)((0,m.A)({},r),{},{$feature:s}),e.services)}catch(n){return W.A.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",n),null}}function Ha(e){return null==e||e===1/0||e===-1/0||"number"==typeof e&&isNaN(e)}function Za(e,t,r,i){var s;if(null==e)return null!=i?i:null;const n=t.readArcadeFeature();t.contextTimeZone=null===(s=r.$view)||void 0===s?void 0:s.timeZone;const o=e.evaluate((0,m.A)((0,m.A)({},r),{},{$feature:n}),e.services);return Ha(o)?null!=i?i:null:o}const Qa=Math.PI/180;class Ka{static create(e){return new Ka(e.map((e=>function(e){switch(e.statisticType){case"min":return new $a(e);case"max":return new ec(e);case"avg":return new rc(e);case"avg_angle":return new ic(e);case"sum":case"count":return new tc(e);case"mode":return new sc(e)}}(e))))}constructor(e){this._statistics=e}values(){return this._statistics.values()}insert(e,t){for(const r of this._statistics)r.insert(e,t)}merge(e){for(let t=0;t<this._statistics.length;t++){const r=this._statistics[t],i=e._statistics[t];if(r.field.name!==i.field.name)throw new Error("InternalError: Tried to merge incompatible statistics");r.merge(i)}}clone(){return new Ka(this._statistics.map((e=>e.clone())))}}class Ja{constructor(e){this.field=e}insert(e,t){if(!this.field.computed)return;const r=this.field.computed.read(e,t);Ha(r)||this._insertValue(r)}}class $a extends Ja{constructor(){super(...arguments),this.type="min",this.value=Number.MAX_VALUE}_insertValue(e){this.value=Math.min(this.value,e)}merge(e){this.value=Math.min(this.value,e.value)}clone(){const e=new $a(this.field);return e.value=this.value,e}}class ec extends Ja{constructor(){super(...arguments),this.type="max",this.value=Number.MIN_VALUE}_insertValue(e){this.value=Math.max(this.value,e)}merge(e){this.value=Math.max(this.value,e.value)}clone(){const e=new ec(this.field);return e.value=this.value,e}}class tc extends Ja{constructor(){super(...arguments),this.type="sum",this.value=0}_insertValue(e){this.value+=e}merge(e){this.value+=e.value}clone(){const e=new tc(this.field);return e.value=this.value,e}}class rc extends Ja{constructor(){super(...arguments),this.type="avg",this._total=0,this._count=0}get value(){return this._total/this._count}_insertValue(e){this._total+=e,this._count+=1}merge(e){this._total+=e._total,this._count+=e._count}clone(){const e=new rc(this.field);return e._total=this._total,e._count=this._count,e}}class ic extends Ja{constructor(){super(...arguments),this.type="avg_angle",this._x=0,this._y=0,this._count=0}get value(){const e=this._x/this._count,t=this._y/this._count,r=180/Math.PI;return Math.atan2(t,e)*r}_insertValue(e){this._x=this._x+Math.cos(e*Qa),this._y=this._y+Math.sin(e*Qa),this._count+=1}merge(e){this._x+=e._x,this._y+=e._y,this._count+=e._count}clone(){const e=new ic(this.field);return e._x=this._x,e._y=this._y,e._count=this._count,e}}class sc extends Ja{constructor(){super(...arguments),this._frequencies=new Map}get value(){let e,t=0;for(const[r,i]of this._frequencies.entries())i>t&&(t=i,e=r);return e}_insertValue(e){const t=this._frequencies.get(e);null!=t?this._frequencies.set(e,t+1):this._frequencies.set(e,1)}merge(e){for(const[t,r]of e._frequencies.entries()){const e=this._frequencies.get(t);null!=e?this._frequencies.set(t,e+r):this._frequencies.set(t,r)}}clone(){const e=new sc(this.field);return e._frequencies=new Map(this._frequencies),e}}class nc extends Ya{static create(e,t,r,i){const s=Ka.create(e),n=new Array(32);for(let o=0;o<n.length;o++)n[o]=null;return new nc(s,t,r,i,n)}constructor(e,t,r,i,s){super(e),this.xNode=t,this.yNode=r,this.depth=i,this.children=s,this._objectIds=new Set,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._xGeohashTotal=0,this._yGeohashTotal=0,this.next=null}get id(){return"".concat(this.xNode,".").concat(this.yNode)}get containedObjectIds(){return this._objectIds}get count(){return this._count}clone(){const e=new nc(this._statistics.clone(),this.xNode,this.yNode,this.depth,this.children);return e._count=this._count,e._xWorldTotal=this._xWorldTotal,e._yWorldTotal=this._yWorldTotal,e._xGeohashTotal=this._xGeohashTotal,e._yGeohashTotal=this._yGeohashTotal,e.next=this.next,e._objectIds=new Set(this._objectIds),e}insert(e,t,r,i,s,n){this._count+=1,this._xWorldTotal+=t,this._yWorldTotal+=r,this._xGeohashTotal+=i,this._yGeohashTotal+=s,this._statistics.insert(e,n),this._objectIds.add(e.getObjectId())}merge(e){if(0!==e._count){this._count+=e._count,this._xWorldTotal+=e._xWorldTotal,this._yWorldTotal+=e._yWorldTotal,this._xGeohashTotal+=e._xWorldTotal,this._yGeohashTotal+=e._yWorldTotal,this._statistics.merge(e._statistics);for(const t of e._objectIds.values())this._objectIds.add(t)}}getCentroid(e){throw new Error("getCentroid not supported for GeohashNode")}getGeometry(e,t){const r=this._getLngLatBounds(),[i,s,n,o]=r,a=(0,ha.Cv)({rings:[[[i,s],[i,o],[n,o],[n,s],[i,s]]]},w.A.WGS84,e),c=(0,Tn.Ye)(new Be.A,a,!1,!1);return null!=t?(0,Tn.Nl)(new Be.A,c,!1,!1,"esriGeometryPolygon",t,!1,!1):c}getGeometricCentroid(e,t){const r=this._getLngLatBounds(),[i,s,n,o]=r,a=(0,ha.Cv)({x:(i+n)/2,y:(s+o)/2},w.A.WGS84,e),c=(0,Tn.qN)(new Be.A,a);return null!=t?(0,Tn.Nl)(new Be.A,c,!1,!1,"esriGeometryPoint",t,!1,!1):c}getAttributes(){const e={aggregateId:this.id};for(const t of this._statistics.values())e[t.field.name]=t.value;return e.aggregateCount=this._count,e}find(e,t,r,i,s,n){if(i>=r)return this;const o=1-i%2,a=3*o+2*(1-o),c=2*o+3*(1-o),l=30-s-a,u=30-n-c,d=((e&7*o+3*(1-o)<<l)>>l)+((t&3*o+7*(1-o)<<u)>>u)*(8*o+4*(1-o)),h=this.children[d];return null==h?null:h.find(e,t,r,i+1,s+a,n+c)}_getLngLatBounds(){const e=this.depth,t=Math.ceil(e/2),r=Math.floor(e/2),i=30-(3*t+2*r),s=30-(2*t+3*r);return function(e,t){let r=-90,i=90,s=-180,n=180;for(let o=0;o<t;o++){const t=Math.ceil((o+1)/2),a=Math.floor((o+1)/2),c=1-o%2,l=30-(3*t+2*a),u=30-(2*t+3*a),d=3*c+2*(1-c),h=2*c+3*(1-c),p=3*c+7*(1-c)<<u,f=(7*c+3*(1-c)<<l&e.geohashX)>>l,_=(p&e.geohashY)>>u;for(let e=d-1;e>=0;e--){const t=(s+n)/2,r=f&1<<e?1:0;s=(1-r)*s+r*t,n=(1-r)*t+r*n}for(let e=h-1;e>=0;e--){const t=(r+i)/2,s=_&1<<e?1:0;r=(1-s)*r+s*t,i=(1-s)*t+s*i}}return[s,r,n,i]}({geohashX:this.xNode<<i,geohashY:this.yNode<<s},this.depth)}}class oc{constructor(e){this._fields=e,this._size=0,this._depth=0,this._root=nc.create(this._fields,0,0,0)}destroy(){}get size(){return this._size}get depth(){return this._depth}find(e,t,r){return this._root.find(e,t,r,0,0,0)}insert(e,t,r,i,s,n,o){let a=this._root,c=0,l=0,u=0;for(;null!==a;){if(a.insert(e,t,r,i,s,o),c>=n)return;const d=Math.ceil((c+1)/2),h=Math.floor((c+1)/2),p=1-c%2,f=30-(3*d+2*h),_=30-(2*d+3*h),y=(i&7*p+3*(1-p)<<f)>>f,m=(s&3*p+7*(1-p)<<_)>>_,g=y+m*(8*p+4*(1-p));l=l<<3*p+2*(1-p)|y,u=u<<2*p+3*(1-p)|m,null==a.children[g]&&(a.children[g]=nc.create(this._fields,l,u,c+1),this._depth=Math.max(this._depth,c+1),this._size+=1),c+=1,a=a.children[g]}}putBins(e,t){for(const r of this.getNodes(t)){const t=e.get(r.id);t?t.merge(r):e.set(r.id,r.clone())}}getNodes(e){const t=[],{geohashBounds:r,level:i}=e;let s=this._root;for(;null!==s;){const e=s.depth,n=s.xNode,o=s.yNode;if(e>=i){t.push(s),s=s.next;continue}const a=Math.ceil((e+1)/2),c=Math.floor((e+1)/2),l=1-e%2,u=30-(3*a+2*c),d=30-(2*a+3*c),h=~((1<<u)-1),p=~((1<<d)-1),f=(r.xLL&h)>>u,_=(r.yLL&p)>>d,y=(r.xTR&h)>>u,m=(r.yTR&p)>>d,g=n<<3*l+2*(1-l),x=o<<2*l+3*(1-l),v=g+8*l+4*(1-l),b=x+4*l+8*(1-l),w=Math.max(g,f),I=Math.max(x,_),S=Math.min(v,y),T=Math.min(b,m);let A=null,M=null;for(let t=I;t<=T;t++)for(let e=w;e<=S;e++){const r=e-g+(t-x)*(8*l+4*(1-l)),i=s.children[r];i&&(A||(A=i,A.next=s.next),M&&(M.next=i),M=i,i.next=s.next)}s=A||s.next}return t}}class ac{constructor(e){this._options=e}insert(e,t){const r=e.getCursor(),i={$view:{scale:this._options.scale,timeZone:this._options.timeZone}};for(;r.next();)this._insertFeature(r,i,t)}_insertFeature(e,t,r){const{featureFilter:i}=this._options;if(null!==i&&!i.check(e))return;let s=0,n=0;if("esriGeometryPoint"===e.geometryType)s=e.readXWorldSpace(),n=e.readYWorldSpace();else{if(r){const t=e.readCentroidForDisplay();if(null==t)return;const[r,i]=t.coords;if(r<0||r>_.CQ||i<0||i>_.CQ)return}const t=e.readCentroidWorldSpace();if(null==t)return;s=t.coords[0],n=t.coords[1]}this._insert(e,s,n,t)}}class cc extends ac{constructor(e){super(e),this._tree=new oc(this._options.fields)}put(e){throw new Error("Geohash tree does not support put")}putBounded(e,t,r){const{geohashLevel:i,spatialReference:s}=this._options,n=function(e,t,r,i){const s=[e.xmin,e.ymin,e.xmax,e.ymax],n=Ga.A.fromExtent(qa.A.fromBounds(s,i)),o=(0,ha.Cv)(n,i,w.A.WGS84,{densificationStep:64*t});if(!o)return null;const a=(0,Tn.Ye)(new Be.A,o,!1,!1),c=a.coords.filter(((e,t)=>!(t%2))),l=a.coords.filter(((e,t)=>t%2)),u=Math.min(...c),d=Math.min(...l),h=Math.max(...c),p=Math.max(...l),f=ja(u,d,r,w.A.WGS84),_=ja(h,p,r,w.A.WGS84);return f&&_?{bounds:s,geohashBounds:{xLL:f[0],yLL:f[1],xTR:_[0],yTR:_[1]},level:r}:null}(t,r,i,s);null!=n&&this._tree.putBins(e,n)}_insert(e,t,r,i){const{geohashLevel:s,spatialReference:n}=this._options,o=ja(t,r,s,n);o&&this._tree.insert(e,t,r,o[0],o[1],s,i)}}var lc=r(31633);class uc extends Ya{static createId(e,t){return"".concat(e,".").concat(t)}static create(e,t,r,i){return new uc(e,t,Ka.create(r),i)}constructor(e,t,r,i){super(r),this.gridX=e,this.gridY=t,this._worldUnitsPerCell=i,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._objectIds=new Set}get id(){return uc.createId(this.gridX,this.gridY)}get containedObjectIds(){return this._objectIds}get count(){return this._count}get firstObjectId(){return this._objectIds.values().next().value}get centroidXWorld(){return this._xWorldTotal/this._count}get centroidYWorld(){return this._yWorldTotal/this._count}clone(){const e=new uc(this.gridX,this.gridY,this._statistics.clone(),this._worldUnitsPerCell);return e._count=this._count,e._xWorldTotal=this._xWorldTotal,e._yWorldTotal=this._yWorldTotal,e._firstFeatureAttributes=this._firstFeatureAttributes,e._objectIds=new Set(this._objectIds),e}insert(e,t,r,i){0===this._count?this._firstFeatureAttributes=e.readAttributes():this._firstFeatureAttributes=null,this._count+=1,this._xWorldTotal+=r,this._yWorldTotal+=i,this._statistics.insert(e,t),this._objectIds.add(e.getObjectId())}merge(e){if(0!==e._count){this._count+=e._count,this._firstFeatureAttributes=e._firstFeatureAttributes,this._xWorldTotal+=e._xWorldTotal,this._yWorldTotal+=e._yWorldTotal,this._statistics.merge(e._statistics);for(const t of e._objectIds.values())this._objectIds.add(t)}}getCentroidX(e){return null==e?this.centroidXWorld:(0,Tn.IE)(e,this.centroidXWorld)}getCentroidY(e){return null==e?this.centroidYWorld:(0,Tn.B2)(e,this.centroidYWorld)}getGeometry(e,t){const r=this.gridX*this._worldUnitsPerCell,i=this.gridY*this._worldUnitsPerCell,s=new Be.A([4],[r,i,r+this._worldUnitsPerCell,i,r+this._worldUnitsPerCell,i+this._worldUnitsPerCell,r,i+this._worldUnitsPerCell]);if(null!=t){const e=new Be.A;return(0,Tn.Nl)(e,s,!1,!1,"esriGeometryPolygon",t)}return s}getCentroid(e){const t=new Be.A([],[this.centroidXWorld,this.centroidYWorld]);if(null!=e){const r=new Be.A;return(0,Tn.Nl)(r,t,!1,!1,"esriGeometryPoint",e)}return t}getGeometricCentroid(e,t){const r=this.gridX*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,i=this.gridY*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,s=new Be.A([],[r,i]);if(null!=t){const e=new Be.A;return(0,Tn.Nl)(e,s,!1,!1,"esriGeometryPoint",t)}return s}getAttributes(){const e={aggregateId:this.id};for(const t of this._statistics.values())e[t.field.name]=t.value;return null!=this._firstFeatureAttributes?(0,m.A)((0,m.A)({},e),this._firstFeatureAttributes):e}}function dc(e,t){return(0,lc.GA)(e)*lc.dy*96/t}class hc extends ac{constructor(e){super(e),this._cells=new Map,this._pixelsPerMapUnit=dc(e.spatialReference,e.scale)}put(e){for(const t of this._cells.values()){const r=e.get(t.id);r?r.merge(t):e.set(t.id,t.clone())}}putBounded(e,t,r){const i=[t.xmin,t.ymin,t.xmax,t.ymax],[s,n,o,a]=i,c=Math.floor(s*this._pixelsPerMapUnit/this._options.cellSize),l=Math.floor(n*this._pixelsPerMapUnit/this._options.cellSize),u=Math.ceil(o*this._pixelsPerMapUnit/this._options.cellSize),d=Math.ceil(a*this._pixelsPerMapUnit/this._options.cellSize);for(let h=l;h<=d;h++)for(let t=c;t<=u;t++){const r="".concat(t,".").concat(h),i=this._cells.get(r);if(!i)continue;const s=e.get(i.id);s?i&&!e.has(i.id)&&s.merge(i):e.set(i.id,i.clone())}}_insert(e,t,r,i){const s=t*this._pixelsPerMapUnit,n=r*this._pixelsPerMapUnit,o=Math.floor(s/this._options.cellSize),a=Math.floor(n/this._options.cellSize);this._getCellOrCreate(o,a).insert(e,i,t,r)}_getCellOrCreate(e,t){const r=uc.createId(e,t);let i=this._cells.get(r);if(!i){const s=1*this._options.cellSize/this._pixelsPerMapUnit;i=uc.create(e,t,this._options.fields,s),this._cells.set(r,i)}return i}}var pc=r(46405),fc=r(16503),_c=r(14902),yc=r(88501),mc=r(90321),gc=r(67478);class xc{static fromBuffer(e,t){return new xc(e,t)}static create(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4294967295;const r=new Uint32Array(Math.ceil(e/32));return new xc(r,t)}constructor(e,t){this._mask=0,this._buf=e,this._mask=t}_getIndex(e){return Math.floor(e/32)}has(e){const t=this._mask&e;return!!(this._buf[this._getIndex(t)]&1<<t%32)}hasRange(e,t){let r=e,i=t;for(;r%32&&r!==i;){if(this.has(r))return!0;r++}for(;i%32&&r!==i;){if(this.has(r))return!0;i--}if(r===i)return!1;for(let s=r/32;s!==i/32;s++)if(this._buf[s])return!0;return!1}set(e){const t=this._mask&e,r=this._getIndex(t),i=1<<t%32;this._buf[r]|=i}setRange(e,t){let r=e,i=t;for(;r%32&&r!==i;)this.set(r++);for(;i%32&&r!==i;)this.set(i--);if(r!==i)for(let s=r/32;s!==i/32;s++)this._buf[s]=4294967295}unset(e){const t=this._mask&e,r=this._getIndex(t),i=1<<t%32;this._buf[r]&=4294967295^i}resize(e){const t=this._buf,r=new Uint32Array(Math.ceil(e/32));r.set(t),this._buf=r}or(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=e._buf[t];return this}and(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=e._buf[t];return this}xor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=e._buf[t];return this}ior(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=~e._buf[t];return this}iand(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=~e._buf[t];return this}ixor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=~e._buf[t];return this}any(){for(let e=0;e<this._buf.length;e++)if(this._buf[e])return!0;return!1}copy(e){for(let t=0;t<this._buf.length;t++)this._buf[t]=e._buf[t];return this}clone(){return new xc(this._buf.slice(),this._mask)}clear(){for(let e=0;e<this._buf.length;e++)this._buf[e]=0;return this}forEachSet(e){for(let t=0;t<this._buf.length;t++){let r=this._buf[t],i=32*t;if(r)for(;r;)1&r&&e(i),r>>>=1,i++}}countSet(){let e=0;return this.forEachSet((t=>{e++})),e}}class vc{constructor(e){this._valid=xc.create(e),this._data=new Array(e)}has(e){return this._valid.has(e)}set(e,t){this._valid.set(e),this._data[e]=t}get(e){return this._data[e]}}var bc,wc,Ic,Sc=r(19902);const Tc=null!==(bc=(0,n.A)("featurelayer-simplify-thresholds"))&&void 0!==bc?bc:[.5,.5,.5,.5],Ac=Tc[0],Mc=Tc[1],kc=Tc[2],Fc=Tc[3],Ec=null!==(wc=(0,n.A)("featurelayer-simplify-payload-size-factors"))&&void 0!==wc?wc:[1,2,4],Cc=Ec[0],Pc=Ec[1],zc=Ec[2],Oc=null!==(Ic=(0,n.A)("featurelayer-simplify-mobile-factor"))&&void 0!==Ic?Ic:2,Rc=(0,n.A)("esri-mobile"),Dc=4294967295;class Lc{constructor(e){this.metadata=e,this.type="FeatureSetReader",this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._boundsBuffer=[],this._caches=new Map,this.arcadeDeclaredClass="esri.arcade.Feature",this._contextTimeZone=null}destroy(){}[Symbol.dispose](){this.destroy()}get isEmpty(){return null!=this._deleted&&this._deleted.countSet()===this.getSize()}getAreaSimplificationThreshold(e,t){let r=1;const i=Rc?Oc:1;t>4e6?r=zc*i:t>1e6?r=Pc*i:t>5e5?r=Cc*i:t>1e5&&(r=i);let s=0;return e>4e3?s=Fc*r:e>2e3?s=kc*r:e>100?s=Mc:e>15&&(s=Ac),s}getBounds(e){if(function(e,t,r){if(!(e.length>t))for(;e.length<=t;)e.push(r)}(this._boundsBuffer,4*this.getIndex()+4,0),this.getBoundsXMin()===Dc)return!1;if(0===this.getBoundsXMin()){const t=this.readGeometryWorldSpace();if(!t)return this.setBoundsXMin(Dc),!1;let r=1/0,i=1/0,s=-1/0,n=-1/0;return t.forEachVertex(((e,t)=>{r=Math.min(r,e),i=Math.min(i,t),s=Math.max(s,e),n=Math.max(n,t)})),this.setBoundsXMin(r),this.setBoundsYMin(i),this.setBoundsXMax(s),this.setBoundsYMax(n),(0,ya.BI)(e,r,i,s,n),!0}const t=this.getBoundsXMin(),r=this.getBoundsYMin(),i=this.getBoundsXMax(),s=this.getBoundsYMax();return(0,ya.BI)(e,t,r,i,s),!0}getBoundsXMin(){return this._boundsBuffer[4*this.getIndex()]}setBoundsXMin(e){this._boundsBuffer[4*this.getIndex()]=e}getBoundsYMin(){return this._boundsBuffer[4*this.getIndex()+1]}setBoundsYMin(e){this._boundsBuffer[4*this.getIndex()+1]=e}getBoundsXMax(){return this._boundsBuffer[4*this.getIndex()+2]}setBoundsXMax(e){this._boundsBuffer[4*this.getIndex()+2]=e}getBoundsYMax(){return this._boundsBuffer[4*this.getIndex()+3]}setBoundsYMax(e){this._boundsBuffer[4*this.getIndex()+3]=e}readAttributeAsTimestamp(e){const t=this.readAttribute(e);return"string"==typeof t?new Date(t).getTime():"number"==typeof t||null==t?t:null}readAttribute(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const r=this._readAttribute(e,t);if(void 0!==r)return r;for(const i of this._joined){i.setIndex(this.getIndex());const r=i._readAttribute(e,t);if(void 0!==r)return r}}readAttributes(){const e=this._readAttributes();for(const t of this._joined){t.setIndex(this.getIndex());const r=t._readAttributes();for(const t of Object.keys(r))e[t]=r[t]}return e}joinAttributes(e){this._joined.push(e)}removeIds(e){if(null==this._objectIdToIndex){const e=new Map,t=this.getCursor();for(;t.next();){const r=t.getObjectId();(0,x.Lw)(r),e.set(r,t.getIndex())}this._objectIdToIndex=e}const t=this._objectIdToIndex;for(const r of e.values())t.has(r)&&this._removeAtIndex(t.get(r))}readOptimizedFeatureWorldSpace(){const e=this.readGeometryWorldSpace(),t=this.readAttributes(),r=this.readCentroidWorldSpace(),i=new da.Om(e,t,r);return i.objectId=this.getObjectId(),i.displayId=this.getDisplayId(),i}readLegacyFeatureForDisplay(){var e;const t=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:null!==(e=t&&{x:t.coords[0],y:t.coords[1]})&&void 0!==e?e:null}}readLegacyFeatureWorldSpace(){var e;const t=this.readCentroidWorldSpace();return{attributes:this.readAttributes(),geometry:this._readLegacyGeometryWorldSpace(),centroid:null!==(e=t&&{x:t.coords[0],y:t.coords[1]})&&void 0!==e?e:null}}readLegacyGeometryForDisplay(){const e=this.readGeometryForDisplay();return(0,Tn.zv)(e,this.geometryType,!1,!1)}readXForDisplay(){return this._readX()}readYForDisplay(){return this._readY()}readXWorldSpace(){const e=this._readX(),t=this.getInTransform();return null==t?e:e*t.scale[0]+t.translate[0]}readYWorldSpace(){const e=this._readY(),t=this.getInTransform();return null==t?e:t.translate[1]-e*t.scale[1]}readGeometryForDisplay(){const e=this._readGeometryDeltaDecoded(!0);if(!e){const e=this._createGeometryFromServerCentroid();return e?e.deltaDecode():null}return e}readGeometryWorldSpace(){let e=this._readGeometry();if(e||(e=this._createGeometryFromServerCentroid()),!e)return null;const t=e.clone(),r=this.getInTransform();return null!=r&&(0,Tn.Ch)(t,t,this.hasZ,this.hasM,r),t}readCentroidForDisplay(){const e=this.readGeometryForDisplay();return e?this._computeDisplayCentroid(e):this._readServerCentroid()}readCentroidWorldSpace(){const e=this.readGeometryForDisplay(),t=e?this._computeDisplayCentroid(e):this._readServerCentroid();if(!t)return null;const r=t.clone(),i=this.getInTransform();return null!=i&&(0,Tn.Ch)(r,r,this.hasZ,this.hasM,i),r}setCache(e){let t=this._caches.get(e);null==t&&(t=new vc(this.getSize()),this._caches.set(e,t)),this._activeCache=t}setCachedValue(e){this._activeCache.set(this.getIndex(),e)}hasCachedValue(){return this._activeCache.has(this.getIndex())}getCachedValue(){return this._activeCache.get(this.getIndex())}_readGeometryDeltaDecoded(e){const t=this._readGeometry(e);return"esriGeometryPoint"!==this.geometryType&&t&&this.getInTransform()?t.deltaDecode():t}get contextTimeZone(){return this._contextTimeZone}set contextTimeZone(e){this._contextTimeZone=e}readArcadeFeature(){return this}hasField(e){return this.fields.has(e)||this._joined.some((t=>t.hasField(e)))}geometry(){const e=this.readGeometryWorldSpace(),t=(0,Tn.zv)(e,this.geometryType,this.hasZ,this.hasM),r=(0,Sc.rS)(t);if(r){if(!this.metadata.spatialReference)throw new Error("InternalError: Expected spatial reference to be defined");r.spatialReference=this.metadata.spatialReference}return r}autocastArcadeDate(e,t){var r;return t&&t instanceof Date?this.isUnknownDateTimeField(e)?pc.lY.unknownDateJSToArcadeDate(t):pc.lY.dateJSAndZoneToArcadeDate(t,null!==(r=this.contextTimeZone)&&void 0!==r?r:gc.qU):t}isUnknownDateTimeField(e){return this.metadata.fieldsIndex.getTimeZone(e)===gc.L5}field(e){let t=this.fields.get(e);if(t)switch(t.type){case"date-only":case"esriFieldTypeDateOnly":return fc.n.fromReader(this.readAttribute(e,!1));case"time-only":case"esriFieldTypeTimeOnly":return _c.k.fromReader(this.readAttribute(e,!1));case"esriFieldTypeTimestampOffset":case"timestamp-offset":return pc.lY.fromReaderAsTimeStampOffset(this.readAttribute(e,!1));case"date":case"esriFieldTypeDate":return this.autocastArcadeDate(e,this.readAttribute(e,!0));default:return this.readAttribute(e,!1)}for(const r of this._joined)if(r.setIndex(this.getIndex()),t=r.fields.get(e),t)switch(t.type){case"date-only":case"esriFieldTypeDateOnly":return fc.n.fromReader(r._readAttribute(e,!1));case"time-only":case"esriFieldTypeTimeOnly":return _c.k.fromReader(r._readAttribute(e,!1));case"esriFieldTypeTimestampOffset":case"timestamp-offset":return pc.lY.fromReaderAsTimeStampOffset(r._readAttribute(e,!1));case"date":case"esriFieldTypeDate":return this.autocastArcadeDate(e,r._readAttribute(e,!0));default:return this.readAttribute(e,!1)}throw new Error("Field ".concat(e," does not exist"))}setField(e,t){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this.fields.fields.map((e=>e.name))}castToText(){var e;if(!(arguments.length>0&&void 0!==arguments[0]&&arguments[0]))return JSON.stringify(this.readLegacyFeatureForDisplay());const t=this.readLegacyFeatureForDisplay();if(!t)return JSON.stringify(null);const r={geometry:t.geometry,attributes:(0,m.A)({},null!==(e=t.attributes)&&void 0!==e?e:{})};for(const i in r.attributes){const e=r.attributes[i];e instanceof Date&&(r.attributes[i]=e.getTime())}return JSON.stringify(r)}gdbVersion(){return null}fullSchema(){return this.metadata.arcadeSchema}castAsJson(){var e,t;let r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return{attributes:this._readAttributes(),geometry:!0===(null===r||void 0===r?void 0:r.keepGeometryType)?this.geometry():null!==(e=null===(t=this.geometry())||void 0===t?void 0:t.toJSON())&&void 0!==e?e:null}}castAsJsonAsync(){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return Promise.resolve(this.castAsJson(e))}_getExists(){return null==this._deleted||!this._deleted.has(this.getIndex())}_computeDisplayCentroid(e){if(null==this.getInTransform())return(0,mc.Q)(new Be.A,e,this.hasM,this.hasZ);const t=le.z.fromOptimized(e,this.geometryType);t.yFactor*=-1;const r=(0,yc.d)(t);return r?(r[1]*=-1,new Be.A([],r)):null}copyInto(e){e._joined=this._joined,e._deleted=this._deleted,e._objectIdToIndex=this._objectIdToIndex,e._boundsBuffer=this._boundsBuffer,e._activeCache=this._activeCache,e._caches=this._caches,e._contextTimeZone=this._contextTimeZone}_readLegacyGeometryWorldSpace(){const e=this.readGeometryWorldSpace();return(0,Tn.zv)(e,this.geometryType,!1,!1)}_createGeometryFromServerCentroid(){const e=this._readServerCentroid();if(!e)return null;const[t,r]=e.coords;return this._createQuantizedExtrudedGeometry(t,r)}_createQuantizedExtrudedGeometry(e,t){return"esriGeometryPolyline"===this.geometryType?this._createQuantizedExtrudedLine(e,t):this._createQuantizedExtrudedQuad(e,t)}_createQuantizedExtrudedQuad(e,t){return new Be.A([5],[e-1,t,1,-1,1,1,-1,1,-1,-1])}_createQuantizedExtrudedLine(e,t){return new Be.A([2],[e-1,t+1,1,-1])}_removeAtIndex(e){null==this._deleted&&(this._deleted=xc.create(this.getSize())),this._deleted.set(e)}}class Nc extends Lc{static from(e,t){return new Nc(e.copy(),t)}constructor(e,t){super(e.metadata),this._currentIndex=-1,this._displayTranslationX=0,this._displayTranslationY=0,this._displayScaleX=1,this._displayScaleY=1,this._reader=e,this._indices=t,this._isPoint="esriGeometryPoint"===e.geometryType}setTransformForDisplay(e){const t=this._reader.getInTransform();if(null==t){const[t,r]=e.scale,[i,s]=e.translate;return this._displayTranslationX=-i/t,this._displayScaleX=1/t,this._displayTranslationY=s/r,this._displayScaleY=1/-r,void(this._displayTransform=e)}const[r,i]=t.scale,[s,n]=t.translate,[o,a]=e.scale,[c,l]=e.translate;if(this._displayScaleX=r/o,this._displayTranslationX=(s-c)/o,this._displayScaleY=i/a,this._displayTranslationY=(-n+l)/a,!this._isPoint&&t)throw new Error("InternalError: Relative transformations not supported for non-point features");this._displayTransform=e}getInTransform(){return this._reader.getInTransform()}get fields(){return this._reader.fields}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const e=new Nc(this._reader.copy(),this._indices);return e._currentIndex=this._currentIndex,e._displayTransform=this._displayTransform,e._displayTranslationX=this._displayTranslationX,e._displayTranslationY=this._displayTranslationY,e._displayScaleX=this._displayScaleX,e._displayScaleY=this._displayScaleY,e}get contextTimeZone(){return this._reader.contextTimeZone}set contextTimeZone(e){this._reader.contextTimeZone=e}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}readXForDisplay(){return this._reader.readXForDisplay()*this._displayScaleX+this._displayTranslationX}readYForDisplay(){return this._reader.readYForDisplay()*this._displayScaleY+this._displayTranslationY}readGeometryForDisplay(){const e=this._reader.readGeometryForDisplay();if(!this._displayTransform)return e;const t=new Be.A;return(0,Tn.Nl)(t,e,this.hasZ,this.hasM,this.geometryType,this._displayTransform),t.deltaDecode()}readCentroidForDisplay(){var e;const t=null===(e=this._reader.readCentroidForDisplay())||void 0===e?void 0:e.clone();if(t){const[e,r]=t.coords;t.coords[0]=e*this._displayScaleX+this._displayTranslationX,t.coords[1]=r*this._displayScaleY+this._displayTranslationY}return t}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}readAttribute(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._reader.readAttribute(e,t)}readAttributes(){return this._reader.readAttributes()}joinAttributes(e){return this._reader.joinAttributes(e)}getBounds(e){return this._reader.getBounds(e)}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(e){return this._reader.setDisplayId(e)}setIndex(e){return this._reader.setIndex(e)}getIndex(){return this._reader.getIndex()}readXWorldSpace(){return this._reader.readXWorldSpace()}readYWorldSpace(){return this._reader.readYWorldSpace()}_readX(){return this._reader.readXForDisplay()}_readY(){return this._reader.readYForDisplay()}_readServerCentroid(){return this._reader._readServerCentroid()}readLegacyFeatureForDisplay(){var e;const t=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:null!==(e=t&&{x:t.coords[0],y:t.coords[1]})&&void 0!==e?e:null}}readLegacyGeometryForDisplay(){const e=this.readGeometryForDisplay();return(0,Tn.zv)(e,this.geometryType,!1,!1)}readGeometryArea(){return this._reader.readGeometryArea()}readGeometryWorldSpace(){return this._reader.readGeometryWorldSpace()}_readGeometry(){return this._reader._readGeometry()}_readAttribute(e,t){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(e){return this._reader.field(e)}hasField(e){return this._reader.hasField(e)}setField(e,t){return this._reader.setField(e,t)}keys(){return this._reader.keys()}castToText(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this._reader.castToText(e)}}class Bc{size(){return this.reader.getSize()}get fields(){return this.reader.fields}invalidate(){this._aggregateIndex=null,this._aggregateIndexHash=null,this._spatialIndex=null}queryFeaturesInBounds(e){const t=this._getSpatialIndex().search(e);return Nc.from(this.reader,t)}getAggregateIndex(e){const t=JSON.stringify(e);if(t!==this._aggregateIndexHash){switch(this._aggregateIndexHash=t,e.type){case"grid":this._aggregateIndex=new hc(e);break;case"geohash":this._aggregateIndex=new cc(e)}this._aggregateIndex.insert(this.reader,this.isTiled)}return this._aggregateIndex}_getSpatialIndex(){return this._spatialIndex||(this._spatialIndex=Va.fromReader(this.reader)),this._spatialIndex}}class Vc extends Lc{static fromFeatures(e,t){const{objectIdField:r,geometryType:i}=t,s=(0,Tn.Di)([],e,i,!1,!1,r);for(let n=0;n<s.length;n++)s[n].displayId=e[n].displayId;return Vc.fromOptimizedFeatures(s,t)}static fromFeatureSet(e,t){const r=(0,Tn.q3)(e,t.objectIdField);return Vc.fromOptimizedFeatureSet(r,t)}static fromOptimizedFeatureSet(e,t){const r=Vc.fromOptimizedFeatures(e.features,t);return r._exceededTransferLimit=e.exceededTransferLimit,r._transform=e.transform,r._fieldsIndex=new pa.A(e.fields),r}static fromOptimizedFeatures(e,t,r){const i=new Vc(e,t);return i._fieldsIndex=t.fieldsIndex,i._transform=r,i}static empty(e){return new Vc([],e)}constructor(e,t){super(t),this._exceededTransferLimit=!1,this._featureIndex=-1,this._fieldsIndex=null,this._geometryType=t.geometryType,this._features=e}get fields(){return this._fieldsIndex}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}get _current(){return this._features[this._featureIndex]}removeIds(e){const t=new Set(e);this._features=this._features.filter((e=>!(null!=e.objectId&&t.has(e.objectId))))}getSize(){return this._features.length}getCursor(){return this.copy()}getInTransform(){return this._transform}getAttributeHash(){let e="";for(const t in this._current.attributes)e+=this._current.attributes[t];return e}getIndex(){return this._featureIndex}setIndex(e){this._featureIndex=e}getObjectId(){var e;return null===(e=this._current)||void 0===e?void 0:e.objectId}getDisplayId(){return this._current.displayId}setDisplayId(e){this._current.displayId=e}copy(){const e=new Vc(this._features,this.metadata);return this.copyInto(e),e}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readGeometryArea(){return(0,da.N3)(this._current)?(0,Tn.Rk)(this._current.geometry,2):0}_readX(){return(0,da.N3)(this._current)?this._current.geometry.coords[0]:0}_readY(){return(0,da.N3)(this._current)?this._current.geometry.coords[1]:0}_readGeometry(){var e;return(0,da.N3)(this._current)&&null!==(e=this._current.geometry)&&void 0!==e?e:null}_readServerCentroid(){return this._current.centroid}_readAttribute(e,t){if(!this._fieldsIndex){const t=this._current.attributes[e];if(void 0!==t)return t;const r=e.toLowerCase();for(const e in this._current.attributes)if(e.toLowerCase()===r)return this._current.attributes[e];return}const r=this._fieldsIndex.get(e);if(!r)return;const i=this._current.attributes[r.name];return null==i?i:t&&this.fields.isDateField(e)?new Date(i):i}_readAttributes(){return this._current.attributes}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._fieldsIndex=this._fieldsIndex}}function qc(e){return"localEdit"===e.chunkId}class Gc extends Bc{constructor(e,t){super(),this.metadata=e,this.removed=new Set,this.overriddenIds=new Set,this._features=[],this.chunkId=t,this.normalizedChunkId=t}get reader(){return Vc.fromOptimizedFeatures(this._features,this.metadata)}get queryInfo(){return{}}get first(){return!1}get end(){return!1}get isTiled(){return!1}get lastLocalEditDropped(){return this._lastLocalEditDropped}applyOverrides(e){this._onChange();const{reader:t,removed:r}=e,i=[],s=new Set,n=t.getCursor(),o=new Set(r);for(this.overriddenIds.clear();n.next();){const e=n.readOptimizedFeatureWorldSpace(),t=e.objectId;i.push(e),s.add(t),this.overriddenIds.add(t),this.removed.delete(t)}for(const a of this._features){const e=a.objectId;o.has(e)||s.has(e)||(i.push(a),this.overriddenIds.add(e))}this._features=i;for(const a of s.values())this.removed.delete(a);for(const a of r)this.removed.add(a),this.overriddenIds.add(a)}removeOverrides(e){this._lastLocalEditDropped=performance.now(),this._onChange();const t=e.reader.getCursor(),r=new Set;for(;t.next();){const e=t.getObjectId();this.overriddenIds.has(e)&&(r.add(e),this.overriddenIds.delete(e))}this._features=this._features.filter((e=>!r.has(e.objectId)))}getTileReader(e){if(!this._features.length)return null;const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}_onChange(){this.invalidate()}}class Uc extends Ho{constructor(e){super(),this._field=e}resize(e){throw new Error("Method not implemented.")}read(e,t){return e.readAttribute(this._field)}readWithDefault(e,t){return e.readAttribute(this._field)}referencesScale(){return!1}referencesGeometry(){return!1}}var jc=r(98976);class Wc extends Ho{static async create(e,t){const r=await(0,jc.Ad)(e,t.spatialReference,t.fields),i=(0,j.Wm)(e);return new Wc(r,i)}constructor(e,t){super(),this._compiled=e,this._cacheKey=t}resize(e){}read(e,t){return this.referencesScale()||"system"!==t.$view.timeZone?Xa(this._compiled,e,t):this._readCached(e,t)}readWithDefault(e,t,r){return this.referencesScale()||"system"!==t.$view.timeZone?Za(this._compiled,e,t,r):this._readWithDefaultCached(e,t,r)}referencesScale(){var e,t;return null!==(e=null===(t=this._compiled)||void 0===t?void 0:t.referencesScale())&&void 0!==e&&e}referencesGeometry(){var e,t;return null!==(e=null===(t=this._compiled)||void 0===t?void 0:t.referencesGeometry())&&void 0!==e&&e}_readCached(e,t){if(e.setCache(this._cacheKey),e.hasCachedValue())return e.getCachedValue();const r=Xa(this._compiled,e,t);return e.setCachedValue(r),r}_readWithDefaultCached(e,t,r){if(e.setCache(this._cacheKey),e.hasCachedValue())return e.getCachedValue();const i=Za(this._compiled,e,t,r);return e.setCachedValue(i),i}}var Yc=r(79701),Xc=r(65460);class Hc extends Ho{static async create(e,t){const r=(0,Xc.lc)(e);return new Hc((e=>r.replaceAll(/{[^}]*}/g,(t=>{const r=t.slice(1,-1),i=e.metadata.fieldsIndex.get(r);if(null==i)return t;const s=e.readAttribute(r);return null==s?"":(0,Yc.W)(s,i)}))))}constructor(e){super(),this._evaluator=e}resize(e){}read(e,t){return this._evaluator(e)}readWithDefault(e,t,r){const i=this._evaluator(e);return Ha(i)?r:i}referencesScale(){return!1}referencesGeometry(){return!1}}class Zc extends Ho{constructor(e,t){super(),this._field=e,this._normalizationInfo=t}resize(e){throw new Error("Method not implemented.")}read(e,t){return this._readNormalized(e)}readWithDefault(e,t){return this._readNormalized(e)}referencesScale(){return!1}referencesGeometry(){return!1}_readNormalized(e){const t=e.readAttribute(this._field);if(null==t)return null;const{normalizationField:r,normalizationTotal:i,normalizationType:s}=this._normalizationInfo,n=e.readAttribute(r);switch(null!==s&&void 0!==s?s:"esriNormalizeByField"){case"esriNormalizeByField":return n?n?t/n:void 0:null;case"esriNormalizeByLog":return Math.log(t)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return i?t/i*100:null}}}var Qc=r(34154);const Kc=()=>W.A.getLogger("esri.views.2d.layers.features.support.whereUtils"),Jc={getAttribute:(e,t)=>e.readAttribute(t)};async function $c(e,t){try{const r=await(0,Qc.G)(e,t);if(!r.isStandardized){const e=new i.A("mapview - bad input","Unable to apply filter's definition expression, as expression is not standardized.",r);Kc().error(e)}return i=>{const s=i.readArcadeFeature();try{return r.testFeature(s,Jc)}catch(t){return Kc().warn("mapview-bad-where-clause","Encountered an error when evaluating where clause",e),!0}}}catch(A){return Kc().warn("mapview-bad-where-clause","Encountered an error when evaluating where clause",e),e=>!0}}const el=()=>W.A.getLogger("esri.views.2d.layers.features.support.ComputedAttributeStorage"),tl=4294967295;function rl(e,t,r){if(!(e.length>t))for(;e.length<=t;)e.push(r)}class il{constructor(e){this._numerics=[],this._strings=[],this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[],this._dirtyBitset=this.getBitset(this.createBitset()),this.compilationOptions=e}createBitset(){const e=this._bitsets.length;return this._bitsets.push(xc.create(this._allocatedSize,Mn)),e+1}async createComputedField(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.expression)try{if(!this.compilationOptions)throw new Error("InternalError: Compilation options not defined");return t?await Hc.create(e.expression,this.compilationOptions):await Wc.create(e.expression,this.compilationOptions)}catch(s){const t=new i.A("featurelayer","Failed to compile arcade expression",{error:s,expression:e.expression});return el().error(t),null}if(e.normalizationType||e.normalizationField)return new Zc(e.field,e);if(e.field)return new Uc(e.field);const r=new i.A("featurelayer","Unable to create computed field. No expression or field found",{info:e});return el().error(r),null}async createWhereClause(e){return e?$c(e,this.compilationOptions.fields):null}getBitset(e){return this._bitsets[e-1]}getComputedNumeric(e,t){return this.getComputedNumericAtIndex(e&Mn,0)}setComputedNumeric(e,t,r){return this.setComputedNumericAtIndex(e&Mn,r,0)}getComputedString(e,t){return this.getComputedStringAtIndex(e&Mn,0)}setComputedString(e,t,r){return this.setComputedStringAtIndex(e&Mn,0,r)}getComputedNumericAtIndex(e,t){const r=e&Mn;return this._ensureNumeric(t,r),this._numerics[t][r]}setComputedNumericAtIndex(e,t,r){const i=e&Mn;this._ensureNumeric(t,i),this._numerics[t][i]=r}getPackedChunkId(e){const t=e&Mn;return this._ensureInstanceId(t),this._instanceIds[t]}setPackedChunkId(e,t){const r=e&Mn;this._ensureInstanceId(r),this._instanceIds[r]=t}getComputedStringAtIndex(e,t){const r=e&Mn;return this._ensureString(t,r),this._strings[t][r]}setComputedStringAtIndex(e,t,r){const i=e&Mn;this._ensureString(t,i),this._strings[t][i]=r}getXMin(e){return this._bounds[4*(e&Mn)]}getYMin(e){return this._bounds[4*(e&Mn)+1]}getXMax(e){return this._bounds[4*(e&Mn)+2]}getYMax(e){return this._bounds[4*(e&Mn)+3]}setBounds(e,t){const r=e&Mn;if(!(arguments.length>2&&void 0!==arguments[2]&&arguments[2])&&!this._dirtyBitset.has(e))return this._bounds[4*r]!==tl;this._dirtyBitset.unset(e);const i=t.readGeometryWorldSpace();if(rl(this._bounds,4*r+4,0),!i||!i.coords.length)return this._bounds[4*r]=tl,this._bounds[4*r+1]=tl,this._bounds[4*r+2]=tl,this._bounds[4*r+3]=tl,!1;let s=1/0,n=1/0,o=-1/0,a=-1/0;return i.forEachVertex(((e,t)=>{s=Math.min(s,e),n=Math.min(n,t),o=Math.max(o,e),a=Math.max(a,t)})),this._bounds[4*r]=s,this._bounds[4*r+1]=n,this._bounds[4*r+2]=o,this._bounds[4*r+3]=a,!0}getBounds(e,t){const r=this.getXMin(t),i=this.getYMin(t),s=this.getXMax(t),n=this.getYMax(t);return(0,ya.BI)(e,r,i,s,n),r!==tl}_ensureNumeric(e,t){this._numerics[e]||(this._numerics[e]=[]),rl(this._numerics[e],t,0)}_ensureInstanceId(e){rl(this._instanceIds,e,0)}_ensureString(e,t){this._strings[e]||(this._strings[e]=[]),rl(this._strings[e],t,null)}}var sl=r(2413),nl=r(65391),ol=r(71857),al=r(81376),cl=r(23478),ll=r(68295);class ul{getObjectId(e){return e.getObjectId()}getAttributes(e){return e.readAttributes()}getAttribute(e,t){return e.readAttribute(t)}getAttributeAsTimestamp(e,t){return e.readAttributeAsTimestamp(t)}cloneWithGeometry(e,t){return e}getGeometry(e){return e.readGeometryWorldSpace()}getCentroid(e,t){return e.readCentroidForDisplay()}}ul.Shared=new ul;class dl{constructor(e){this._geometryBounds=(0,sl.vt)(),this._idToVisibility=new Map,this._serviceInfo=e}static async create(e){const t=new dl(e);return await t.update(e.filterJSON,e.spatialReference),t}get hash(){return this._hash}check(e){return this._applyFilter(e)}clear(){const e=this._resetAllHiddenIds();return this.update(),{show:e,hide:[]}}invalidate(){this._idToVisibility.forEach(((e,t)=>{this._idToVisibility.set(t,0)}))}setKnownIds(e){for(const t of e)this._idToVisibility.set(t,1)}setTrue(e){const t=[],r=[],i=new Set(e);return this._idToVisibility.forEach(((e,s)=>{const n=!!(1&this._idToVisibility.get(s)),o=i.has(s);!n&&o?t.push(s):n&&!o&&r.push(s),this._idToVisibility.set(s,o?3:0)})),{show:t,hide:r}}createQuery(){const{geometry:e,spatialRel:t,where:r,timeExtent:i,objectIds:s}=this;return ll.A.fromJSON({geometry:e,spatialRel:t,where:r,timeExtent:i,objectIds:s})}async update(e,t){this._hash=JSON.stringify(e);const r=await(0,ol.T2)(e,null,t);await Promise.all([this._setGeometryFilter(r),this._setIdFilter(r),this._setAttributeFilter(r),this._setTimeFilter(r)])}async _setAttributeFilter(e){if(null===e||void 0===e||!e.where)return this._clause=null,void(this.where=null);this._clause=await $c(e.where,this._serviceInfo.fieldsIndex),this.where=e.where}_setIdFilter(e){this._idsToShow=(null===e||void 0===e?void 0:e.objectIds)&&new Set(e.objectIds),this._idsToHide=(null===e||void 0===e?void 0:e.hiddenIds)&&new Set(e.hiddenIds),this.objectIds=null===e||void 0===e?void 0:e.objectIds}async _setGeometryFilter(e){if(null===e||void 0===e||!e.geometry)return this._spatialQueryOperator=null,this.geometry=null,void(this.spatialRel=null);const t=e.geometry,r=e.spatialRel||"esriSpatialRelIntersects",i=await(0,al.xt)(r,t,this._serviceInfo.geometryType,this._serviceInfo.hasZ,this._serviceInfo.hasM);(0,nl.Rg)(this._geometryBounds,t),this._spatialQueryOperator=i,this.geometry=t,this.spatialRel=r}_setTimeFilter(e){if(this.timeExtent=this._timeOperator=null,null!==e&&void 0!==e&&e.timeExtent)if(this._serviceInfo.timeInfo)this.timeExtent=e.timeExtent,this._timeOperator=(0,cl.I)(this._serviceInfo.timeInfo,e.timeExtent,ul.Shared);else{const t=new i.A("feature-layer-view:time-filter-not-available","Unable to apply time filter, as layer doesn't have time metadata.",e.timeExtent);W.A.getLogger("esri.views.2d.layers.features.controllers.FeatureFilter").error(t)}}_applyFilter(e){return this._filterByGeometry(e)&&this._filterById(e)&&this._filterByTime(e)&&this._filterByExpression(e)}_filterByExpression(e){return!this.where||this._clause(e)}_filterById(e){var t,r;return(!(null!==(t=this._idsToHide)&&void 0!==t&&t.size)||!this._idsToHide.has(e.getObjectId()))&&(!(null!==(r=this._idsToShow)&&void 0!==r&&r.size)||this._idsToShow.has(e.getObjectId()))}_filterByGeometry(e){if(!this.geometry)return!0;const t=e.readGeometryWorldSpace();return!!t&&this._spatialQueryOperator(t)}_filterByTime(e){return null==this._timeOperator||this._timeOperator(e)}_resetAllHiddenIds(){const e=[];return this._idToVisibility.forEach(((t,r)=>{1&t||(this._idToVisibility.set(r,1),e.push(r))})),e}}class hl{static minimal(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return new hl({geometryType:e,fieldsIndex:new pa.A(r).toJSON(),objectIdField:t,subtypes:null,subtypeField:null,types:null,globalIdField:null,spatialReference:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null})}static createFeature(e){return new hl(e)}constructor(e){var t,r,i;this._options=e,this._fieldsIndex=pa.A.fromJSON(e.fieldsIndex),e.spatialReference&&(this._spatialReference=w.A.fromJSON(e.spatialReference)),this._arcadeSchema={fields:this.fieldsIndex.fields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,objectIdField:this.objectIdField,globalIdField:this._options.globalIdField,spatialReference:this._spatialReference,timeInfo:this._options.timeInfo,typeIdField:null!==(t=this._options.typeIdField)&&void 0!==t?t:void 0,types:null!==(r=this._options.types)&&void 0!==r?r:void 0,subtypeField:this._options.subtypeField,subtypes:null!==(i=this._options.subtypes)&&void 0!==i?i:void 0}}get fieldsIndex(){return this._fieldsIndex}get geometryType(){return"esriGeometryMultiPatch"===this._options.geometryType?"esriGeometryPolygon":this._options.geometryType}get serviceGeometryType(){return this._options.geometryType}get subtypeField(){return this._options.subtypeField}get timeInfo(){return this._options.timeInfo}get objectIdField(){return this._options.objectIdField}get globalIdField(){return this._options.globalIdField}get arcadeSchema(){return this._arcadeSchema}get spatialReference(){return this._spatialReference}get timeReferenceUnknownClient(){return this._options.timeReferenceUnknownClient}}class pl extends xa{constructor(e,t){super(e),this.bins=new Map,this.featureCache=new Map,this.done=!1,this._store=t}reset(){this.destroy(),this.done=!1}invaldateForLocalEditDropped(){this.handledChunks.clear(),this.bins.clear()}destroy(){const e=this.subscription.tile.key.level;for(const t of this.featureCache.keys())this._store.releaseDisplayIdForObjectId("".concat(t,".").concat(e));this.bins.clear(),this.featureCache.clear(),this.handledChunks.clear()}get tile(){return this.subscription.tile}*featuresWorldSpace(){for(const e of this.featureCache.values()){const t=e.clone();t.geometry&&(0,Tn.Ch)(t.geometry,t.geometry,!1,!1,this.subscription.tile.transform),yield t}}}class fl extends ba{static async create(e,t,r,i,s){const n=new il({spatialReference:t}),o=await Promise.all(e.fields.map((async e=>fa.create(n,e)))),a=e.featureFilter?await dl.create({geometryType:r.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:r.metadata.timeInfo,fieldsIndex:r.metadata.fieldsIndex,spatialReference:t,filterJSON:e.featureFilter}):null;return"geohash"===e.index.type&&await(0,ha.Nk)(t,w.A.WGS84),new fl(e,a,s,o,t,r,i)}constructor(e,t,r,i,s,n,o){super(n,o,s,i),this._schema=e,this._featureFilter=t,this._timeZone=r,this._metadata=hl.createFeature({geometryType:"esriGeometryPolygon",objectIdField:"aggregateId",fieldsIndex:new pa.A(e.fields).toJSON(),globalIdField:null,spatialReference:n.metadata.spatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null})}createState(e){return new pl(e,this._attributeStore)}applyLocalEdit(e){var t=this;return(0,ua.A)((function*(){for(const e of t._sendStates.values()){e.reset();const r=new wa(e.subscription,Vc.empty(t._source.metadata),!0,!1,{});yield r}}))()}displayMap(e,t,r){const i=new Map(e.map((e=>[t(e),e]))),s=[];for(const n of this._sendStates.values())for(const e of n.featuresWorldSpace()){const{objectId:t,displayId:n}=e,o=i.get(t);if(null!=o){const e=r(n,o,t);s.push(e),i.delete(t)}}return s}getDisplayFeatures(e){const t=new Set(e),r=new Set,i=[];for(const s of this._sendStates.values())for(const e of s.featuresWorldSpace())t.has(e.displayId)&&!r.has(e.objectId)&&(e.geometry&&i.push((0,m.A)((0,m.A)({},(0,Tn.oN)(e,this._metadata.geometryType,!1,!1)),{},{displayId:e.displayId})),r.add(e.objectId));return{features:[],aggregates:i}}getFeatureObjectIdsForAggregate(e){for(const t of this._sendStates.values())for(const r of t.bins.values())if(r.id===e)return Array.from(r.containedObjectIds);return[]}beforeUpdateChunks(){const e=this._source.chunks();if(!e.length)return;let t=!1;for(const r of e)qc(r)&&r.lastLocalEditDropped!==this._lastHandledLocalEdit&&(this._lastHandledLocalEdit=r.lastLocalEditDropped,t=!0);if(t)for(const r of this._sendStates.values())r.invaldateForLocalEditDropped()}updateChunks(){var e=this;return(0,ua.A)((function*(){for(const t of e._sendStates.values())yield*ca((0,g.A)(e._update(t,e._source)),la.A)}))()}forEachAggregateWorldSpace(e){const t=new Set;for(const r of this._sendStates.values())for(const i of r.featuresWorldSpace())t.has(i.objectId)||(e(i),t.add(i.objectId))}_createIndexOptions(e){switch(this._schema.index.type){case"geohash":return{type:"geohash",fields:this.aggregateFields,featureFilter:this._featureFilter,geohashLevel:this._schema.index.fixBinLevel,spatialReference:this.spatialReference,timeZone:this._timeZone,scale:e.scale};case"grid":{const t=this._schema.index.fixedBinLevel,r=null!=t?e.tileInfoView.getLODInfoAt(t).scale:e.scale;return{type:"grid",fields:this.aggregateFields,cellSize:this._schema.index.size,featureFilter:this._featureFilter,spatialReference:this.spatialReference,timeZone:this._timeZone,scale:r}}}}_update(e,t){var r=this;return(0,ua.A)((function*(){const{handledChunks:i,subscription:s,bins:n,featureCache:o}=e,a=s.tile;if(e.done)return;for(const y of t.chunks()){if(i.has(y.chunkId))continue;i.add(y.chunkId);const t=y.queryInfo;if("tileId"in t){const e=new f.A(t.tileId);if(e.level!==a.level||e.world!==a.key.world)continue}y.getAggregateIndex(r._createIndexOptions(e.tile)).putBounded(n,e.tile.extent,e.tile.resolution)}const c=[],l=s.tile.transform,u=s.tile.key.level;for(const e of n.values()){let t=o.get(e.id);if(t)t.attributes=e.getAttributes();else{const i=e.getGeometry(r.spatialReference,l);t=new da.Om(i,e.getAttributes(),null),i||(t.centroid=e.getGeometricCentroid(r.spatialReference,l)),t.objectId=e.id,t.displayId=r._attributeStore.createDisplayIdForObjectId("".concat(t.objectId,".").concat(u)),o.set(e.id,t)}c.push(t)}r.events.emit("changed"),e.done=!t.updateTracking.updating;const d=Vc.fromOptimizedFeatures(c,r._metadata,l),h=d.getCursor(),p=e.subscription.tile.createArcadeEvaluationOptions(r._timeZone);for(;h.next();)r._attributeStore.setAttributeData(h.getDisplayId(),h,p);const _=new Ia(e.subscription,d,[],e.done,{});yield _}))()}}class _l{constructor(e,t){this.inner=e,this.displayId=t}}const yl=128;class ml extends xa{constructor(e){super(e),this.didSend=!1,this.done=!1}}class gl{constructor(e,t,r,i,s){this._level=e,this._scale=t,this._indexOptions=r,this._clusterRadius=i,this._store=s,this._cells=new Map,this._handledChunks=new Set,this._statistics=new Map,this._clusters=new Map}destroy(){this._clearClusters()}_clearClusters(){for(const e of this._clusters.values())this._store.releaseDisplayIdForObjectId(e.inner.id);this._clusters.clear()}*aggregatesWorldSpace(){for(const e of this._clusters.values()){const t=e.inner.getCentroid(null),r=new da.Om(t,e.inner.getAttributes(),null);r.objectId=e.inner.id,r.displayId=e.displayId,yield r}}clusters(){return this._clusters.values()}updateChunks(e,t){let r=!1;for(const o of e){const e=o.queryInfo;"tileId"in e&&new f.A(e.tileId).level!==this._level||(this._handledChunks.has(o.normalizedChunkId)||(this._handledChunks.add(o.normalizedChunkId),r=!0,o.getAggregateIndex((0,m.A)((0,m.A)({},this._indexOptions),{},{scale:this._scale})).put(this._cells)))}const i={xMin:1/0,yMin:1/0,xMax:-1/0,yMax:-1/0},s=dc(this._indexOptions.spatialReference,this._scale),n=this._indexOptions.cellSize;for(const{subscription:o}of t){const e=o.tile.bounds,t=Math.floor(e[0]*s/n),r=Math.floor(e[1]*s/n),a=Math.ceil(e[2]*s/n),c=Math.ceil(e[3]*s/n);i.xMin=Math.min(i.xMin,t),i.yMin=Math.min(i.yMin,r),i.xMax=Math.max(i.xMax,a),i.yMax=Math.max(i.yMax,c)}return null!=this._lastCellBounds&&i.xMin===this._lastCellBounds.xMin&&i.yMin===this._lastCellBounds.yMin&&i.yMin===this._lastCellBounds.yMin&&i.yMax===this._lastCellBounds.yMax||(r=!0,this._lastCellBounds=i),r&&this._clusterCells(i),r}async updateStatistics(e){let t=!1;for(const r of this._clusters.values())r.inner.count>1&&(t=this._updateAggregateStatistics(this._statistics,r.inner)||t);if(t){const t=Array.from(this._statistics.entries()).map((e=>{let[t,r]=e;return{fieldName:t,minValue:r.minValue,maxValue:r.maxValue}}));await e.container.updateStatistics(this._level,t)}}createAggregateFeatures(e,t){const r=e.subscription,i=[],s=r.tile.transform;for(const n of this._clusters.values()){let e=n.inner.getCentroidX(s);const t=n.inner.getCentroidY(s),o=r.tile.lod,a=o.wrap?o.worldSize[0]:null,c=1===n.inner.count?n.inner.firstObjectId:n.inner.id,l=n.displayId;if(null!=a)if(1===a){const r=new Be.A([],[e,t]),s=new da.Om(r,n.inner.getAttributes(),null);s.geometry.coords[0]-=_.CQ,s.objectId=c,s.displayId=l,i.push(s);const o=new Be.A([],[e,t]),a=new da.Om(o,n.inner.getAttributes(),null);a.geometry.coords[0]+=_.CQ,a.objectId=c,a.displayId=l,i.push(a)}else e>_.CQ+_.CQ/2?e-=a*_.CQ:e<-_.CQ/2&&(e+=a*_.CQ);if(e<_.CQ+yl&&e>=-128&&t<_.CQ+yl&&t>=-128){const r=new Be.A([],[e,t]),s=new da.Om(r,n.inner.getAttributes(),null);s.objectId=c,s.displayId=l,i.push(s)}}return Vc.fromOptimizedFeatures(i,t,r.tile.transform)}_clusterCells(e){let t=Array.from(this._cells.values());t=t.sort(((e,t)=>t.count-e.count));const r=[];for(const o of this._clusters.values())r.push(o.inner.id);this._clusters.clear();const i=this._clusterRadius*(1/dc(this._indexOptions.spatialReference,this._scale)),s=1+this._clusterRadius/this._indexOptions.cellSize,n=new Set;for(const o of t){if(n.has(o.id))continue;if(o.gridX<e.xMin||o.gridX>e.xMax||o.gridY<e.yMin||o.gridY>e.yMax)continue;const t=this._store.createDisplayIdForObjectId(o.id),r=new _l(o.clone(),t);n.add(o.id),this._clusters.set(o.id,r);const a=o.centroidXWorld,c=o.centroidYWorld;for(let e=o.gridY-s;e<=o.gridY+s;e++)for(let t=o.gridX-s;t<=o.gridX+s;t++){if(e===o.gridY&&t===o.gridX)continue;const s=this._cells.get(uc.createId(t,e));if(!s||n.has(s.id))continue;const l=Math.abs(s.centroidXWorld-a),u=Math.abs(s.centroidYWorld-c);l<i&&u<i&&(r.inner.merge(s),n.add(s.id))}}for(const o of r)this._store.releaseDisplayIdForObjectId(o)}_updateAggregateStatistics(e,t){let r=!1;for(const i of t.statistics.values()){if("esriFieldTypeString"===i.field.type)continue;const t=i.value,s=i.field,n=e.get(s.name);if(n){const{minValue:e,maxValue:i}=n,s=Math.min(n.minValue,t),o=Math.max(n.maxValue,t);e===s&&i===o||(n.minValue=s,n.maxValue=o,r=!0)}else e.set(s.name,{minValue:t,maxValue:t}),r=!0}return r}}class xl extends ba{static async create(e,t,r,i,s,n){const o=new il({spatialReference:r}),a={type:"grid",fields:await Promise.all(t.fields.map((async e=>fa.create(o,e)))),spatialReference:r,featureFilter:t.featureFilter?await dl.create({geometryType:i.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:i.metadata.timeInfo,fieldsIndex:i.metadata.fieldsIndex,spatialReference:r,filterJSON:t.featureFilter}):null,cellSize:t.clusterRadius/4,timeZone:n};return new xl(e,t.clusterRadius,a,t.fields,i,s)}constructor(e,t,r,i,s,n){super(s,n,r.spatialReference,r.fields),this._connection=e,this._clusterRadius=t,this._indexOptions=r,this._cellsPerScale=new Map,this._metadata=hl.createFeature({geometryType:"esriGeometryPoint",objectIdField:"aggregateId",fieldsIndex:new pa.A([...i,...this._source.metadata.fieldsIndex.fields,{name:"aggregateId",alias:"aggregateId",type:"esriFieldTypeOID"}]).toJSON(),globalIdField:null,spatialReference:s.metadata.spatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null})}get enablePixelBuffering(){return!1}invalidate(){super.invalidate();for(const e of this._cellsPerScale.values())e.destroy();this._cellsPerScale.clear()}onSubscribe(e){super.onSubscribe(e),this._requiredLevel=e.tile.level,this._requiredScale=e.tile.scale}createState(e){return new ml(e)}applyLocalEdit(e){var t=this;return(0,ua.A)((function*(){for(const e of t._cellsPerScale.values())e.destroy();t._cellsPerScale.clear();for(const e of t._sendStates.values())e.done=!1}))()}displayMap(e,t,r){const i=new Map(e.map((e=>[t(e),e]))),s=[],n=this._getClusterState(this._requiredLevel,this._requiredScale);for(const o of n.clusters()){const e=i.get(o.inner.id);if(null==e){if(1===o.inner.count){const e=i.get(o.inner.firstObjectId);if(null!=e){const t=r(o.displayId,e,o.inner.firstObjectId);s.push(t),i.delete(o.inner.firstObjectId)}}}else{const t=r(o.displayId,e,o.inner.id);s.push(t),i.delete(o.inner.id)}}return s}getDisplayFeatures(e){const t=new Set(e),r=new Set,i=[],s=[],n=this._getClusterState(this._requiredLevel,this._requiredScale);for(const o of n.aggregatesWorldSpace())if(t.has(o.displayId)&&!r.has(o.displayId)){const e=(0,Tn.oN)(o,this._metadata.geometryType,!1,!1);if(r.add(o.displayId),1===e.attributes.cluster_count){i.push((0,m.A)((0,m.A)({},e),{},{displayId:o.displayId}));continue}s.push((0,m.A)((0,m.A)({},e),{},{displayId:o.displayId}))}return{features:i,aggregates:s}}getFeatureObjectIdsForAggregate(e){const t=this._getClusterState(this._requiredLevel,this._requiredScale);for(const r of t.clusters())if(r.inner.id===e)return Array.from(r.inner.containedObjectIds);return[]}updateChunks(){var e=this;return(0,ua.A)((function*(){const t=e._source.chunks();if(!t.length)return;for(const o of t)qc(o)&&o.lastLocalEditDropped!==e._lastHandledLocalEdit&&(e.invalidate(),e._lastHandledLocalEdit=o.lastLocalEditDropped);const r=e._getClusterState(e._requiredLevel,e._requiredScale),i=Array.from(e._sendStates.values()).filter((t=>t.subscription.tile.level===e._requiredLevel));if(r.updateChunks(t,i)||!e._source.updateTracking.updating)for(const o of i)o.subscription.tile.level===e._requiredLevel&&(o.didSend=!1,o.done=!1);const s=Array.from(e._sendStates.values()).filter((e=>e.done)).map((e=>e.subscription.tile.key)),n=new Set(s);for(const o of e._sendStates.values()){if(e._source.updateTracking.updating){if(s.some((e=>e.containsChild(o.subscription.tile.key))))continue;if(o.subscription.tile.key.getChildKeys().every((e=>n.has(e))))continue}o.didSend||o.subscription.tile.level!==e._requiredLevel||(o.didSend=!0,yield*ca((0,g.A)(e._update(o,r,e._source)),la.A))}yield(0,la.A)(r.updateStatistics(e._connection))}))()}forEachAggregateWorldSpace(e){if(null==this._requiredLevel||null==this._requiredScale)return;const t=this._getClusterState(this._requiredLevel,this._requiredScale);for(const r of t.aggregatesWorldSpace())e(r)}_getClusterState(e,t){if(null==e||null==t)throw new Error("InternalError: Level and scale must be defined");let r=this._cellsPerScale.get(t);return r||(r=new gl(e,t,this._indexOptions,this._clusterRadius,this._attributeStore),this._cellsPerScale.set(t,r)),r}_update(e,t,r){var i=this;return(0,ua.A)((function*(){if(e.done)return;const s=t.createAggregateFeatures(e,i._metadata);i.events.emit("changed"),e.done=!r.updateTracking.updating;const n=s.getCursor(),o=e.subscription.tile.createArcadeEvaluationOptions(i._indexOptions.timeZone);for(;n.next();)i._attributeStore.setAttributeData(n.getDisplayId(),n,o);const a=new wa(e.subscription,s,!0,e.done,{});yield a}))()}}class vl extends xa{}class bl extends va{constructor(e,t,r){super(e,t),this._timeZone=r,this.handledChunks=new Set,this.handledChunksForIdCreation=new Set,this.handledChunksForAttributeData=new Set,this._streamLayerDeferredObjectIdsToRemove=[]}destroy(){super.destroy();for(const e of this._source.chunks())this._cleanupChunkIds(e)}invalidateAttributeData(){this.handledChunksForAttributeData.clear()}onSubscribe(e){super.onSubscribe(e),this._evalOptions=e.tile.createArcadeEvaluationOptions(this._timeZone)}createState(e){return new vl(e)}get aggregateQueryEngine(){return null}displayMap(e,t,r){const i=new Map(e.map((e=>[t(e),e]))),s=[];for(const n of this._source.chunks()){const e=n.reader.getCursor();for(;e.next();){const t=e.getObjectId(),n=e.getDisplayId(),o=i.get(t);if(null!=o){const e=r(n,o,t);s.push(e),i.delete(t)}}}return s}getDisplayFeatures(e){const t=new Set(e),r=new Set,i=[];for(const s of this._source.chunks()){const e=s.reader.getCursor();for(;e.next();){const s=e.getObjectId(),n=e.getDisplayId();t.has(n)&&!r.has(s)&&(i.push((0,m.A)((0,m.A)({},e.readLegacyFeatureWorldSpace()),{},{displayId:n})),r.add(s))}}return{features:i,aggregates:[]}}applyLocalEdit(e){var t=this;return(0,ua.A)((function*(){const r=[],i=e.reader.getCursor();for(;i.next();){const e=i.getObjectId(),s=t._attributeStore.createDisplayIdForObjectId(e);i.setDisplayId(s),t._attributeStore.setAttributeData(s,i,t._evalOptions),r.push(s)}const s=[];for(const n of e.removed){const e=t._attributeStore.getDisplayIdForObjectId(n);null!=e&&s.push(e)}(0,n.A)("esri-2d-update-debug")&&console.debug("FeatureUpdateStrategy.applyLocalEdit",{message:e,modifiedDisplayIds:r,removedDisplayIds:s});const o=new Gc(t._source.metadata,"localEdit");o.applyOverrides(e),t.handledChunks.add(o.chunkId),t.handledChunksForAttributeData.add(o.chunkId),t.handledChunksForIdCreation.add(o.chunkId);for(const e of t._sendStates.values())e.handledChunks.add(o.chunkId),yield new Ia(e.subscription,null,r,!1,o.queryInfo);for(const e of t._sendStates.values()){const t=o.getTileReader(e.subscription.tile);yield new Ia(e.subscription,t,s,!1,o.queryInfo)}for(const n of e.removed)t._attributeStore.releaseDisplayIdForObjectId(n)}))()}updateChunks(){var e=this;return(0,ua.A)((function*(){if(e._source.chunks().length){yield(0,la.A)(e._updateAttributeData());for(const t of e._sendStates.values())yield*ca((0,g.A)(e._update(t)),la.A)}}))()}removeChunks(e){for(const t of e)this.handledChunks.delete(t.chunkId),this.handledChunksForAttributeData.delete(t.chunkId),this._cleanupChunkIds(t)}afterUpdateChunks(){for(const e of this._streamLayerDeferredObjectIdsToRemove)this._attributeStore.releaseDisplayIdForObjectId(e);this._streamLayerDeferredObjectIdsToRemove=[]}_cleanupChunkIds(e){if(this.handledChunksForIdCreation.has(e.chunkId)){const t=e.reader.getCursor();for(;t.next();){const e=t.getObjectId();this._source.isStream?this._streamLayerDeferredObjectIdsToRemove.push(e):this._attributeStore.releaseDisplayIdForObjectId(e)}this.handledChunksForIdCreation.delete(e.chunkId)}}async _updateAttributeData(){for(const e of this._source.chunks()){const{chunkId:t,reader:r}=e;if(!this.handledChunksForIdCreation.has(t)){this.handledChunksForIdCreation.add(t);const e=r.getCursor();for(;e.next();){const t=this._attributeStore.createDisplayIdForObjectId(e.getObjectId());e.setDisplayId(t)}}}for(const e of this._source.chunks())if(!this.handledChunksForAttributeData.has(e.chunkId)){this.handledChunksForAttributeData.add(e.chunkId);const t=e.reader.getCursor();for(;t.next();){const e=t.getDisplayId();this._attributeStore.setAttributeData(e,t,this._evalOptions)}}}*_update(e){const{subscription:t,handledChunks:r}=e;for(const i of this._source.chunks()){const{chunkId:s}=i;if(r.has(s))continue;r.add(s);const n=i.getTileReader(t.tile);n&&(yield new wa(e.subscription,n,!1,i.end,i.queryInfo))}}}class wl{constructor(e){this.data=e,this._referenceCount=0}increment(){this._referenceCount+=1}decrement(){this._referenceCount-=1}empty(){return 0===this._referenceCount}}class Il{constructor(){this._freeIdsGenerationA=[],this._freeIdsGenerationB=[],this._idCounter=1,this._freeIds=this._freeIdsGenerationA,this._objectIdToDisplayId=new Map}createIdForObjectId(e){let t=this._objectIdToDisplayId.get(e);return t?t.increment():(t=new wl(function(e,t){return((t?kn:0)|e)>>>0}(this._getFreeId(),!1)),t.increment(),this._objectIdToDisplayId.set(e,t)),t.data}releaseIdForObjectId(e){const t=this._objectIdToDisplayId.get(e);t&&(t.decrement(),t.empty()&&(this._objectIdToDisplayId.delete(e),this._freeIds.push(t.data)))}getDisplayIdForObjectId(e){const t=this._objectIdToDisplayId.get(e);return null!=t?t.data:null}releaseAll(){for(const e of this._objectIdToDisplayId.values())this._freeIds.push(e.data);this._objectIdToDisplayId.clear()}incrementGeneration(){this._freeIds=this._freeIds===this._freeIdsGenerationA?this._freeIdsGenerationB:this._freeIdsGenerationA}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}const Sl=()=>W.A.getLogger("esri.views.layers.2d.features.support.AttributeStore"),Tl=((e,t)=>e&&function(){for(var e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t.warn("DEBUG:",...r)}||(()=>null))(!1,Sl()),Al=(0,n.A)("esri-shared-array-buffer");(0,n.A)("esri-atomics");class Ml{constructor(e,t,r){this.size=0,this.texelSize=4,this.dirtyStart=0,this.dirtyEnd=0;const{pixelType:i,layout:s,textureOnly:n}=t;this.textureOnly=n||!1,this.pixelType=i,this.layout=s,this._resetRange(),this.size=e,this.isLocal=r,n||(this.data=this._initData(i,e))}get buffer(){var e;return null===(e=this.data)||void 0===e?void 0:e.buffer}unsetComponentAllTexels(e,t){const r=this.data;for(let i=0;i<this.size*this.size;i++)r[i*this.texelSize+e]&=~t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(e,t){const r=this.data;for(let i=0;i<this.size*this.size;i++)r[i*this.texelSize+e]|=255&t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(e,t,r){const i=this.data;for(const s of r)i[s*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,s),this.dirtyEnd=Math.max(this.dirtyEnd,s)}setComponentTexel(e,t,r){this.data[r*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}unsetComponentTexel(e,t,r){this.data[r*this.texelSize+e]&=~t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}getData(e,t){const r=Fn(e);return this.data[r*this.texelSize+t]}setData(e,t,r){const i=Fn(e),s=1<<t;this.layout&s?null!=this.data&&(this.data[i*this.texelSize+t]=r,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i)):Sl().error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}expand(e){if(this.size=e,!this.textureOnly){const t=this._initData(this.pixelType,e),r=this.data;t.set(r),this.data=t}}toMessage(){const e=this.dirtyStart,t=this.dirtyEnd,r=this.texelSize;if(e>t)return null;this._resetRange();const i=!this.isLocal,s=this.pixelType,n=this.layout,o=this.data;return{start:e,end:t,data:i&&o.slice(e*r,(t+1)*r)||null,pixelType:s,layout:n}}_initData(e,t){const r=ArrayBuffer,s=function(e){switch(e){case X.ld.UNSIGNED_BYTE:return Uint8Array;case X.ld.UNSIGNED_SHORT_4_4_4_4:return Uint16Array;case X.ld.FLOAT:return Float32Array;default:return void Q().error(new i.A("webgl-utils","Unable to handle type ".concat(e)))}}(e),n=new s(new r(t*t*4*s.BYTES_PER_ELEMENT));for(let i=0;i<n.length;i+=4)n[i+1]=255;return n}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class kl{constructor(e){this._client=e,this._filters=[],this._blocks=new Array,this._attributeComputeInfo=null,this._abortController=new AbortController,this._size=_.TB,this._idsToHighlight=new Map,this._referencesScale=!1,this._referencesGeometry=!1,this._initialized=!1,this.version=0,this._idGenerator=new Il,this._epoch=1}destroy(){this._abortController.abort()}_initialize(){if(null!=this._blockDescriptors)return;const e=X.ld.FLOAT;Tl("Creating AttributeStore ".concat(Al?"with":"without"," shared memory")),this._blockDescriptors=[{pixelType:X.ld.UNSIGNED_BYTE,layout:1},{pixelType:X.ld.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:X.ld.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:e,layout:15},{pixelType:e,layout:15},{pixelType:e,layout:15},{pixelType:e,layout:15},{pixelType:X.ld.FLOAT,layout:15}],this._blocks=this._blockDescriptors.map((()=>null))}get referencesScale(){return this._referencesScale}get referencesGeometry(){return this._referencesGeometry}get hasHighlight(){return this._idsToHighlight.size>0}createDisplayIdForObjectId(e){return this._idGenerator.createIdForObjectId(e)}releaseDisplayIdForObjectId(e){return this._idGenerator.releaseIdForObjectId(e)}getDisplayIdForObjectId(e){return this._idGenerator.getDisplayIdForObjectId(e)}incrementDisplayIdGeneration(){this._idGenerator.incrementGeneration()}releaseAllIds(){this._idGenerator.releaseAll()}async update(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;const o=(0,b.Ui)(this._schema,e);if(this.version=s,o&&((0,n.A)("esri-2d-update-debug")&&console.debug("Version[".concat(s,"] AttributeStore.update"),{changed:o}),this._schema=e,this._attributeComputeInfo=null,this._initialize(),null!=e))if(r&&(this._filters=await Promise.all(e.filters.map((e=>e?dl.create({geometryType:r.geometryType,hasM:!1,hasZ:!1,timeInfo:r.timeInfo,fieldsIndex:r.fieldsIndex,spatialReference:null!==i&&void 0!==i?i:r.spatialReference,filterJSON:e}):null)))),"subtype"!==e.type)this._attributeComputeInfo={isSubtype:!1,map:new Map},await Promise.all(e.bindings.map((async e=>{var r,i;const s=await this._bind(t,e);this._referencesGeometry=this._referencesGeometry||null!==(r=null===s||void 0===s?void 0:s.referencesGeometry())&&void 0!==r&&r,this._referencesScale=this._referencesScale||null!==(i=null===s||void 0===s?void 0:s.referencesScale())&&void 0!==i&&i})));else{this._attributeComputeInfo={isSubtype:!0,subtypeField:e.subtypeField,map:new Map},this._referencesScale=!1,this._referencesGeometry=!1;for(const r in e.bindings){const i=e.bindings[r];await Promise.all(i.map((async e=>{var i,s;const n=await this._bind(t,e,parseInt(r,10));this._referencesGeometry=this._referencesGeometry||null!==(i=null===n||void 0===n?void 0:n.referencesGeometry())&&void 0!==i&&i,this._referencesScale=this._referencesScale||null!==(s=null===n||void 0===n?void 0:n.referencesScale())&&void 0!==s&&s})))}}}setHighlight(e,t){const r=this._getBlock(0);r.unsetComponentAllTexels(0,(1<<_.U5)-1);for(const{displayId:i,highlightFlags:s}of e){if(null==i)continue;const e=Fn(i);r.setComponent(0,s,[e])}this._idsToHighlight.clear();for(const{objectId:i,highlightFlags:s}of e)this._idsToHighlight.set(i,s);for(const{objectId:i,highlightFlags:s}of t)this._idsToHighlight.set(i,s)}setData(e,t,r,i){const s=Fn(e);this._ensureSizeForTexel(s),this._getBlock(t).setData(e,r,i)}getData(e,t,r){return this._getBlock(t).getData(e,r)}getHighlightFlags(e){return this._idsToHighlight.get(e)||0}unsetAttributeData(e){const t=Fn(e);this._getBlock(0).setData(t,0,0)}setAttributeData(e,t,r){var i;const s=Fn(e);this._ensureSizeForTexel(s),this._getBlock(0).setData(s,0,this.getFilterFlags(t));const n=this._attributeComputeInfo;let o=null;n&&(o=n.isSubtype?n.map.get(t.readAttribute(n.subtypeField)):n.map,(null===(i=o)||void 0===i?void 0:i.size)&&o.forEach(((e,i)=>{var n;const o=1*i%4,a=Math.floor(1*i/4),c=this._getBlock(a+_.dV.VV);let l=null===(n=e.field)||void 0===n?void 0:n.read(t,r);e.valueRepresentation&&(l=function(e,t){if(!e||!t)return e;switch(t){case"radius":case"distance":return 2*e;case"diameter":case"width":return e;case"area":return Math.sqrt(e)}return e}(l,e.valueRepresentation)),(null===l||isNaN(l)||l===1/0||l===-1/0)&&(l=Oe),c.setData(s,o,l)})))}get epoch(){return this._epoch}sendUpdates(){const e=this._blocks.map((e=>null!=e?e.toMessage():null)),t=this._getInitArgs();(0,n.A)("esri-2d-log-updating")&&console.log("AttributeStore: _doSendUpdate.start"),this._client.update({initArgs:t,blockData:e,version:this.version,sendUpdateEpoch:this._epoch}),this._epoch+=1,(0,n.A)("esri-2d-log-updating")&&console.log("AttributeStore: _doSendUpdate.end")}_ensureSizeForTexel(e){for(;e>=this._size*this._size;)if(this._expand())return}async _bind(e,t,r){const i=await e.createComputedField(t),{valueRepresentation:s}=t,n=this._attributeComputeInfo;if(n.isSubtype){var o;const e=null!==(o=n.map.get(r))&&void 0!==o?o:new Map;e.set(t.binding,{field:i,valueRepresentation:s}),n.map.set(r,e)}else n.map.set(t.binding,{field:i,valueRepresentation:s});return i}_getInitArgs(){return this._initialized?null:(this._initialized=!0,this._getBlock(_.dV.Animation),this._getBlock(_.dV.GPGPU),this._getBlock(_.dV.LocalTimeOrigin),{blockSize:this._size,blockDescriptors:this._blocks.map((e=>null!=e?{textureOnly:e.textureOnly,buffer:e.buffer,pixelType:e.pixelType}:null))})}_getBlock(e){const t=this._blocks[e];if(null!=t)return t;Tl("Initializing AttributeBlock at index ".concat(e));const r=new Ml(this._size,this._blockDescriptors[e],this._client.isLocal);return this._blocks[e]=r,this._initialized=!1,r}_expand(){if(this._size<this._schema.capabilities.maxTextureSize){const e=this._size<<=1;Tl("Expanding block size to",e,this._blocks);for(const t of this._blocks)null===t||void 0===t||t.expand(e);return this._initialized=!1,this._size=e,0}return Sl().error(new i.A("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}isVisible(e){return!!(this._getBlock(0).getData(e,0)&1<<_.U5)}getFilterFlags(e){let t=0;for(let i=0;i<this._filters.length;i++){const r=!!(1<<i),s=this._filters[i];t|=(!r||null==s||s.check(e)?1:0)<<i}let r=0;if(this._idsToHighlight.size){const t=e.getObjectId();r=this.getHighlightFlags(t)}return t<<_.U5|r}}class Fl{constructor(e,t){this._connection=e,this._source=t,this._version=1,this._registry=new ia,this._proxy=new $({fetch:(e,t)=>this._connection.layerView.fetch(e,t),fetchDictionary:(e,t)=>this._connection.layerView.fetchDictionary(e,t)}),this._attributeStore=new kl({isLocal:!1,update:e=>(0,d.oV)(this._connection.container.updateAttributeView(e))})}destroy(){var e;this._proxy.destroy(),null!==(e=this._strategy)&&void 0!==e&&e.destroy(),this._attributeStore.destroy()}get aggregateQueryEngine(){var e;return null===(e=this._strategy)||void 0===e?void 0:e.aggregateQueryEngine}getDisplayFeatures(e){return this._strategy?this._strategy.getDisplayFeatures(e):{features:[],aggregates:[]}}getDisplayIds(e){const t={};return this._strategy?(this._strategy.displayMap(e,(e=>e),((e,r,i)=>{t[i]=e})),t):t}getFeatureObjectIdsForAggregate(e){return this._strategy?this._strategy.getFeatureObjectIdsForAggregate(e):[]}onSubscribe(e){var t;null===(t=this._strategy)||void 0===t||t.onSubscribe(e)}onUnsubscribe(e){var t;null===(t=this._strategy)||void 0===t||t.onUnsubscribe(e)}async update(e,t,r,i,s){var o,a,c,l,u;const d=e.processor,h=(0,v.i8)(null===(o=this._schema)||void 0===o?void 0:o.storage,d.storage),p=(0,v.i8)(null===(a=this._schema)||void 0===a?void 0:a.mesh.properties,d.mesh.properties),f=(0,v.i8)(null===(c=this._schema)||void 0===c?void 0:c.mesh.factory,d.mesh.factory),_=(0,v.i8)(null===(l=this._schema)||void 0===l?void 0:l.mesh.strategy,d.mesh.strategy),y=p||f||_;if(!h&&!y&&!i)return;(0,n.A)("esri-2d-update-debug")&&console.debug("Version[".concat(this._version,"] SymbolProcessor.update"),{changes:(0,b.Ui)(this._schema,d),schema:d}),this._schema=d;const m=w.A.fromJSON(this._source.service.outSpatialReference),g=new il({fields:this._source.metadata.fieldsIndex,spatialReference:m});if(await this._attributeStore.update(d.storage,g,this._source.metadata,m,t),null!==(u=this._strategy)&&void 0!==u&&u.invalidateAttributeData(),!i&&!y)return;(_||p)&&await this._updateStrategy(d.mesh.strategy,m,s,d.mesh.properties.timeZone),this._updateSortKey(g,"sortKey"in d.mesh.properties?d.mesh.properties.sortKey:null);const x=new sa(g,this._proxy,r,this._registry);return(f||"dictionary"===d.mesh.factory.symbology.type)&&(this._factory=await U.create(x,d.mesh.factory)),this._invalidate(),this._version=t,this._connection.container.updateRenderState(this._version)}async applyLocalEdit(e){if(!this._strategy)return;const t=this._strategy.applyLocalEdit(e);var r,i=!1,s=!1;try{for(var n,o=(0,g.A)(t);i=!(n=await o.next()).done;i=!1){const e=n.value;try{await this._process(e)}catch(A){}}}catch(a){s=!0,r=a}finally{try{i&&null!=o.return&&await o.return()}finally{if(s)throw r}}}async updateChunks(){var e,t;null!==(e=this._strategy)&&void 0!==e&&e.beforeUpdateChunks(),await this._doUpdateChunks(),null===(t=this._strategy)||void 0===t||t.afterUpdateChunks()}async removeChunks(e){var t;null!==(t=this._strategy)&&void 0!==t&&t.removeChunks(e),this._attributeStore.incrementDisplayIdGeneration()}updateHighlight(e){let{highlights:t}=e;if(!this._strategy)return void this._attributeStore.setHighlight(t.map((e=>{let{objectId:t,highlightFlags:r}=e;return{objectId:t,highlightFlags:r,displayId:-1}})),t);const r=this._strategy.displayMap(t,(e=>{let{objectId:t}=e;return t}),((e,t,r)=>{let{highlightFlags:i}=t;return{objectId:r,displayId:e,highlightFlags:i}}));this._attributeStore.setHighlight(r,t)}async _doUpdateChunks(){if(!this._strategy)return;const e=this._strategy.updateChunks(),t=[],r=new Map;var i,s=!1,o=!1;try{for(var c,l=(0,g.A)(e);s=!(c=await l.next()).done;s=!1){const e=c.value;{let i=r.get(e.id);null==i&&(i=new oa({concurrency:16,process:e=>this._process(e)}),r.set(e.id,i));const s=i.push(e).catch((e=>(0,a.jH)(e)));t.push(s)}}}catch(u){o=!0,i=u}finally{try{s&&null!=l.return&&await l.return()}finally{if(o)throw i}}try{await Promise.all(t)}catch(d){}(0,n.A)("esri-2d-update-debug")&&console.log("SendUpdates"),this._attributeStore.sendUpdates(),(0,n.A)("esri-2d-update-debug")&&console.log("SendUpdates.await")}async _updateStrategy(e,t,r,i){var s;switch(null!==(s=this._strategy)&&void 0!==s&&s.destroy(),e.type){case"feature":this._strategy=new bl(this._source,this._attributeStore,i);break;case"binning":this._strategy=await fl.create(e,t,this._source,this._attributeStore,i);break;case"cluster":this._strategy=await xl.create(this._connection,e,t,this._source,this._attributeStore,i)}for(const n of r)this._strategy.onSubscribe(n)}async _updateSortKey(e,t){var r;if(this._sortInfo=(0,x.pR)(null===(r=this._sortInfo)||void 0===r?void 0:r.computed),null!=t){const r=t.byRenderer?null:await e.createComputedField(t);this._sortInfo=(0,m.A)((0,m.A)({},t),{},{computed:r})}}_invalidate(){this._strategy&&this._strategy.invalidate()}async _process(e){var t,r;const i=e.subscription;if((0,n.A)("esri-2d-update-debug")){const t=i.tile;console.debug("Version[".concat(this._version,"] Tile[").concat(t.key.id,", end=").concat(e.end,"] Processor._process"))}await this._fetchResources(e),(0,a.Te)(i.signal);const s=await this._write(e,i.tile.createArcadeEvaluationOptions(null===(t=this._schema)||void 0===t?void 0:t.mesh.properties.timeZone)),o=i.tile.tileInfoView.getLODInfoAt(i.tile.key),{message:c,transferList:l}=s.serialize(o),u={objectIdMap:null,inner:e.createMessage(c,this._version,this._attributeStore.epoch)};if(null!==(r=this._schema)&&void 0!==r&&r.mesh.properties.returnMeshObjectId){var d;u.objectIdMap={};const t=null===(d=e.reader)||void 0===d?void 0:d.getCursor();if(t)for(;t.next();)u.objectIdMap[t.getDisplayId()]=t.getObjectId()}if((0,a.Te)(i.signal),await this._connection.container.onMessage(u,{signal:i.signal,transferList:l}),this._attributeStore.sendUpdates(),(0,n.A)("esri-2d-update-debug")){const t=i.tile;console.debug("Version[".concat(this._version,"] Tile[").concat(t.key.id,", end=").concat(e.end,"] Processor._process.await"))}}async _fetchResources(e){await this._fetchMatcherResources(e),await this._fetchWriterResources(e)}async _fetchMatcherResources(e){if(e.reader)return this._factory.enqueueMatcherRequests(this._proxy,e.reader)}async _fetchWriterResources(e){if(!e.reader)return;const t=e.reader.getCursor(),r=e.subscription.tile.createArcadeEvaluationOptions(this._schema.mesh.properties.timeZone);for(;t.next();)this._factory.enqueueWriterRequests(this._proxy,t,r);await this._proxy.fetchEnqueuedResources()}async _write(e,t){var r,i;const s=e.subscription.tile,n=null===(r=e.reader)||void 0===r?void 0:r.getCursor(),o=null!==(i=null===n||void 0===n?void 0:n.getSize())&&void 0!==i?i:0,a=s.tileInfoView.tileInfo.isWrappable,c=s.tileInfoView.tileInfo.spatialReference.isWGS84,l=new z(s.key,this._strategy.enablePixelBuffering,a,c,o);if(!n)return l;const u=s.createArcadeEvaluationOptions(this._schema.mesh.properties.timeZone);for(;n.next();){const e=this._getSortKeyValue(n,t);l.entityStart(n.getDisplayId(),e),this._factory.write(l,this._proxy,n,u,s.level),l.entityEnd()}return l}_getSortKeyValue(e,t){if(!this._sortInfo)return 0;const{computed:r,order:i,byRenderer:s}=this._sortInfo,n=s?this._factory.getSortKey(e,t):null===r||void 0===r?void 0:r.read(e,t);return null==n||isNaN(n)?0:n*("asc"===i?-1:1)}}var El=r(3825),Cl=r(36643);class Pl{static from(e){let t=0,r=0,i=0;return e.forEach((e=>{const s=e._readGeometry();s&&(r+=s.isPoint?1:s.lengths.reduce(((e,t)=>e+t),0),i+=s.isPoint?1:s.lengths.length,t+=1)})),new Pl(t,r,i)}constructor(e,t,r){this.featureCount=e,this.vertexCount=t,this.ringCount=r}toJSON(){return{featureCount:this.featureCount,ringCount:this.featureCount,vertexCount:this.featureCount}}}var zl=r(13096),Ol=r(59187);class Rl{static fromSchema(e,t,r){const i="feature"===t.type?t.mutable.dataFilter.queryScaleRanges:[];return new Rl(function(e,t,r){var i,s,n;const o=null!==(i=e.orderByFields)&&void 0!==i?i:r.objectIdField+" ASC",a=e.source,c={returnCentroid:!(null!==a&&"object"==typeof a&&"path"in a&&(0,zl.Wo)(a.path))&&"esriGeometryPolygon"===r.serviceGeometryType,returnGeometry:!0,timeReferenceUnknownClient:null!==(s=r.timeReferenceUnknownClient)&&void 0!==s?s:void 0,outSpatialReference:w.A.fromJSON(e.outSpatialReference),orderByFields:"memory"===e.type?[]:[o],where:null!==(n=t.mutable.dataFilter.definitionExpression)&&void 0!==n?n:"1=1",outFields:t.mutable.availableFields,multipatchOption:"esriGeometryMultiPatch"===r.serviceGeometryType?"xyFootprint":null};if("feature"===t.type){const{gdbVersion:e,historicMoment:r,timeExtent:i}=t.mutable.dataFilter;return(0,m.A)((0,m.A)({},c),{},{gdbVersion:e,historicMoment:r?new Date(r):null,timeExtent:i?Ol.A.fromJSON(i):null,outFields:t.mutable.availableFields})}return c}(e,t,r),i,r.subtypeField,t.mutable.dataFilter.customParameters,r.geometryType,e.queryMetadata)}constructor(e,t,r,i,s,n){this._queryParams=e,this._queryScaleRanges=t,this._subtypeField=r,this._customParameters=i,this._geometryType=s,this._queryMetadata=n}get pageSize(){var e;if(null==this._queryMetadata)throw new Error("InternalError: Service does not support paged queries");const t=this._queryMetadata.supportsMaxRecordCountFactor?4:null,r=(null!==(e=this._queryMetadata.maxRecordCount)&&void 0!==e?e:8e3)*(null!==t&&void 0!==t?t:1);return Math.min(8e3,r)}updateHistoricMoment(e){this._queryParams.historicMoment=e}updateFields(e){this._queryParams.outFields=e}createPatchFieldsQuery(e,t){if(!t.getSize())return null;const r=e.clone();if("*"===this._queryParams.outFields[0]){var i;if("*"===(null!==(i=r.outFields)&&void 0!==i?i:[])[0])return null;r.outFields=this._queryParams.outFields}else{const e=new Set(this._queryParams.outFields),i=[];for(const r of e)t.hasField(r)||i.push(r);if(0===i.length)return null;r.outFields=i}return r.returnGeometry=!1,r.returnCentroid=!1,r.quantizationParameters=null,r.cacheHint=!0,{inner:r,customParameters:this._customParameters}}createQuery(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this._queryParams)throw new Error("InternalError: queryInfo should be defined");return{inner:new ll.A((0,m.A)((0,m.A)({},this._queryParams),e)),customParameters:this._customParameters}}createTileQuery(e,t){var r;if(null==this._queryMetadata)throw new Error("InternalError: Service does not support tile queries");const i=this.createQuery(t),s=i.inner;if(this._queryScaleRanges.length){const t=this._queryScaleRanges.filter((t=>(!t.minScale||t.minScale>=e.maxScale)&&(!t.maxScale||t.maxScale<=e.minScale))).map((e=>e.subtypeCode));if(t.length){const e="".concat(this._subtypeField," IN (").concat(t,")");s.where=(0,Qc.m)(s.where,e)}}if(s.quantizationParameters=null!==(r=t.quantizationParameters)&&void 0!==r?r:e.getQuantizationParameters(),s.resultType="tile",s.geometry=e.extent,this._queryMetadata.supportsQuantization?"esriGeometryPolyline"===this._geometryType&&(s.maxAllowableOffset=e.resolution*(0,n.A)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==this._geometryType&&"esriGeometryPolygon"!==this._geometryType||(s.maxAllowableOffset=e.resolution,"esriGeometryPolyline"===this._geometryType&&(s.maxAllowableOffset*=(0,n.A)("feature-polyline-generalization-factor"))),s.defaultSpatialReferenceEnabled=this._queryMetadata.supportsDefaultSpatialReference,s.compactGeometryEnabled=this._queryMetadata.supportsCompactGeometry,this._queryMetadata.supportsMaxRecordCountFactor&&(s.maxRecordCountFactor=4),(0,n.A)("esri-tiles-debug")){const t=e.id.replaceAll("/",".");i.customParameters=i.customParameters?(0,m.A)((0,m.A)({},i.customParameters),{},{tileId:t}):{tileId:t}}return i}createPagedTileQuery(e,t){const r=this.pageSize;return this.createTileQuery(e,{start:r*t,num:r,returnExceededLimitFeatures:!0})}createPagedQuery(e){const t=this.pageSize;return this.createQuery({start:t*e,num:t,returnExceededLimitFeatures:!0,maxRecordCountFactor:4})}}var Dl=r(91967),Ll=r(46053),Nl=r(85842);let Bl=class extends Dl.A{constructor(e){super(),this._connection=e,this._enabledEventTypes=new Set,this._updateInfo={websocket:0,client:0},this._lastTime=performance.now(),this._queuedCommands=[],this.addHandles([(0,l.wB)((()=>{var e,t;return null!==(e=null===(t=this._strategy)||void 0===t?void 0:t.connectionStatus)&&void 0!==e?e:"disconnected"}),(e=>{this._layerView.setProperty({propertyName:"pipelineConnectionStatus",value:e})}),{initial:!0}),(0,l.wB)((()=>{var e;return(null===(e=this._strategy)||void 0===e?void 0:e.errorString)||null}),(e=>this._layerView.setProperty({propertyName:"pipelineErrorString",value:e})),{initial:!0})])}destroy(){this._strategy=null,this.removeAllHandles()}get _layerView(){return this._connection.layerView}set strategy(e){null==this._strategy&&this._resetUpdateInfo(performance.now());const t="event-handles";this.removeHandles(t),null!=e&&(this.addHandles([e.events.on("data-received",(e=>this._onFeature(e))),e.events.on("message-received",(e=>this._onWebSocketMessage(e))),e.events.on("features-updated",(e=>this._onUpdate(e))),e.events.on("tick",(()=>this._onTick()))],t),this._queuedCommands.forEach((t=>t(e))),this._queuedCommands=[]),this._strategy=e}updateCustomParameters(e){null!=e&&this._callOrEnqueue((t=>t.updateCustomParameters(e)))}sendMessageToSocket(e){this._callOrEnqueue((t=>t.sendMessageToSocket(e)))}sendMessageToClient(e){this._callOrEnqueue((t=>t.sendMessageToClient(e)))}enableEvent(e,t){t?this._enabledEventTypes.add(e):this._enabledEventTypes.delete(e)}disconnect(){var e;null===(e=this._strategy)||void 0===e||e.disconnect()}connect(){var e;null===(e=this._strategy)||void 0===e||e.connect()}clear(){var e;null===(e=this._strategy)||void 0===e||e.clear()}_onWebSocketMessage(e){this._enabledEventTypes.has("message-received")&&this._layerView.emitEvent({name:"message-received",event:e})}_onFeature(e){this._updateInfo.websocket++,this._enabledEventTypes.has("data-received")&&this._layerView.emitEvent({name:"data-received",event:{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry}})}_onUpdate(e){this._updateInfo.client+=e}_onTick(){const e=performance.now(),t=e-this._lastTime;if(t>2500){const r=Math.round(this._updateInfo.client/(t/1e3)),i=Math.round(this._updateInfo.websocket/(t/1e3));this._resetUpdateInfo(e),this._layerView.emitEvent({name:"update-rate",event:{client:r,websocket:i}})}}_resetUpdateInfo(e){this._lastTime=e,this._updateInfo.client=0,this._updateInfo.websocket=0}_callOrEnqueue(e){null!=this._strategy?e(this._strategy):this._queuedCommands.push(e)}};(0,Nt._)([(0,Ll.MZ)()],Bl.prototype,"_strategy",void 0),Bl=(0,Nt._)([(0,Nl.$)("esri.views.2d.layers.features.sources.StreamMessenger")],Bl);class Vl{constructor(e){this._store=e,this._controller=new AbortController}destroy(){this._controller.abort()}get _options(){return{signal:this._controller.signal}}unsafeSetQueryHistoricMoment(e){throw new Error("InternalError: LoadStrategy does not support query info")}async queryOverride(e){throw new Error("InternalError: LoadStrategy does not support fetching")}async queryByObjectId(e){throw new Error("InternalError: LoadStrategy does not support fetching")}async addParquetFile(e){throw new Error("InternalError: LoadStrategy does not support loading blobs")}}var ql=r(45012),Gl=r(76279),Ul=r(26799),jl=r(29234),Wl=r(10693);const Yl=268435455;class Xl{constructor(){this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}}const Hl=268435455,Zl=128e3,Ql={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(Zl),decoded:new Int32Array(Zl)}};function Kl(e){return e<=Ql.small.delta.length?Ql.small:(e<=Ql.large.delta.length||(Ql.large.delta=new Int32Array(Math.round(1.25*e)),Ql.large.decoded=new Int32Array(Math.round(1.25*e))),Ql.large)}function Jl(e){for(;e.next();){if(1===e.tag())return e.getMessage();e.skip()}return null}function $l(e,t,r,i,s,n){return.5*Math.abs(e*i+r*n+s*t-e*n-r*t-s*i)}function eu(e,t,r,i,s){return!!e&&(0===t*s-i*r&&t*i+r*s>0)}class tu extends Lc{static fromBuffer(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const s=t.geometryType,n=function(e){try{const t=2,r=new jl.A(new Uint8Array(e),new DataView(e));for(;r.next();){if(r.tag()===t)return Jl(r.getMessage());r.skip()}}catch(n){const t=new i.A("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:n});W.A.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(t)}return null}(e),o=function(e,t){var r;let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const n=e.asUnsafe(),o=n.pos(),a=new Xl;let c=0,l=0,u=null,d=null,h=null,p=!1;const f=[];for(;n.next();)switch(n.tag()){case 1:u=n.getString();break;case 3:d=n.getString();break;case 12:h=n.processMessage(Wl.ae);break;case 9:if(a.exceededTransferLimit=n.getBool(),a.exceededTransferLimit){a.offsets.geometry=s?new Float64Array(8e3):new Int32Array(8e3),a.centroid=s?new Float64Array(16e3):new Int32Array(16e3);for(let e=0;e<a.centroid.length;e++)a.centroid[e]=Yl}break;case 13:{const e=n.processMessage(Wl.cn);e.index=c++,f.push(e);break}case 15:{const e=n.getLength(),r=n.pos()+e;if(!a.exceededTransferLimit){const e=a.offsets.geometry,t=a.centroid;e.push(0),t.push(Yl),t.push(Yl)}!p&&a.exceededTransferLimit&&(p=!0,a.offsets.attributes=s?new Float64Array(8e3*c):new Uint32Array(8e3*c));let i=l*c;for(;n.pos()<r&&n.next();)switch(n.tag()){case 1:{p?a.offsets.attributes[i++]=n.pos():a.offsets.attributes.push(n.pos());const e=n.getLength();n.skipLen(e);break}case 2:if(t){const e=n.getLength(),t=n.pos()+e;for(;n.pos()<t&&n.next();)switch(n.tag()){case 3:{n.getUInt32();const e=n.getSInt64(),t=n.getSInt64();a.centroid[2*l]=e,a.centroid[2*l+1]=t;break}default:n.skip()}}else{a.offsets.geometry[l]=n.pos();const e=n.getLength();a.vertexCount+=e,n.skipLen(e)}break;case 4:{const e=n.getLength(),t=n.pos()+e;for(;n.pos()<t&&n.next();)switch(n.tag()){case 3:{n.getUInt32();const e=n.getSInt64(),t=n.getSInt64();a.centroid[2*l]=e,a.centroid[2*l+1]=t;break}default:n.skip()}break}default:n.skip()}l++,a.hasFeatures=!0;break}default:n.skip()}const _=u||d;if(!_)throw new i.A("FeatureSet has no objectId or globalId field name");return a.fields=new pa.A(f),a.featureCount=l,a.fieldCount=c,a.objectIdFieldIndex=null===(r=a.fields.get(_))||void 0===r?void 0:r.index,a.transform=h,a.displayIds=new Uint32Array(a.featureCount),a.groupIds=new Uint16Array(a.featureCount),n.move(o),a}(n,"esriGeometryPoint"===s,r);return new tu(n,o,t)}constructor(e,t,r){super(r),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._parseCaches=new Array,this._geometryType=r.geometryType,this._reader=e,this._header=t,this._hasNext=t.hasFeatures,this._isPoints="esriGeometryPoint"===r.geometryType}get _size(){return this._header.featureCount}get fields(){return this._header.fields}get geometryType(){return this._geometryType}get hasZ(){return!1}get hasM(){return!1}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this._size}getInTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e}getAttributeHash(){let e="";for(const t of this._header.fields.fields)e+=this._readAttributeAtIndex(t.index)+".";return e}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(e){this._header.displayIds[this._featureIndex]=e}readGeometryArea(){return this._cache.area||this._readGeometry(!0),this._cache.area}copy(){const e=this._reader.clone(),t=new tu(e,this._header,this.metadata);return this.copyInto(t),t}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}_readX(){return this._header.centroid[2*this._featureIndex]}_readY(){return this._header.centroid[2*this._featureIndex+1]}_readServerCentroid(){const e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1];return e===Hl?null:new Be.A([],[e,t])}_readGeometry(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this._cache.geometry){var t;let i=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===Hl)return null;const e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1];i=new Be.A([],[e,t])}else{const t=this._header.offsets.geometry[this._featureIndex],s=this._reader;if(0===t)return null;s.move(t);try{i=e?this._parseGeometryForDisplay(s):this._parseGeometry(s)}catch(r){return null}}return 0===(null===(t=i)||void 0===t?void 0:t.coords.length)&&(i=null),this._cache.geometry=i,i}return this._cache.geometry}_readAttribute(e,t){const r=this._header.fields.get(e);if(null==r)return;const i=this._readAttributeAtIndex(r.index),s=this._header.fields.isDateField(r.name);return t?null==i?i:s?new Date(i):i:i}_readAttributes(){const e={};for(const t of this._header.fields.fields)e[t.name]=this._readAttributeAtIndex(t.index);return e}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext,e._parseCaches=this._parseCaches}_readAttributeAtIndex(e){let t=this._parseCaches[e];if(t||(t=new vc(this.getSize()),this._parseCaches[e]=t),t.has(this._featureIndex))return t.get(this._featureIndex);const r=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],i=this._reader;i.move(r);const s=function(e){const t=e.getLength(),r=e.pos()+t;for(;e.pos()<r&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}(i);return t.set(this._featureIndex,s),s}_readGeometryDeltaDecoded(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this._cache.unquantGeometry){const t=this._readGeometry(e);if(!t)return this._cache.unquantGeometry=void 0,null;if(!this.getInTransform())return this._cache.unquantGeometry=t,t;const r=Kl(t.coords.length).decoded,i=t.clone(r),s=i.coords;let n=0;for(const e of i.lengths){for(let t=1;t<e;t++){const e=2*(n+t),r=2*(n+t-1);s[e]+=s[r],s[e+1]+=s[r+1]}n+=e}return this._cache.unquantGeometry=i,i}return this._cache.unquantGeometry}_parseGeometry(e){const t=e.asUnsafe(),r=t.getLength(),i=t.pos()+r,s=[],n=[];for(;t.pos()<i&&t.next();)switch(t.tag()){case 2:{const e=t.getUInt32(),r=t.pos()+e;for(;t.pos()<r;)n.push(t.getUInt32());break}case 3:{const e=t.getUInt32(),r=t.pos()+e;for(s.push(t.getSInt64()),s.push(t.getSInt64()),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();t.pos()<r;)s.push(t.getSInt64()),s.push(t.getSInt64()),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();break}default:t.skip()}return new Be.A(n,s)}_parseGeometryForDisplay(e){const t=e.asUnsafe(),r=t.getLength(),i=t.pos()+r,s=[],n=[];let o=0,a=0,c=null,l=0;const u="esriGeometryPolygon"===this.geometryType,d="esriGeometryPolyline"===this.geometryType,h=u||d;for(;t.pos()<i&&t.next();)switch(t.tag()){case 2:{const e=t.getUInt32(),r=t.pos()+e;for(;t.pos()<r;){const e=t.getUInt32();s.push(e),o+=e}c=Kl(2*o).delta;break}case 3:{t.getUInt32();const e=2+(this.hasZ?1:0)+(this.hasM?1:0);(0,x.Lw)(c);for(const r of s)if(a+e*r>c.length)for(let e=0;e<r;e++)t.getSInt32(),t.getSInt32(),this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();else if(u){const e=this.getAreaSimplificationThreshold(r,this._header.vertexCount);let i=2,s=1;const o=!1;let u=t.getSInt32(),d=t.getSInt32();c[a++]=u,c[a++]=d,this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();let p=t.getSInt32(),f=t.getSInt32();for(this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();i<r;){let r=t.getSInt32(),n=t.getSInt32();this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32();const o=u+p,_=d+f;$l(u,d,o,_,o+r,_+n)>=e?(l+=-.5*(o-u)*(_+d),s>1&&eu(h,c[a-2],c[a-1],p,f)?(c[a-2]+=p,c[a-1]+=f):(c[a++]=p,c[a++]=f,s++),u=o,d=_):(r+=p,n+=f),p=r,f=n,i++}s<3||o?a-=2*s:(l+=-.5*(u+p-u)*(d+f+d),eu(h,c[a-2],c[a-1],p,f)?(c[a-2]+=p,c[a-1]+=f,n.push(s)):(c[a++]=p,c[a++]=f,n.push(++s)))}else{let e=0,i=t.getSInt32(),s=t.getSInt32();this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32(),c[a++]=i,c[a++]=s,e+=1;for(let n=1;n<r;n++){const r=t.getSInt32(),o=t.getSInt32(),u=i+r,d=s+o;l+=-.5*(u-i)*(d+s),this.hasZ&&t.getSInt32(),this.hasM&&t.getSInt32(),n>2&&eu(h,c[a-2],c[a-1],r,o)?(c[a-2]+=r,c[a-1]+=o):(c[a++]=r,c[a++]=o,e+=1),i=u,s=d}n.push(e)}break}default:t.skip()}return this._cache.area=l,n.length?new Be.A(n,c):null!=c?this._createQuantizedExtrudedGeometry(c[0],c[1]):null}}class ru{constructor(e,t){this.service=e,this._metadata=t}destroy(){}}class iu extends ru{constructor(e,t){super(e,t),this._portsOpen=async function(e){const t=new ql.A;return await t.open(e,{}),t}(e.source).then((e=>this.client=e))}destroy(){this.client.close(),this.client=null}async executeQuery(e,t){await this._portsOpen;const r=await this.client.invoke("queryFeatures",e.toJSON(),t);return Vc.fromFeatureSet(r,this._metadata)}}class su extends ru{async executeQuery(e,t){const{data:r}=await(0,Cl.kS)(this.service.source,e,t),i=!e.quantizationParameters;return tu.fromBuffer(r,this._metadata,i)}}class nu extends ru{async executeQuery(e,t){var r;const{source:i,queryMetadata:s}=this.service;if(null!=e.quantizationParameters&&!s.supportsQuantization){const r=e.clone(),s=(0,Gl.VV)(r.quantizationParameters);r.quantizationParameters=null;const{data:n}=await(0,Cl.eW)(i,r,this._metadata.spatialReference,t),o=(0,Tn.q3)(n,this._metadata.objectIdField);return(0,Tn.jH)(s,o),Vc.fromOptimizedFeatureSet(o,this._metadata)}const{data:n}=await(0,Cl.eW)(i,e,this._metadata.spatialReference,t);return"esriGeometryPoint"===this._metadata.geometryType&&(n.features=null===(r=n.features)||void 0===r?void 0:r.filter((e=>{if(null!=e.geometry){const t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0}))),Vc.fromFeatureSet(n,this._metadata)}}class ou extends ru{async executeQuery(e,t){if(e.quantizationParameters&&!this.service.queryMetadata.supportsQuantization){const r=e.clone(),i=(0,Gl.VV)(r.quantizationParameters);r.quantizationParameters=null;const s=await(0,Ul.I)(this.service.source,e,t);return(0,Tn.jH)(i,s),Vc.fromOptimizedFeatureSet(s,this._metadata)}const r=await(0,Ul.I)(this.service.source,e,t);return Vc.fromOptimizedFeatureSet(r,this._metadata)}}class au extends Vl{constructor(e,t,r,i,s){super(r),this._serviceInfo=e,this._queryInfo=t,this._metadata=i,this._connection=s,this._queue=new na.e({concurrency:16,process:async e=>{var t;const r={signal:null===(t=e.options)||void 0===t?void 0:t.signal,query:e.query.customParameters};return this._adapter.executeQuery(e.query.inner,r)}}),this._adapter=function(e,t){switch(e.type){case"memory":return new iu(e,t);case"ogc":return new ou(e,t);case"feature-service":return e.queryMetadata.supportsFormatPBF&&(0,n.A)("featurelayer-pbf")?new su(e,t):new nu(e,t)}}(e,i)}unsafeSetQueryHistoricMoment(e){this._queryInfo.updateHistoricMoment(e)}async updateFields(e){this._queryInfo.updateFields(e);const t=Array.from(this._store.chunks()).map((async e=>{const r=ll.A.fromJSON(e.queryInfo.queryJSON);if(r)try{return await this._tryUpdateFields(e.reader,r),null}catch(t){return t}})),r=(await Promise.all(t)).filter((e=>e));if(r.length)throw new i.A("featurelayer-query","Encountered errors when downloading fields",{errors:r})}async queryByObjectId(e){if(0===e.length)return Vc.empty(this._metadata);const t=this._queryInfo.createQuery({objectIds:e});return this._fetch(t)}async _fetch(e,t){const r=await this._enqueue(e,t);return await this._tryUpdateFields(r,e.inner),r}async _tryUpdateFields(e,t){const r=this._queryInfo.createPatchFieldsQuery(t,e);if(!r)return;const i=await this._enqueue(r,this._options);e.joinAttributes(i)}async _enqueue(e,t){return this._connection.onEvent({type:"fetchStart"}),this._queue.push({query:e,options:t}).finally((()=>{this._connection.onEvent({type:"fetchEnd",done:0===this._queue.length})}))}}class cu extends au{constructor(){super(...arguments),this._chunksById=new Map}unload(e){this._removeChunks(e.tile)}_addChunk(e){const t=e.tile.id;this._chunksById.has(t)||this._chunksById.set(t,[]);const r=e.size();(r||e.first||e.end)&&((0,n.A)("esri-2d-update-debug")&&console.debug("Chunk[".concat(e.chunkId,"] ATileLoadStrategy.addChunk [count=").concat(r,"]")),this._chunksById.get(t).push(e),this._store.insert(e))}_removeChunks(e){var t;const r=null!==(t=this._chunksById.get(e.key.id))&&void 0!==t?t:[];for(const i of r)(0,n.A)("esri-2d-update-debug")&&console.debug("Tile[".concat(e.key.id,"] Chunk[").concat(i.chunkId,"] ATileLoadStrategy.removeChunk")),this._store.remove(i);this._chunksById.delete(e.key.id)}}class lu extends Bc{constructor(e,t,r,i,s,n){var o,a;super(),this._reader=e,this._queryJSON=t,this._tile=r,this._sourceTile=i,this._sourceTileDepth=s,this._end=n,this.chunkId="".concat(this._tile.key.id,".").concat(null===(o=this._sourceTile)||void 0===o?void 0:o.key.id).concat(this._end?"e":""),this.normalizedChunkId="".concat(this._tile.key.normalizedId,".").concat(null===(a=this._sourceTile)||void 0===a?void 0:a.key.normalizedId).concat(this._end?"e":"")}get queryInfo(){var e;return{type:"drill-down-tile",chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,sourceTileDepth:this._sourceTileDepth,sourceTileId:null===(e=this._sourceTile)||void 0===e?void 0:e.key.id,size:this.size(),end:this.end}}get first(){return 0===this._sourceTileDepth}get reader(){return this._reader}get end(){return this._end}get tile(){return this._tile}get isTiled(){return!0}getTileReader(e){return this._tile.key.id===e.key.id?this.reader:null}}class uu{constructor(e,t){this.subscription=e,this._tileIdToResult=new Map,this._controller=new AbortController,this._handles=(0,s.vE)([(0,a.u7)(e.signal,(()=>this._controller.abort())),(0,a.u7)(t,(()=>this._controller.abort()))])}destroy(){this._controller.abort(),this._handles.remove()}get(e){return this._tileIdToResult.get(e)}set(e,t){this._tileIdToResult.set(e,t)}get options(){return{signal:this._controller.signal}}}class du extends cu{constructor(){super(...arguments),this._loadStates=new Map}destroy(){super.destroy();for(const e of this._loadStates.values())e.destroy();this._loadStates.clear()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(e){this._loadStates.has(e.key.id)||this._loadStates.set(e.key.id,new uu(e,this._options));const t=this._loadStates.get(e.key.id);let r;try{var i,s=!1,n=!1;try{for(var o,c=(0,g.A)(this._fetchChunkInfos(t,e.tile,0));s=!(o=await c.next()).done;s=!1){const e=o.value;{const{queryJSON:r,reader:i,sourceTile:s,sourceTileDepth:n,tile:o}=e,c=new lu(i,r,o,s,n,!1);(0,a.Te)(t.options),this._addChunk(c)}}}catch(u){n=!0,i=u}finally{try{s&&null!=c.return&&await c.return()}finally{if(n)throw i}}}catch(d){r=d}const l=new lu(Vc.empty(this._metadata),null,e.tile,null,-1,!0);if(this._addChunk(l),r)throw r}unload(e){var t;super.unload(e),null!==(t=this._loadStates.get(e.key.id))&&void 0!==t&&t.destroy(),this._loadStates.delete(e.key.id)}_fetchChunkInfos(e,t,r){var i=this;return(0,ua.A)((function*(){let s=e.get(t.id);const o=!!s;if(s||(s=yield(0,la.A)(i._fetchChunkInfo(e,t,r)),e.set(t.id,s)),s.reader.exceededTransferLimit&&r<(0,n.A)("featurelayer-query-max-depth"))for(const n of t.createChildTiles())yield*ca((0,g.A)(i._fetchChunkInfos(e,n,r+1)),la.A);else o||(yield s)}))()}async _fetchChunkInfo(e,t,r){const i=e.subscription.tile.getQuantizationParameters(),s=this._queryInfo.createTileQuery(t,{returnExceededLimitFeatures:!1,quantizationParameters:i});return{reader:await this._fetch(s,e.options),queryJSON:s.inner.toJSON(),tile:e.subscription.tile,sourceTile:t,sourceTileDepth:r}}}class hu extends Bc{constructor(e,t,r,i,s){super(),this._reader=e,this._queryJSON=t,this._tile=r,this._page=i,this._end=s,this.chunkId="".concat(this._tile.key.id,".").concat(this._page).concat(this.end?"e":""),this.normalizedChunkId="".concat(this._tile.key.normalizedId,".").concat(this._page).concat(this.end?"e":"")}get queryInfo(){return{type:"paged-tile",chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get reader(){return this._reader}get first(){return 0===this._page}get end(){return this._end}get page(){return this._page}get tile(){return this._tile}get isTiled(){return!0}getTileReader(e){return this._tile.key.id===e.key.id?this.reader:null}}class pu{constructor(e,t){this.subscription=e,this._pages=new Set,this._controller=new AbortController,this._done=!1,this._handles=(0,s.vE)([(0,a.u7)(e.signal,(()=>this._controller.abort())),(0,a.u7)(t,(()=>this._controller.abort()))])}destroy(){this._controller.abort(),this._handles.remove()}get pageStart(){let e=-1;for(const t of this._pages.values())e=Math.max(e,t);return e+1}get done(){return this._done}get options(){return{signal:this._controller.signal}}add(e,t){this._pages.add(e),this._done=this._done||t}}class fu extends cu{constructor(){super(...arguments),this._loadStates=new Map}destroy(){super.destroy();for(const e of this._loadStates.values())e.destroy();this._loadStates.clear()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(e){this._loadStates.has(e.key.id)||this._loadStates.set(e.key.id,new pu(e,this._options));const t=this._loadStates.get(e.key.id);let r;try{await this._fetchPages(t)}catch(s){r=s}const i=new hu(Vc.empty(this._metadata),null,e.tile,-1,!0);if((0,a.G4)(t.options)||this._addChunk(i),r)throw r}unload(e){var t;super.unload(e),null!==(t=this._loadStates.get(e.key.id))&&void 0!==t&&t.destroy(),this._loadStates.delete(e.key.id)}async _fetchPages(e){let t=0,r=e.pageStart,i=1;for(;t<20&&!e.done;){const s=[];for(let t=0;t<i;t++)s.push(this._fetchChunk(e,r++));const n=await Promise.all(s);for(const t of n)(0!==t.size()||t.first)&&(e.add(t.page,!t.reader.exceededTransferLimit),(0,a.Te)(e.options),this._addChunk(t));t++,i=Math.min(i+1,4)}}async _fetchChunk(e,t){const r=e.subscription.tile,i=this._queryInfo.createPagedTileQuery(r,t),s=await this._fetch(i,e.options);return new hu(s,i.inner.toJSON(),r,t,!1)}}var _u=r(41289),yu=r(28899);let mu;const gu=new Array(128).fill(void 0);function xu(e){return gu[e]}gu.push(void 0,null,!0,!1);let vu=gu.length;function bu(e){const t=xu(e);return function(e){e<132||(gu[e]=vu,vu=e)}(e),t}function wu(e){vu===gu.length&&gu.push(gu.length+1);const t=vu;return vu=gu[t],gu[t]=e,t}const Iu="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&Iu.decode();let Su=null;function Tu(){return null!==Su&&0!==Su.byteLength||(Su=new Uint8Array(mu.memory.buffer)),Su}function Au(e,t){return e>>>=0,Iu.decode(Tu().subarray(e,e+t))}const Mu="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>{mu.__wbindgen_export_0.get(e.dtor)(e.a,e.b)}));function ku(e,t,r){mu._dyn_core__ops__function__FnMut__A____Output___R_as_wasm_bindgen__closure__WasmClosure___describe__invoke__h7be72b1871260ae2(e,t,wu(r))}let Fu=0;const Eu="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},Cu="function"==typeof Eu.encodeInto?function(e,t){return Eu.encodeInto(e,t)}:function(e,t){const r=Eu.encode(e);return t.set(r),{read:e.length,written:r.length}};function Pu(e,t,r){if(void 0===r){const r=Eu.encode(e),i=t(r.length,1)>>>0;return Tu().subarray(i,i+r.length).set(r),Fu=r.length,i}let i=e.length,s=t(i,1)>>>0;const n=Tu();let o=0;for(;o<i;o++){const t=e.charCodeAt(o);if(t>127)break;n[s+o]=t}if(o!==i){0!==o&&(e=e.slice(o)),s=r(s,i,i=o+3*e.length,1)>>>0;const t=Tu().subarray(s+o,s+i);o+=Cu(e,t).written,s=r(s,i,o,1)>>>0}return Fu=o,s}let zu=null;function Ou(){return(null===zu||!0===zu.buffer.detached||void 0===zu.buffer.detached&&zu.buffer!==mu.memory.buffer)&&(zu=new DataView(mu.memory.buffer)),zu}function Ru(e,t){try{return e.apply(this,t)}catch(r){mu.__wbindgen_exn_store(wu(r))}}let Du=null;function Lu(e,t){const r=t(2*e.length,2)>>>0;return(null!==Du&&0!==Du.byteLength||(Du=new Uint16Array(mu.memory.buffer)),Du).set(e,r/2),Fu=e.length,r}function Nu(e,t,r){const i=Pu(e,mu.__wbindgen_malloc,mu.__wbindgen_realloc),s=Fu;return bu(mu.readMetadata(i,s,wu(t),wu(r)))}function Bu(e,t){if(!(e instanceof t))throw new Error("expected instance of ".concat(t.name));return e.ptr}function Vu(e){return null==e}const qu="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>mu.__wbg_fieldmetadata_free(e>>>0,1)));class Gu{static __wrap(e){e>>>=0;const t=Object.create(Gu.prototype);return t.__wbg_ptr=e,qu.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,qu.unregister(this),e}free(){const e=this.__destroy_into_raw();mu.__wbg_fieldmetadata_free(e,0)}get name(){let e,t;try{const s=mu.__wbindgen_add_to_stack_pointer(-16);mu.fieldmetadata_name(s,this.__wbg_ptr);var r=Ou().getInt32(s+0,!0),i=Ou().getInt32(s+4,!0);return e=r,t=i,Au(r,i)}finally{mu.__wbindgen_add_to_stack_pointer(16),mu.__wbindgen_free(e,t,1)}}get index(){return mu.fieldmetadata_index(this.__wbg_ptr)}get type(){return["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeBigInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"][mu.fieldmetadata_esri_type(this.__wbg_ptr)]}}const Uu="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>mu.__wbg_filemetadata_free(e>>>0,1)));class ju{static __wrap(e){e>>>=0;const t=Object.create(ju.prototype);return t.__wbg_ptr=e,Uu.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Uu.unregister(this),e}free(){const e=this.__destroy_into_raw();mu.__wbg_filemetadata_free(e,0)}version(){return mu.filemetadata_version(this.__wbg_ptr)}numRows(){return mu.filemetadata_numRows(this.__wbg_ptr)>>>0}numFields(){return mu.filemetadata_numFields(this.__wbg_ptr)>>>0}keyValueMetadata(e){try{const i=mu.__wbindgen_add_to_stack_pointer(-16),s=Pu(e,mu.__wbindgen_malloc,mu.__wbindgen_realloc),n=Fu;mu.filemetadata_keyValueMetadata(i,this.__wbg_ptr,s,n);var t=Ou().getInt32(i+0,!0),r=Ou().getInt32(i+4,!0);let o;return 0!==t&&(o=Au(t,r).slice(),mu.__wbindgen_free(t,1*r,1)),o}finally{mu.__wbindgen_add_to_stack_pointer(16)}}getFieldIndex(e){const t=Pu(e,mu.__wbindgen_malloc,mu.__wbindgen_realloc),r=Fu,i=mu.filemetadata_getFieldIndex(this.__wbg_ptr,t,r);return 16777215===i?void 0:i}getFieldByIndex(e){const t=mu.filemetadata_getFieldByIndex(this.__wbg_ptr,e);return 0===t?void 0:Gu.__wrap(t)}}const Wu="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>mu.__wbg_geometryinfodescriptor_free(e>>>0,1)));class Yu{static __wrap(e){e>>>=0;const t=Object.create(Yu.prototype);return t.__wbg_ptr=e,Wu.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Wu.unregister(this),e}free(){const e=this.__destroy_into_raw();mu.__wbg_geometryinfodescriptor_free(e,0)}get wkbIndex(){const e=mu.__wbg_get_geometryinfodescriptor_wkbIndex(this.__wbg_ptr);return 16777215===e?void 0:e}set wkbIndex(e){mu.__wbg_set_geometryinfodescriptor_wkbIndex(this.__wbg_ptr,Vu(e)?16777215:e)}get lngIndex(){const e=mu.__wbg_get_geometryinfodescriptor_lngIndex(this.__wbg_ptr);return 16777215===e?void 0:e}set lngIndex(e){mu.__wbg_set_geometryinfodescriptor_lngIndex(this.__wbg_ptr,Vu(e)?16777215:e)}get latIndex(){const e=mu.__wbg_get_geometryinfodescriptor_latIndex(this.__wbg_ptr);return 16777215===e?void 0:e}set latIndex(e){mu.__wbg_set_geometryinfodescriptor_latIndex(this.__wbg_ptr,Vu(e)?16777215:e)}static new(){const e=mu.geometryinfodescriptor_new();return Yu.__wrap(e)}}const Xu="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>mu.__wbg_parquetchunk_free(e>>>0,1)));class Hu{static __wrap(e){e>>>=0;const t=Object.create(Hu.prototype);return t.__wbg_ptr=e,Xu.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Xu.unregister(this),e}free(){const e=this.__destroy_into_raw();mu.__wbg_parquetchunk_free(e,0)}size(){return mu.parquetchunk_size(this.__wbg_ptr)>>>0}hasField(e){return 0!==mu.parquetchunk_hasField(this.__wbg_ptr,e)}readX(e){return mu.parquetchunk_readX(this.__wbg_ptr,e)}readY(e){return mu.parquetchunk_readY(this.__wbg_ptr,e)}readAttributes(e){return bu(mu.parquetchunk_readAttributes(this.__wbg_ptr,e))}readAttribute(e,t){return bu(mu.parquetchunk_readAttribute(this.__wbg_ptr,e,t))}}const Zu="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>mu.__wbg_parquetfile_free(e>>>0,1)));let Qu=class e{static __wrap(t){t>>>=0;const r=Object.create(e.prototype);return r.__wbg_ptr=t,Zu.register(r,r.__wbg_ptr,r),r}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Zu.unregister(this),e}free(){const e=this.__destroy_into_raw();mu.__wbg_parquetfile_free(e,0)}metadata(){const e=mu.parquetfile_metadata(this.__wbg_ptr);return ju.__wrap(e)}readChunksWithCallback(e,t){const r=Lu(e,mu.__wbindgen_malloc),i=Fu;return bu(mu.parquetfile_readChunksWithCallback(this.__wbg_ptr,r,i,wu(t)))}updateChunks(e){const t=Lu(e,mu.__wbindgen_malloc),r=Fu;return bu(mu.parquetfile_updateChunks(this.__wbg_ptr,t,r))}};const Ku="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>mu.__wbg_rangeproviderjs_free(e>>>0,1)));class Ju{static __wrap(e){e>>>=0;const t=Object.create(Ju.prototype);return t.__wbg_ptr=e,Ku.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Ku.unregister(this),e}free(){const e=this.__destroy_into_raw();mu.__wbg_rangeproviderjs_free(e,0)}static new(e,t){const r=mu.rangeproviderjs_new(wu(e),wu(t));return Ju.__wrap(r)}static withFetch(){const e=mu.rangeproviderjs_withFetch();return Ju.__wrap(e)}}function $u(){const e={wbg:{}};return e.wbg.__wbg_new_abda76e883ba8a5f=function(){return wu(new Error)},e.wbg.__wbg_stack_658279fe44541cf6=function(e,t){const r=Pu(xu(t).stack,mu.__wbindgen_malloc,mu.__wbindgen_realloc),i=Fu;Ou().setInt32(e+4,i,!0),Ou().setInt32(e+0,r,!0)},e.wbg.__wbg_error_f851667af71bcfc6=function(e,t){let r,i;try{r=e,i=t,console.error(Au(e,t))}finally{mu.__wbindgen_free(r,i,1)}},e.wbg.__wbindgen_object_drop_ref=function(e){bu(e)},e.wbg.__wbindgen_is_function=function(e){return"function"==typeof xu(e)},e.wbg.__wbg_self_3093d5d1f7bcb682=function(){return Ru((function(){return wu(self.self)}),arguments)},e.wbg.__wbg_window_3bcfc4d31bc012f8=function(){return Ru((function(){return wu(window.window)}),arguments)},e.wbg.__wbg_globalThis_86b222e13bdf32ed=function(){return Ru((function(){return wu(globalThis.globalThis)}),arguments)},e.wbg.__wbg_global_e5a3fe56f8be9485=function(){return Ru((function(){return wu(global.global)}),arguments)},e.wbg.__wbindgen_is_undefined=function(e){return void 0===xu(e)},e.wbg.__wbg_newnoargs_76313bd6ff35d0f2=function(e,t){return wu(new Function(Au(e,t)))},e.wbg.__wbindgen_object_clone_ref=function(e){return wu(xu(e))},e.wbg.__wbindgen_number_new=function(e){return wu(e)},e.wbg.__wbg_new_525245e2b9901204=function(){return wu(new Object)},e.wbg.__wbindgen_string_new=function(e,t){return wu(Au(e,t))},e.wbg.__wbg_call_1084a111329e68ce=function(){return Ru((function(e,t){return wu(xu(e).call(xu(t)))}),arguments)},e.wbg.__wbg_call_89af060b4e1523f2=function(){return Ru((function(e,t,r){return wu(xu(e).call(xu(t),xu(r)))}),arguments)},e.wbg.__wbg_call_7de908392845a9a5=function(){return Ru((function(e,t,r,i,s){return wu(xu(e).call(xu(t),xu(r),xu(i),xu(s)))}),arguments)},e.wbg.__wbg_valueOf_563b3487b1b116aa=function(e){return xu(e).valueOf()},e.wbg.__wbg_set_eacc7d73fefaafdf=function(){return Ru((function(e,t,r){return Reflect.set(xu(e),xu(t),xu(r))}),arguments)},e.wbg.__wbg_buffer_b7b08af79b0b0974=function(e){return wu(xu(e).buffer)},e.wbg.__wbg_new_b85e72ed1bfd57f9=function(e,t){try{var r={a:e,b:t};return wu(new Promise(((e,t)=>{const i=r.a;r.a=0;try{return function(e,t,r,i){mu.wasm_bindgen__convert__closures__invoke2_mut__h35729c14da098d24(e,t,wu(r),wu(i))}(i,r.b,e,t)}finally{r.a=i}})))}finally{r.a=r.b=0}},e.wbg.__wbg_resolve_570458cb99d56a43=function(e){return wu(Promise.resolve(xu(e)))},e.wbg.__wbg_then_95e6edc0f89b73b1=function(e,t){return wu(xu(e).then(xu(t)))},e.wbg.__wbg_then_876bb3c633745cc6=function(e,t,r){return wu(xu(e).then(xu(t),xu(r)))},e.wbg.__wbg_new_ea1883e1e5e86686=function(e){return wu(new Uint8Array(xu(e)))},e.wbg.__wbg_length_8339fcf5d8ecd12e=function(e){return xu(e).length},e.wbg.__wbg_set_d1e79e2388520f18=function(e,t,r){xu(e).set(xu(t),r>>>0)},e.wbg.__wbindgen_throw=function(e,t){throw new Error(Au(e,t))},e.wbg.__wbindgen_memory=function(){return wu(mu.memory)},e.wbg.__wbg_queueMicrotask_48421b3cc9052b68=function(e){return wu(xu(e).queueMicrotask)},e.wbg.__wbindgen_cb_drop=function(e){const t=bu(e).original;return 1==t.cnt--&&(t.a=0,!0)},e.wbg.__wbg_queueMicrotask_12a30234db4045d3=function(e){queueMicrotask(xu(e))},e.wbg.__wbg_parquetchunk_new=function(e){return wu(Hu.__wrap(e))},e.wbg.__wbindgen_bigint_from_i64=function(e){return wu(e)},e.wbg.__wbg_parquetfile_new=function(e){return wu(Qu.__wrap(e))},e.wbg.__wbg_filemetadata_new=function(e){return wu(ju.__wrap(e))},e.wbg.__wbindgen_closure_wrapper1401=function(e,t,r){return wu(function(e,t,r,i){const s={a:e,b:t,cnt:1,dtor:r},n=function(){s.cnt++;const e=s.a;s.a=0;try{for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return i(e,s.b,...r)}finally{0==--s.cnt?(mu.__wbindgen_export_0.get(s.dtor)(e,s.b),Mu.unregister(s)):s.a=e}};return n.original=s,Mu.register(n,s,s),n}(e,t,74,ku))},e}function ed(e,t){return mu=e.exports,td.__wbindgen_wasm_module=t,zu=null,Du=null,Su=null,mu}async function td(e){if(void 0!==mu)return mu;void 0!==e&&Object.getPrototypeOf(e)===Object.prototype?({module_or_path:e}=e):console.warn("using deprecated parameters for the initialization function; pass a single object instead");const t=$u();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:r,module:i}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if("application/wasm"==e.headers.get("Content-Type"))throw r;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r)}const i=await e.arrayBuffer();return await WebAssembly.instantiate(i,t)}{const r=await WebAssembly.instantiate(e,t);return r instanceof WebAssembly.Instance?{instance:r,module:e}:r}}(await e,t);return ed(r,i)}const rd=Object.freeze(Object.defineProperty({__proto__:null,FieldMetadata:Gu,FileMetadata:ju,GeometryInfoDescriptor:Yu,ParquetChunk:Hu,ParquetFile:Qu,RangeProviderJs:Ju,default:td,enableTracing:function(){mu.enableTracing()},initSync:function(e){if(void 0!==mu)return mu;void 0!==e&&Object.getPrototypeOf(e)===Object.prototype?({module:e}=e):console.warn("using deprecated parameters for `initSync()`; pass a single object instead");const t=$u();return e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),ed(new WebAssembly.Instance(e,t),e)},readFile:function(e,t,r,i,s){const n=Pu(e,mu.__wbindgen_malloc,mu.__wbindgen_realloc),o=Fu;Bu(i,ju);var a=i.__destroy_into_raw();Bu(s,Yu);var c=s.__destroy_into_raw();return bu(mu.readFile(n,o,wu(t),wu(r),a,c))},readMetadata:Nu},Symbol.toStringTag,{value:"Module"}));let id=null;async function sd(){return id||(id=async function(){const e=await Promise.resolve().then((()=>rd));return await e.default({module_or_path:(0,yu.s)("esri/libs/parquet/pkg/arcgis_parquet_bg.wasm")}),e.enableTracing(),e}()),id}const nd=e=>async function(t,r,i){const s=e(),{data:n}=await(0,El.A)(t,{responseType:"array-buffer",query:s,headers:{range:"bytes=".concat(r,"-").concat(i)}});return n},od=e=>async function(t){const r=e(),{data:i}=await(0,El.A)(t,{responseType:"native",method:"head",query:r}),s=i.headers.get("Content-Length");if(null==s)throw new Error("Unable to parse content length");return parseInt(s,10)};class ad{static async create(e,t){const r=await sd(),i=await r.readMetadata(e,nd(t),od(t));return ad.fromFileMetadata(i)}static fromFileMetadata(e){const t=[];for(let r=0;r<e.numFields();r++){const i=e.getFieldByIndex(r);t.push({name:i.name,type:i.type,alias:i.name,index:i.index}),i.free()}return new ad(e,t)}constructor(e,t){this._inner=e,this.fields=t}destroy(){this._inner.free()}[Symbol.dispose](){this.destroy()}get size(){return this._inner.numRows()}getFieldIndex(e){return this._inner.getFieldIndex(e)}tryReadGeoMetadata(){const e=this._inner.keyValueMetadata("geo");return null==e?null:JSON.parse(e)}}class cd{static async create(e,t){const r=await sd(),i=nd(t.getCustomParameters),s=od(t.getCustomParameters),n=await Nu(e,i,s),{geometryInfo:o}=t,a=Yu.new();"location"===o.type?(a.latIndex=n.getFieldIndex(o.latitudeFieldName),a.lngIndex=n.getFieldIndex(o.longitudeFieldName)):a.wkbIndex=n.getFieldIndex(o.primaryFieldName);const c=await r.readFile(e,i,s,n,a);return new cd(c,ad.fromFileMetadata(c.metadata()))}constructor(e,t){this.inner=e,this.metadata=t}destroy(){this.inner.free(),this.metadata.destroy()}[Symbol.dispose](){this.destroy()}}class ld extends Bc{constructor(e,t,r,i){super(),this._reader=e,this._queryJSON=t,this._page=r,this._end=i,this.chunkId="".concat(this._page).concat(this.end?"e":""),this.normalizedChunkId=this.chunkId}get reader(){return this._reader}get first(){return 0===this._page}get end(){return this._end}get queryInfo(){return{type:"snapshot",chunkId:this.chunkId,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(e){const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}}var ud=r(45417);class dd extends Lc{constructor(e,t,r,i,s){var n,o;let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:new Uint32Array(i.size());super(e),this._fields=t,this._geometryInfo=r,this._inner=i,this._chunkId=s,this._displayIds=a,this._index=-1,this._size=this._inner.size(),"geometry"===this._geometryInfo.type&&(this._primaryGeometryIndex=null===(n=this._fields.get(this._geometryInfo.primaryFieldName))||void 0===n?void 0:n.index),null!=e.objectIdField&&(this._objectIdFieldIndex=null===(o=this._fields.get(e.objectIdField))||void 0===o?void 0:o.index),this._chunkId>65535&&console.error("Exceeded max allowed parquet reader size")}destroy(){super.destroy(),this._inner.free()}get fields(){return this._fields}get geometryType(){return"esriGeometryPoint"}get hasFeatures(){return!0}get hasNext(){throw new Error("Method not implemented.")}get exceededTransferLimit(){return!1}get hasZ(){return!1}get hasM(){return!1}getInTransform(){return null}getSize(){return this._size}getCursor(){return this.copy()}getAttributeHash(){let e="";for(const t of this.fields.fields)e+=this._readAttribute(t.name,!1)+".";return e}getObjectId(){return null!=this._objectIdFieldIndex?this._inner.readAttribute(this._index,this._objectIdFieldIndex):this._index<<16|this._chunkId}getDisplayId(){return this._displayIds[this._index]}setDisplayId(e){this._displayIds[this._index]=e}setIndex(e){this._index=e}getIndex(){return this._index}next(){for(;++this._index<this._size&&!this._getExists(););return this._index<this._size}readGeometryArea(){throw new Error("Method not implemented.")}copy(){const e=new dd(this.metadata,this._fields,this._geometryInfo,this._inner,this._chunkId,this._displayIds);return this.copyInto(e),e}copyInto(e){super.copyInto(e),e._index=this._index}_readGeometry(e){const t=(0,ud.je)(this._inner.readX(this._index),this._inner.readY(this._index));return new Be.A([],t)}_readX(){var e;return null===(e=this._readGeometry())||void 0===e?void 0:e.coords[0]}_readY(){var e;return null===(e=this._readGeometry())||void 0===e?void 0:e.coords[1]}_readServerCentroid(){return null}_readAttribute(e,t){const r=this.fields.get(e);if(!r)return;const i=this._inner.readAttribute(this._index,r.index);if(null==i)return i;const s=this.fields.isDateField(r.name);return t?null==i?i:s?new Date(i):i:i}_readAttributes(){const e={};for(const t of this._fields.fields)this._inner.hasField(t.index)&&t.index!==this._primaryGeometryIndex&&(e[t.name]=this._readAttribute(t.name,!1));return null==this._objectIdFieldIndex&&(e.__OBJECTID=this.getObjectId()),e}}class hd extends Vl{constructor(e,t,r,i){super(i),this._service=e,this._metadata=t,this._schema=r,this._chunkId=0,this._files=[],this._availableFields=new Set(r.mutable.availableFields);const{geometryInfo:s}=this._service;"location"===s.type?(this._availableFields.add(s.latitudeFieldName),this._availableFields.add(s.longitudeFieldName)):this._availableFields.add(s.primaryFieldName)}destroy(){for(const e of this._files)e.destroy()}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}async updateFields(e){await this._promise;const t=new Set(e),r=(0,_u.iv)(t,this._availableFields);this._availableFields=(0,_u.KC)(r,this._availableFields),await Promise.all(this._files.map((e=>{const t=Array.from(r).map((t=>e.metadata.getFieldIndex(t)));return e.inner.updateChunks(new Uint16Array(t))})))}async load(e){return null==this._promise&&(this._promise=this._download()),this._promise}unload(e){}async addParquetFile(e){this._insert(e)}async _insert(e){const t=await cd.create(e,{geometryInfo:this._service.geometryInfo,outSpatialReference:this._service.outSpatialReference,getCustomParameters:()=>this._schema.mutable.dataFilter.customParameters}),{geometryInfo:r}=this._service;(0,a.Te)(this._options);const{fields:i,timeZoneByFieldName:s}=this._service.metadata.fieldsIndex,n=i.map((e=>(0,m.A)((0,m.A)({},e),{},{index:t.metadata.getFieldIndex(e.name)}))),o=pa.A.fromJSON({fields:n,timeZoneByFieldName:s}),c=new Uint16Array(Array.from(this._availableFields.values()).map((e=>{var t;return null===(t=o.get(e))||void 0===t?void 0:t.index})));await t.inner.readChunksWithCallback(c,(e=>{const t=this._chunkId++,i=new dd(this._metadata,o,r,e,t),s=new ld(i,null,t,!1);this._store.insert(s)})),this._files.push(t)}async _download(){try{await Promise.all(this._service.source.urls.map((e=>this._insert(e))));const e=new ld(Vc.empty(this._metadata),null,-1,!0);this._store.insert(e)}catch(e){throw console.error(e),e}}}class pd extends au{constructor(e,t,r,i,s,n){super(e,t,r,s,n),this._random=new c.A(1e3),this._featureCount=i}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}load(e){return null==this._promise&&(this._promise=this._downloadPages(this._featureCount)),this._promise}unload(e){}async _downloadPages(e){const t=Math.ceil(e/this._queryInfo.pageSize),r=Array.from({length:t},((e,t)=>t)).sort(((e,t)=>this._random.getInt()-this._random.getInt())),s=await Promise.all(r.map((e=>this._downloadPage(e)))),n=new ld(Vc.empty(this._metadata),null,-1,!0);this._store.insert(n);const o=s.filter((e=>e));if(o.length)throw new i.A("featurelayer-query","Encountered errors when downloading data",{errors:o})}async _downloadPage(e){try{const t=this._queryInfo.createPagedQuery(e),r=await this._fetch(t,this._options),i=new ld(r,t.inner.toJSON(),e,!1);return(0,a.Te)(this._options),this._store.insert(i),null}catch(t){return t}}}var fd=r(25269),_d=r(55039);let yd=class extends Dl.A{constructor(e){super(e)}get connectionStatus(){var e;return null===(e=this.connection)||void 0===e?void 0:e.connectionStatus}get errorString(){var e;return null===(e=this.connection)||void 0===e?void 0:e.errorString}};(0,Nt._)([(0,Ll.MZ)()],yd.prototype,"connection",void 0),(0,Nt._)([(0,Ll.MZ)()],yd.prototype,"connectionStatus",null),(0,Nt._)([(0,Ll.MZ)()],yd.prototype,"errorString",null),yd=(0,Nt._)([(0,Nl.$)("esri.views.2d.layers.features.sources.StreamConnectionState")],yd);class md{constructor(e,t){this._metadata=e,this._onUpdate=t,this._objectIdToFeature=new Map}get size(){return this._objectIdToFeature.size}get reader(){return Vc.fromFeatures([...this._objectIdToFeature.values()],this._metadata)}add(e){this._objectIdToFeature.set(e.objectId,e)}forEach(e){this._objectIdToFeature.forEach(e)}removeById(e){const t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),t):null}clear(){this._objectIdToFeature=new Map}update(e,t){var r;this._onUpdate(null!==(r=null===e||void 0===e?void 0:e.length)&&void 0!==r?r:0)}}class gd extends Bc{constructor(e){super(),this._reader=e,this.chunkId="stream-chunk",this.normalizedChunkId="stream-chunk"}get reader(){return this._reader}get first(){return!0}get end(){return!0}get queryInfo(){return{type:"stream",chunkId:this.chunkId,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(e){const t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}}class xd extends Vl{constructor(e,t,r,i,s){super(r),this._service=e,this._dataFilter=t,this._streamOptions=i,this._metadata=s,this._connectionState=new yd,this._forceRefresh=!1,this.events=new _a.A;const{objectIdField:n,timeInfo:o}=this._metadata,{purgeOptions:a}=t;this._stagingStore=new md(this._metadata,(e=>this.events.emit("features-updated",e))),this._manager=new fd.GY(this._stagingStore,n,o,a),this.connect()}destroy(){super.destroy(),this.disconnect()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}get connectionStatus(){return this._connectionState.connectionStatus}get errorString(){var e;return null===(e=this._connectionState)||void 0===e?void 0:e.errorString}async refresh(){const e=null!=this._chunk;this._manager.checkForUpdates()||!e||this._forceRefresh?(this._chunk&&this._store.remove(this._chunk),this._forceRefresh=!1,this._chunk=new gd(this._stagingStore.reader),this._store.insert(this._chunk),this.events.emit("tick")):this.events.emit("tick")}async updateFields(e){throw new Error("Updating available fields not supported for StreamLayer")}async load(e){}unload(e){}disconnect(){var e;this._connection=(0,x.pR)(this._connection),this._connectionState.connection=null,null===(e=this._handlesGroup)||void 0===e||e.remove()}connect(){if(null!=this._connection)return;const{geometryType:e,spatialReference:t}=this._metadata,{maxReconnectionAttempts:r,maxReconnectionInterval:i,geometryDefinition:n,definitionExpression:o,customParameters:a}=this._dataFilter;this._connection=(0,_d.createConnection)(this._service.source,t,this._streamOptions.outSR,e,o,n,r,i,a),this._handlesGroup=(0,s.vE)([this._connection.on("data-received",(e=>this._onFeature(e))),this._connection.on("message-received",(e=>this._onWebSocketMessage(e)))]),this._connectionState.connection=this._connection}clear(){this._manager.checkForUpdates(),this._stagingStore.clear(),this._forceRefresh=!0}updateCustomParameters(e){var t;null===(t=this._connection)||void 0===t||t.updateCustomParameters(e)}sendMessageToSocket(e){var t;null===(t=this._connection)||void 0===t||t.sendMessageToSocket(e)}sendMessageToClient(e){var t;null===(t=this._connection)||void 0===t||t.sendMessageToClient(e)}_onWebSocketMessage(e){if("type"in e)switch(e.type){case"delete":if(e.objectIds)for(const t of e.objectIds)this._manager.removeById(t);if(e.trackIds)for(const t of e.trackIds)this._manager.removeByTrackId(t);break;case"clear":this.clear()}this.events.emit("message-received",e)}_onFeature(e){try{this._manager.add(e),this.events.emit("data-received",e)}catch(t){}}}class vd{constructor(e){this._onChange=e,this._chunks=new Map,this._chunksToRemove=[],this.events=new _a.A,this.featureAdapter=new ul}destroy(){this.clear()}clear(){for(const e of this._chunks.values())this._chunksToRemove.push(e);this._chunks.clear(),null!=this._localEditChunk&&this._chunksToRemove.push(this._localEditChunk),this._localEditChunk=null}*chunks(){this._localEditChunk&&(yield this._localEditChunk),this._localOverridesChunk&&(yield this._localOverridesChunk),yield*this._chunks.values()}dataChunks(){return this._chunks.values()}insert(e){var t,r;(0,n.A)("esri-2d-update-debug")&&console.debug("Chunk[".concat(e.chunkId,"] SourceChunkStore.insert")),null!==(t=this._localOverridesChunk)&&void 0!==t&&t.overriddenIds.size&&(e.reader.removeIds(this._localOverridesChunk.overriddenIds),e.invalidate()),null!==(r=this._localEditChunk)&&void 0!==r&&r.overriddenIds.size&&this._localEditChunk.removeOverrides(e),this._chunks.set(e.chunkId,e),this.events.emit("changed"),this._onChange()}remove(e){(0,n.A)("esri-2d-update-debug")&&console.debug("Chunk[".concat(e.chunkId,"] SourceChunkStore.remove")),this._chunks.delete(e.chunkId),this._chunksToRemove.push(e)}cleanupRemovedChunks(){const e=this._chunksToRemove;return this._chunksToRemove=[],e}applyLocalOverrides(e,t){null==this._localOverridesChunk&&(this._localOverridesChunk=new Gc(t,"localOverride")),this._localOverridesChunk.applyOverrides(e);for(const r of this._chunks.values())r.reader.removeIds(this._localOverridesChunk.overriddenIds),r.invalidate();this.events.emit("changed")}applyLocalEdit(e,t){null==this._localEditChunk&&(this._localEditChunk=new Gc(t,"localEdit")),this._localEditChunk.applyOverrides(e);for(const r of this._chunks.values())r.reader.removeIds(this._localEditChunk.overriddenIds),r.invalidate();this.events.emit("changed")}forEach(e){const t=new Set;for(const r of this.chunks()){const i=r.reader.getCursor();for(;i.next();){const r=i.getObjectId();t.has(r)||(e(i.copy()),t.add(r))}}}forEachUnsafe(e){const t=new Set;for(const r of this.chunks()){const i=r.reader.getCursor();for(;i.next();){const r=i.getObjectId();t.has(r)||(e(i),t.add(r))}}}forEachInBounds(e,t){const r=new Set;for(const i of this.chunks()){const s=i.queryFeaturesInBounds(e);for(;s.next();){const e=s.getObjectId();r.has(e)||(t(s.copy()),r.add(e))}}}forEachBounds(e,t){const r=(0,ya.vt)();for(const i of e)i.getBounds(r)&&t(r)}}var bd=r(67993),wd=r(19451);let Id=class extends Dl.A{constructor(e){super(e),this.debugName="",this._updatingHandles=new wd.U,this._idToUpdatingState=new bd.A}get updating(){const e=this._updatingHandles.updating||Array.from(this._idToUpdatingState.values()).some((e=>e));if((0,n.A)("esri-2d-log-updating")){const t=Array.from(this._idToUpdatingState.entries()).map((e=>{let[t,r]=e;return"-> ".concat(t,": ").concat(r)})).join("\n");console.log("".concat(this.debugName,": Updating: ").concat(e,"\n-> Handles: ").concat(this._updatingHandles.updating,"\n").concat(t))}return e}addUpdateTracking(e,t){const r=(0,l.wB)((()=>t.updating),(t=>this._idToUpdatingState.set(e,t)),{sync:!0});this.addHandles(r)}addPromise(e){return this._updatingHandles.addPromise(e)}};(0,Nt._)([(0,Ll.MZ)({constructOnly:!0})],Id.prototype,"debugName",void 0),(0,Nt._)([(0,Ll.MZ)({readOnly:!0})],Id.prototype,"updating",null),Id=(0,Nt._)([(0,Nl.$)("esri.views.2d.layers.support.UpdateTracking2D")],Id);class Sd{constructor(e,t,r,i,s){this.service=e,this._aggregateAdapter=t,this._subscriptions=r,this._onChange=i,this._connection=s,this._updateTracking=new Id({debugName:"FeatureSource"}),this._didInvalidateData=!1,this._store=new vd(this._onChange),this._metadata=hl.createFeature(e.metadata)}destroy(){var e,t;null!==(e=this._strategy)&&void 0!==e&&e.destroy(),this._store.destroy(),null!==(t=this._streamMessenger)&&void 0!==t&&t.destroy(),"memory"===this.service.type&&this.service.source.map((e=>e.close()))}get metadata(){if(!this._metadata)throw new Error("InternalError: Metadata not defined. Was update called?");return this._metadata}get store(){return this._store}get streamMessenger(){return null==this._streamMessenger&&this._initStreamMessenger(),this._streamMessenger}get statistics(){return Pl.from(this._store)}get updateTracking(){return this._updateTracking}get queryEngine(){if(!this._queryEngine){if(!this._schema)return null;const{dataFilter:e}=this._schema.mutable,t=this._schema.mutable.availableFields,r=this._metadata;this._queryEngine=new ga.d({featureStore:this._store,fieldsIndex:r.fieldsIndex,geometryType:r.geometryType,objectIdField:r.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.service.outSpatialReference,aggregateAdapter:this._aggregateAdapter,timeInfo:r.timeInfo,definitionExpression:e.definitionExpression,availableFields:t})}return this._queryEngine}get isStream(){return"stream"===this._schema.type}chunks(){return Array.from(this._store.chunks())}cleanupRemovedChunks(){return this._store.cleanupRemovedChunks()}onSubscribe(e){var t;this._connection.onEvent({type:"subscribe",tile:e.tile.id});const r=null===(t=this._strategy)||void 0===t?void 0:t.load(e);r&&(r.then((()=>this._connection.onEvent({type:"loaded",tile:e.tile.id}))).catch((t=>this._connection.onEvent({type:"error",tile:e.tile.id,error:t}))),this._updateTracking.addPromise(r))}onResume(e){var t;this._updateTracking.addPromise((0,a.QZ)(null===(t=this._strategy)||void 0===t?void 0:t.load(e)))}onUnsubscribe(e){var t;this._connection.onEvent({type:"unsubscribe",tile:e.tile.id}),null===(t=this._strategy)||void 0===t||t.unload(e)}getLocalEdit(e){return this._updateTracking.addPromise(this._getGetLocalEdit(e))}applyLocalEdit(e){this._didInvalidateData=!0,this._store.applyLocalEdit(e,this.metadata)}async update(e,t){var r,i,s;const o=e.source,a=(0,b.Ui)(null===(r=this._schema)||void 0===r?void 0:r.mutable,o.mutable);if(!a)return!1;if((0,n.A)("esri-2d-update-debug")&&console.debug("Version[".concat(t,"] FeatureSource.update"),{changes:a}),this._schema=o,null!==(i=this._queryEngine)&&void 0!==i&&i.destroy(),this._queryEngine=null,"feature-service"===this.service.type&&null!=this.service.queryMetadata.lastEditDate&&(this._lastEditDate=this.service.queryMetadata.lastEditDate),null==this._streamMessenger&&"stream"===this._schema.type&&this._initStreamMessenger(),(0,b.w2)(a,"sourceRefreshVersion")&&null!==(s=this._strategy)&&void 0!==s&&s.refresh)return await this._strategy.refresh(),!0;if(("feature"===o.type||"parquet"===o.type)&&(0,b.w2)(a,"availableFields")){if(await this._queryLastEditDateChanged()||this._didInvalidateData)this._didInvalidateData=!1,await this._updateStrategy(t);else{this._connection.onEvent({type:"updateFieldsStart"});try{await this._strategy.updateFields(o.mutable.availableFields),this._connection.onEvent({type:"updateFieldsEnd"})}catch(c){this._connection.onEvent({type:"updateFieldsError",error:c})}}return!1}return!(!(0,b.Mj)(a,"dataFilter")&&!(0,b.Mj)(a,"sourceRefreshVersion"))&&(await this._updateStrategy(t),!0)}async addParquetFile(e){this._strategy.addParquetFile(e)}_initStreamMessenger(){null==this._streamMessenger&&(this._streamMessenger=new Bl(this._connection))}async _getGetLocalEdit(e){if(e.historicMoment&&"feature"===this._schema.type&&(this._schema.mutable.dataFilter.historicMoment=e.historicMoment,this._strategy.unsafeSetQueryHistoricMoment(new Date(e.historicMoment))),"edit-by-feature"===e.type){const t=[...e.added,...e.updated].map((e=>da.Om.fromJSON(e,this.metadata.objectIdField)));return{reader:Vc.fromOptimizedFeatures(t,this.metadata),removed:this._resolveIdentifiers(e.removed)}}const t=this._resolveIdentifiers(e.removed);if(!e.updated.length&&!e.added.length)return{reader:Vc.empty(this.metadata),removed:t};const r=this._resolveIdentifiers([...e.added,...e.updated]);return{reader:await this._strategy.queryByObjectId(r),removed:t}}_resolveIdentifiers(e){const t=[],r=[];for(const i of e)null!=i.objectId&&-1!==i.objectId?r.push(i.objectId):t.push(i.globalId);if(t.length){const e=new Set(t),i=this.metadata.globalIdField;if(null==i)throw new Error("InternalError: Recieved an edit with globalIds, but not supported by the service");this._store.forEachUnsafe((t=>{const s=t.readAttribute(i);e.has(s)&&r.push(t.getObjectId())}))}return r}async _queryLastEditDateChanged(){if(null==this._lastEditDate)return!1;const e=this.service.source,t=(0,m.A)((0,m.A)({},e.query),{},{f:"json"}),r=(await(0,El.A)(e.path,{query:t,responseType:"json"})).data.editingInfo.lastEditDate;return r!==this._lastEditDate&&(this._lastEditDate=r,!0)}async _createStrategy(){const e="isSourceHosted"in this.service&&this.service.isSourceHosted,t=Array.isArray(this.service.source),r=this.service.source&&"collection"in this.service.source,i=e||t||r;if("stream"===this._schema.type){const e=new xd(this.service,this._schema.mutable.dataFilter,this._store,{outSR:this.service.outSpatialReference},this.metadata);return this._streamMessenger.strategy=e,e}if("parquet"===this._schema.type){const e=this.service;return new hd(e,this._metadata,this._schema,this._store)}const s=this.service,n=Rl.fromSchema(s,this._schema,this._metadata),o=await this._supportSnapshotMode(s,n);return o?new pd(s,n,this._store,o.featureCount,this.metadata,this._connection):i?new fu(s,n,this._store,this.metadata,this._connection):new du(s,n,this._store,this.metadata,this._connection)}async _updateStrategy(e){var t;const r=await this._createStrategy();this._connection.onEvent({type:"updateStrategyStart",about:r.about});const i=!!this._strategy;this._store.clear(),null!==(t=this._strategy)&&void 0!==t&&t.destroy(),this._strategy=r,(0,n.A)("esri-2d-update-debug")&&console.debug("Version[".concat(e,"] FeatureSource.updateStrategy"),{strategy:r});const s=Array.from(this._subscriptions.values());if(!s.length)return void this._connection.onEvent({type:"updateStrategyEnd"});const o=Promise.all(s.map((e=>this._strategy.load(e).then((()=>this._connection.onEvent({type:"loaded",tile:e.tile.id}))).catch((t=>this._connection.onEvent({type:"error",tile:e.tile.id,error:t}))))));this._updateTracking.addPromise(o);try{i&&await o}catch(c){(0,a.jH)(c)}this._connection.onEvent({type:"updateStrategyEnd"}),(0,n.A)("esri-2d-update-debug")&&console.debug("Version[".concat(e,"] FeatureSource.updateStrategyEnd"),{strategy:r})}async _supportSnapshotMode(e,t){const{queryMetadata:r}=e,i=r.snapshotInfo;if(!i||!i.supportsSnapshotMinThreshold||!i.snapshotCountThresholds)return null;const s=e.source,n=t.createQuery();n.inner.orderByFields=[],n.inner.returnGeometry=!1;const o=(await(0,Cl.gW)(s,n.inner,{query:n.customParameters})).data.count,{min:a,max:c}=i.snapshotCountThresholds;return o<=a||i.supportsSnapshotMaxThreshold&&o<c?{featureCount:o}:null}}class Td{constructor(e,t){this.tile=e,this.version=t,this._abortController=new AbortController}get key(){return this.tile.key}get signal(){return this._abortController.signal}abort(){this._abortController.abort()}}var Ad=r(11373),Md=r(69194);class kd{constructor(e,t){this.key=new f.A(0,0,0,0),this.bounds=(0,sl.vt)(),this.objectIds=new Set,this.key.set(t);const r=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=r.resolution,this.level=r.level,this.scale=r.scale,this.minScale=e.zoomToScale(r.level-1),this.maxScale=e.zoomToScale(r.level+1)}get lod(){return this.tileInfoView.getLODInfoAt(this.key)}get id(){return this.key.id}get extent(){return qa.A.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createArcadeEvaluationOptions(e){return{$view:{scale:this.scale,timeZone:e}}}createChildTiles(){const e=this.key.getChildKeys(),t=Ad.A.acquire();for(let r=0;r<e.length;r++)t[r]=new kd(this.tileInfoView,e[r]);return t}getQuantizationParameters(){return Md.A.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}class Fd{constructor(e){this.inner=e,this.resolver=(0,a.Tw)()}}class Ed{constructor(){this._aggregateAdapter={getFeatureObjectIds:e=>this._processor.getFeatureObjectIdsForAggregate(e)},this._subscriptions=new Map,this._updateRequested=!1,this._updateSubscriptionRequests=[],this._updateHighlightRequests=[]}destroy(){var e,t,r;this._subscriptions.clear(),null!==(e=this._processor)&&void 0!==e&&e.destroy(),null!==(t=this._source)&&void 0!==t&&t.destroy(),null!==(r=this._handles)&&void 0!==r&&r.remove(),this._updateLocalEditsRequest=null,this._tileInfoView=null}onAttach(e){(0,n.A)("esri-2d-update-debug")&&console.debug("Pipeline.onAttach");const t=this._connection,r=h.A.fromJSON(e.tileInfoJSON);this._tileInfoView=new p.A(r),this._source=new Sd(e.service,this._aggregateAdapter,this._subscriptions,(()=>this._requestUpdate()),t),this._processor=new Fl(t,this._source),this._handles=(0,s.vE)([(0,l.wB)((()=>this._source.updateTracking.updating),(()=>{this._requestUpdate(),(0,a.QZ)(this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:!0}))}))])}onDetach(){(0,n.A)("esri-2d-update-debug")&&console.debug("Pipeline.onDetach"),this.destroy()}set remoteClient(e){this._connection=new y(e)}get features(){var e;const t=null===(e=this._source)||void 0===e?void 0:e.queryEngine;if(!t)throw new i.A("no-queryEngine","No query engine defined");return t}get aggregates(){var e;const t=null===(e=this._processor)||void 0===e?void 0:e.aggregateQueryEngine;if(!t)throw new i.A("no-queryEngine","No aggregate query engine defined");return t}get processor(){return this._processor}get streamMessenger(){return this._source.streamMessenger}getDisplayFeatures(e){return this._processor.getDisplayFeatures(e)}getDisplayIds(e){return this._processor.getDisplayIds(e)}async updateSchema(e,t){return(0,n.A)("esri-2d-update-debug")&&this._updateSchemaRequest&&console.error("InternalError: Schema already updating"),this._updateSchemaRequest=new Fd({schema:e,version:t}),this._requestUpdate(),this._updateSchemaRequest.resolver.promise}updateSubscriptions(e){const t=new Fd(e);return this._updateSubscriptionRequests.push(t),this._requestUpdate(),t.resolver.promise}updateHighlight(e){const t=new Fd(e);return this._updateHighlightRequests.push(t),this._requestUpdate(),t.resolver.promise}async addParquetFile(e){return this._source.addParquetFile(e)}async onEdits(e){if(null!=this._updateLocalEditsRequest)throw new i.A("InternalError - Already processing an edit");this._updateLocalEditsRequest=new Fd(e);const t=this._updateLocalEditsRequest.resolver.promise;return this._requestUpdate(),t}queryStatistics(){return this._source.statistics.toJSON()}async queryVisibleFeatures(e,t){return this.features.executeQuery(e,t)}async queryHeatmapStatistics(e){var t;const r=Math.round((0,u.Lz)(e.radius));let i=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY;const n="string"==typeof e.fieldOffset,o=null!==(t=e.fieldOffset)&&void 0!==t?t:0,a=Array.from(this._subscriptions.values()),c=this._source.chunks(),l=r**2,d=3/(Math.PI*l),h=2*r,p=Math.ceil(_.CQ/h);for(const u of a){const t=u.tile,r=new Float64Array(p*p);for(const i of c){const s=i.getTileReader(t);if(!s)continue;const a=s.getCursor();for(;a.next();){let t=1;if(null!=e.field){const r=a.readAttribute(e.field);t=n?-1*+r:+r+o}const i=a.readXForDisplay()/h,s=a.readYForDisplay()/h,c=Math.floor(i),u=Math.floor(s);if(c<0||u<0||c>=p||u>=p)continue;const f=((.5+c-i)*h)**2+((.5+u-s)*h)**2;if(f>l)continue;const _=t*(d*(1-f/l)**2);r[u+c*p]+=_}}for(let e=0;e<r.length;e++)i=Math.min(i,r[e]),s=Math.max(s,r[e])}return{max:s,min:i}}async getSampleFeatures(e){const t=this._source.chunks();if(t.reduce(((e,t)=>e+t.size()),0)<=e.minFeatureCount){if(!this._source.updateTracking.updating){const e=[];return this._source.store.forEachUnsafe((t=>e.push(t.readLegacyFeatureWorldSpace()))),e}return null}const r=new Set,i=[],s=t.map((e=>e.reader.getCursor())),n=new c.A,o=3*e.sampleSize;for(let a=0;a<o&&i.length<e.sampleSize;a++){const e=s[n.getIntRange(0,t.length-1)];if(0===e.getSize())continue;const o=n.getIntRange(0,e.getSize()-1);e.setIndex(o);const a=e.getObjectId();r.has(a)||(r.add(a),i.push(e.readLegacyFeatureWorldSpace()))}return i.length>=e.sampleSize?i:null}_requestUpdate(){this._updateRequested||(this._updateRequested=!0,(0,o.d)((()=>this._scheduleNextUpdate())))}_scheduleNextUpdate(){this._updateRequested&&(this._ongoingUpdate||(this._ongoingUpdate=(0,d.oV)(this._doUpdate()).finally((()=>{this._ongoingUpdate=null,this._scheduleNextUpdate()})),this._updateRequested=!1))}_subscribe(e){const t=e.tileId;if(this._subscriptions.has(t))return;(0,n.A)("esri-2d-update-debug")&&console.debug("Tile[".concat(t,"] Pipeline.subscribe"));const r=new kd(this._tileInfoView,t),i=new Td(r,e.version);this._subscriptions.set(t,i),this._source.onSubscribe(i),this._processor.onSubscribe(i)}_unsubscribe(e){const t=this._subscriptions.get(e);t&&((0,n.A)("esri-2d-update-debug")&&console.debug("Tile[".concat(e,"] Pipeline.unsubscribe")),t.abort(),this._source.onUnsubscribe(t),this._processor.onUnsubscribe(t),this._subscriptions.delete(t.key.id))}async _doUpdate(){if((0,n.A)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateStart"),await this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:!0}),this._updateSubscriptionRequests.length){const e=this._updateSubscriptionRequests;this._updateSubscriptionRequests=[];for(const t of e)this._doUpdateSubscriptions(t.inner),t.resolver.resolve()}const e=this._updateSchemaRequest;if(this._updateSchemaRequest=null,null!=e){const{schema:t,version:r}=e.inner;await this._doUpdateSchema(t,r)}const t=this._updateLocalEditsRequest;if(this._updateLocalEditsRequest=null,null!=t){(0,n.A)("esri-2d-update-debug")&&console.debug("Pipeline.applyEditOverride",t.inner);const e=await this._source.getLocalEdit(t.inner);await this._processor.applyLocalEdit(e),this._source.applyLocalEdit(e),(0,n.A)("esri-2d-update-debug")&&console.debug("Pipeline.endEditOverride",t.inner)}if(this._updateHighlightRequests.length){const e=this._updateHighlightRequests;this._updateHighlightRequests=[];for(const t of e)this._processor.updateHighlight(t.inner),t.resolver.resolve()}const r=this._source.cleanupRemovedChunks();this._processor.removeChunks(r);try{this._subscriptions.size&&((0,n.A)("esri-2d-update-debug")&&console.debug("Pipeline.updateChunksStart"),await this._processor.updateChunks(),(0,n.A)("esri-2d-update-debug")&&console.debug("Pipeline.updateChunksEnd"))}catch(i){(0,a.jH)(i)}null!=t&&t.resolver.resolve(),null!=e&&e.resolver.resolve(),this._updateRequested?((0,n.A)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateEnd [updateRequested=true]"),await this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:!0})):((0,n.A)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateEnd [updateRequested=false, After flush]"),await this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:this._updateRequested}))}async _doUpdateSchema(e,t){var r;(0,n.A)("esri-2d-update-debug")&&console.debug("Version[".concat(t,"] Pipeline.updateStart"),{schema:e});const i={tileInfo:null===(r=this._tileInfoView)||void 0===r?void 0:r.tileInfo},s=await this._source.update(e,t),o=Array.from(this._subscriptions.values());await this._processor.update(e,t,i,s,o),(0,n.A)("esri-2d-update-debug")&&console.debug("Version[".concat(t,"] Pipeline.updateEnd"))}_doUpdateSubscriptions(e){(0,n.A)("esri-2d-update-debug")&&console.debug("Pipeline.updateSubscriptions",e);for(const t of e.subscribe)this._subscribe(t);for(const t of e.unsubscribe)this._unsubscribe(t)}}}}]);
//# sourceMappingURL=6979.334720e9.chunk.js.map